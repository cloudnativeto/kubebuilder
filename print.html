<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- This file is modified just to include the logo on the menu bar and the right favicon -->
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>The Kubebuilder Book</title>
        
        <meta name="robots" content="noindex" />
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="shortcut icon" href="https://cloudnative.to/kubebuilder/logos/favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:500" rel="stylesheet" type="text/css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        
        <link rel="stylesheet" href="theme/css/markers.css">
        
        <link rel="stylesheet" href="theme/css/custom.css">
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');
                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }
                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div id="sidebar-scrollbox" class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="introduction.html">引言</a></li><li class="chapter-item expanded affix "><a href="quick-start.html">快速入门</a></li><li class="spacer"></li><li class="chapter-item expanded "><a href="cronjob-tutorial/cronjob-tutorial.html"><strong aria-hidden="true">1.</strong> 教程：构建 CronJob</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="cronjob-tutorial/basic-project.html"><strong aria-hidden="true">1.1.</strong> 基本项目中有什么？</a></li><li class="chapter-item expanded "><a href="cronjob-tutorial/empty-main.html"><strong aria-hidden="true">1.2.</strong> 每一个旅程都需要一个起点，每个程序都需要一个 main 入口</a></li><li class="chapter-item expanded "><a href="cronjob-tutorial/gvks.html"><strong aria-hidden="true">1.3.</strong> Groups、Versions 和 Kinds 之间的关系</a></li><li class="chapter-item expanded "><a href="cronjob-tutorial/new-api.html"><strong aria-hidden="true">1.4.</strong> 创建一个API</a></li><li class="chapter-item expanded "><a href="cronjob-tutorial/api-design.html"><strong aria-hidden="true">1.5.</strong> 设计一个API</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="cronjob-tutorial/other-api-files.html"><strong aria-hidden="true">1.5.1.</strong> 简要说明：剩下文件的作用？</a></li></ol></li><li class="chapter-item expanded "><a href="cronjob-tutorial/controller-overview.html"><strong aria-hidden="true">1.6.</strong> controller 中有什么？</a></li><li class="chapter-item expanded "><a href="cronjob-tutorial/controller-implementation.html"><strong aria-hidden="true">1.7.</strong> 实现一个 controller</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="cronjob-tutorial/main-revisited.html"><strong aria-hidden="true">1.7.1.</strong> main 的修改？</a></li></ol></li><li class="chapter-item expanded "><a href="cronjob-tutorial/webhook-implementation.html"><strong aria-hidden="true">1.8.</strong> 实现 defaulting/validating webhooks</a></li><li class="chapter-item expanded "><a href="cronjob-tutorial/running.html"><strong aria-hidden="true">1.9.</strong> 运行和部署 controller</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="cronjob-tutorial/cert-manager.html"><strong aria-hidden="true">1.9.1.</strong> 部署 cert manager</a></li><li class="chapter-item expanded "><a href="cronjob-tutorial/running-webhook.html"><strong aria-hidden="true">1.9.2.</strong> 部署 webhooks</a></li></ol></li><li class="chapter-item expanded "><a href="cronjob-tutorial/writing-tests.html"><strong aria-hidden="true">1.10.</strong> 编写测试</a></li><li class="chapter-item expanded "><a href="cronjob-tutorial/epilogue.html"><strong aria-hidden="true">1.11.</strong> 结语</a></li></ol></li><li class="chapter-item expanded "><a href="multiversion-tutorial/tutorial.html"><strong aria-hidden="true">2.</strong> 教程: Multi-Version API</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="multiversion-tutorial/api-changes.html"><strong aria-hidden="true">2.1.</strong> Changing things up</a></li><li class="chapter-item expanded "><a href="multiversion-tutorial/conversion-concepts.html"><strong aria-hidden="true">2.2.</strong> Hubs, spokes, and other wheel metaphors</a></li><li class="chapter-item expanded "><a href="multiversion-tutorial/conversion.html"><strong aria-hidden="true">2.3.</strong> 实现 conversion</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="multiversion-tutorial/webhooks.html"><strong aria-hidden="true">2.3.1.</strong> 配置 webhooks</a></li></ol></li><li class="chapter-item expanded "><a href="multiversion-tutorial/deployment.html"><strong aria-hidden="true">2.4.</strong> Deployment 和 Testing</a></li><li class="spacer"></li></ol></li><li class="chapter-item expanded "><a href="migrations.html"><strong aria-hidden="true">3.</strong> 迁移</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="migration/v1vsv2.html"><strong aria-hidden="true">3.1.</strong> Kubebuilder 从 v1 迁移到 v2 </a></li><li><ol class="section"><li class="chapter-item expanded "><a href="migration/guide.html"><strong aria-hidden="true">3.1.1.</strong> 迁移指南</a></li></ol></li><li class="chapter-item expanded "><a href="migration/multi-group.html"><strong aria-hidden="true">3.2.</strong> Single Group 到 Multi-Group</a></li><li class="spacer"></li></ol></li><li class="chapter-item expanded "><a href="reference/reference.html"><strong aria-hidden="true">4.</strong> 参考</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="reference/generating-crd.html"><strong aria-hidden="true">4.1.</strong> 生成 CRDs</a></li><li class="chapter-item expanded "><a href="reference/using-finalizers.html"><strong aria-hidden="true">4.2.</strong> 使用 Finalizers</a></li><li class="chapter-item expanded "><a href="reference/kind.html"><strong aria-hidden="true">4.3.</strong> Kind 集群</a></li><li class="chapter-item expanded "><a href="reference/webhook-overview.html"><strong aria-hidden="true">4.4.</strong> webhook 是什么?</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="reference/admission-webhook.html"><strong aria-hidden="true">4.4.1.</strong> 准入 webhook</a></li><li class="chapter-item expanded "><a href="reference/webhook-for-core-types.html"><strong aria-hidden="true">4.4.2.</strong> 核心类型的 Webhooks</a></li></ol></li><li class="chapter-item expanded "><a href="reference/markers.html"><strong aria-hidden="true">4.5.</strong> 用于配置/代码生成的标记</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="reference/markers/crd.html"><strong aria-hidden="true">4.5.1.</strong> CRD 生成</a></li><li class="chapter-item expanded "><a href="reference/markers/crd-validation.html"><strong aria-hidden="true">4.5.2.</strong> CRD 验证</a></li><li class="chapter-item expanded "><a href="reference/markers/crd-processing.html"><strong aria-hidden="true">4.5.3.</strong> CRD 处理</a></li><li class="chapter-item expanded "><a href="reference/markers/webhook.html"><strong aria-hidden="true">4.5.4.</strong> Webhook</a></li><li class="chapter-item expanded "><a href="reference/markers/object.html"><strong aria-hidden="true">4.5.5.</strong> Object/DeepCopy</a></li><li class="chapter-item expanded "><a href="reference/markers/rbac.html"><strong aria-hidden="true">4.5.6.</strong> RBAC</a></li></ol></li><li class="chapter-item expanded "><a href="reference/controller-gen.html"><strong aria-hidden="true">4.6.</strong> controller-gen 命令行界面</a></li><li class="chapter-item expanded "><a href="reference/completion.html"><strong aria-hidden="true">4.7.</strong> shell 自动补全</a></li><li class="chapter-item expanded "><a href="reference/artifacts.html"><strong aria-hidden="true">4.8.</strong> 制品包</a></li><li class="chapter-item expanded "><a href="reference/envtest.html"><strong aria-hidden="true">4.9.</strong> 在集成测试中使用 envtest</a></li><li class="chapter-item expanded "><a href="reference/metrics.html"><strong aria-hidden="true">4.10.</strong> 指标</a></li><li class="spacer"></li></ol></li><li class="chapter-item expanded "><a href="TODO.html">附录: TODO 界面</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar" class="menu-bar">
                    <div id="menu-bar-sticky-container">
                        <div class="left-buttons">
                            <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                                <i class="fa fa-bars"></i>
                            </button>
                            <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                                <i class="fa fa-paint-brush"></i>
                            </button>
                            <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                                <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                            </ul>
                            
                            <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                                <i class="fa fa-search"></i>
                            </button>
                            
                        </div>

                        <h1 class="menu-title"><img alt="The Kubebuilder Book" src="https://cloudnative.to/kubebuilder/logos/logo-single-line.png"></h1>

                        <div class="right-buttons">
                            <a href="print.html" title="Print this book" aria-label="Print this book">
                                <i id="print-button" class="fa fa-print"></i>
                            </a>
                            
                        </div>
                    </div>
                </div>

                <header id="notice-bar">
    <h2>kubebuilder 中文文档由<a href="https://cloudnative.to/">云原生社区</a>主导翻译。任何问题可以在<a href="https://github.com/cloudnativeto/kubebuilder/issues">这儿</a>提issue。issue模版可以参考<a href="https://github.com/cloudnativeto/kubebuilder/issues/193">这个</a>。
    </h2>
</header>


                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <p><strong>注意：</strong> 着急的读者可以直接跳到这里<a href="quick-start.html">快速开始</a>。</p>
<p><strong>若在使用 Kubebuilder v1? 请查看 <a href="https://book-v1.book.kubebuilder.io">legacy documentation</a></strong>。</p>
<h2><a class="header" href="#文档适合哪些人看" id="文档适合哪些人看">文档适合哪些人看</a></h2>
<h4><a class="header" href="#kubernetes-的使用者" id="kubernetes-的使用者">Kubernetes 的使用者</a></h4>
<p>Kubernetes 的使用者将通过学习其 APIs 是如何设计和实现的，从而更深入地了解 Kubernetes 。这本书将教读者如何开发自己的 Kubernetes APIs 以及如何设计核心 Kubernetes API 的原理。</p>
<p>包括：</p>
<ul>
<li>Kubernetes APIs 和 Resources 的构造</li>
<li>APIs 版本控制语义</li>
<li>故障自愈</li>
<li>垃圾回收和 Finalizers</li>
<li>声明式与命令式 APIs</li>
<li>基于 Level-Based 与 Edge-Base APIs</li>
<li>Resources 与 Subresources</li>
</ul>
<h4><a class="header" href="#kubernetes-api-开发者" id="kubernetes-api-开发者">Kubernetes API 开发者</a></h4>
<p>API 扩展开发者将学习实现标准的 Kubernetes API 原理和概念，以及用于快速执行的简单工具和库。这本书涵盖了开发人员通常会遇到的陷阱和误区。</p>
<p>包括：</p>
<ul>
<li>如何用一个 reconciliation 方法处理多个 events</li>
<li>如何配置定期执行 reconciliation 方法</li>
<li><em>即将到来的</em>
<ul>
<li>何时使用 lister cache 与 live lookups</li>
<li>垃圾回收与 Finalizers</li>
<li>如何使用 Declarative 与 Webhook Validation</li>
<li>如何实现 API 版本控制</li>
</ul>
</li>
</ul>
<h2><a class="header" href="#贡献" id="贡献">贡献</a></h2>
<p>如果您想为本书或代码做出贡献，请先阅读我们的<a href="https://github.com/cloudnativeto/kubebuilder/tree/zh/docs/book">贡献</a>准则。</p>
<h2><a class="header" href="#资源" id="资源">资源</a></h2>
<ul>
<li>代码仓库：<a href="https://sigs.k8s.io/kubebuilder">sigs.k8s.io/kubebuilder</a></li>
<li>Slack 沟通群：<a href="http://slack.k8s.io/#kubebuilder">#kubebuilder</a></li>
<li>Google Group：<a href="https://groups.google.com/forum/#!forum/kubebuilder">kubebuilder@googlegroups.com</a></li>
<li>云原生社区：<a href="https://cloudnative.to">https://cloudnative.to</a></li>
</ul>
<h1><a class="header" href="#快速入门" id="快速入门">快速入门</a></h1>
<p>快速入门包含如下内容：</p>
<ul>
<li><a href="quick-start.html#%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E9%A1%B9%E7%9B%AE">创建一个项目</a></li>
<li><a href="quick-start.html#%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA-API">创建一个 API</a></li>
<li><a href="quick-start.html#%E6%B5%8B%E8%AF%95">测试</a></li>
<li><a href="quick-start.html#%E5%A6%82%E4%BD%95%E5%9C%A8%E9%9B%86%E7%BE%A4%E4%B8%AD%E8%BF%90%E8%A1%8C">如何在集群中运行</a></li>
</ul>
<h2><a class="header" href="#依赖组件" id="依赖组件">依赖组件</a></h2>
<ul>
<li><a href="https://golang.org/dl/">go</a> version v1.15+.</li>
<li><a href="https://docs.docker.com/install/">docker</a> version 17.03+.</li>
<li><a href="https://kubernetes.io/docs/tasks/tools/install-kubectl/">kubectl</a> version v1.11.3+.</li>
<li><a href="https://sigs.k8s.io/kustomize/docs/INSTALL.md">kustomize</a> v3.1.0+</li>
<li>能够访问 Kubernetes v1.11.3+ 集群</li>
</ul>
<h2><a class="header" href="#安装" id="安装">安装</a></h2>
<p>安装 <a href="https://sigs.k8s.io/kubebuilder">kubebuilder</a>:</p>
<pre><code class="language-bash">os=$(go env GOOS)
arch=$(go env GOARCH)

# 下载 kubebuilder 并解压到 tmp 目录中
curl -L https://go.kubebuilder.io/dl/2.3.1/${os}/${arch} | tar -xz -C /tmp/
</code></pre>
<p>If you are using a Kubebuilder plugin version less than version <code>v3+</code>, you must configure the Kubernetes binaries required for the <a href="https://book.kubebuilder.io/reference/testing/envtest.html">envtest</a>, run: </p>
<pre><code class="language-bash"># 将 kubebuilder 移动到一个长期的路径，并将其加入环境变量 path 中 
# （如果你把 kubebuilder 放在别的地方，你需要额外设置 KUBEBUILDER_ASSETS 环境变量）

sudo mv /tmp/kubebuilder_2.3.1_${os}_${arch} /usr/local/kubebuilder
export PATH=$PATH:/usr/local/kubebuilder/bin
</code></pre>
<aside class="note">
<h1><a class="header" href="#请使用-master-分支的-kubebuilder-进行构建" id="请使用-master-分支的-kubebuilder-进行构建">请使用 master 分支的 kubebuilder 进行构建</a></h1>
<p>另外，你可以从 <code>https://go.kubebuilder.io/dl/latest/${os}/${arch}</code> 下载安装包</p>
</aside>
<p>Kubebuilder 通过 <code>kubebuilder completion &lt;bash|zsh&gt;</code> 命令为 Bash 和 Zsh 提供了自动完成的支持，这可以节省你大量的重复编码工作。更多信息请参见 <a href="./reference/completion.html">completion</a> 文档。</p>
</aside>
<h2><a class="header" href="#创建一个项目" id="创建一个项目">创建一个项目</a></h2>
<p>创建一个目录，然后在里面运行 <code>kubebuilder init</code> 命令，初始化一个新项目。示例如下。</p>
<pre><code class="language-bash">mkdir $GOPATH/src/example
cd $GOPATH/src/example
kubebuilder init --domain my.domain
</code></pre>
<aside class="note">
<h1><a class="header" href="#如果你的安装目录不在-gopath-中" id="如果你的安装目录不在-gopath-中">如果你的安装目录不在 `$GOPATH` 中</a></h1>
<p>如果你的 kubebuilder 安装目录不在 <code>$GOPATH</code> 中，你需要运行 <code>go mod init &lt;modulename&gt;</code> 来告诉 kubebuilder 和 Go module 的基本导入路径。</p>
<p>若要进一步了解 <code>GOPATH</code>，参阅 <a href="https://golang.org/doc/code.html">如何编写 Go 代码</a> 页面文档中的 <a href="https://golang.org/doc/code.html#GOPATH">GOPATH 环境变量</a> 章节。</p>
</aside>
<aside class="note">
<h1><a class="header" href="#go-package-问题" id="go-package-问题">Go package 问题</a></h1>
<p>确保你已经执行 <code>$ export GO111MODULE=on</code> 命令来激活模块支持，以解决像 <code>cannot find package .... (from $GOROOT)</code> 这样的问题。</p>
</aside>
<h2><a class="header" href="#创建一个-api" id="创建一个-api">创建一个 API</a></h2>
<p>运行下面的命令，创建一个新的 API（组/版本）为 “webapp/v1”，并在上面创建新的 Kind(CRD) “Guestbook”。</p>
<pre><code class="language-bash">kubebuilder create api --group webapp --version v1 --kind Guestbook
</code></pre>
<aside class="note">
<h1><a class="header" href="#创建选项" id="创建选项">创建选项</a></h1>
<p>如果你在 Create Resource [y/n] 和 Create Controller [y/n] 中按<code>y</code>，那么这将创建文件 <code>api/v1/guestbook_types.go</code> ，该文件中定义相关 API ，而针对于这一类型 (CRD) 的对账业务逻辑生成在 <code>controller/guestbook_controller.go</code> 文件中。</p>
</aside>
<p><strong>可选项：</strong> 编辑 API 定义和对账业务逻辑。更多信息请参见 <a href="/cronjob-tutorial/api-design.html">设计一个 API</a> 和 <a href="cronjob-tutorial/controller-overview.html">控制器</a>。</p>
<details><summary>示例 `(api/v1/guestbook_types.go)` </summary>
<p>
<pre><code class="language-go">// GuestbookSpec defines the desired state of Guestbook
type GuestbookSpec struct {
	// INSERT ADDITIONAL SPEC FIELDS - desired state of cluster
	// Important: Run &quot;make&quot; to regenerate code after modifying this file

	// Quantity of instances
	// +kubebuilder:validation:Minimum=1
	// +kubebuilder:validation:Maximum=10
	Size int32 `json:&quot;size&quot;`

	// Name of the ConfigMap for GuestbookSpec's configuration
	// +kubebuilder:validation:MaxLength=15
	// +kubebuilder:validation:MinLength=1
	ConfigMapName string `json:&quot;configMapName&quot;`

	// +kubebuilder:validation:Enum=Phone;Address;Name
	Type string `json:&quot;alias,omitempty&quot;`
}

// GuestbookStatus defines the observed state of Guestbook
type GuestbookStatus struct {
	// INSERT ADDITIONAL STATUS FIELD - define observed state of cluster
	// Important: Run &quot;make&quot; to regenerate code after modifying this file

	// PodName of the active Guestbook node.
	Active string `json:&quot;active&quot;`

	// PodNames of the standby Guestbook nodes.
	Standby []string `json:&quot;standby&quot;`
}

// +kubebuilder:object:root=true
// +kubebuilder:subresource:status
// +kubebuilder:resource:scope=Cluster

// Guestbook is the Schema for the guestbooks API
type Guestbook struct {
	metav1.TypeMeta   `json:&quot;,inline&quot;`
	metav1.ObjectMeta `json:&quot;metadata,omitempty&quot;`

	Spec   GuestbookSpec   `json:&quot;spec,omitempty&quot;`
	Status GuestbookStatus `json:&quot;status,omitempty&quot;`
}
</code></pre>
</p>
</details>
<h2><a class="header" href="#测试" id="测试">测试</a></h2>
<p>你需要一个 Kubernetes 集群来运行。 你可以使用 <a href="https://sigs.k8s.io/kind">KIND</a> 来获取一个本地集群进行测试，也可以在远程集群上运行。</p>
<aside class="note">
<h1><a class="header" href="#使用的上下文" id="使用的上下文">使用的上下文</a></h1>
<p>你的控制器将自动使用你的 <code>kubeconfig</code> 文件中的当前上下文（即无论群集 <code>kubectl cluster-info</code> 显示的是什么群集）。</p>
</aside> 
<p>将 CRD 安装到集群中</p>
<pre><code class="language-bash">make install
</code></pre>
<p>运行控制器（这将在前台运行，如果你想让它一直运行，请切换到新的终端）。</p>
<pre><code class="language-bash">make run
</code></pre>
<h2><a class="header" href="#安装-cr-实例" id="安装-cr-实例">安装 CR 实例</a></h2>
<p>如果你按了 <code>y</code> 创建资源 [y/n]，那么你就为示例中的自定义资源定义 <code>CRD</code> 创建了一个自定义资源 <code>CR</code> （如果你更改了 API 定义，请务必先编辑它们）。</p>
<pre><code class="language-bash">kubectl apply -f config/samples/
</code></pre>
<h2><a class="header" href="#如何在集群中运行" id="如何在集群中运行">如何在集群中运行</a></h2>
<p>构建并推送你的镜像到 <code>IMG</code> 指定的位置。</p>
<pre><code class="language-bash">make docker-build docker-push IMG=&lt;some-registry&gt;/&lt;project-name&gt;:tag
</code></pre>
<p>根据 <code>IMG</code> 指定的镜像将控制器部署到集群中。</p>
<pre><code class="language-bash">make deploy IMG=&lt;some-registry&gt;/&lt;project-name&gt;:tag
</code></pre>
<aside class="note">
<h1><a class="header" href="#rbac-错误" id="rbac-错误">RBAC 错误</a></h1>
<p>如果你遇到 RBAC 错误，你可能需要授予自己集群管理员权限或以管理员身份登录。请参考 <a href="https://cloud.google.com/kubernetes-engine/docs/how-to/role-based-access-control#iam-rolebinding-bootstrap">在 GKE 集群 v1.11.x 及以上版本上使用 Kubernetes RBAC 的组件依赖</a> 可能是你的情况。 </p>
</aside> 
<h2><a class="header" href="#卸载-crd" id="卸载-crd">卸载 CRD</a></h2>
<p>从你的集群中删除 CRD</p>
<pre><code class="language-bash">make uninstall
</code></pre>
<h2><a class="header" href="#卸载控制器" id="卸载控制器">卸载控制器</a></h2>
<p>从集群中卸载控制器</p>
<pre><code class="language-bash">make undeploy
</code></pre>
<h2><a class="header" href="#下一步" id="下一步">下一步</a></h2>
<p>现在，参照 <a href="https://book.kubebuilder.io/cronjob-tutorial/cronjob-tutorial.html">CronJob 教程</a>，通过开发一个演示示例项目更好地理解 kubebuilder 的工作原理。</p>
<h1><a class="header" href="#教程构建-cronjob" id="教程构建-cronjob">教程：构建 CronJob</a></h1>
<p>太多的教程一开始都是以一些非常复杂的设置开始，或者是实现一些玩具应用，让你了解了基本的知识，然后又在更复杂的东西上停滞不前。相反地，本教程将会带你了解 Kubebuilder 的（几乎）全部复杂功能，从简单的功能开始，到全部功能。</p>
<p>让我们假装厌倦了 Kubernetes 中的 CronJob 控制器的非 Kubebuilder 实现繁重的维护工作（当然，这有点小题大做），我们想用 KubeBuilder 来重写它。</p>
<p><strong>CronJob</strong> 控制器的工作是定期在 Kubernetes 集群上运行一次性任务。它是以 <strong>Job</strong> 控制器为基础实现的，而 <strong>Job</strong> 控制器的任务是运行一次性的任务，确保它们完成。</p>
<p>与其试图一开始解决重写 Job 控制器的问题，我们先看看如何与外部类型进行交互。</p>
<aside class="note">
<h1><a class="header" href="#渐进-vs-跳进" id="渐进-vs-跳进">渐进 vs 跳进</a></h1>
<p>注意，本教程的大部分内容都是从书的源目录下的 Go 文件中生成的：<a href="https://github.com/kubernetes-sigs/kubebuilder/tree/master/docs/book/src/cronjob-tutorial/testdata">docs/book/src/cronjob-tutorial/testdata</a>。完整的、可运行的项目在 <a href="https://github.com/kubernetes-sigs/kubebuilder/tree/master/docs/book/src/cronjob-tutorial/testdata/project">project</a> 中，而中间文件则直接在 <a href="https://github.com/kubernetes-sigs/kubebuilder/tree/master/docs/book/src/cronjob-tutorial/testdata">testdata</a> 目录。</p>
</aside>
<h2><a class="header" href="#创建项目" id="创建项目">创建项目</a></h2>
<p>正如 <a href="cronjob-tutorial/../quick-start.html">快速入门</a> 中所介绍的那样，我们需要创建一个新的项目。确保你已经 <a href="cronjob-tutorial/../quick-start.html#%E5%AE%89%E8%A3%85">安装 Kubebuilder</a>，然后再创建一个新项目。</p>
<pre><code class="language-bash"># 我们将使用 tutorial.kubebuilder.io 域，
# 所以所有的 API 组将是&lt;group&gt;.tutorial.kubebuilder.io.
kubebuilder init --domain tutorial.kubebuilder.io
</code></pre>
<p>现在我们已经创建了一个项目，让我们来看看 Kubebuilder 为我们初始化了哪些组件。....</p>
<h1><a class="header" href="#一个-kubebuilder-项目有哪些组件" id="一个-kubebuilder-项目有哪些组件">一个 kubebuilder 项目有哪些组件？</a></h1>
<p>当自动生成一个新项目时，Kubebuilder 为我们提供了一些基本的模板。</p>
<h2><a class="header" href="#创建基础组件" id="创建基础组件">创建基础组件</a></h2>
<p>首先是基本的项目文件初始化，为项目构建做好准备。</p>
<details> <summary>`go.mod`: 我们的项目的 Go mod 配置文件，记录依赖库信息。</summary>
<pre><code class="language-go">module tutorial.kubebuilder.io/project

go 1.15

require (
	github.com/go-logr/logr v0.1.0
	github.com/onsi/ginkgo v1.12.1
	github.com/onsi/gomega v1.10.1
	github.com/robfig/cron v1.2.0
	k8s.io/api v0.18.6
	k8s.io/apimachinery v0.18.6
	k8s.io/client-go v0.18.6
	sigs.k8s.io/controller-runtime v0.6.2
)
</code></pre>
</details>
<details><summary>`Makefile`: 用于控制器构建和部署的 Makefile 文件</summary>
<pre><code class="language-makefile">
# Image URL to use all building/pushing image targets
IMG ?= controller:latest
# Produce CRDs that work back to Kubernetes 1.11 (no version conversion)
CRD_OPTIONS ?= &quot;crd:trivialVersions=true&quot;

# Get the currently used golang install path (in GOPATH/bin, unless GOBIN is set)
ifeq (,$(shell go env GOBIN))
GOBIN=$(shell go env GOPATH)/bin
else
GOBIN=$(shell go env GOBIN)
endif

all: manager

# Run tests
ENVTEST_ASSETS_DIR=$(shell pwd)/testbin
test: generate fmt vet manifests
	mkdir -p ${ENVTEST_ASSETS_DIR}
	test -f ${ENVTEST_ASSETS_DIR}/setup-envtest.sh || curl -sSLo ${ENVTEST_ASSETS_DIR}/setup-envtest.sh https://raw.githubusercontent.com/kubernetes-sigs/controller-runtime/master/hack/setup-envtest.sh
	source ${ENVTEST_ASSETS_DIR}/setup-envtest.sh; fetch_envtest_tools $(ENVTEST_ASSETS_DIR); setup_envtest_env $(ENVTEST_ASSETS_DIR); go test ./... -coverprofile cover.out

# Build manager binary
manager: generate fmt vet
	go build -o bin/manager main.go

# Run against the configured Kubernetes cluster in ~/.kube/config
run: generate fmt vet manifests
	go run ./main.go

# Install CRDs into a cluster
install: manifests kustomize
	$(KUSTOMIZE) build config/crd | kubectl apply -f -

# Uninstall CRDs from a cluster
uninstall: manifests kustomize
	$(KUSTOMIZE) build config/crd | kubectl delete -f -

# Deploy controller in the configured Kubernetes cluster in ~/.kube/config
deploy: manifests kustomize
	cd config/manager &amp;&amp; $(KUSTOMIZE) edit set image controller=${IMG}
	$(KUSTOMIZE) build config/default | kubectl apply -f -

# UnDeploy controller from the configured Kubernetes cluster in ~/.kube/config
undeploy:
	$(KUSTOMIZE) build config/default | kubectl delete -f -

# Generate manifests e.g. CRD, RBAC etc.
manifests: controller-gen
	$(CONTROLLER_GEN) $(CRD_OPTIONS) rbac:roleName=manager-role webhook paths=&quot;./...&quot; output:crd:artifacts:config=config/crd/bases

# Run go fmt against code
fmt:
	go fmt ./...

# Run go vet against code
vet:
	go vet ./...

# Generate code
generate: controller-gen
	$(CONTROLLER_GEN) object:headerFile=&quot;hack/boilerplate.go.txt&quot; paths=&quot;./...&quot;

# Build the docker image
docker-build: test
	docker build . -t ${IMG}

# Push the docker image
docker-push:
	docker push ${IMG}

# find or download controller-gen
# download controller-gen if necessary
controller-gen:
ifeq (, $(shell which controller-gen))
	@{ \
	set -e ;\
	CONTROLLER_GEN_TMP_DIR=$$(mktemp -d) ;\
	cd $$CONTROLLER_GEN_TMP_DIR ;\
	go mod init tmp ;\
	go get sigs.k8s.io/controller-tools/cmd/controller-gen@v0.3.0 ;\
	rm -rf $$CONTROLLER_GEN_TMP_DIR ;\
	}
CONTROLLER_GEN=$(GOBIN)/controller-gen
else
CONTROLLER_GEN=$(shell which controller-gen)
endif

kustomize:
ifeq (, $(shell which kustomize))
	@{ \
	set -e ;\
	KUSTOMIZE_GEN_TMP_DIR=$$(mktemp -d) ;\
	cd $$KUSTOMIZE_GEN_TMP_DIR ;\
	go mod init tmp ;\
	go get sigs.k8s.io/kustomize/kustomize/v3@v3.5.4 ;\
	rm -rf $$KUSTOMIZE_GEN_TMP_DIR ;\
	}
KUSTOMIZE=$(GOBIN)/kustomize
else
KUSTOMIZE=$(shell which kustomize)
endif
</code></pre>
</details>
<details><summary>`PROJECT`: 用于生成组件的 Kubebuilder 元数据</summary>
<pre><code class="language-yaml">domain: tutorial.kubebuilder.io
layout: go.kubebuilder.io/v3-alpha
projectName: project
repo: tutorial.kubebuilder.io/project
resources:
- group: batch
  kind: CronJob
  version: v1
version: 3-alpha
</code></pre>
</details>
<h2><a class="header" href="#启动配置" id="启动配置">启动配置</a></h2>
<p>我们还可以在 <a href="https://github.com/kubernetes-sigs/kubebuilder/tree/master/docs/book/src/cronjob-tutorial/testdata/project/config"><code>config/</code></a> 目录下获得启动配置。现在，它只包含了在集群上启动控制器所需的 <a href="https://sigs.k8s.io/kustomize">Kustomize</a> YAML 定义，但一旦我们开始编写控制器，它还将包含我们的 CustomResourceDefinitions(CRD) 、RBAC 配置和 WebhookConfigurations 。</p>
<p><a href="https://github.com/kubernetes-sigs/kubebuilder/tree/master/docs/book/src/cronjob-tutorial/testdata/project/config/default"><code>config/default</code></a> 在标准配置中包含 <a href="https://github.com/kubernetes-sigs/kubebuilder/blob/master/docs/book/src/cronjob-tutorial/testdata/project/config/default/kustomization.yaml">Kustomize base</a> ，它用于启动控制器。</p>
<p>其他每个目录都包含一个不同的配置，重构为自己的基础。</p>
<ul>
<li>
<p><a href="https://github.com/kubernetes-sigs/kubebuilder/tree/master/docs/book/src/cronjob-tutorial/testdata/project/config/manager"><code>config/manager</code></a>: 在集群中以 pod 的形式启动控制器</p>
</li>
<li>
<p><a href="https://github.com/kubernetes-sigs/kubebuilder/tree/master/docs/book/src/cronjob-tutorial/testdata/project/config/rbac"><code>config/rbac</code></a>: 在自己的账户下运行控制器所需的权限</p>
</li>
</ul>
<h2><a class="header" href="#入口函数" id="入口函数">入口函数</a></h2>
<p>最后，当然也是最重要的一点，生成项目的入口函数：<code>main.go</code>。接下来我们看看它。.....</p>
<h1><a class="header" href="#每段旅程需要一个起点每个程序需要一个入口函数" id="每段旅程需要一个起点每个程序需要一个入口函数">每段旅程需要一个起点，每个程序需要一个入口函数</a></h1>
<div class="literate"><cite class="literate-source"><a href="https://sigs.k8s.io/kubebuilder/docs/book/src/cronjob-tutorial/testdata/emptymain.go">emptymain.go</a></cite><details class="collapse-code"><summary class="hljs"><pre class="hljs"><span class="hljs-comment">Apache License</span></pre></summary>
<p>Licensed under the Apache License, Version 2.0 (the “License”);
you may not use this file except in compliance with the License.
You may obtain a copy of the License at</p>
<pre><code>http://www.apache.org/licenses/LICENSE-2.0
</code></pre>
<p>Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an “AS IS” BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.</p>
</details>
<p>我们的 main 文件最开始是 import 一些基本库，尤其是：</p>
<ul>
<li>核心的 <a href="https://pkg.go.dev/sigs.k8s.io/controller-runtime?tab=doc">控制器运行时</a> 库</li>
<li>默认的控制器运行时日志库-- Zap (后续会对它作更多的介绍)</li>
</ul>
<pre><code class="language-go">package main

import (
	&quot;flag&quot;
	&quot;fmt&quot;
	&quot;os&quot;

	&quot;k8s.io/apimachinery/pkg/runtime&quot;
	_ &quot;k8s.io/client-go/plugin/pkg/client/auth/gcp&quot;
	ctrl &quot;sigs.k8s.io/controller-runtime&quot;
	&quot;sigs.k8s.io/controller-runtime/pkg/cache&quot;
	&quot;sigs.k8s.io/controller-runtime/pkg/log/zap&quot;
	// +kubebuilder:scaffold:imports
)
</code></pre>
<p>每一组控制器都需要一个 <a href="https://book.kubebuilder.io/cronjob-tutorial/gvks.html#err-but-whats-that-scheme-thing"><em>Scheme</em></a>，它提供了 Kinds 和相应的 Go 类型之间的映射。我们将在编写 API 定义的时候再谈一谈 Kinds，所以现在只需要记住它就好。</p>
<pre><code class="language-go">var (
	scheme   = runtime.NewScheme()
	setupLog = ctrl.Log.WithName(&quot;setup&quot;)
)

func init() {

	// +kubebuilder:scaffold:scheme
}
</code></pre>
<p>这段代码的核心逻辑比较简单: </p>
<ul>
<li>我们通过 flag 库解析入参</li>
<li>我们实例化了一个<a href="https://pkg.go.dev/sigs.k8s.io/controller-runtime/pkg/manager#Manager"><em>manager</em></a>，它记录着我们所有控制器的运行情况，以及设置共享缓存和API服务器的客户端（注意，我们把我们的 Scheme 的信息告诉了 manager）。</li>
<li>运行 manager，它反过来运行我们所有的控制器和 webhooks。manager 状态被设置为 Running，直到它收到一个优雅停机 (graceful shutdown) 信号。这样一来，当我们在 Kubernetes 上运行时，我们就可以优雅地停止 pod。</li>
</ul>
<p>虽然我们现在还没有任何业务代码可供执行，但请记住 <code>+kubebuilder:scaffold:builder</code> 的注释 --- 事情很快就会变得有趣起来。</p>
<pre><code class="language-go">func main() {
	var metricsAddr string
	flag.StringVar(&amp;metricsAddr, &quot;metrics-addr&quot;, &quot;:8080&quot;, &quot;The address the metric endpoint binds to.&quot;)
	flag.Parse()

	ctrl.SetLogger(zap.New(zap.UseDevMode(true)))

	mgr, err := ctrl.NewManager(ctrl.GetConfigOrDie(), ctrl.Options{Scheme: scheme, MetricsBindAddress: metricsAddr})
	if err != nil {
		setupLog.Error(err, &quot;unable to start manager&quot;)
		os.Exit(1)
	}
</code></pre>
<p>注意：Manager 可以通过以下方式限制控制器可以监听资源的命名空间。</p>
<pre><code class="language-go">	mgr, err = ctrl.NewManager(ctrl.GetConfigOrDie(), ctrl.Options{
		Scheme:             scheme,
		Namespace:          namespace,
		MetricsBindAddress: metricsAddr,
	})
</code></pre>
<p>上面的例子将把你的项目改成只监听单一的命名空间。在这种情况下，建议通过将默认的 ClusterRole 和 ClusterRoleBinding 分别替换为 Role 和 RoleBinding 来限制所提供给这个命名空间的授权。</p>
<p>另外，也可以使用 <a href="https://pkg.go.dev/github.com/kubernetes-sigs/controller-runtime/pkg/cache#MultiNamespacedCacheBuilder">MultiNamespacedCacheBuilder</a> 来监听特定的命名空间。</p>
<pre><code class="language-go">	var namespaces []string // List of Namespaces

	mgr, err = ctrl.NewManager(ctrl.GetConfigOrDie(), ctrl.Options{
		Scheme:             scheme,
		NewCache:           cache.MultiNamespacedCacheBuilder(namespaces),
		MetricsBindAddress: fmt.Sprintf(&quot;%s:%d&quot;, metricsHost, metricsPort),
	})
</code></pre>
<p>更多信息请参见 <a href="https://pkg.go.dev/sigs.k8s.io/controller-runtime/pkg/cache?tab=doc#MultiNamespacedCacheBuilder">MultiNamespacedCacheBuilder</a></p>
<pre><code class="language-go">	// +kubebuilder:scaffold:builder

	setupLog.Info(&quot;starting manager&quot;)
	if err := mgr.Start(ctrl.SetupSignalHandler()); err != nil {
		setupLog.Error(err, &quot;problem running manager&quot;)
		os.Exit(1)
	}
}
</code></pre>
</div>
<p>说完这些，我们就可以开始创建我们的 API 了！</p>
<h1><a class="header" href="#gvk-介绍" id="gvk-介绍">GVK 介绍</a></h1>
<p>在我们开始讲 API 之前，我们应该先介绍一下 Kubernetes 中 API 相关的术语。</p>
<p>当我们在 Kubernetes 中谈论 API 时，我们经常会使用 4 个术语：<strong>groups</strong> 、<strong>versions</strong>、<strong>kinds</strong> 和 <strong>resources</strong>。</p>
<h2><a class="header" href="#组和版本" id="组和版本">组和版本</a></h2>
<p>Kubernetes 中的 <strong>API 组</strong>简单来说就是相关功能的集合。每个组都有一个或多个<strong>版本</strong>，顾名思义，它允许我们随着时间的推移改变 <strong>API</strong> 的职责。</p>
<h2><a class="header" href="#类型和资源" id="类型和资源">类型和资源</a></h2>
<p>每个 API 组-版本包含一个或多个 API 类型，我们称之为 <strong>Kinds</strong>。虽然一个 Kind 可以在不同版本之间改变表单内容，但每个表单必须能够以某种方式存储其他表单的所有数据（我们可以将数据存储在字段中，或者在注释中）。 这意味着，使用旧的 API 版本不会导致新的数据丢失或损坏。更多 API 信息，请参阅 <a href="https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md">Kubernetes API 指南</a>。</p>
<p>你也会偶尔听到提到 <strong>resources</strong>。 resources（资源） 只是 API 中的一个 Kind 的使用方式。通常情况下，Kind 和 resources 之间有一个一对一的映射。 例如，<code>pods</code> 资源对应于 <code>Pod</code> 种类。但是有时，同一类型可能由多个资源返回。例如，<code>Scale</code> Kind 是由所有 <code>scale</code> 子资源返回的，如 <code>deployments/scale</code> 或 <code>replicasets/scale</code>。这就是允许 Kubernetes HorizontalPodAutoscaler(HPA) 与不同资源交互的原因。然而，使用 CRD，每个 Kind 都将对应一个 resources。</p>
<p>注意：resources 总是用小写，按照惯例是 Kind 的小写形式。</p>
<blockquote>
<p>GVK = Group Version Kind
GVR = Group Version Resources</p>
</blockquote>
<h2><a class="header" href="#那么这些术语如何对应到-golang-中的实现呢" id="那么这些术语如何对应到-golang-中的实现呢">那么，这些术语如何对应到 Golang 中的实现呢？</a></h2>
<p>当我们在一个特定的群组版本 (Group-Version) 中提到一个 Kind 时，我们会把它称为 <strong>GroupVersionKind</strong>，简称 GVK。与 资源 (resources) 和 GVR 一样，我们很快就会看到，每个 GVK 对应 Golang 代码中的到对应生成代码中的 Go type。</p>
<p>现在我们理解了这些术语，我们就可以<strong>真正</strong>地创建我们的 API！</p>
<h2><a class="header" href="#scheme-是什么" id="scheme-是什么">Scheme 是什么？</a></h2>
<p>我们之前看到的 <code>Scheme</code> 是一种追踪 Go Type 的方法，它对应于给定的 GVK（不要被它吓倒 <a href="https://pkg.go.dev/k8s.io/apimachinery/pkg/runtime#Scheme">godocs</a>）。</p>
<p>例如，假设我们将 <code>&quot;tutorial.kubebuilder.io/api/v1&quot;.CronJob{}</code> 类型放置在 <code>batch.tutorial.kubebuilder.io/v1</code> API 组中（也就是说它有 <code>CronJob</code> Kind)。</p>
<p>然后，我们便可以在 API server 给定的 json 数据构造一个新的 <code>&amp;CronJob{}</code>。</p>
<pre><code class="language-json">{
    &quot;kind&quot;: &quot;CronJob&quot;,
    &quot;apiVersion&quot;: &quot;batch.tutorial.kubebuilder.io/v1&quot;,
    ...
}
</code></pre>
<p>或当我们在一次变更中去更新或提交 <code>&amp;CronJob{}</code> 时，查找正确的组版本。</p>
<h1><a class="header" href="#创建一个-api-1" id="创建一个-api-1">创建一个 API</a></h1>
<p>搭建一个新的 Kind （你刚在 <a href="cronjob-tutorial/./gvks.html#kinds-and-resources">上一章节</a> 中注意到的，是吗？) 和相应的控制器，我们可以用 <code>kubebuilder create api</code>:</p>
<pre><code class="language-bash">kubebuilder create api --group batch --version v1 --kind CronJob
</code></pre>
<p>当第一次我们为每个组-版本调用这个命令的时候，它将会为新的组-版本创建一个目录。</p>
<p>在本案例中，创建了一个对应于<code>batch.tutorial.kubebuilder.io/v1</code>（记得我们在开始时 <a href="cronjob-tutorial/cronjob-tutorial.html#scaffolding-out-our-project"><code>--domain</code></a> 的设置吗？) 的 <a href="https://sigs.k8s.io/kubebuilder/docs/book/src/cronjob-tutorial/testdata/project/api/v1"><code>api/v1/</code></a> 目录。</p>
<p>它也为我们的<code>CronJob</code> Kind 添加了一个文件，<code>api/v1/cronjob_types.go</code>。每次当我们用不同的 kind 去调用这个命令，它将添加一个相应的新文件。</p>
<p>让我们来看看我们得到了哪些东西，然后我们就可以开始去填写了。</p>
<div class="literate"><cite class="literate-source"><a href="https://sigs.k8s.io/kubebuilder/docs/book/src/cronjob-tutorial/testdata/emptyapi.go">emptyapi.go</a></cite><details class="collapse-code"><summary class="hljs"><pre class="hljs"><span class="hljs-comment">Apache License</span></pre></summary>
<p>Licensed under the Apache License, Version 2.0 (the “License”);
you may not use this file except in compliance with the License.
You may obtain a copy of the License at</p>
<pre><code>http://www.apache.org/licenses/LICENSE-2.0
</code></pre>
<p>Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an “AS IS” BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.</p>
</details>
<p>我们非常简单地开始：我们导入<code>meta/v1</code> API 组，通常本身并不会暴露该组，而是包含所有 Kubernetes 种类共有的元数据。</p>
<pre><code class="language-go">package v1

import (
	metav1 &quot;k8s.io/apimachinery/pkg/apis/meta/v1&quot;
)
</code></pre>
<p>下一步，我们为种类的 Spe c和 Status 定义类型。Kubernetes 功能通过使期待的状态(<code>Spec</code>)和实际集群状态(其他对象的
<code>Status</code>)保持一致和外部状态，然后记录观察到的状态(<code>Status</code>)。
因此，每个 <em>functional</em> 对象包括 spec 和 status 。很少的类型，像 <code>ConfigMap</code> 不需要遵从这个模式，因为它们不编码期待的状态，
但是大部分类型需要做这一步。</p>
<pre><code class="language-go">// 编辑这个文件！这是你拥有的脚手架！
// 注意: json 标签是必需的。为了能够序列化字段，任何你添加的新的字段一定有json标签。

// CronJobSpec 定义了 CronJob 期待的状态
type CronJobSpec struct {
	// 插入额外的 SPEC 字段 - 集群期待的状态
	// 重要：修改了这个文件之后运行&quot;make&quot;去重新生成代码
}

// CronJobStatus 定义了 CronJob 观察的的状态
type CronJobStatus struct {
	// 插入额外的 STATUS 字段 - 定义集群观察的状态
	// 重要：修改了这个文件之后运行&quot;make&quot;去重新生成代码
}
</code></pre>
<p>下一步，我们定义与实际种类相对应的类型，<code>CronJob</code> 和 <code>CronJobList</code> 。
<code>CronJob</code> 是一个根类型, 它描述了 <code>CronJob</code> 种类。像所有 Kubernetes 对象，它包含
<code>TypeMeta</code> (描述了API版本和种类)，也包含其中拥有像名称,名称空间和标签的东西的 <code>ObjectMeta</code> 。</p>
<p><code>CronJobList</code> 只是多个 <code>CronJob</code> 的容器。它是批量操作中使用的种类，像 LIST 。</p>
<p>通常情况下，我们从不修改任何一个 -- 所有修改都要到 Spec 或者 Status 。</p>
<p>那个小小的 <code>+kubebuilder:object:root</code> 注释被称为标记。我们将会看到更多的它们，但要知道它们充当额外的元数据，
告诉<a href="https://github.com/kubernetes-sigs/controller-tools">controller-tools</a>(我们的代码和YAML生成器)额外的信息。
这个特定的标签告诉 <code>object </code>生成器这个类型表示一个种类。然后，<code>object</code> 生成器为我们生成
这个所有表示种类的类型一定要实现的<a href="https://pkg.go.dev/k8s.io/apimachinery/pkg/runtime?tab=doc#Object">runtime.Object</a>接口的实现。</p>
<pre><code class="language-go">// +kubebuilder:object:root=true
// +kubebuilder:subresource:status
// CronJob 是 cronjobs API 的 Schema
type CronJob struct {
	metav1.TypeMeta   `json:&quot;,inline&quot;`
	metav1.ObjectMeta `json:&quot;metadata,omitempty&quot;`

	Spec   CronJobSpec   `json:&quot;spec,omitempty&quot;`
	Status CronJobStatus `json:&quot;status,omitempty&quot;`
}

// +kubebuilder:object:root=true
// CronJobList 包含了一个 CronJob 的列表
type CronJobList struct {
	metav1.TypeMeta `json:&quot;,inline&quot;`
	metav1.ListMeta `json:&quot;metadata,omitempty&quot;`
	Items           []CronJob `json:&quot;items&quot;`
}
</code></pre>
<p>最后，我们将这个 Go 类型添加到 API 组中。这允许我们将这个 API 组中的类型可以添加到任何<a href="https://pkg.go.dev/k8s.io/apimachinery/pkg/runtime?tab=doc#Scheme">Scheme</a>。</p>
<pre><code class="language-go">func init() {
	SchemeBuilder.Register(&amp;CronJob{}, &amp;CronJobList{})
}
</code></pre>
</div>
<p>现在我们已经看到了基本的结构了，让我们开始去填写它吧！</p>
<h1><a class="header" href="#设计一个-api" id="设计一个-api">设计一个 API</a></h1>
<p>在 Kubernetes 中，我们对如何设计 API 有一些原则。也就是说，所有序列化的字段<strong>必须</strong>是 <code>驼峰式</code> ，所以我们使用的 JSON 标签需要遵循该格式。我们也可以使用<code>omitempty</code> 标签来标记一个字段在空的时候应该在序列化的时候省略。</p>
<p>字段可以使用大多数的基本类型。数字是个例外：出于 API 兼容性的目的，我们只允许三种数字类型。对于整数，需要使用 <code>int32</code> 和 <code>int64</code> 类型；对于小数，使用 <code>resource.Quantity</code> 类型。</p>
<details><summary>等等，什么是 `resource.Quantity`？</summary>
<p><code>Quantity</code> 是十进制数的一种特殊符号，它有一个明确固定的表示方式，使它们在不同的机器上更具可移植性。 你可能在 Kubernetes 中指定资源请求和对 pods 的限制时已经注意到它们。</p>
<p>它们在概念上的工作原理类似于浮点数：它们有一个 significand、基数和指数。它们的序列化和人类可读格式使用整数和后缀来指定值，就像我们描述计算机存储的方式一样。</p>
<p>例如，值 <code>2m</code> 在十进制符号中表示 <code>0.002</code>。 <code>2Ki</code> 在十进制中表示 <code>2048</code> ，而 <code>2K</code> 在十进制中表示 <code>2000</code>。 如果我们要指定分数，我们就换成一个后缀，让我们使用一个整数：<code>2.5</code> 就是 <code>2500m</code>。</p>
<p>有两个支持的基数：10 和 2（分别称为十进制和二进制）。十进制基数用 “普通的” SI 后缀表示（如 <code>M</code> 和 <code>K</code> ），而二进制基数用 “mebi” 符号表示（如 <code>Mi</code> 和 <code>Ki</code> ）。 对比 <a href="https://en.wikipedia.org/wiki/Binary_prefix">megabytes vs mebibytes</a>。</p>
</details>
<p>还有一个我们使用的特殊类型：<code>metav1.Time</code>。 它有一个稳定的、可移植的序列化格式的功能，其他与 <code>time.Time</code> 相同。</p>
<p>说完了这些，让我们来看看我们的 CronJob 对象是什么样子的吧！</p>
<div class="literate"><cite class="literate-source"><a href="https://sigs.k8s.io/kubebuilder/docs/book/src/cronjob-tutorial/testdata/project/api/v1/cronjob_types.go">project/api/v1/cronjob_types.go</a></cite><details class="collapse-code"><summary class="hljs"><pre class="hljs"><span class="hljs-comment">Apache License</span></pre></summary>
<p>Copyright 2020 The Kubernetes authors.</p>
<p>Licensed under the Apache License, Version 2.0 (the “License”);
you may not use this file except in compliance with the License.
You may obtain a copy of the License at</p>
<pre><code>http://www.apache.org/licenses/LICENSE-2.0
</code></pre>
<p>Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an “AS IS” BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.</p>
</details>
<pre><code class="language-go">package v1
</code></pre>
<details class="collapse-code"><summary class="hljs"><pre class="hljs"><span class="hljs-comment">Imports</span></pre></summary>
<pre><code class="language-go">import (
	batchv1beta1 &quot;k8s.io/api/batch/v1beta1&quot;
	corev1 &quot;k8s.io/api/core/v1&quot;
	metav1 &quot;k8s.io/apimachinery/pkg/apis/meta/v1&quot;
)

// EDIT THIS FILE!  THIS IS SCAFFOLDING FOR YOU TO OWN!
// NOTE: json tags are required.  Any new fields you add must have json tags for the fields to be serialized.
</code></pre>
</details>
<p>首先，让我们来看看 spec。正如我们之前讨论过的，spec 代表所期望的状态，所以控制器的任何 “输入” 都会在这里。</p>
<p>通常来说，CronJob 由以下几部分组成：</p>
<ul>
<li>一个时间表（ CronJob 中的 cron ）</li>
<li>要运行的 Job 模板（ CronJob 中的 Job ）</li>
</ul>
<p>当然 CronJob 还需要一些额外的东西，使得它更加易用</p>
<ul>
<li>一个已经启动的 Job 的超时时间（如果该 Job 执行超时，那么我们会将在下次调度的时候重新执行该 Job）。</li>
<li>如果多个 Job 同时运行，该怎么办（我们要等待吗？还是停止旧的 Job ？）</li>
<li>暂停 CronJob 运行的方法，以防出现问题。</li>
<li>对旧 Job 历史的限制</li>
</ul>
<p>请记住，由于我们从不读取自己的状态，我们需要有一些其他的方法来跟踪一个 Job 是否已经运行。我们可以使用至少一个旧的 Job 来做这件事。</p>
<p>我们将使用几个标记（<code>// +comment</code>）来指定额外的元数据。在生成 CRD 清单时，<a href="https://github.com/kubernetes-sigs/controller-tools">controller-tools</a> 将使用这些数据。我们稍后将看到，controller-tools 也将使用 GoDoc 来生成字段的描述。</p>
<pre><code class="language-go">// CronJobSpec defines the desired state of CronJob
type CronJobSpec struct {
	// +kubebuilder:validation:MinLength=0

	// The schedule in Cron format, see https://en.wikipedia.org/wiki/Cron.
	Schedule string `json:&quot;schedule&quot;`

	// +kubebuilder:validation:Minimum=0

	// Optional deadline in seconds for starting the job if it misses scheduled
	// time for any reason.  Missed jobs executions will be counted as failed ones.
	// +optional
	StartingDeadlineSeconds *int64 `json:&quot;startingDeadlineSeconds,omitempty&quot;`

	// Specifies how to treat concurrent executions of a Job.
	// Valid values are:
	// - &quot;Allow&quot; (default): allows CronJobs to run concurrently;
	// - &quot;Forbid&quot;: forbids concurrent runs, skipping next run if previous run hasn't finished yet;
	// - &quot;Replace&quot;: cancels currently running job and replaces it with a new one
	// +optional
	ConcurrencyPolicy ConcurrencyPolicy `json:&quot;concurrencyPolicy,omitempty&quot;`

	// This flag tells the controller to suspend subsequent executions, it does
	// not apply to already started executions.  Defaults to false.
	// +optional
	Suspend *bool `json:&quot;suspend,omitempty&quot;`

	// Specifies the job that will be created when executing a CronJob.
	JobTemplate batchv1beta1.JobTemplateSpec `json:&quot;jobTemplate&quot;`

	// +kubebuilder:validation:Minimum=0

	// The number of successful finished jobs to retain.
	// This is a pointer to distinguish between explicit zero and not specified.
	// +optional
	SuccessfulJobsHistoryLimit *int32 `json:&quot;successfulJobsHistoryLimit,omitempty&quot;`

	// +kubebuilder:validation:Minimum=0

	// The number of failed finished jobs to retain.
	// This is a pointer to distinguish between explicit zero and not specified.
	// +optional
	FailedJobsHistoryLimit *int32 `json:&quot;failedJobsHistoryLimit,omitempty&quot;`
}
</code></pre>
<p>我们定义了一个自定义类型来保存我们的并发策略。实际上，它的底层类型是 string，但该类型给出了额外的文档，并允许我们在类型上附加验证，而不是在字段上验证，使验证逻辑更容易复用。</p>
<pre><code class="language-go">// ConcurrencyPolicy describes how the job will be handled.
// Only one of the following concurrent policies may be specified.
// If none of the following policies is specified, the default one
// is AllowConcurrent.
// +kubebuilder:validation:Enum=Allow;Forbid;Replace
type ConcurrencyPolicy string

const (
	// AllowConcurrent allows CronJobs to run concurrently.
	AllowConcurrent ConcurrencyPolicy = &quot;Allow&quot;

	// ForbidConcurrent forbids concurrent runs, skipping next run if previous
	// hasn't finished yet.
	ForbidConcurrent ConcurrencyPolicy = &quot;Forbid&quot;

	// ReplaceConcurrent cancels currently running job and replaces it with a new one.
	ReplaceConcurrent ConcurrencyPolicy = &quot;Replace&quot;
)
</code></pre>
<p>接下来，让我们设计一下我们的 status，它表示实际看到的状态。它包含了我们希望用户或其他控制器能够轻松获得的任何信息。</p>
<p>我们将保存一个正在运行的 Jobs，以及我们最后一次成功运行 Job 的时间。注意，我们使用 <code>metav1.Time</code> 而不是 <code>time.Time</code> 来保证序列化的兼容性以及稳定性，如上所述。</p>
<pre><code class="language-go">// CronJobStatus defines the observed state of CronJob
type CronJobStatus struct {
	// INSERT ADDITIONAL STATUS FIELD - define observed state of cluster
	// Important: Run &quot;make&quot; to regenerate code after modifying this file

	// A list of pointers to currently running jobs.
	// +optional
	Active []corev1.ObjectReference `json:&quot;active,omitempty&quot;`

	// Information when was the last time the job was successfully scheduled.
	// +optional
	LastScheduleTime *metav1.Time `json:&quot;lastScheduleTime,omitempty&quot;`
}
</code></pre>
<p>最后，CronJob 和 CronJobList 直接使用模板生成的即可。如前所述，我们不需要改变这个，除了标记我们想要一个有状态子资源，这样我们的行为就像内置的 kubernetes 类型。</p>
<pre><code class="language-go">// +kubebuilder:object:root=true
// +kubebuilder:subresource:status

// CronJob is the Schema for the cronjobs API
type CronJob struct {
</code></pre>
<details class="collapse-code"><summary class="hljs"><pre class="hljs"><span class="hljs-comment">Root Object Definitions</span></pre></summary>
<pre><code class="language-go">	metav1.TypeMeta   `json:&quot;,inline&quot;`
	metav1.ObjectMeta `json:&quot;metadata,omitempty&quot;`

	Spec   CronJobSpec   `json:&quot;spec,omitempty&quot;`
	Status CronJobStatus `json:&quot;status,omitempty&quot;`
}

// +kubebuilder:object:root=true

// CronJobList contains a list of CronJob
type CronJobList struct {
	metav1.TypeMeta `json:&quot;,inline&quot;`
	metav1.ListMeta `json:&quot;metadata,omitempty&quot;`
	Items           []CronJob `json:&quot;items&quot;`
}

func init() {
	SchemeBuilder.Register(&amp;CronJob{}, &amp;CronJobList{})
}
</code></pre>
</details></div>
<p>现在我们定义好了一个 API，我们需要编写一个控制器来实际实现这些功能。</p>
<h1><a class="header" href="#简要说明-剩下文件的作用" id="简要说明-剩下文件的作用">简要说明: 剩下文件的作用？</a></h1>
<p>如果你在 <a href="https://sigs.k8s.io/kubebuilder/docs/book/src/cronjob-tutorial/testdata/project/api/v1"><code>api/v1/</code></a> 目录下看到了其他文件，
你可能会注意到除了 <code>cronjob_types.go</code> 这个文件外，还有两个文件：<code>groupversion_info.go</code> 和 <code>zz_generated.deepcopy.go</code>。</p>
<p>虽然这些文件都不需要编辑(前者保持原样，而后者是自动生成的)，但是如果知道这些文件的内容，那么将是非常有用的。</p>
<h2><a class="header" href="#groupversion_infogo" id="groupversion_infogo"><code>groupversion_info.go</code></a></h2>
<p><code>groupversion_info.go</code> 包含了关于 group-version 的一些元数据:</p>
<div class="literate"><cite class="literate-source"><a href="https://sigs.k8s.io/kubebuilder/docs/book/src/cronjob-tutorial/testdata/project/api/v1/groupversion_info.go">project/api/v1/groupversion_info.go</a></cite><details class="collapse-code"><summary class="hljs"><pre class="hljs"><span class="hljs-comment">Apache License</span></pre></summary>
<p>Copyright 2020 The Kubernetes authors.</p>
<p>Licensed under the Apache License, Version 2.0 (the “License”);
you may not use this file except in compliance with the License.
You may obtain a copy of the License at</p>
<pre><code>http://www.apache.org/licenses/LICENSE-2.0
</code></pre>
<p>Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an “AS IS” BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.</p>
</details>
<p>首先，我们有一些<em>包</em>级别的标记的标记,表示存在这个包中的 Kubernetes 对象，并且这个包表示 <code>batch.tutorial.kubebuilder.io</code> 组。<code>object</code> 生成器使用前者，而后者是由 CRD 生成器来生成的，它会从这个包创建 CRD 的元数据。</p>
<pre><code class="language-go">// 包 v1 包含了 batch v1 API 这个组的 API Schema 定义。
// +kubebuilder:object:generate=true
// +groupName=batch.tutorial.kubebuilder.io
package v1

import (
	&quot;k8s.io/apimachinery/pkg/runtime/schema&quot;
	&quot;sigs.k8s.io/controller-runtime/pkg/scheme&quot;
)
</code></pre>
<p>然后，我们有一些常见且常用的变量来帮助我们设置我们的 Scheme 。因为我们需要在这个包的 controller 中用到所有的类型，
用一个方便的方法给其他 <code>Scheme</code> 来添加所有的类型，是非常有用的(而且也是一种惯例)。SchemeBuilder 能够帮助我们轻松的实现这个事情。</p>
<pre><code class="language-go">var (
	// GroupVersion 是用来注册这些对象的 group version。
	GroupVersion = schema.GroupVersion{Group: &quot;batch.tutorial.kubebuilder.io&quot;, Version: &quot;v1&quot;}

	// SchemeBuilder 被用来给 GroupVersionKind scheme 添加 go 类型。
	SchemeBuilder = &amp;scheme.Builder{GroupVersion: GroupVersion}

	// AddToScheme 将 group-version 中的类型添加到指定的 scheme 中。
	AddToScheme = SchemeBuilder.AddToScheme
)
</code></pre>
</div>
<h2><a class="header" href="#zz_generateddeepcopygo" id="zz_generateddeepcopygo"><code>zz_generated.deepcopy.go</code></a></h2>
<p><code>zz_generated.deepcopy.go</code> 包含了前述 <code>runtime.Object</code> 接口的自动实现，这些实现标记了代表 <code>Kinds</code> 的所有根类型。</p>
<p><code>runtime.Object</code> 接口的核心是一个深拷贝方法，即 <code>DeepCopyObject</code>。</p>
<p>controller-tools 中的 <code>object</code> 生成器也能够为每一个根类型以及其子类型生成另外两个易用的方法：<code>DeepCopy</code> 和
<code>DeepCopyInto</code>。</p>
<h1><a class="header" href="#控制器简介" id="控制器简介">控制器简介</a></h1>
<p>控制器是 Kubernetes 的核心，也是任何 operator 的核心。 </p>
<p>控制器的工作是确保对于任何给定的对象，世界的实际状态（包括集群状态，以及潜在的外部状态，如 Kubelet 的运行容器或云提供商的负载均衡器）与对象中的期望状态相匹配。每个控制器专注于一个根 Kind，但可能会与其他 Kind 交互。</p>
<p>我们把这个过程称为 <strong>reconciling</strong>。</p>
<p>在 controller-runtime 中，为特定种类实现 reconciling 的逻辑被称为 <a href="https://pkg.go.dev/sigs.k8s.io/controller-runtime/pkg/reconcile"><em>Reconciler</em></a>。 Reconciler 接受一个对象的名称，并返回我们是否需要再次尝试（例如在错误或周期性控制器的情况下，如 HorizontalPodAutoscaler）。</p>
<div class="literate"><cite class="literate-source"><a href="https://sigs.k8s.io/kubebuilder/docs/book/src/cronjob-tutorial/testdata/emptycontroller.go">emptycontroller.go</a></cite><details class="collapse-code"><summary class="hljs"><pre class="hljs"><span class="hljs-comment">Apache License</span></pre></summary>
<p>Licensed under the Apache License, Version 2.0 (the “License”);
you may not use this file except in compliance with the License.
You may obtain a copy of the License at</p>
<pre><code>http://www.apache.org/licenses/LICENSE-2.0
</code></pre>
<p>Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an “AS IS” BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.</p>
</details>
<p>首先，我们从一些标准的 import 开始。和之前一样，我们需要核心 controller-runtime 运行库，以及 client 包和我们的 API 类型包。</p>
<pre><code class="language-go">package controllers

import (
	&quot;context&quot;

	&quot;github.com/go-logr/logr&quot;
	&quot;k8s.io/apimachinery/pkg/runtime&quot;
	ctrl &quot;sigs.k8s.io/controller-runtime&quot;
	&quot;sigs.k8s.io/controller-runtime/pkg/client&quot;

	batchv1 &quot;tutorial.kubebuilder.io/project/api/v1&quot;
)
</code></pre>
<p>接下来，kubebuilder 为我们搭建了一个基本的 reconciler 结构。几乎每一个调节器都需要记录日志，并且能够获取对象，所以可以直接使用。</p>
<pre><code class="language-go">// CronJobReconciler reconciles a CronJob object
type CronJobReconciler struct {
	client.Client
	Log    logr.Logger
	Scheme *runtime.Scheme
}
</code></pre>
<p>Most controllers eventually end up running on the cluster, so they need RBAC
permissions, which we specify using controller-tools <a href="cronjob-tutorial//reference/markers/rbac.html">RBAC
markers</a>.  These are the bare minimum permissions
needed to run.  As we add more functionality, we’ll need to revisit these.</p>
<pre><code class="language-go">// +kubebuilder:rbac:groups=batch.tutorial.kubebuilder.io,resources=cronjobs,verbs=get;list;watch;create;update;patch;delete
// +kubebuilder:rbac:groups=batch.tutorial.kubebuilder.io,resources=cronjobs/status,verbs=get;update;patch
</code></pre>
<p><code>Reconcile</code> 实际上是对单个对象进行调谐。我们的 Request 只是有一个名字，但我们可以使用 client 从缓存中获取这个对象。</p>
<p>我们返回一个空的结果，没有错误，这就向 controller-runtime 表明我们已经成功地对这个对象进行了调谐，在有一些变化之前不需要再尝试调谐。</p>
<p>大多数控制器需要一个日志句柄和一个上下文，所以我们在 Reconcile 中将他们初始化。</p>
<p>上下文是用来允许取消请求的，也或者是实现 tracing 等功能。它是所有 client 方法的第一个参数。<code>Background</code> 上下文只是一个基本的上下文，没有任何额外的数据或超时时间限制。</p>
<p>控制器-runtime通过一个名为logr的库使用结构化的日志记录。正如我们稍后将看到的，日志记录的工作原理是将键值对附加到静态消息中。我们可以在我们的调和方法的顶部预先分配一些对，让这些对附加到这个调和器的所有日志行。</p>
<p>controller-runtime 通过一个名为 <a href="https://github.com/go-logr/logr">logr</a> 日志库使用结构化的记录日志。正如我们稍后将看到的，日志记录的工作原理是将键值对附加到静态消息中。我们可以在我们的 Reconcile 方法的顶部预先分配一些配对信息，将他们加入这个 Reconcile 的所有日志中。</p>
<pre><code class="language-go">func (r *CronJobReconciler) Reconcile(req ctrl.Request) (ctrl.Result, error) {
	_ = context.Background()
	_ = r.Log.WithValues(&quot;cronjob&quot;, req.NamespacedName)

	// your logic here

	return ctrl.Result{}, nil
}
</code></pre>
<p>最后，我们将 Reconcile 添加到 manager 中，这样当 manager 启动时它就会被启动。</p>
<p>现在，我们只是注意到这个 Reconcile 是在 <code>CronJob</code>s 上运行的。以后，我们也会用这个来标记其他的对象。</p>
<pre><code class="language-go">func (r *CronJobReconciler) SetupWithManager(mgr ctrl.Manager) error {
	return ctrl.NewControllerManagedBy(mgr).
		For(&amp;batchv1.CronJob{}).
		Complete(r)
}
</code></pre>
</div>
<p>现在我们已经了解了 Reconcile 的基本结构，我们来补充一下 <code>CronJob</code>s 的逻辑。</p>
<h1><a class="header" href="#实现一个控制器" id="实现一个控制器">实现一个控制器</a></h1>
<p>CronJob 控制器的基本逻辑如下:</p>
<ol>
<li>
<p>根据名称加载定时任务</p>
</li>
<li>
<p>列出所有有效的 job，更新其状态</p>
</li>
<li>
<p>根据保留的历史版本数清理版本过旧的 job</p>
</li>
<li>
<p>检查当前 CronJob 是否被挂起(如果被挂起，则不执行任何操作)</p>
</li>
<li>
<p>计算 job 下一个定时执行时间</p>
</li>
<li>
<p>如果 job 符合执行时机，没有超出截止时间，且不被并发策略阻塞，执行该 job</p>
</li>
<li>
<p>当任务进入运行状态或到了下一次执行时间， job 重新排队</p>
</li>
</ol>
<div class="literate"><cite class="literate-source"><a href="https://sigs.k8s.io/kubebuilder/docs/book/src/cronjob-tutorial/testdata/project/controllers/cronjob_controller.go">project/controllers/cronjob_controller.go</a></cite><details class="collapse-code"><summary class="hljs"><pre class="hljs"><span class="hljs-comment">Apache License</span></pre></summary>
<p>Copyright 2020 The Kubernetes authors.</p>
<p>Licensed under the Apache License, Version 2.0 (the “License”);
you may not use this file except in compliance with the License.
You may obtain a copy of the License at</p>
<pre><code>http://www.apache.org/licenses/LICENSE-2.0
</code></pre>
<p>Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an “AS IS” BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.</p>
</details>
<p>开始编码之前，先引进基本的依赖。除此之外还需要一些额外的依赖库，在使用到它们时，我们再详细介绍。</p>
<pre><code class="language-go">package controllers

import (
	&quot;context&quot;
	&quot;fmt&quot;
	&quot;sort&quot;
	&quot;time&quot;

	&quot;github.com/go-logr/logr&quot;
	&quot;github.com/robfig/cron&quot;
	kbatch &quot;k8s.io/api/batch/v1&quot;
	corev1 &quot;k8s.io/api/core/v1&quot;
	metav1 &quot;k8s.io/apimachinery/pkg/apis/meta/v1&quot;
	&quot;k8s.io/apimachinery/pkg/runtime&quot;
	ref &quot;k8s.io/client-go/tools/reference&quot;
	ctrl &quot;sigs.k8s.io/controller-runtime&quot;
	&quot;sigs.k8s.io/controller-runtime/pkg/client&quot;

	batch &quot;tutorial.kubebuilder.io/project/api/v1&quot;
)
</code></pre>
<p>接下来，我们需要一个时钟好让我们在测试中模拟计时。</p>
<pre><code class="language-go">// CronJob 调谐器对 CronJob 对象进行调谐
type CronJobReconciler struct {
	client.Client
	Log    logr.Logger
	Scheme *runtime.Scheme
	Clock
}
</code></pre>
<details class="collapse-code"><summary class="hljs"><pre class="hljs"><span class="hljs-comment">Clock</span></pre></summary>
<p>我们虚拟了一个时钟以便在测试中方便地来回调节时间，
调用<code>time.Now</code>获取真实时间</p>
<pre><code class="language-go">type realClock struct{}

func (_ realClock) Now() time.Time { return time.Now() }

// clock接口可以获取当前的时间
// 可以帮助我们在测试中模拟计时
type Clock interface {
	Now() time.Time
}
</code></pre>
</details>
<p>注意，我们需要获得RBAC权限——我们需要一些额外权限去
创建和管理job，添加如下一些<a href="cronjob-tutorial//reference/markers/rbac.html">字段</a></p>
<pre><code class="language-go">// +kubebuilder:rbac:groups=batch.tutorial.kubebuilder.io,resources=cronjobs,verbs=get;list;watch;create;update;patch;delete
// +kubebuilder:rbac:groups=batch.tutorial.kubebuilder.io,resources=cronjobs/status,verbs=get;update;patch
// +kubebuilder:rbac:groups=batch,resources=jobs,verbs=get;list;watch;create;update;patch;delete
// +kubebuilder:rbac:groups=batch,resources=jobs/status,verbs=get
</code></pre>
<p>控制器的核心部分——调谐逻辑</p>
<pre><code class="language-go">var (
	scheduledTimeAnnotation = &quot;batch.tutorial.kubebuilder.io/scheduled-at&quot;
)

func (r *CronJobReconciler) Reconcile(req ctrl.Request) (ctrl.Result, error) {
	ctx := context.Background()
	log := r.Log.WithValues(&quot;cronjob&quot;, req.NamespacedName)
</code></pre>
<h3><a class="header" href="#1-根据名称加载定时任务" id="1-根据名称加载定时任务">1: 根据名称加载定时任务</a></h3>
<p>通过 client 获取定时任务。所有 client 方法第一个参数都是 context（用于取消定时任务）作为
第一个参数，把请求对象信息作为最后一个参数。Get 方法例外，它把
<a href="https://pkg.go.dev/sigs.k8s.io/controller-runtime/pkg/client?tab=doc#ObjectKey"><code>NamespacedName</code></a>
作为中间的第二个参数（大多数方法都没有中间的NamespacedName参数，下文会提到）</p>
<p>许多client方法的最后一个参数接受变长参数。</p>
<pre><code class="language-go">	var cronJob batch.CronJob
	if err := r.Get(ctx, req.NamespacedName, &amp;cronJob); err != nil {
		log.Error(err, &quot;unable to fetch CronJob&quot;)
		//忽略掉 not-found 错误，它们不能通过重新排队修复（要等待新的通知）
		//在删除一个不存在的对象时，可能会报这个错误。
		return ctrl.Result{}, client.IgnoreNotFound(err)
	}
</code></pre>
<h3><a class="header" href="#2-列出所有有效-job更新它们的状态" id="2-列出所有有效-job更新它们的状态">2: 列出所有有效 job，更新它们的状态</a></h3>
<p>为确保每个 job 的状态都会被更新到，我们需要列出某个 CronJob 在当前命名空间下的所有 job。
和 Get 方法类似，我们可以使用 List 方法来列出 CronJob 下所有的 job。注意，我们使用变长参数
来映射命名空间和任意多个匹配变量（实际上相当于是建立了一个索引）。</p>
<pre><code class="language-go">	var childJobs kbatch.JobList
	if err := r.List(ctx, &amp;childJobs, client.InNamespace(req.Namespace), client.MatchingFields{jobOwnerKey: req.Name}); err != nil {
		log.Error(err, &quot;unable to list child Jobs&quot;)
		return ctrl.Result{}, err
	}
</code></pre>
<aside class="note">
<h1><a class="header" href="#索引的作用" id="索引的作用">索引的作用？</a></h1>
<p>调谐器会获取 cronjob 下的所有 job 以更新它们状态。随着 cronjob 数量的增加，遍历全部 conjob
查找会变的相当低效。为了提高查询效率，这些任务会根据控制器名称建立索引。缓存后的 job 对象会
被添加上一个 jobOwnerKey 字段。这个字段引用其归属控制器和函数作为索引。在下文中，我们将配置
manager 作为这个字段的索引</p>
</aside>
<p>查找到所有的 job 后，将其归类为 active，successful，failed 三种类型，同时持续跟踪其
最新的执行情况以更新其状态。牢记，status 值应该是从实际的运行状态中实时获取。从 cronjob
中读取 job 的状态通常不是一个好做法。应该从每次执行状态中获取。我们后续也采用这种方法。</p>
<p>我们可以检查一个 job 是否已处于 “finished” 状态，使用 status 条件还可以知道它是 succeeded
或 failed 状态。</p>
<pre><code class="language-go">	// 找出所有有效的 job
	var activeJobs []*kbatch.Job
	var successfulJobs []*kbatch.Job
	var failedJobs []*kbatch.Job
	var mostRecentTime *time.Time // 记录其最近一次运行时间以便更新状态
</code></pre>
<details class="collapse-code"><summary class="hljs"><pre class="hljs"><span class="hljs-comment">isJobFinished</span></pre></summary>
<p>当一个 job 被标记为 “succeeded” 或 “failed” 时，我们认为这个任务处于 “finished” 状态。
Status conditions 允许我们给 job 对象添加额外的状态信息，开发人员或控制器可以通过
这些校验信息来检查 job 的完成或健康状态。</p>
<pre><code class="language-go">	isJobFinished := func(job *kbatch.Job) (bool, kbatch.JobConditionType) {
		for _, c := range job.Status.Conditions {
			if (c.Type == kbatch.JobComplete || c.Type == kbatch.JobFailed) &amp;&amp; c.Status == corev1.ConditionTrue {
				return true, c.Type
			}
		}

		return false, &quot;&quot;
	}
</code></pre>
</details><details class="collapse-code"><summary class="hljs"><pre class="hljs"><span class="hljs-comment">getScheduledTimeForJob</span></pre></summary>
<p>使用辅助函数来提取创建 job 时注释中排定的执行时间</p>
<pre><code class="language-go">	getScheduledTimeForJob := func(job *kbatch.Job) (*time.Time, error) {
		timeRaw := job.Annotations[scheduledTimeAnnotation]
		if len(timeRaw) == 0 {
			return nil, nil
		}

		timeParsed, err := time.Parse(time.RFC3339, timeRaw)
		if err != nil {
			return nil, err
		}
		return &amp;timeParsed, nil
	}
</code></pre>
</details>
<pre><code class="language-go">	for i, job := range childJobs.Items {
		_, finishedType := isJobFinished(&amp;job)
		switch finishedType {
		case &quot;&quot;: // ongoing
			activeJobs = append(activeJobs, &amp;childJobs.Items[i])
		case kbatch.JobFailed:
			failedJobs = append(failedJobs, &amp;childJobs.Items[i])
		case kbatch.JobComplete:
			successfulJobs = append(successfulJobs, &amp;childJobs.Items[i])
		}

		//将启动时间存放在注释中，当job生效时可以从中读取
		scheduledTimeForJob, err := getScheduledTimeForJob(&amp;job)
		if err != nil {
			log.Error(err, &quot;unable to parse schedule time for child job&quot;, &quot;job&quot;, &amp;job)
			continue
		}
		if scheduledTimeForJob != nil {
			if mostRecentTime == nil {
				mostRecentTime = scheduledTimeForJob
			} else if mostRecentTime.Before(*scheduledTimeForJob) {
				mostRecentTime = scheduledTimeForJob
			}
		}
	}

	if mostRecentTime != nil {
		cronJob.Status.LastScheduleTime = &amp;metav1.Time{Time: *mostRecentTime}
	} else {
		cronJob.Status.LastScheduleTime = nil
	}
	cronJob.Status.Active = nil
	for _, activeJob := range activeJobs {
		jobRef, err := ref.GetReference(r.Scheme, activeJob)
		if err != nil {
			log.Error(err, &quot;unable to make reference to active job&quot;, &quot;job&quot;, activeJob)
			continue
		}
		cronJob.Status.Active = append(cronJob.Status.Active, *jobRef)
	}
</code></pre>
<p>此处会记录我们观察到的 job 数量。为便于调试，略微提高日志级别。注意，这里没有使用
格式化字符串，使用由键值对构成的固定格式信息来输出日志。这样更易于过滤和查询日志</p>
<pre><code class="language-go">	log.V(1).Info(&quot;job count&quot;, &quot;active jobs&quot;, len(activeJobs), &quot;successful jobs&quot;, len(successfulJobs), &quot;failed jobs&quot;, len(failedJobs))
</code></pre>
<p>使用收集到日期信息来更新 CRD 状态。和之前类似，通过 client 来完成操作。
针对 status 这一子资源，我们可以使用<code>Status</code>部分的<code>Update</code>方法。</p>
<p>status 子资源会忽略掉对 spec 的变更。这与其它更新操作的发生冲突的风险更小，
而且实现了权限分离。</p>
<pre><code class="language-go">	if err := r.Status().Update(ctx, &amp;cronJob); err != nil {
		log.Error(err, &quot;unable to update CronJob status&quot;)
		return ctrl.Result{}, err
	}
</code></pre>
<p>更新状态后，后续要确保状态符合我们在 spec 定下的预期。</p>
<h3><a class="header" href="#3-根据保留的历史版本数清理过旧的-job" id="3-根据保留的历史版本数清理过旧的-job">3: 根据保留的历史版本数清理过旧的 job</a></h3>
<p>我们先清理掉一些版本太旧的 job，这样可以不用保留太多无用的 job</p>
<pre><code class="language-go">	// 注意: 删除操作采用的“尽力而为”策略
	// 如果个别job删除失败了，不会将其重新排队，直接结束删除操作
	if cronJob.Spec.FailedJobsHistoryLimit != nil {
		sort.Slice(failedJobs, func(i, j int) bool {
			if failedJobs[i].Status.StartTime == nil {
				return failedJobs[j].Status.StartTime != nil
			}
			return failedJobs[i].Status.StartTime.Before(failedJobs[j].Status.StartTime)
		})
		for i, job := range failedJobs {
			if int32(i) &gt;= int32(len(failedJobs))-*cronJob.Spec.FailedJobsHistoryLimit {
				break
			}
			if err := r.Delete(ctx, job, client.PropagationPolicy(metav1.DeletePropagationBackground)); client.IgnoreNotFound(err) != nil {
				log.Error(err, &quot;unable to delete old failed job&quot;, &quot;job&quot;, job)
			} else {
				log.V(0).Info(&quot;deleted old failed job&quot;, &quot;job&quot;, job)
			}
		}
	}

	if cronJob.Spec.SuccessfulJobsHistoryLimit != nil {
		sort.Slice(successfulJobs, func(i, j int) bool {
			if successfulJobs[i].Status.StartTime == nil {
				return successfulJobs[j].Status.StartTime != nil
			}
			return successfulJobs[i].Status.StartTime.Before(successfulJobs[j].Status.StartTime)
		})
		for i, job := range successfulJobs {
			if int32(i) &gt;= int32(len(successfulJobs))-*cronJob.Spec.SuccessfulJobsHistoryLimit {
				break
			}
			if err := r.Delete(ctx, job, client.PropagationPolicy(metav1.DeletePropagationBackground)); (err) != nil {
				log.Error(err, &quot;unable to delete old successful job&quot;, &quot;job&quot;, job)
			} else {
				log.V(0).Info(&quot;deleted old successful job&quot;, &quot;job&quot;, job)
			}
		}
	}
</code></pre>
<h3><a class="header" href="#4-检查是否被挂起" id="4-检查是否被挂起">4: 检查是否被挂起</a></h3>
<p>如果当前 cronjob 被挂起，不会再运行其下的任何 job，我们将其停止。这对于某些 job 出现异常
的排查非常有用。我们无需删除 cronjob 来中止其后续其他 job 的运行。</p>
<pre><code class="language-go">	if cronJob.Spec.Suspend != nil &amp;&amp; *cronJob.Spec.Suspend {
		log.V(1).Info(&quot;cronjob suspended, skipping&quot;)
		return ctrl.Result{}, nil
	}
</code></pre>
<h3><a class="header" href="#5-计算-job-下一次执行时间" id="5-计算-job-下一次执行时间">5: 计算 job 下一次执行时间</a></h3>
<p>如果 cronjob 没被挂起，则我们需要计算它的下一次执行时间，
同时检查是否有遗漏的执行没被处理</p>
<details class="collapse-code"><summary class="hljs"><pre class="hljs"><span class="hljs-comment">getNextSchedule</span></pre></summary>
<p>借助强大的 cron 库，我们可以轻易的计算出定时任务的下一次执行时间。
我们根据最近一次的执行时间来计算下一次执行时间，如果没有找到最近
一次执行时间，则根据定时任务的创建时间来计算。</p>
<p>如果遗漏了很多次执行并且没有为这些执行设置截止时间。我们将其忽略
以避免异常造成控制器的频繁重启和资源紧张。</p>
<p>如果遗漏的执行次数并不多，我们返回最近一次的执行时间和下一次将要
执行的时间，这样我们可以知道该何时去调谐。</p>
<pre><code class="language-go">	getNextSchedule := func(cronJob *batch.CronJob, now time.Time) (lastMissed time.Time, next time.Time, err error) {
		sched, err := cron.ParseStandard(cronJob.Spec.Schedule)
		if err != nil {
			return time.Time{}, time.Time{}, fmt.Errorf(&quot;Unparseable schedule %q: %v&quot;, cronJob.Spec.Schedule, err)
		}

		// 出于优化的目的，我们可以使用点技巧。从上一次观察到的执行时间开始执行，
		// 这个执行时间可以被在这里被读取。但是意义不大，因为我们刚更新了这个值。

		var earliestTime time.Time
		if cronJob.Status.LastScheduleTime != nil {
			earliestTime = cronJob.Status.LastScheduleTime.Time
		} else {
			earliestTime = cronJob.ObjectMeta.CreationTimestamp.Time
		}
		if cronJob.Spec.StartingDeadlineSeconds != nil {
			// 如果开始执行时间超过了截止时间，不再执行
			schedulingDeadline := now.Add(-time.Second * time.Duration(*cronJob.Spec.StartingDeadlineSeconds))

			if schedulingDeadline.After(earliestTime) {
				earliestTime = schedulingDeadline
			}
		}
		if earliestTime.After(now) {
			return time.Time{}, sched.Next(now), nil
		}

		starts := 0
		for t := sched.Next(earliestTime); !t.After(now); t = sched.Next(t) {
			lastMissed = t
			// 一个 CronJob 可能会遗漏多次执行。举个例子，周五5:00pm技术人员下班后，
			// 控制器在5:01pm发生了异常。然后直到周二早上才有技术人员发现问题并
			// 重启控制器。那么所有的以1小时为周期执行的定时任务，在没有技术人员
			// 进一步的干预下，都会有80多个 job 在恢复正常后一并启动（如果 job 允许
			// 多并发和延迟启动）

			// 如果 CronJob 的某些地方出现异常，控制器或 apiservers (用于设置任务创建时间)
			// 的时钟不正确, 那么就有可能出现错过很多次执行时间的情形（跨度可达数十年）
			// 这将会占满控制器的CPU和内存资源。这种情况下，我们不需要列出错过的全部
			// 执行时间。

			starts++
			if starts &gt; 100 {
				// 获取不到最近一次执行时间，直接返回空切片
				return time.Time{}, time.Time{}, fmt.Errorf(&quot;Too many missed start times (&gt; 100). Set or decrease .spec.startingDeadlineSeconds or check clock skew.&quot;)
			}
		}
		return lastMissed, sched.Next(now), nil
	}
</code></pre>
</details>
<pre><code class="language-go">	// 计算出定时任务下一次执行时间（或是遗漏的执行时间）
	missedRun, nextRun, err := getNextSchedule(&amp;cronJob, r.Now())
	if err != nil {
		log.Error(err, &quot;unable to figure out CronJob schedule&quot;)
		// 重新排队直到有更新修复这次定时任务调度，不必返回错误
		return ctrl.Result{}, nil
	}
</code></pre>
<p>上述步骤执行完后，将准备好的请求加入队列直到下次执行，
然后确定这些 job 是否要实际执行</p>
<pre><code class="language-go">	scheduledResult := ctrl.Result{RequeueAfter: nextRun.Sub(r.Now())} // 保存以便别处复用
	log = log.WithValues(&quot;now&quot;, r.Now(), &quot;next run&quot;, nextRun)
</code></pre>
<h3><a class="header" href="#6-如果-job-符合执行时机并且没有超出截止时间且不被并发策略阻塞执行该-job" id="6-如果-job-符合执行时机并且没有超出截止时间且不被并发策略阻塞执行该-job">6: 如果 job 符合执行时机，并且没有超出截止时间，且不被并发策略阻塞，执行该 job</a></h3>
<p>如果 job 遗漏了一次执行，且还没超出截止时间，把遗漏的这次执行也不上</p>
<pre><code class="language-go">	if missedRun.IsZero() {
		log.V(1).Info(&quot;no upcoming scheduled times, sleeping until next&quot;)
		return scheduledResult, nil
	}

	// 确保错过的执行没有超过截止时间
	log = log.WithValues(&quot;current run&quot;, missedRun)
	tooLate := false
	if cronJob.Spec.StartingDeadlineSeconds != nil {
		tooLate = missedRun.Add(time.Duration(*cronJob.Spec.StartingDeadlineSeconds) * time.Second).Before(r.Now())
	}
	if tooLate {
		log.V(1).Info(&quot;missed starting deadline for last run, sleeping till next&quot;)
		// TODO(directxman12): events
		return scheduledResult, nil
	}
</code></pre>
<p>如果确认 job 需要实际执行。我们有三种策略执行该 job。要么先等待现有的 job 执行完后，在启动本次 job；
或是直接覆盖取代现有的job；或是不考虑现有的 job，直接作为新的 job 执行。因为缓存导致的信息有所延迟，
当更新信息后需要重新排队。</p>
<pre><code class="language-go">	// 确定要 job 的执行策略 —— 并发策略可能禁止多个job同时运行
	if cronJob.Spec.ConcurrencyPolicy == batch.ForbidConcurrent &amp;&amp; len(activeJobs) &gt; 0 {
		log.V(1).Info(&quot;concurrency policy blocks concurrent runs, skipping&quot;, &quot;num active&quot;, len(activeJobs))
		return scheduledResult, nil
	}

	// 直接覆盖现有 job
	if cronJob.Spec.ConcurrencyPolicy == batch.ReplaceConcurrent {
		for _, activeJob := range activeJobs {
			// we don't care if the job was already deleted
			if err := r.Delete(ctx, activeJob, client.PropagationPolicy(metav1.DeletePropagationBackground)); client.IgnoreNotFound(err) != nil {
				log.Error(err, &quot;unable to delete active job&quot;, &quot;job&quot;, activeJob)
				return ctrl.Result{}, err
			}
		}
	}
</code></pre>
<p>确定如何处理现有 job 后，创建符合我们预期的 job</p>
<details class="collapse-code"><summary class="hljs"><pre class="hljs"><span class="hljs-comment">constructJobForCronJob</span></pre></summary>
<p>基于 CronJob 模版构建 job，从模板复制 spec 及对象的元信息。</p>
<p>然后在注解中设置执行时间，这样我们可以在每次的调谐中获取起作为“上一次执行时间”</p>
<p>最后，还需要设置 owner reference字段。当我们删除 CronJob 时，Kubernetes 垃圾收集
器会根据这个字段对应的 job。同时，当某个job状态发生变更（创建，删除，完成）时，
controller-runtime 可以根据这个字段识别出要对那个 CronJob 进行调谐。</p>
<pre><code class="language-go">	constructJobForCronJob := func(cronJob *batch.CronJob, scheduledTime time.Time) (*kbatch.Job, error) {
		// job 名称带上执行时间以确保唯一性，避免排定执行时间的 job 创建两次
		name := fmt.Sprintf(&quot;%s-%d&quot;, cronJob.Name, scheduledTime.Unix())

		job := &amp;kbatch.Job{
			ObjectMeta: metav1.ObjectMeta{
				Labels:      make(map[string]string),
				Annotations: make(map[string]string),
				Name:        name,
				Namespace:   cronJob.Namespace,
			},
			Spec: *cronJob.Spec.JobTemplate.Spec.DeepCopy(),
		}
		for k, v := range cronJob.Spec.JobTemplate.Annotations {
			job.Annotations[k] = v
		}
		job.Annotations[scheduledTimeAnnotation] = scheduledTime.Format(time.RFC3339)
		for k, v := range cronJob.Spec.JobTemplate.Labels {
			job.Labels[k] = v
		}
		if err := ctrl.SetControllerReference(cronJob, job, r.Scheme); err != nil {
			return nil, err
		}

		return job, nil
	}
</code></pre>
</details>
<pre><code class="language-go">	// 构建 job
	job, err := constructJobForCronJob(&amp;cronJob, missedRun)
	if err != nil {
		log.Error(err, &quot;unable to construct job from template&quot;)
		// job 的 spec 没有变更，无需重新排队
		return scheduledResult, nil
	}

	// ...在集群中创建 job
	if err := r.Create(ctx, job); err != nil {
		log.Error(err, &quot;unable to create Job for CronJob&quot;, &quot;job&quot;, job)
		return ctrl.Result{}, err
	}

	log.V(1).Info(&quot;created Job for CronJob run&quot;, &quot;job&quot;, job)
</code></pre>
<h3><a class="header" href="#7-当-job-开始运行或到了-job-下一次的执行时间重新排队" id="7-当-job-开始运行或到了-job-下一次的执行时间重新排队">7: 当 job 开始运行或到了 job 下一次的执行时间，重新排队</a></h3>
<p>最终我们返回上述预备的结果。我们还需重新排队当任务还有下一次执行时。
这被视作最长截止时间——如果期间发生了变更，例如 job 被提前启动或是提前
结束，或被修改，我们可能会更早进行调谐。</p>
<pre><code class="language-go">	// 当有 job 进入运行状态后，重新排队，同时更新状态
	return scheduledResult, nil
}
</code></pre>
<h3><a class="header" href="#启动-cronjob-控制器" id="启动-cronjob-控制器">启动 CronJob 控制器</a></h3>
<p>最后，我们还要完善下我们的启动过程。为了让调谐器可以通过 job 的 owner 值快速找到 job。
我们需要一个索引。声明一个索引键，后续我们可以将其用于 client 的虚拟变量名中，从 job
对象中提取索引值。此处的索引会帮我们处理好 namespaces 的映射关系。所以如果 job 有 owner
值，我们快速地获取 owner 值。</p>
<p>另外，我们需要告知 manager，这个控制器拥有哪些 job。当对应的 job 发生变更或被删除时，
自动调用调谐器对 CronJob 进行调谐。</p>
<pre><code class="language-go">var (
	jobOwnerKey = &quot;.metadata.controller&quot;
	apiGVStr    = batch.GroupVersion.String()
)

func (r *CronJobReconciler) SetupWithManager(mgr ctrl.Manager) error {
	// 此处不是测试，我们需要创建一个真实的时钟
	if r.Clock == nil {
		r.Clock = realClock{}
	}

	if err := mgr.GetFieldIndexer().IndexField(context.Background(), &amp;kbatch.Job{}, jobOwnerKey, func(rawObj runtime.Object) []string {
		//获取 job 对象，提取 owner...
		job := rawObj.(*kbatch.Job)
		owner := metav1.GetControllerOf(job)
		if owner == nil {
			return nil
		}
		// ...确保 owner 是个 CronJob...
		if owner.APIVersion != apiGVStr || owner.Kind != &quot;CronJob&quot; {
			return nil
		}

		// ...是 CronJob，返回
		return []string{owner.Name}
	}); err != nil {
		return err
	}

	return ctrl.NewControllerManagedBy(mgr).
		For(&amp;batch.CronJob{}).
		Owns(&amp;kbatch.Job{}).
		Complete(r)
}
</code></pre>
</div>
<p>看起来并不复杂，不过我们总算有了个能运行的控制器了。我们先在集群里测试下，如果一切顺利，将它部署起来！</p>
<h1><a class="header" href="#你还记得关于-main-函数的一些要点吗" id="你还记得关于-main-函数的一些要点吗">你还记得关于 main 函数的一些要点吗？</a></h1>
<p>但首先，还记得我们之前说过的 <a href="cronjob-tutorial//cronjob-tutorial/empty-main.html">再次回顾 <code>main.go</code></a> 吗？让我们看一下哪些地方改变了，哪些是需要添加的。</p>
<div class="literate"><cite class="literate-source"><a href="https://sigs.k8s.io/kubebuilder/docs/book/src/cronjob-tutorial/testdata/project/main.go">project/main.go</a></cite><details class="collapse-code"><summary class="hljs"><pre class="hljs"><span class="hljs-comment">Apache License</span></pre></summary>
<p>Copyright 2020 The Kubernetes authors.</p>
<p>Licensed under the Apache License, Version 2.0 (the “License”);
you may not use this file except in compliance with the License.
You may obtain a copy of the License at</p>
<pre><code>http://www.apache.org/licenses/LICENSE-2.0
</code></pre>
<p>Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an “AS IS” BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.</p>
</details><details class="collapse-code"><summary class="hljs"><pre class="hljs"><span class="hljs-comment">Imports</span></pre></summary>
<pre><code class="language-go">package main

import (
	&quot;flag&quot;
	&quot;os&quot;

	&quot;k8s.io/apimachinery/pkg/runtime&quot;
	utilruntime &quot;k8s.io/apimachinery/pkg/util/runtime&quot;
	clientgoscheme &quot;k8s.io/client-go/kubernetes/scheme&quot;
	_ &quot;k8s.io/client-go/plugin/pkg/client/auth/gcp&quot;
	ctrl &quot;sigs.k8s.io/controller-runtime&quot;
	&quot;sigs.k8s.io/controller-runtime/pkg/log/zap&quot;

	batchv1 &quot;tutorial.kubebuilder.io/project/api/v1&quot;
	&quot;tutorial.kubebuilder.io/project/controllers&quot;
	// +kubebuilder:scaffold:imports
)
</code></pre>
</details>
<p>要注意的第一个区别是 kubebuilder 已经添加了一组新的 API 包（<code>batchv1</code>）到 scheme。这意味着可以在我们的控制器中使用这些对象。</p>
<p>如果我们要使用任何其他的 CRD，我们必须用相同的方法添加它们的 scheme。内置的类型例如 Job 就添加了它自己的 scheme <code>clientgoscheme</code>。</p>
<pre><code class="language-go">var (
	scheme   = runtime.NewScheme()
	setupLog = ctrl.Log.WithName(&quot;setup&quot;)
)

func init() {
	utilruntime.Must(clientgoscheme.AddToScheme(scheme))

	utilruntime.Must(batchv1.AddToScheme(scheme))
	// +kubebuilder:scaffold:scheme
}
</code></pre>
<p>另一个变化是 kubebuilder 已经添加了一个阻塞调用我们的 CornJob 控制器的 <code>SetupWithManager</code> 方法。</p>
<pre><code class="language-go">func main() {
</code></pre>
<details class="collapse-code"><summary class="hljs"><pre class="hljs"><span class="hljs-comment">old stuff</span></pre></summary>
<pre><code class="language-go">	var metricsAddr string
	var enableLeaderElection bool
	flag.StringVar(&amp;metricsAddr, &quot;metrics-addr&quot;, &quot;:8080&quot;, &quot;The address the metric endpoint binds to.&quot;)
	flag.BoolVar(&amp;enableLeaderElection, &quot;enable-leader-election&quot;, false,
		&quot;Enable leader election for controller manager. &quot;+
			&quot;Enabling this will ensure there is only one active controller manager.&quot;)
	flag.Parse()

	ctrl.SetLogger(zap.New(zap.UseDevMode(true)))

	mgr, err := ctrl.NewManager(ctrl.GetConfigOrDie(), ctrl.Options{
		Scheme:             scheme,
		MetricsBindAddress: metricsAddr,
		Port:               9443,
		LeaderElection:     enableLeaderElection,
		LeaderElectionID:   &quot;80807133.tutorial.kubebuilder.io&quot;,
	})
	if err != nil {
		setupLog.Error(err, &quot;unable to start manager&quot;)
		os.Exit(1)
	}
</code></pre>
</details>
<pre><code class="language-go">	if err = (&amp;controllers.CronJobReconciler{
		Client: mgr.GetClient(),
		Log:    ctrl.Log.WithName(&quot;controllers&quot;).WithName(&quot;CronJob&quot;),
		Scheme: mgr.GetScheme(),
	}).SetupWithManager(mgr); err != nil {
		setupLog.Error(err, &quot;unable to create controller&quot;, &quot;controller&quot;, &quot;CronJob&quot;)
		os.Exit(1)
	}
	if err = (&amp;batchv1.CronJob{}).SetupWebhookWithManager(mgr); err != nil {
		setupLog.Error(err, &quot;unable to create webhook&quot;, &quot;webhook&quot;, &quot;CronJob&quot;)
		os.Exit(1)
	}
</code></pre>
<pre><code>我们也会为我们的类型设置 webhook，接下来我们会谈到它。我们只需要将他们添加到 manager。因为我们想分开运行 webhook，而不是在本地测试我们的控制器时运行它们，我们会将它们配置到环境变量中。
</code></pre>
<p>当我们本地运行的时候只需确保 <code>ENABLE_WEBHOOKS=false</code>。</p>
<pre><code class="language-go">	if os.Getenv(&quot;ENABLE_WEBHOOKS&quot;) != &quot;false&quot; {
		if err = (&amp;batchv1.CronJob{}).SetupWebhookWithManager(mgr); err != nil {
			setupLog.Error(err, &quot;unable to create webhook&quot;, &quot;webhook&quot;, &quot;Captain&quot;)
			os.Exit(1)
		}
	}
	// +kubebuilder:scaffold:builder
</code></pre>
<details class="collapse-code"><summary class="hljs"><pre class="hljs"><span class="hljs-comment">old stuff</span></pre></summary>
<pre><code class="language-go">	setupLog.Info(&quot;starting manager&quot;)
	if err := mgr.Start(ctrl.SetupSignalHandler()); err != nil {
		setupLog.Error(err, &quot;problem running manager&quot;)
		os.Exit(1)
	}
</code></pre>
</details>
<pre><code class="language-go">}
</code></pre>
</div>
<p><em>现在</em> 我们可以实现我们的控制器了。</p>
<h1><a class="header" href="#实现默认验证-webhook" id="实现默认验证-webhook">实现默认/验证 webhook</a></h1>
<p>如果你想为你的 CRD 实现一个 <a href="cronjob-tutorial/../reference/admission-webhook.html">admission webhooks</a>，
你需要做的一件事就是去实现<code>Defaulter</code> 和/或 <code>Validator</code> 接口。</p>
<p>Kubebuilder 会帮你处理剩下的事情，像下面这些：</p>
<ol>
<li>创建 webhook 服务端。</li>
<li>确保服务端已添加到 manager 中。</li>
<li>为你的 webhooks 创建处理函数。</li>
<li>用路径在你的服务端中注册每个处理函数。</li>
</ol>
<p>首先，让我们为我们的 CRD (CronJob) 创建一个 webhooks 的支架。我们将需要运行下面的命令并带上 <code>--defaulting</code> 和 <code>--programmatic-validation</code> 标志（因为我们的测试项目会用到默认和验证 webhooks)：</p>
<pre><code class="language-bash">kubebuilder create webhook --group batch --version v1 --kind CronJob --defaulting --programmatic-validation
</code></pre>
<p>这里会在你的 <code>main.go</code> 中搭建一个 webhook 函数的支架并用 manager 注册你的 webhook。</p>
<div class="literate"><cite class="literate-source"><a href="https://sigs.k8s.io/kubebuilder/docs/book/src/cronjob-tutorial/testdata/project/api/v1/cronjob_webhook.go">project/api/v1/cronjob_webhook.go</a></cite><details class="collapse-code"><summary class="hljs"><pre class="hljs"><span class="hljs-comment">Apache License</span></pre></summary>
<p>Copyright 2020 The Kubernetes authors.</p>
<p>Licensed under the Apache License, Version 2.0 (the “License”);
you may not use this file except in compliance with the License.
You may obtain a copy of the License at</p>
<pre><code>http://www.apache.org/licenses/LICENSE-2.0
</code></pre>
<p>Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an “AS IS” BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.</p>
</details><details class="collapse-code"><summary class="hljs"><pre class="hljs"><span class="hljs-comment">Go imports</span></pre></summary>
<pre><code class="language-go">package v1

import (
	&quot;github.com/robfig/cron&quot;
	apierrors &quot;k8s.io/apimachinery/pkg/api/errors&quot;
	&quot;k8s.io/apimachinery/pkg/runtime&quot;
	&quot;k8s.io/apimachinery/pkg/runtime/schema&quot;
	validationutils &quot;k8s.io/apimachinery/pkg/util/validation&quot;
	&quot;k8s.io/apimachinery/pkg/util/validation/field&quot;
	ctrl &quot;sigs.k8s.io/controller-runtime&quot;
	logf &quot;sigs.k8s.io/controller-runtime/pkg/log&quot;
	&quot;sigs.k8s.io/controller-runtime/pkg/webhook&quot;
)
</code></pre>
</details>
<p>接下来，我们为 webhooks 配置一个日志记录器。</p>
<pre><code class="language-go">var cronjoblog = logf.Log.WithName(&quot;cronjob-resource&quot;)
</code></pre>
<p>然后，我们将 webhook 和 manager 关联起来。</p>
<pre><code class="language-go">func (r *CronJob) SetupWebhookWithManager(mgr ctrl.Manager) error {
	return ctrl.NewWebhookManagedBy(mgr).
		For(r).
		Complete()
}
</code></pre>
<p>请注意我们用 kubebuilder 标记去生成 webhook 清单。
这个标记负责生成一个 mutating webhook 清单。</p>
<p>每个标记的意义可参考<a href="cronjob-tutorial//reference/markers/webhook.html">这里</a>。</p>
<pre><code class="language-go">// +kubebuilder:webhook:path=/mutate-batch-tutorial-kubebuilder-io-v1-cronjob,mutating=true,failurePolicy=fail,groups=batch.tutorial.kubebuilder.io,resources=cronjobs,verbs=create;update,versions=v1,name=mcronjob.kb.io
</code></pre>
<p>我们使用 <code>webhook.Defaulter</code> 接口给我们的 CRD 设置默认值。
webhook 会自动调用这个默认值。</p>
<p><code>Default</code> 方法期待修改接收者，设置默认值。</p>
<pre><code class="language-go">var _ webhook.Defaulter = &amp;CronJob{}

// Default 实现了 webhook.Defaulter ，因此将为该类型注册一个webhook。
func (r *CronJob) Default() {
	cronjoblog.Info(&quot;default&quot;, &quot;name&quot;, r.Name)

	if r.Spec.ConcurrencyPolicy == &quot;&quot; {
		r.Spec.ConcurrencyPolicy = AllowConcurrent
	}
	if r.Spec.Suspend == nil {
		r.Spec.Suspend = new(bool)
	}
	if r.Spec.SuccessfulJobsHistoryLimit == nil {
		r.Spec.SuccessfulJobsHistoryLimit = new(int32)
		*r.Spec.SuccessfulJobsHistoryLimit = 3
	}
	if r.Spec.FailedJobsHistoryLimit == nil {
		r.Spec.FailedJobsHistoryLimit = new(int32)
		*r.Spec.FailedJobsHistoryLimit = 1
	}
}
</code></pre>
<p>这个标记负责生成一个 validating webhook 清单。</p>
<pre><code class="language-go">// TODO(user): 如果你要想开启删除验证，请将 verbs 修改为 &quot;verbs=create;update;delete&quot; 。
// +kubebuilder:webhook:verbs=create;update,path=/validate-batch-tutorial-kubebuilder-io-v1-cronjob,mutating=false,failurePolicy=fail,groups=batch.tutorial.kubebuilder.io,resources=cronjobs,versions=v1,name=vcronjob.kb.io
</code></pre>
<p>用声明式验证来验证我们的 CRD 。一般来说，声明式验证应该就足够了，但是有时对于复杂的验证需要
更高级的用例。</p>
<p>例如，下面我们将看到，我们使用这个来验证格式良好的 cron 调度，而不需要构造一个很长的正则表达式。</p>
<p>如果实现了 <code>webhook.Validator</code> 接口并调用了这个验证，webhook 将会自动被服务。</p>
<p><code>ValidateCreate</code>, <code>ValidateUpdate</code> 和 <code>ValidateDelete</code> 方法期望在创建、更新和删除时
分别验证其接收者。我们将 ValidateCreate 从 ValidateUpdate 分离开来以允许某些行为，像
使某些字段不可变，以至于仅可以在创建的时候去设置它们。我们也将 ValidateDelete 从 
ValidateUpdate 分离开来以允许在删除的时候的不同验证行为。然而，这里我们只对 <code>ValidateCreate</code> 
和 <code>ValidateUpdate</code> 用相同的共享验证。在 <code>ValidateDelete</code> 不做任何事情，因为我们不需要再
删除的时候做任何验证。</p>
<pre><code class="language-go">var _ webhook.Validator = &amp;CronJob{}

// ValidateCreate 实现了 webhook.Validator，因此将为该类型注册一个webhook。
func (r *CronJob) ValidateCreate() error {
	cronjoblog.Info(&quot;validate create&quot;, &quot;name&quot;, r.Name)

	return r.validateCronJob()
}

// ValidateUpdate 实现了 webhook.Validator，因此将为该类型注册一个webhook。
func (r *CronJob) ValidateUpdate(old runtime.Object) error {
	cronjoblog.Info(&quot;validate update&quot;, &quot;name&quot;, r.Name)

	return r.validateCronJob()
}

// ValidateDelete 实现了 webhook.Validator，因此将为该类型注册一个webhook。
func (r *CronJob) ValidateDelete() error {
	cronjoblog.Info(&quot;validate delete&quot;, &quot;name&quot;, r.Name)

	// TODO(user): 填写删除对象时你的验证逻辑。
	return nil
}
</code></pre>
<p>我们验证 CronJob 的 spec 和 name 。</p>
<pre><code class="language-go">func (r *CronJob) validateCronJob() error {
	var allErrs field.ErrorList
	if err := r.validateCronJobName(); err != nil {
		allErrs = append(allErrs, err)
	}
	if err := r.validateCronJobSpec(); err != nil {
		allErrs = append(allErrs, err)
	}
	if len(allErrs) == 0 {
		return nil
	}

	return apierrors.NewInvalid(
		schema.GroupKind{Group: &quot;batch.tutorial.kubebuilder.io&quot;, Kind: &quot;CronJob&quot;},
		r.Name, allErrs)
}
</code></pre>
<p>OpenAPI schema 声明性地验证一些字段。
你可以在 <a href="cronjob-tutorial/api-design.html">API</a> 中发现 kubebuilder 验证标记(前缀是 <code>// +kubebuilder:validation</code>)。
你可以通过运行 <code>controller-gen crd -w</code> 或者 <a href="cronjob-tutorial//reference/markers/crd-validation.html">这里</a> 查找到
kubebuilder支持的用于声明验证的所有标记。</p>
<pre><code class="language-go">func (r *CronJob) validateCronJobSpec() *field.Error {
	// kubernetes API machinery 的字段助手会帮助我们很好地返回结构化的验证错误。
	return validateScheduleFormat(
		r.Spec.Schedule,
		field.NewPath(&quot;spec&quot;).Child(&quot;schedule&quot;))
}
</code></pre>
<p>我们将需要验证 <a href="https://en.wikipedia.org/wiki/Cron">cron</a> 调度是否有良好的格式。</p>
<pre><code class="language-go">func validateScheduleFormat(schedule string, fldPath *field.Path) *field.Error {
	if _, err := cron.ParseStandard(schedule); err != nil {
		return field.Invalid(fldPath, schedule, err.Error())
	}
	return nil
}
</code></pre>
<details class="collapse-code"><summary class="hljs"><pre class="hljs"><span class="hljs-comment">Validate object name</span></pre></summary>
<p>验证 schema 可以声明性地验证字符串字段的长度。</p>
<p>但是 <code>ObjectMeta.Name</code> 字段定义在 apimachinery 仓库下的共享的包中，所以
我们不能用验证 schema 声明性地验证它。</p>
<pre><code class="language-go">func (r *CronJob) validateCronJobName() *field.Error {
	if len(r.ObjectMeta.Name) &gt; validationutils.DNS1035LabelMaxLength-11 {
		// job 的名字长度像所有 Kubernetes 对象一样是是 63 字符(必须适合 DNS 子域)。
		// 在创建 job 的时候，cronjob 的控制器会添加一个 11 字符的后缀(`-$TIMESTAMP`)。
		// job 的名字长度限制在 63 字符。因此 cronjob 的名字的长度一定小于等于 63-11=52 。
		// 如果这里我们没有进行验证，后面当job创建的时候就会失败。
		return field.Invalid(field.NewPath(&quot;metadata&quot;).Child(&quot;name&quot;), r.Name, &quot;must be no more than 52 characters&quot;)
	}
	return nil
}
</code></pre>
</details></div>
<h1><a class="header" href="#运行和部署-controller" id="运行和部署-controller">运行和部署 controller</a></h1>
<p>要测试 controller，我们可以在集群本地运行它。不过，在开始之前，我们需要按照 <a href="cronjob-tutorial//quick-start.html">快速入门</a> 安装 CRD。如果需要，将使用 controller-tools 自动更新 YAML 清单：</p>
<pre><code class="language-bash">make install
</code></pre>
<p>现在我们已经安装了 CRD，在集群上运行 controller 了。这将使用与集群连接所用的任何凭据，因此我们现在不必担心 RBAC。</p>
<aside class="note"> 
<h1><a class="header" href="#本地运行-webhooks" id="本地运行-webhooks">本地运行 webhooks</a></h1>
<p>如果您想在本地运行 webhooks，必须为 webhooks 服务生成证书，并将它们放在正确的目录中（默认 <code>/tmp/k8s-webhook-server/serving-certs/tls.{crt,key}</code>）。</p>
<p>如果您未运行本地 API server，则还需要弄清楚如何将流量从远程群集代理到本地 Webhook 服务器。因此，我们通常建议在执行本地 code-run-test 时禁用 webhooks，如下所示。</p>
</aside>
<p>在单独的终端中运行</p>
<pre><code class="language-bash">make run ENABLE_WEBHOOKS=false
</code></pre>
<p>您应该会看到 controller 关于启动的日志，但它还没有做任何事情。</p>
<p>此时，我们需要一个 CronJob 进行测试。让我们写一个样例到 <code>config/samples/batch_v1_cronjob.yaml</code>，并使用:</p>
<pre><code class="language-yaml">apiVersion: batch.tutorial.kubebuilder.io/v1
kind: CronJob
metadata:
  name: cronjob-sample
spec:
  schedule: &quot;*/1 * * * *&quot;
  startingDeadlineSeconds: 60
  concurrencyPolicy: Allow # explicitly specify, but Allow is also default.
  jobTemplate:
    spec:
      template:
        spec:
          containers:
          - name: hello
            image: busybox
            args:
            - /bin/sh
            - -c
            - date; echo Hello from the Kubernetes cluster
          restartPolicy: OnFailure
</code></pre>
<pre><code class="language-bash">kubectl create -f config/samples/batch_v1_cronjob.yaml
</code></pre>
<p>此时，您应该看到一系列的活动。如果看到变更，则应该看到您的 cronjob 正在运行，并且正在更新状态：</p>
<pre><code class="language-bash">kubectl get cronjob.batch.tutorial.kubebuilder.io -o yaml
kubectl get job
</code></pre>
<p>现在我们知道它正在工作，我们可以在集群中运行它。停止 <code>make run</code> 调用，然后运行</p>
<pre><code class="language-bash">make docker-build docker-push IMG=&lt;some-registry&gt;/&lt;project-name&gt;:tag
make deploy IMG=&lt;some-registry&gt;/&lt;project-name&gt;:tag
</code></pre>
<p>如果像以前一样再次列出 cronjobs，我们应该会看到控制器再次运行！</p>
<h1><a class="header" href="#部署-cert-manager" id="部署-cert-manager">部署 cert manager</a></h1>
<p>我们建议使用 <a href="https://github.com/jetstack/cert-manager">cert manager</a> 为 webhook 服务器提供证书。只要其他解决方案将证书放在期望的位置，也将会起作用。</p>
<p>你可以按照 <a href="https://docs.cert-manager.io/en/latest/getting-started/install/kubernetes.html">cert manager 文档</a> 进行安装。</p>
<p>Cert manager 还有一个叫做 CA 注入器的组件，该组件负责将 CA 捆绑注入到 Mutating|ValidatingWebhookConfiguration 中。</p>
<p>为此，你需要在 Mutating|ValidatingWebhookConfiguration 对象中使用带有 key 为 <code>cert-manager.io/inject-ca-from</code> 的注释。
注释的值应指向现有的证书 CR 实例，格式为 <code>&lt;certificate-namespace&gt;/&lt;certificate-name&gt;</code>。</p>
<p>这是我们用于注释 Mutating|ValidatingWebhookConfiguration 对象的 <a href="https://github.com/kubernetes-sigs/kustomize">kustomize</a> patch。</p>
<pre><code class="language-yaml"># This patch add annotation to admission webhook config and
# the variables $(CERTIFICATE_NAMESPACE) and $(CERTIFICATE_NAME) will be substituted by kustomize.
apiVersion: admissionregistration.k8s.io/v1beta1
kind: MutatingWebhookConfiguration
metadata:
  name: mutating-webhook-configuration
  annotations:
    cert-manager.io/inject-ca-from: $(CERTIFICATE_NAMESPACE)/$(CERTIFICATE_NAME)
---
apiVersion: admissionregistration.k8s.io/v1beta1
kind: ValidatingWebhookConfiguration
metadata:
  name: validating-webhook-configuration
  annotations:
    cert-manager.io/inject-ca-from: $(CERTIFICATE_NAMESPACE)/$(CERTIFICATE_NAME)
</code></pre>
<h1><a class="header" href="#部署-admission-webhooks" id="部署-admission-webhooks">部署 Admission Webhooks</a></h1>
<h2><a class="header" href="#kind-cluster" id="kind-cluster">Kind Cluster</a></h2>
<p>建议使用 <a href="cronjob-tutorial/../reference/kind.html">kind</a> 集群来更快速的开发 webhook。
为什么呢？</p>
<ul>
<li>你可以在 1 分钟内本地启动有多个节点的集群。</li>
<li>你可以在几秒中内关闭它。</li>
<li>你不需要把你的镜像推送到远程仓库。</li>
</ul>
<h2><a class="header" href="#证书管理" id="证书管理">证书管理</a></h2>
<p>你要遵循<a href="cronjob-tutorial/./cert-manager.html">这个</a>来安装证书管理器。</p>
<h2><a class="header" href="#构建你的镜像" id="构建你的镜像">构建你的镜像</a></h2>
<p>运行下面的命令来本地构建你的镜像。</p>
<pre><code class="language-bash">make docker-build
</code></pre>
<p>如果你使用的是 kind 集群，那么你不需要把镜像推送到远程容器仓库。你可以直接加载你本地的镜像到你的 kind 集群：</p>
<pre><code class="language-bash">kind load docker-image your-image-name:your-tag
</code></pre>
<h2><a class="header" href="#部署-webhooks" id="部署-webhooks">部署 Webhooks</a></h2>
<p>你需要通过启用 webhook 和证书管理配置。<code>config/default/kustomization.yaml</code> 应该看起来是这样子的：</p>
<pre><code class="language-yaml"># 为所有资源添加名字空间
namespace: project-system

# 这个字段的值会加在所有资源名字的前面，比如一个叫做 &quot;wordpress&quot; 的 deployment 会变成 &quot;alices-wordpress&quot;。
# 注意它应该和上面名字空间字段的前缀匹配（'-' 之前的字符串）。
namePrefix: project-

# 要给所有资源和选择器添加的标签。
#commonLabels:
#  someName: someValue

bases:
- ../crd
- ../rbac
- ../manager
# [WEBHOOK] 用于启用 webhook，取消注释所有有 [WEBHOOK] 前缀的字段，包括在 crd/kustomization.yaml 中的。
- ../webhook
# [CERTMANAGER] 用于启用证书管理，需要取消带有 'CERTMANAGER' 的所有字段的注释。'WEBHOOK' 组件是必须的。
- ../certmanager
# [PROMETHEUS] 用于启用 prometheus 监控，取消带有 'PROMETHEUS' 的左右字段的注释。
#- ../prometheus

patchesStrategicMerge:
  # 通过给 /metrics 的 endpoint 加上认证来保护它。
  # 如果你想你的 controller-manager 暴露 /metrics 的 endpoint 并且不需要任何授权，那么注释掉下面这行。
- manager_auth_proxy_patch.yaml

# [WEBHOOK] 用于启用 webhook，取消注释所有有 [WEBHOOK] 前缀的字段，包括在 crd/kustomization.yaml 中的。
- manager_webhook_patch.yaml

# [CERTMANAGER] 用于启用证书管理，需要取消带有 'CERTMANAGER' 的所有字段的注释。
# 取消在 crd/kustomization.yaml 中 'CERTMANAGER' 部分的注释可以在 admission webhook 中启用 CA 注入。
# 需要启用 'CERTMANAGER' 来使用 ca 注入。
- webhookcainjection_patch.yaml

# 下面的配置是为了教授 kustomize 如何进行变量替换。
vars:
# [CERTMANAGER] 用于启用证书管理，取消带有 'CERTMANAGER' 前缀的所有部分注释。
- name: CERTIFICATE_NAMESPACE # CR 证书的命名空间
  objref:
    kind: Certificate
    group: cert-manager.io
    version: v1alpha2
    name: serving-cert # 这个名字应该和 certificate.yaml 文件中的一个名字相匹配
  fieldref:
    fieldpath: metadata.namespace
- name: CERTIFICATE_NAME
  objref:
    kind: Certificate
    group: cert-manager.io
    version: v1alpha2
    name: serving-cert # 这个名字应该和 certificate.yaml 文件中的一个名字相匹配
- name: SERVICE_NAMESPACE # service 的命名空间
  objref:
    kind: Service
    version: v1
    name: webhook-service
  fieldref:
    fieldpath: metadata.namespace
- name: SERVICE_NAME
  objref:
    kind: Service
    version: v1
    name: webhook-service
</code></pre>
<p>现在你可以通过下面的命令把它部署到你的集群中了：</p>
<pre><code class="language-bash">make deploy IMG=&lt;some-registry&gt;/&lt;project-name&gt;:tag
</code></pre>
<p>等一会儿，webhook 的 pod 启动并且也提供了证书认证。这个过程通常需要 1 分钟。</p>
<p>现在你可以创建一个有效的 CronJob 来测试你的 webhook。这个过程应该会顺利通过的。</p>
<pre><code class="language-bash">kubectl create -f config/samples/batch_v1_cronjob.yaml
</code></pre>
<p>你也能试着创建一个无效的 CronJob（比如使用一个非法格式的调度字段）。你应该可以看到创建失败并且有验证错误信息。</p>
<aside class="note warning">
<h1><a class="header" href="#启动问题" id="启动问题">启动问题</a></h1>
<p>如果你在同一个集群为 pod 部署了一个 webhook，要留意以启动问题，因为创建 webhook pod 的请求可能会被发送到 webhook pod 它自己，而它自己还没有启动起来。</p>
<p>为了让它能正常工作，你可以使用选择器来跳过它自己，如果你的 kubernetes 版本是 1.9+ 的可以使用 <a href="https://github.com/kubernetes/api/blob/kubernetes-1.14.5/admissionregistration/v1beta1/types.go#L189-L233">namespaceSelector</a>，如果你的 kubernetes 版本是 1.15+ 的使用 <a href="https://github.com/kubernetes/api/blob/kubernetes-1.15.2/admissionregistration/v1beta1/types.go#L262-L274">objectSelector</a>。</p>
</aside>
<h1><a class="header" href="#编写控制器测试示例" id="编写控制器测试示例">编写控制器测试示例</a></h1>
<p>测试 Kubernetes 控制器是一个大的课题，kubebuilder 为您生成的样板测试文件相当少。</p>
<p>为了带您了解 Kubebuilder 生成的控制器的集成测试模式，我们将重新阅读一遍我们在第一篇教程中构建的 CronJob，并为它编写一个简单的测试。</p>
<p>基本的方法是，在生成的 <code>suite_test.go</code> 文件中，您将用 envtest 去创建一个本地 Kubernetes API 服务端，并实例化和运行你的控制器，然后编写附加的 <code>*_test.go</code> 文件并用 <a href="http://onsi.github.io/ginkgo">Ginko</a> 去测试它。</p>
<p>如果您想修改您的 envtest 集群的配置方式，请查看 <a href="cronjob-tutorial//reference/testing/envtest.html">编写和运行集成测试</a> 和 <a href="https://pkg.go.dev/sigs.k8s.io/controller-runtime/pkg/envtest?tab=doc"><code>envtest docs</code></a> 章节。</p>
<h2><a class="header" href="#测试环境配置" id="测试环境配置">测试环境配置</a></h2>
<div class="literate"><cite class="literate-source"><a href="https://sigs.k8s.io/kubebuilder/docs/book/src/cronjob-tutorial/testdata/project/controllers/suite_test.go">../../cronjob-tutorial/testdata/project/controllers/suite_test.go</a></cite>
<p>当我们在<a href="cronjob-tutorial//cronjob-tutorial/new-api.html">之前章节</a>用 <code>kubebuilder create api</code> 创建 CronJob API，Kubebuilder 已经为您创建了一些测试工作。
Kubebuilder 生成了一个用于配置基本测试环境框架的文件 <code>controllers/suite_test.go</code> 。</p>
<p>首先，它将包含必要的 imports 。</p>
<details class="collapse-code"><summary class="hljs"><pre class="hljs"><span class="hljs-comment">Apache License</span></pre></summary>
<p>Licensed under the Apache License, Version 2.0 (the “License”);
you may not use this file except in compliance with the License.
You may obtain a copy of the License at</p>
<pre><code>http://www.apache.org/licenses/LICENSE-2.0
</code></pre>
<p>Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an “AS IS” BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.</p>
</details><details class="collapse-code"><summary class="hljs"><pre class="hljs"><span class="hljs-comment">Imports</span></pre></summary>
<pre><code class="language-go">package controllers

import (
	&quot;path/filepath&quot;
	&quot;testing&quot;

	. &quot;github.com/onsi/ginkgo&quot;
	. &quot;github.com/onsi/gomega&quot;
	&quot;k8s.io/client-go/kubernetes/scheme&quot;
	&quot;k8s.io/client-go/rest&quot;
	ctrl &quot;sigs.k8s.io/controller-runtime&quot;
	&quot;sigs.k8s.io/controller-runtime/pkg/client&quot;
	&quot;sigs.k8s.io/controller-runtime/pkg/envtest&quot;
	&quot;sigs.k8s.io/controller-runtime/pkg/envtest/printer&quot;
	logf &quot;sigs.k8s.io/controller-runtime/pkg/log&quot;
	&quot;sigs.k8s.io/controller-runtime/pkg/log/zap&quot;

	batchv1 &quot;tutorial.kubebuilder.io/project/api/v1&quot;
	// +kubebuilder:scaffold:imports
)

// 这些测试示例使用了 Ginkgo (BDD-style Go 测试框架)。学习更多关于 Ginkgo 请参考 http://onsi.github.io/ginkgo/。
</code></pre>
</details>
<p>现在，让我们看看生成的代码。</p>
<pre><code class="language-go">var cfg *rest.Config
var k8sClient client.Client //  您将在你的测试代码中使用这个 client。
var testEnv *envtest.Environment

var _ = BeforeSuite(func(done Done) {
	logf.SetLogger(zap.New(zap.WriteTo(GinkgoWriter), zap.UseDevMode(true)))
</code></pre>
<p>首先， envtest 集群将从 Kubebuilder 为您生成的 CRD 目录下读取 CRD 信息。</p>
<pre><code class="language-go">	By(&quot;bootstrapping test environment&quot;)
	testEnv = &amp;envtest.Environment{
		CRDDirectoryPaths: []string{filepath.Join(&quot;..&quot;, &quot;config&quot;, &quot;crd&quot;, &quot;bases&quot;)},
	}
</code></pre>
<p>然后，我们启动 envtest 集群。</p>
<pre><code class="language-go">	var err error
	cfg, err = testEnv.Start()
	Expect(err).ToNot(HaveOccurred())
	Expect(cfg).ToNot(BeNil())
</code></pre>
<p>自动生成的测试代码将把 CronJob Kind schema 添加到默认的 client-go k8s scheme 中。
这保证了 CronJob 的 API/Kind 可以在我们控制器测试代码中正常使用。</p>
<pre><code class="language-go">	err = batchv1.AddToScheme(scheme.Scheme)
	Expect(err).NotTo(HaveOccurred())
</code></pre>
<p>schemas 之后，你将看到下面标记。
当一个新的 API 添加到项目中，这个标记允许新的 schemas 自动的添加到这里。</p>
<pre><code class="language-go">	// +kubebuilder:scaffold:scheme
</code></pre>
<p>为我们测试 CRUD 操作创建一个客户端。</p>
<pre><code class="language-go">	k8sClient, err = client.New(cfg, client.Options{Scheme: scheme.Scheme})
	Expect(err).ToNot(HaveOccurred())
	Expect(k8sClient).ToNot(BeNil())
</code></pre>
<p>然而，这个自动生成的文件缺少了实际启动控制器的方法。
上面的代码将会建立一个和您自定义的 Kind 交互的客户端，但是无法测试您的控制器的行为。
如果你想要测试自定义的控制器逻辑，您需要添加一些相似的管理逻辑到 BeforeSuite() 函数，
这样就可以将你的自定义控制器运行在这个测试集群上。</p>
<p>您可能注意到了，下面运行在控制器中的逻辑代码几乎和您的 CronJob 项目中的 main.go 中是相同的！
唯一不同的是 manager 启动在一个独立的 goroutine 中，因此，当您运行完测试后，它不会阻止 envtest 的清理工作。</p>
<p>一旦添加了下面的代码，你将可以删除掉上面的 k8sClient，因为你可以从 manager 中获取到 k8sClient (如下所示)。</p>
<pre><code class="language-go">	k8sManager, err := ctrl.NewManager(cfg, ctrl.Options{
		Scheme: scheme.Scheme,
	})
	Expect(err).ToNot(HaveOccurred())

	err = (&amp;CronJobReconciler{
		Client: k8sManager.GetClient(),
		Log:    ctrl.Log.WithName(&quot;controllers&quot;).WithName(&quot;CronJob&quot;),
	}).SetupWithManager(k8sManager)
	Expect(err).ToNot(HaveOccurred())

	go func() {
		err = k8sManager.Start(ctrl.SetupSignalHandler())
		Expect(err).ToNot(HaveOccurred())
	}()

	k8sClient = k8sManager.GetClient()
	Expect(k8sClient).ToNot(BeNil())

	close(done)
}, 60)
</code></pre>
<p>Kubebuilder 还为清除 envtest 和在 controller/ 目录中实际运行测试的文件生成样板函数。
你不需要更改这部分代码</p>
<pre><code class="language-go">var _ = AfterSuite(func() {
	By(&quot;tearing down the test environment&quot;)
	err := testEnv.Stop()
	Expect(err).ToNot(HaveOccurred())
})

func TestAPIs(t *testing.T) {
	RegisterFailHandler(Fail)

	RunSpecsWithDefaultAndCustomReporters(t,
		&quot;Controller Suite&quot;,
		[]Reporter{printer.NewlineReporter{}})
}
</code></pre>
<p>现在，您已经在测试集群上运行了控制器，并且客户端已经准备好对 CronJob 执行操作，我们可以开始编写集成测试了!</p>
</div>
<h2><a class="header" href="#测试控制器行为" id="测试控制器行为">测试控制器行为</a></h2>
<div class="literate"><cite class="literate-source"><a href="https://sigs.k8s.io/kubebuilder/docs/book/src/cronjob-tutorial/testdata/project/controllers/cronjob_controller_test.go">../../cronjob-tutorial/testdata/project/controllers/cronjob_controller_test.go</a></cite>
<p>理想情况下，每个控制器都应该存在对应的测试文件 <code>&lt;kind&gt;_conroller_test.go</code>，并在 <code>test_suite.go</code> 中调用。
接下来，让我们为CronJob控制器编写示例测试(<code>cronjob_controller_test.go。</code>)</p>
<details class="collapse-code"><summary class="hljs"><pre class="hljs"><span class="hljs-comment">Apache License</span></pre></summary>
<p>Licensed under the Apache License, Version 2.0 (the “License”);
you may not use this file except in compliance with the License.
You may obtain a copy of the License at</p>
<pre><code>http://www.apache.org/licenses/LICENSE-2.0
</code></pre>
<p>Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an “AS IS” BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.</p>
</details><details class="collapse-code"><summary class="hljs"><pre class="hljs"><span class="hljs-comment">Imports</span></pre></summary>
<p>像往常一样，我们从必要的导入开始。我们还定义了一些有用的变量。</p>
<pre><code class="language-go">package controllers

import (
	&quot;context&quot;
	&quot;reflect&quot;
	&quot;time&quot;

	. &quot;github.com/onsi/ginkgo&quot;
	. &quot;github.com/onsi/gomega&quot;
	batchv1 &quot;k8s.io/api/batch/v1&quot;
	batchv1beta1 &quot;k8s.io/api/batch/v1beta1&quot;
	v1 &quot;k8s.io/api/core/v1&quot;
	metav1 &quot;k8s.io/apimachinery/pkg/apis/meta/v1&quot;
	&quot;k8s.io/apimachinery/pkg/types&quot;

	cronjobv1 &quot;tutorial.kubebuilder.io/project/api/v1&quot;
)
</code></pre>
</details>
<p>编写一个简单的集成测试的第一步是真实的创建一个您可以运行测试的 CronJob 的实例。
请注意，要创建一个 CronJob，你需要先创建一个包含 CronJob 定义的 stub 结构体。</p>
<p>请注意，当我们创建一个存根 CronJob ，CronJob 还需要它所需要的下游对象的存根。
没有下面存根的 Job 模板 spec 和 Pod 模板 spec ，Kubernetes API 将不能创建 CronJob 。</p>
<pre><code class="language-go">var _ = Describe(&quot;CronJob controller&quot;, func() {

	// 定义对象名称、测试超时时间、持续时间以及测试间隔等常量。
	const (
		CronjobName      = &quot;test-cronjob&quot;
		CronjobNamespace = &quot;default&quot;
		JobName          = &quot;test-job&quot;

		timeout  = time.Second * 10
		duration = time.Second * 10
		interval = time.Millisecond * 250
	)

	Context(&quot;When updating CronJob Status&quot;, func() {
		It(&quot;Should increase CronJob Status.Active count when new Jobs are created&quot;, func() {
			By(&quot;By creating a new CronJob&quot;)
			ctx := context.Background()
			cronJob := &amp;cronjobv1.CronJob{
				TypeMeta: metav1.TypeMeta{
					APIVersion: &quot;batch.tutorial.kubebuilder.io/v1&quot;,
					Kind:       &quot;CronJob&quot;,
				},
				ObjectMeta: metav1.ObjectMeta{
					Name:      CronjobName,
					Namespace: CronjobNamespace,
				},
				Spec: cronjobv1.CronJobSpec{
					Schedule: &quot;1 * * * *&quot;,
					JobTemplate: batchv1beta1.JobTemplateSpec{
						Spec: batchv1.JobSpec{
							// 简单起见，我们只填写必需的字段。
							Template: v1.PodTemplateSpec{
								Spec: v1.PodSpec{
									// 简单起见，我们只填写必需的字段。
									Containers: []v1.Container{
										{
											Name:  &quot;test-container&quot;,
											Image: &quot;test-image&quot;,
										},
									},
									RestartPolicy: v1.RestartPolicyOnFailure,
								},
							},
						},
					},
				},
			}
			Expect(k8sClient.Create(ctx, cronJob)).Should(Succeed())

		
</code></pre>
<p>在创建这个 CronJob 之后，让我们检查 CronJob 的 Spec 字段与我们传入的字段是否匹配。
请注意，因为 k8s apiserver 在前面的 ‘Create()’ 调用之后可能还没有完成 CronJob 的创建，我将用 Gomega 的 Eventually() 测试函数代替 Expect() 去给 apiserver 一个机会去完成CronJob的创建。</p>
<p><code>Eventually()</code> 方法每隔一个时间间隔执行一次参数中指定的函数，直到满足下列两个条件之一才会退出方法。
(a) 函数的输出与<code>Should()</code>调用的期望输出匹配
(b) 重试时间（重试次数 * 间隔周期）大于指定的超时时间</p>
<p>在下面的示例中，timeout 和 interval 是我们选择的 Go Duration 值。</p>
<pre><code class="language-go">			cronjobLookupKey := types.NamespacedName{Name: CronjobName, Namespace: CronjobNamespace}
			createdCronjob := &amp;cronjobv1.CronJob{}

			// 创建操作可能不会立马完成，因此我们需要多次重试去获取这个新建的 CronJob。
			Eventually(func() bool {
				err := k8sClient.Get(ctx, cronjobLookupKey, createdCronjob)
				if err != nil {
					return false
				}
				return true
			}, timeout, interval).Should(BeTrue())
			// 让我们确保我们的Schedule 字符串值被正确地转换/处理。
			Expect(createdCronjob.Spec.Schedule).Should(Equal(&quot;1 * * * *&quot;))
		
</code></pre>
<p>现在，我们已经在我们的测试集群中创建了一个CronJob，下一步是写一个测试用例去真正的测试我们 CronJob 控制器的行为。
让我们测试一下 CronJob 控制器根据正在运行的 Jobs 更新 CronJob.Status.Active 的逻辑。
我们将验证当 CronJob 有一个活动的下游 Job ，它的 CronJob.Status.Active 字段包含对该Job的引用。</p>
<p>首先，我们应该获取之前创建的测试 CronJob ，并验证它目前没有任何正在运行的 Job。
在这里我们使用 Gomega 的 <code>Consistently()</code> 检查，以确保正在运行的 Job 总数在一段时间内保持为 0 。</p>
<pre><code class="language-go">			By(&quot;By checking the CronJob has zero active Jobs&quot;)
			Consistently(func() (int, error) {
				err := k8sClient.Get(ctx, cronjobLookupKey, createdCronjob)
				if err != nil {
					return -1, err
				}
				return len(createdCronjob.Status.Active), nil
			}, duration, interval).Should(Equal(0))
		
</code></pre>
<p>下一步，为我们的 CronJob 创建一个 Job 的 stub 对象以及它的下游模板 specs 。
我们将 Job 的状态 “Active” 设置为 2，来模拟当前 Job 运行了 2 个 pod ，这表示我们的 Job 正在运行。</p>
<p>然后，我们获取 Job 的 stub 对象 ，并将其所有者引用指向我们的测试 CronJob 。
这确保了测试 Job 属于我们的测试 CronJob ，并被它跟踪。
一旦完成，我们就创建新的 Job 实例。</p>
<pre><code class="language-go">			By(&quot;By creating a new Job&quot;)
			testJob := &amp;batchv1.Job{
				ObjectMeta: metav1.ObjectMeta{
					Name:      JobName,
					Namespace: CronjobNamespace,
				},
				Spec: batchv1.JobSpec{
					Template: v1.PodTemplateSpec{
						Spec: v1.PodSpec{
							// 简单起见，我们只填写必需的字段。
							Containers: []v1.Container{
								{
									Name:  &quot;test-container&quot;,
									Image: &quot;test-image&quot;,
								},
							},
							RestartPolicy: v1.RestartPolicyOnFailure,
						},
					},
				},
				Status: batchv1.JobStatus{
					Active: 2,
				},
			}

			// 请注意，所有者引用需要配置 CronJob 的 GroupVersionKind。
			kind := reflect.TypeOf(cronjobv1.CronJob{}).Name()
			gvk := cronjobv1.GroupVersion.WithKind(kind)

			controllerRef := metav1.NewControllerRef(createdCronjob, gvk)
			testJob.SetOwnerReferences([]metav1.OwnerReference{*controllerRef})
			Expect(k8sClient.Create(ctx, testJob)).Should(Succeed())
		
</code></pre>
<p>添加这个 Job 到我们的测试 CronJob 中将会触发我们的控制器的协调逻辑。
之后，我们可以编写一个测试用例验证我们的控制器最终是否按照预期更新了我们的 CronJob 的状态字段！</p>
<pre><code class="language-go">			By(&quot;By checking that the CronJob has one active Job&quot;)
			Eventually(func() ([]string, error) {
				err := k8sClient.Get(ctx, cronjobLookupKey, createdCronjob)
				if err != nil {
					return nil, err
				}

				names := []string{}
				for _, job := range createdCronjob.Status.Active {
					names = append(names, job.Name)
				}
				return names, nil
			}, timeout, interval).Should(ConsistOf(JobName), &quot;should list our active job %s in the active jobs list in status&quot;, JobName)
		})
	})

})
</code></pre>
<p>完成这些代码后，您可以在 <code>controllers/</code> 目录下执行 <code>go test ./...</code> ，运行新的测试代码！</p>
</div>
<p>上面状态更新的示例演示了一个带有下游对象的自定义 Kind 的通用测试策略。到此，希望您已经学到了下列用于测试控制器行为的方法：</p>
<ul>
<li>配置你的控制器运行在 envtest 集群上</li>
<li>为创建测试对象编写测试示例</li>
<li>隔离对对象的更改，以测试特定的控制器行为</li>
</ul>
<h2><a class="header" href="#高级示例" id="高级示例">高级示例</a></h2>
<p>还有更多使用 envtest 来严格测试控制器行为的例子。包括：</p>
<ul>
<li>Azure Databricks Operator: 仔细阅读 <a href="https://github.com/microsoft/azure-databricks-operator/blob/0f722a710fea06b86ecdccd9455336ca712bf775/controllers/suite_test.go"><code>suite_test.go</code></a> 以及那个目录下所有的 <code>*_test.go</code> 文件 <a href="https://github.com/microsoft/azure-databricks-operator/blob/0f722a710fea06b86ecdccd9455336ca712bf775/controllers/secretscope_controller_test.go">例如这个</a>。</li>
</ul>
<h1><a class="header" href="#结语" id="结语">结语</a></h1>
<p>至此，我们已经实现了一个功能比较完备的 Cronjob controller 了，利用了 KubeBuilder 的大部分特性，而且用
envtest 写了 controller 的测试。</p>
<p>如果你想要知道更多，可以看 <a href="cronjob-tutorial//multiversion-tutorial/tutorial.html">Multi-Version
Tutorial</a>，学习如何给项目添加新API。</p>
<p>另外，你可以自己尝试完成以下步骤--稍后我们会有一个教程。</p>
<ul>
<li><code>kubectl get</code> <a href="cronjob-tutorial//reference/generating-crd.html#additional-printer-columns">添加额外的列打印</a></li>
</ul>
<h1><a class="header" href="#教程多版本-api" id="教程多版本-api">教程：多版本 API</a></h1>
<p>大多数项目都是从一个 alpha API 开始的，这个 API 会随着发布版本的不同而变化。
然后，最终大多数项目将会转向更稳定的版本。一旦你的 API 足够的稳定，你就不能够对它做破坏性的修改。
这就是 API 版本发挥作用的地方。</p>
<p>让我们对 <code>CronJob</code> API spec 做一些改变，确保我们的 CronJob 项目支持所有不同的版本。</p>
<p>如果你还没有准备好，请确保你已经阅读过了基础的 <a href="multiversion-tutorial//cronjob-tutorial/cronjob-tutorial.html">CronJob 教程</a>。</p>
<aside class="note">
<h1><a class="header" href="#跟随-vs-跳跃" id="跟随-vs-跳跃">跟随 vs 跳跃</a></h1>
<p>请注意本教程的大部分内容是由形成一个可运行的项目的 literate Go 文件生成的，并且放在了本书的下面源目录下 <a href="https://github.com/kubernetes-sigs/kubebuilder/tree/master/docs/book/src/multiversion-tutorial/testdata/project">docs/book/src/multiversion-tutorial/testdata/project</a>。</p>
</aside>
<aside class="note warning">
<h1><a class="header" href="#最小-kubernetes-版本来了" id="最小-kubernetes-版本来了">最小 kubernetes 版本来了！</a></h1>
<p>CRD 转换在 Kubernetes 1.13 版本（也就是说它是默认关闭的，需要通过一个 <a href="https://kubernetes.io/docs/reference/command-line-tools-reference/feature-gates/" title="Kubernetes Feature Gates">feature gate</a> 去打开）中作为一个 alpha 特性被引入支持，
在 Kubernetes 1.15 版本（也就是说它是默认打开的）中变成了 beta 版。</p>
<p>如果你的 Kubernetes 版本是 1.13-1.14，确保开启了特性开关。
如果你的 Kubernetes 版本是 1.12 或者更低，你将需要一个新的集群去使用转换。
查看 <a href="multiversion-tutorial//reference/kind.html">Kind 说明</a> 去了解如果设置一个多功能的集群。</p>
</aside>
<p>接下来，让我们弄清楚我们想要做哪些更改。</p>
<h1><a class="header" href="#修改" id="修改">修改</a></h1>
<p>Kubernetes API 中一个相当常见的改变是获取一些非结构化的或者存储在一些特殊的字符串格式的数据，
并将其修改为结构化的数据。我们的 <code>schedule</code> 字段非常适合这个案例 -- 现在，在 <code>v1</code> 中，我们的 schedules 是这样的</p>
<pre><code class="language-yaml">schedule: &quot;*/1 * * * *&quot;
</code></pre>
<p>这是一个非常典型的特殊字符串格式的例子（除非你是一个 Unix 系统管理员，否则非常难以理解它）。</p>
<p>让我们来使它更结构化一点。根据我们 <a href="multiversion-tutorial//TODO.html">CronJob 代码</a>，我们支持”standard” Cron 格式。</p>
<p>在 Kubernetes 里，<strong>所有版本都必须通过彼此进行安全的往返</strong>。这意味着如果我们从版本 1 转换到版本 2，然后回退到版本 1，我们一定会失去一些信息。因此，我们对 API 所做的任何更改都必须与 v1 中所支持的内容兼容还需要确保我们添加到 v2 中的任何内容在 v1 中都得到支持。某些情况下，这意味着我们需要向 V1 中添加新的字段，但是在我们这个例子中，我们不会这么做，因为我们没有添加新的功能。</p>
<p>记住这些，让我们将上面的示例转换为稍微更结构化一点：</p>
<pre><code class="language-yaml">schedule:
  minute: */1
</code></pre>
<p>现在，至少我们每个字段都有了标签，但是我们仍然可以为每个字段轻松地支持所有不同的语法。</p>
<p>对这个改变我们将需要一个新的 API 版本。我们称它为 v2:</p>
<pre><code class="language-shell">kubebuilder create api --group batch --version v2 --kind CronJob
</code></pre>
<p>现在，让我们复制已经存在的类型，并做一些改变：</p>
<div class="literate"><cite class="literate-source"><a href="https://sigs.k8s.io/kubebuilder/docs/book/src/multiversion-tutorial/testdata/project/api/v2/cronjob_types.go">project/api/v2/cronjob_types.go</a></cite><details class="collapse-code"><summary class="hljs"><pre class="hljs"><span class="hljs-comment">Apache License</span></pre></summary>
<p>Copyright 2020 The Kubernetes authors.</p>
<p>Licensed under the Apache License, Version 2.0 (the “License”);
you may not use this file except in compliance with the License.
You may obtain a copy of the License at</p>
<pre><code>http://www.apache.org/licenses/LICENSE-2.0
</code></pre>
<p>Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an “AS IS” BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.</p>
</details>
<p>因为我们现在在v2 包中，controller-gen 将自动假设这是对于 v2 版本的。
我们可以用<a href="multiversion-tutorial//reference/markers/crd.html"><code>+versionName</code>marker</a>去重写它。</p>
<pre><code class="language-go">package v2
</code></pre>
<details class="collapse-code"><summary class="hljs"><pre class="hljs"><span class="hljs-comment">Imports</span></pre></summary>
<pre><code class="language-go">import (
	batchv1beta1 &quot;k8s.io/api/batch/v1beta1&quot;
	corev1 &quot;k8s.io/api/core/v1&quot;
	metav1 &quot;k8s.io/apimachinery/pkg/apis/meta/v1&quot;
)

// 编辑这个文件！这是你拥有的脚手架！
// 注意: json 标签是必需的。为了字段能够被序列化任何你添加的新的字段一定有 json 标签。
</code></pre>
</details>
<p>除了将 schedule 字段更改为一个新类型外，我们将基本上保持 spec 不变。</p>
<pre><code class="language-go">// CronJobSpec 定义了 CronJob 期待的状态
type CronJobSpec struct {
	// Cron 格式的 schedule，详情请看https://en.wikipedia.org/wiki/Cron。
	Schedule CronSchedule `json:&quot;schedule&quot;`
</code></pre>
<details class="collapse-code"><summary class="hljs"><pre class="hljs"><span class="hljs-comment">The rest of Spec</span></pre></summary>
<pre><code class="language-go">	// +kubebuilder:validation:Minimum=0

	// 对于开始 job 以秒为单位的可选的并如果由于任何原因错失了调度的时间截止日期。未执行的
	// job 将被统计为失败的 job 。
	// +optional
	StartingDeadlineSeconds *int64 `json:&quot;startingDeadlineSeconds,omitempty&quot;`

	// 指定如何处理job的并发执行。
	// 有效的值是：
	// - &quot;Allow&quot; (默认)： 允许 CronJobs 并发执行；
	// - &quot;Forbid&quot;：禁止并发执行，如果之前运行的还没有完成，跳过下一次执行；
	// - &quot;Replace&quot;： 取消当前正在运行的 job 并用新的 job 替换它
	// +optional
	ConcurrencyPolicy ConcurrencyPolicy `json:&quot;concurrencyPolicy,omitempty&quot;`

	// 此标志告诉控制器暂停后续执行，它不会应用到已经开始执行的 job 。默认值是 false。
	// +optional
	Suspend *bool `json:&quot;suspend,omitempty&quot;`

	// 指定当执行一个 CronJob 时将会被创建的 job 。
	JobTemplate batchv1beta1.JobTemplateSpec `json:&quot;jobTemplate&quot;`

	// +kubebuilder:validation:Minimum=0

	// 要保留的成功完成的 jobs 的数量。
	// 这是一个用来区分明确 0 值和未指定的指针。
	// +optional
	SuccessfulJobsHistoryLimit *int32 `json:&quot;successfulJobsHistoryLimit,omitempty&quot;`

	// +kubebuilder:validation:Minimum=0

	// 要保留的失败的 jobs 的数量。
	// 这是一个用来区分明确 0 值和未指定的指针。
	// +optional
	FailedJobsHistoryLimit *int32 `json:&quot;failedJobsHistoryLimit,omitempty&quot;`
</code></pre>
</details>
<pre><code class="language-go">}
</code></pre>
<p>接下来，我们定义一个类型存储我们的 schedule 。
基于我们上面提议的 YAML 格式，每个对应的 Cron “field” 都有一个字段。</p>
<pre><code class="language-go">// 描述一个Cron schedule。
type CronSchedule struct {
	// 指定 job 执行的分钟数。
	// +optional
	Minute *CronField `json:&quot;minute,omitempty&quot;`
	// 指定 job 执行的小时数。
	// +optional
	Hour *CronField `json:&quot;hour,omitempty&quot;`
	// 指定 job 执行的月的天数。
	// +optional
	DayOfMonth *CronField `json:&quot;dayOfMonth,omitempty&quot;`
	// 指定 job 执行的月数。
	// +optional
	Month *CronField `json:&quot;month,omitempty&quot;`
	// 指定 job 执行的一周的天数。
	// +optional
	DayOfWeek *CronField `json:&quot;dayOfWeek,omitempty&quot;`
}
</code></pre>
<p>最后，我们定义一个封装器类型来表示一个字段。
我们可以为这个字段附加一些额外的验证，但是现在我们只仅仅用它做文档的目的。</p>
<pre><code class="language-go">// 表示一个 Cron 字段说明符。
type CronField string
</code></pre>
<details class="collapse-code"><summary class="hljs"><pre class="hljs"><span class="hljs-comment">Other Types</span></pre></summary>
<p>所有其他类型将保持与以前相同。</p>
<pre><code class="language-go">// ConcurrencyPolicy 描述 job 将会被怎样处理。仅仅下面并发策略中的一种可以被指定。
// 如果没有指定下面策略的任何一种，那么默认的一个是 AllowConcurrent 。
// +kubebuilder:validation:Enum=Allow;Forbid;Replace
type ConcurrencyPolicy string

const (
	// AllowConcurrent 允许 CronJobs 并发执行.
	AllowConcurrent ConcurrencyPolicy = &quot;Allow&quot;

	// ForbidConcurrent 禁止并发执行, 如果之前运行的还没有完成，跳过下一次执行
	ForbidConcurrent ConcurrencyPolicy = &quot;Forbid&quot;

	// ReplaceConcurrent 取消当前正在运行的 job 并用新的 job 替换它。
	ReplaceConcurrent ConcurrencyPolicy = &quot;Replace&quot;
)

// CronJobStatus 定义了 CronJob 观察的的状态
type CronJobStatus struct {
	// 插入额外的 STATUS 字段 - 定义集群观察的状态
	// 重要：修改了这个文件之后运行&quot;make&quot;去重新生成代码

	// 一个存储当前正在运行 job 的指针列表。
	// +optional
	Active []corev1.ObjectReference `json:&quot;active,omitempty&quot;`

	// 当 job 最后一次成功被调度的信息。
	// +optional
	LastScheduleTime *metav1.Time `json:&quot;lastScheduleTime,omitempty&quot;`
}

// +kubebuilder:object:root=true
// +kubebuilder:subresource:status

// CronJob 是 cronjobs API 的 Schema
type CronJob struct {
	metav1.TypeMeta   `json:&quot;,inline&quot;`
	metav1.ObjectMeta `json:&quot;metadata,omitempty&quot;`

	Spec   CronJobSpec   `json:&quot;spec,omitempty&quot;`
	Status CronJobStatus `json:&quot;status,omitempty&quot;`
}

// +kubebuilder:object:root=true

// CronJobList 包含了一个 CronJob 的列表
type CronJobList struct {
	metav1.TypeMeta `json:&quot;,inline&quot;`
	metav1.ListMeta `json:&quot;metadata,omitempty&quot;`
	Items           []CronJob `json:&quot;items&quot;`
}

func init() {
	SchemeBuilder.Register(&amp;CronJob{}, &amp;CronJobList{})
}
</code></pre>
</details></div>
<h2><a class="header" href="#存储版本" id="存储版本">存储版本</a></h2>
<div class="literate"><cite class="literate-source"><a href="https://sigs.k8s.io/kubebuilder/docs/book/src/multiversion-tutorial/testdata/project/api/v1/cronjob_types.go">project/api/v1/cronjob_types.go</a></cite><details class="collapse-code"><summary class="hljs"><pre class="hljs"><span class="hljs-comment">Apache License</span></pre></summary>
<p>Copyright 2020 The Kubernetes authors.</p>
<p>Licensed under the Apache License, Version 2.0 (the “License”);
you may not use this file except in compliance with the License.
You may obtain a copy of the License at</p>
<pre><code>http://www.apache.org/licenses/LICENSE-2.0
</code></pre>
<p>Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an “AS IS” BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.</p>
</details>
<pre><code class="language-go">package v1
</code></pre>
<details class="collapse-code"><summary class="hljs"><pre class="hljs"><span class="hljs-comment">Imports</span></pre></summary>
<pre><code class="language-go">import (
	batchv1beta1 &quot;k8s.io/api/batch/v1beta1&quot;
	corev1 &quot;k8s.io/api/core/v1&quot;
	metav1 &quot;k8s.io/apimachinery/pkg/apis/meta/v1&quot;
)

// 编辑这个文件！这是你拥有的脚手架！
// 注意: json 标签是必需的。为了字段能够被序列化任何你添加的新的字段一定有 json 标签。
</code></pre>
</details><details class="collapse-code"><summary class="hljs"><pre class="hljs"><span class="hljs-comment">old stuff</span></pre></summary>
<pre><code class="language-go">// CronJobSpec 定义了 CronJob 期待的状态
type CronJobSpec struct {
	// +kubebuilder:validation:MinLength=0

	// Cron 格式的 schedule，详情请看https://en.wikipedia.org/wiki/Cron。
	Schedule string `json:&quot;schedule&quot;`

	// +kubebuilder:validation:Minimum=0

	// 对于开始 job 以秒为单位的可选的并如果由于任何原因错失了调度的时间截止日期。未执行的
	// job 将被统计为失败的 job 。
	// +optional
	StartingDeadlineSeconds *int64 `json:&quot;startingDeadlineSeconds,omitempty&quot;`

	// 指定如何处理job的并发执行。
	// 有效的值是：
	// - &quot;Allow&quot; (默认)： 允许 CronJobs 并发执行；
	// - &quot;Forbid&quot;：禁止并发执行，如果之前运行的还没有完成，跳过下一次执行；
	// - &quot;Replace&quot;： 取消当前正在运行的 job 并用新的 job 替换它
	// +optional
	ConcurrencyPolicy ConcurrencyPolicy `json:&quot;concurrencyPolicy,omitempty&quot;`

	// 此标志告诉控制器暂停后续执行，它不会应用到已经开始执行的 job 。默认值是 false。
	// +optional
	Suspend *bool `json:&quot;suspend,omitempty&quot;`

	// 指定当执行一个 CronJob 时将会被创建的 job 。
	JobTemplate batchv1beta1.JobTemplateSpec `json:&quot;jobTemplate&quot;`

	// +kubebuilder:validation:Minimum=0

	// 要保留的成功完成的 jobs 的数量。
	// 这是一个用来区分明确 0 值和未指定的指针。
	// +optional
	SuccessfulJobsHistoryLimit *int32 `json:&quot;successfulJobsHistoryLimit,omitempty&quot;`

	// +kubebuilder:validation:Minimum=0

	// 要保留的失败的 jobs 的数量。
	// 这是一个用来区分明确 0 值和未指定的指针。
	// +optional
	FailedJobsHistoryLimit *int32 `json:&quot;failedJobsHistoryLimit,omitempty&quot;`
}

// ConcurrencyPolicy 描述 job 将会被怎样处理。仅仅下面并发策略中的一种可以被指定。
// 如果没有指定下面策略的任何一种，那么默认的一个是 AllowConcurrent 。
// +kubebuilder:validation:Enum=Allow;Forbid;Replace
type ConcurrencyPolicy string

const (
	// AllowConcurrent 允许 CronJobs 并发执行.
	AllowConcurrent ConcurrencyPolicy = &quot;Allow&quot;

	// ForbidConcurrent 禁止并发执行, 如果之前运行的还没有完成，跳过下一次执行
	// hasn't finished yet.
	ForbidConcurrent ConcurrencyPolicy = &quot;Forbid&quot;

	// ReplaceConcurrent 取消当前正在运行的 job 并用新的 job 替换它。
	ReplaceConcurrent ConcurrencyPolicy = &quot;Replace&quot;
)

// CronJobStatus 定义了 CronJob 观察的的状态
type CronJobStatus struct {
	// 插入额外的 STATUS 字段 - 定义集群观察的状态
	// 重要：修改了这个文件之后运行&quot;make&quot;去重新生成代码

	// 一个存储当前正在运行 job 的指针列表。
	// +optional
	Active []corev1.ObjectReference `json:&quot;active,omitempty&quot;`

	// 当 job 最后一次成功被调度的信息。
	// +optional
	LastScheduleTime *metav1.Time `json:&quot;lastScheduleTime,omitempty&quot;`
}
</code></pre>
</details>
<p>因为我们将有多个版本，我们将需要标记一个存储版本。
这是一个 Kubernetes API 服务端使用存储我们数据的版本。
我们将选择v1版本作为我们项目的版本。</p>
<p>我们将用 <a href="multiversion-tutorial//reference/markers/crd.html"><code>+kubebuilder:storageversion</code></a> 去做这件事。</p>
<p>注意如果在存储版本改变之前它们已经被写入那么在仓库中可能存在多个版本 -- 改变存储版本仅仅影响
在改变之后对象的创建/更新。</p>
<pre><code class="language-go">// +kubebuilder:object:root=true
// +kubebuilder:subresource:status
// +kubebuilder:storageversion

// CronJob 是 cronjobs API 的 Schema
type CronJob struct {
	metav1.TypeMeta   `json:&quot;,inline&quot;`
	metav1.ObjectMeta `json:&quot;metadata,omitempty&quot;`

	Spec   CronJobSpec   `json:&quot;spec,omitempty&quot;`
	Status CronJobStatus `json:&quot;status,omitempty&quot;`
}
</code></pre>
<details class="collapse-code"><summary class="hljs"><pre class="hljs"><span class="hljs-comment">old stuff</span></pre></summary>
<pre><code class="language-go">// +kubebuilder:object:root=true

// CronJobList 包含了一个 CronJob 的列表
type CronJobList struct {
	metav1.TypeMeta `json:&quot;,inline&quot;`
	metav1.ListMeta `json:&quot;metadata,omitempty&quot;`
	Items           []CronJob `json:&quot;items&quot;`
}

func init() {
	SchemeBuilder.Register(&amp;CronJob{}, &amp;CronJobList{})
}
</code></pre>
</details></div>
<p>现在我们已经准备好了类型，接下来需要设置转换。</p>
<h1><a class="header" href="#hubs-spokes-和其他的-wheel-metaphors" id="hubs-spokes-和其他的-wheel-metaphors">Hubs, spokes, 和其他的 wheel metaphors</a></h1>
<p>由于我们现在有两个不同的版本，用户可以请求任意一个版本，我们必须定义一种在版本之间进行转换的方法。对于 CRD ，这是通过使用 Webhook 完成的，类似我们<a href="multiversion-tutorial//cronjob-tutorial/webhook-implementation.html">在基础中定义 webhooks 教程</a>的默认设置和验证一样。像以前一样，控制器运行时将帮助我们将所有细节都连接在一起，而我们只需实现本身的转换即可。</p>
<p>在执行此操作之前，我们需要了解控制器运行时如何处理版本的。即：</p>
<h2><a class="header" href="#任意两个版本间转换的不足之处" id="任意两个版本间转换的不足之处">任意两个版本间转换的不足之处</a></h2>
<p>定义转换的一种简单方法可能是定义转换函数如何可以在我们的每个版本之间进行转换。然后，只要我们需要进行转换的时候，我们只需要查找适当的函数，然后调用它就可以执行转换。当我们只有两个版本时，这可以正常工作，但是如果我们有4个版本的时候，或者更多的时候该怎么办？那将会有很多转换功能。</p>
<p>相反，控制器运行时会根据 “hub 和 spoke” 模型-我们将一个版本标记为“hub”，而所有其他版本只需定义为与 hub 之间的来源即可：</p>
<!-- include these inline so we can style an match variables -->
<div class="diagrams">
<svg xmlns:svg="http://www.w3.org/2000/svg" xmlns="http://www.w3.org/2000/svg" version="1.0" width="10352" height="10352" preserveAspectRatio="xMidYMid meet" viewBox="0 0 10352 10352" alt="an eight-vertex complete graph"> 
<g style="fill:none;stroke-width:70">
<path d="M 7089,557 L 9795,7089 L 3263,9795 L 557,3263 L 7089,557 L 7089,9795 L 557,7089 L 3263,557 L 9795,3263 L 7089,9795 L 557,3263 L 9795,3263 L 3263,9795 L 3263,557 L 9795,7089 L 557,7089 L 7089,557 M 9795,7089 L 557,3263 M 3263,557 L 7089,9795 M 9795,3263 L 557,7089"/> 
<polyline points="6913,381 9619,3087 9619,6913 6913,9619 3087,9619 381,6913 381,3087 3087,381 6913,381 3087,9619" transform="translate(176,176)" />
</g>
<g style="fill:blue;stroke-width:70" transform="translate(2831,9505)">
<circle r="200" cx="419" cy="-8996"/> 
<circle r="200" cx="-2311" cy="-6258"/> 
<circle r="200" cx="-2314" cy="-2403"/> 
<circle r="200" cx="6999" cy="-2410"/> 
<circle r="200" cx="6999" cy="-6258"/> 
<circle r="200" cx="4266" cy="-8989"/> 
<circle r="200" cx="4257" cy="306"/> 
<circle r="200" cx="411" cy="315"/>
</g></svg>
<div>becomes</div>
<svg
   xmlns="http://www.w3.org/2000/svg"
   version="1.1"
   width="10352"
   height="10352"
   preserveAspectRatio="xMidYMid meet" viewBox="0 0 10352 10352"
   alt="a seven-spoke hub-spoke graph"
   id="hub-spoke-graph">
  <defs
     id="defs37" />
  <g
     style="fill:none;stroke-width:70"
     transform="translate(276, 300)"
     id="g32">
    <path
       style="fill:none;stroke-width:70;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1"
       d="M 113.08429,6113.9954 4982.533,4864.2096 9887.353,6125.7859"
       id="path848"/>
    <path
       style="fill:none;stroke-width:70;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1"
       d="m 4997.2126,1.63198 10.3317,4900.09452 -2180.0607,4597.941"
       id="path852"/>
    <path
       style="fill:none;stroke-width:70;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1"
       d="M 7216.7333,9562.1046 5010.9543,4876.7586"
       id="path854"/>
    <path
       style="fill:none;stroke-width:70;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1"
       d="M 1079.8998,1881.2301 5007.5443,4901.7265 8914.6424,1866.492"
       id="path850"/>
    <g
       style="fill:blue;stroke-width:70"
       id="g30">
      <circle
         cx="2831"
         cy="9505"
         r="200"
         id="circle14" />
      <circle
         cx="5000"
         cy="0"
         r="200"
         id="circle16" />
      <circle
         cx="8909"
         cy="1883"
         r="200"
         id="circle18" />
      <circle
         cx="9875"
         cy="6113"
         r="200"
         id="circle20" />
      <circle
         cx="7169"
         cy="9505"
         r="200"
         id="circle22" />
      <circle
         cx="2831"
         cy="9505"
         r="200"
         id="circle24" />
      <circle
         cx="125"
         cy="6113"
         r="200"
         id="circle26" />
      <circle
         cx="1091"
         cy="1883"
         r="200"
         id="circle28" />
      <circle
         id="circle41"
         r="200"
         cy="4876"
         cx="5000" />
    </g>
  </g>
</svg>
</div>
<p>如果我们必须在两个 non-hub 之间进行转换，则我们首先要进行转换到这个 hub 对应的版本，然后再转换到我们所需的版本：</p>
<div class="diagrams">
<svg alt="spoke to hub to spoke" version="1.1" width="1068" height="623" preserveAspectRation="xMidYMid meet" viewBox="120.0 120.0 1068.0 623.0" fill="none" stroke="none" stroke-linecap="square" stroke-miterlimit="10" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg"><g><path fill="#cfe2f3" d="m120.51706 436.18896l0 0c0 -35.49408 28.773636 -64.2677 64.267715 -64.2677l0 0c17.04486 0 33.3916 6.7710266 45.444138 18.823578c12.052536 12.052521 18.823578 28.399261 18.823578 45.444122l0 0c0 35.49408 -28.773636 64.26773 -64.267715 64.26773l0 0c-35.49408 0 -64.267715 -28.773651 -64.267715 -64.26773z" fill-rule="evenodd"/><path stroke="#000000" stroke-width="1.0" stroke-linejoin="round" stroke-linecap="butt" d="m120.51706 436.18896l0 0c0 -35.49408 28.773636 -64.2677 64.267715 -64.2677l0 0c17.04486 0 33.3916 6.7710266 45.444138 18.823578c12.052536 12.052521 18.823578 28.399261 18.823578 45.444122l0 0c0 35.49408 -28.773636 64.26773 -64.267715 64.26773l0 0c-35.49408 0 -64.267715 -28.773651 -64.267715 -64.26773z" fill-rule="evenodd"/><path fill="#000000" class="text invert" d="m172.06798 450.58896l-7.890625 -20.75l3.703125 0l4.453125 12.421875q0.71875 2.015625 1.328125 4.1875q0.46875 -1.640625 1.3125 -3.953125l4.609375 -12.65625l3.609375 0l-7.84375 20.75l-3.28125 0zm31.734375 -3.375l0 3.375l-18.921875 0q-0.046875 -1.265625 0.40625 -2.4375q0.71875 -1.9375 2.3125 -3.8125q1.59375 -1.875 4.59375 -4.34375q4.671875 -3.828125 6.3125 -6.0625q1.640625 -2.234375 1.640625 -4.21875q0 -2.09375 -1.5 -3.53125q-1.484375 -1.4375 -3.890625 -1.4375q-2.53125 0 -4.0625 1.53125q-1.515625 1.515625 -1.546875 4.21875l-3.609375 -0.375q0.375 -4.046875 2.796875 -6.15625q2.421875 -2.125 6.5 -2.125q4.125 0 6.515625 2.28125q2.40625 2.28125 2.40625 5.671875q0 1.71875 -0.703125 3.375q-0.703125 1.65625 -2.328125 3.5q-1.625 1.828125 -5.421875 5.03125q-3.15625 2.65625 -4.0625 3.609375q-0.890625 0.9375 -1.484375 1.90625l14.046875 0z" fill-rule="nonzero"/><path fill="#cfe2f3" d="m1060.3674 426.88452l0 0c0 -35.49408 28.773682 -64.26773 64.2677 -64.26773l0 0c17.044922 0 33.3916 6.771057 45.444214 18.823578c12.05249 12.052551 18.823486 28.399292 18.823486 45.444153l0 0c0 35.49408 -28.77356 64.2677 -64.2677 64.2677l0 0c-35.49402 0 -64.2677 -28.77362 -64.2677 -64.2677z" fill-rule="evenodd"/><path stroke="#000000" stroke-width="1.0" stroke-linejoin="round" stroke-linecap="butt" d="m1060.3674 426.88452l0 0c0 -35.49408 28.773682 -64.26773 64.2677 -64.26773l0 0c17.044922 0 33.3916 6.771057 45.444214 18.823578c12.05249 12.052551 18.823486 28.399292 18.823486 45.444153l0 0c0 35.49408 -28.77356 64.2677 -64.2677 64.2677l0 0c-35.49402 0 -64.2677 -28.77362 -64.2677 -64.2677z" fill-rule="evenodd"/><path fill="#000000" class="text invert" d="m1111.9183 441.28452l-7.890625 -20.75l3.703125 0l4.453125 12.421875q0.71875 2.015625 1.328125 4.1875q0.46875 -1.640625 1.3125 -3.953125l4.609375 -12.65625l3.609375 0l-7.84375 20.75l-3.28125 0zm13.28125 -7.5625l3.515625 -0.46875q0.59375 2.984375 2.046875 4.3125q1.46875 1.3125 3.546875 1.3125q2.484375 0 4.1875 -1.71875q1.71875 -1.71875 1.71875 -4.25q0 -2.421875 -1.59375 -4.0q-1.578125 -1.578125 -4.015625 -1.578125q-1.0 0 -2.484375 0.390625l0.390625 -3.078125q0.359375 0.03125 0.578125 0.03125q2.234375 0 4.03125 -1.171875q1.796875 -1.171875 1.796875 -3.609375q0 -1.9375 -1.3125 -3.203125q-1.296875 -1.265625 -3.375 -1.265625q-2.046875 0 -3.421875 1.296875q-1.359375 1.28125 -1.75 3.859375l-3.515625 -0.625q0.640625 -3.53125 2.921875 -5.46875q2.296875 -1.953125 5.6875 -1.953125q2.34375 0 4.3125 1.015625q1.984375 1.0 3.03125 2.734375q1.046875 1.734375 1.046875 3.6875q0 1.859375 -1.0 3.390625q-1.0 1.515625 -2.953125 2.40625q2.546875 0.59375 3.953125 2.4375q1.40625 1.84375 1.40625 4.625q0 3.75 -2.734375 6.359375q-2.734375 2.609375 -6.921875 2.609375q-3.765625 0 -6.265625 -2.25q-2.484375 -2.25 -2.828125 -5.828125z" fill-rule="nonzero"/><path fill="#cfe2f3" d="m575.7323 436.18896l0 0c0 -35.49408 28.77362 -64.2677 64.2677 -64.2677l0 0c17.04486 0 33.3916 6.7710266 45.444153 18.823578c12.05249 12.052521 18.823547 28.399261 18.823547 45.444122l0 0c0 35.49408 -28.77362 64.26773 -64.2677 64.26773l0 0c-35.49408 0 -64.2677 -28.773651 -64.2677 -64.26773z" fill-rule="evenodd"/><path stroke="#000000" stroke-width="1.0" stroke-linejoin="round" stroke-linecap="butt" d="m575.7323 436.18896l0 0c0 -35.49408 28.77362 -64.2677 64.2677 -64.2677l0 0c17.04486 0 33.3916 6.7710266 45.444153 18.823578c12.05249 12.052521 18.823547 28.399261 18.823547 45.444122l0 0c0 35.49408 -28.77362 64.26773 -64.2677 64.26773l0 0c-35.49408 0 -64.2677 -28.773651 -64.2677 -64.26773z" fill-rule="evenodd"/><path fill="#000000" class="text invert" d="m627.2832 450.58896l-7.890625 -20.75l3.703125 0l4.453125 12.421875q0.71875 2.015625 1.328125 4.1875q0.46875 -1.640625 1.3125 -3.953125l4.609375 -12.65625l3.609375 0l-7.84375 20.75l-3.28125 0zm26.5 0l-3.515625 0l0 -22.40625q-1.265625 1.21875 -3.328125 2.4375q-2.0625 1.203125 -3.703125 1.796875l0 -3.390625q2.953125 -1.390625 5.15625 -3.359375q2.203125 -1.96875 3.125 -3.828125l2.265625 0l0 28.75z" fill-rule="nonzero"/><path fill="#000000" fill-opacity="0.0" d="m249.05249 436.18896l326.6772 0" fill-rule="evenodd"/><path stroke="#000000" stroke-width="1.0" stroke-linejoin="round" stroke-linecap="butt" d="m249.05249 436.18896l326.6772 0" fill-rule="evenodd"/><path fill="#000000" fill-opacity="0.0" d="m704.2677 436.18896l356.09448 -9.291321" fill-rule="evenodd"/><path stroke="#000000" stroke-width="1.0" stroke-linejoin="round" stroke-linecap="butt" d="m704.2677 436.18896l356.09448 -9.291321" fill-rule="evenodd"/><path fill="#000000" class="text" transform="translate(0, 8)" d="m495.57812 348.6966l2.859375 -0.25q0.203125 1.71875 0.9375 2.828125q0.75 1.09375 2.3125 1.78125q1.5625 0.671875 3.515625 0.671875q1.734375 0 3.0625 -0.515625q1.328125 -0.515625 1.96875 -1.40625q0.65625 -0.90625 0.65625 -1.96875q0 -1.078125 -0.625 -1.875q-0.625 -0.8125 -2.0625 -1.359375q-0.921875 -0.359375 -4.078125 -1.109375q-3.15625 -0.765625 -4.421875 -1.4375q-1.640625 -0.859375 -2.453125 -2.125q-0.796875 -1.28125 -0.796875 -2.859375q0 -1.734375 0.984375 -3.234375q0.984375 -1.515625 2.875 -2.296875q1.890625 -0.78125 4.203125 -0.78125q2.546875 0 4.484375 0.828125q1.953125 0.8125 3.0 2.40625q1.046875 1.59375 1.125 3.609375l-2.90625 0.21875q-0.234375 -2.171875 -1.59375 -3.28125q-1.34375 -1.109375 -3.984375 -1.109375q-2.75 0 -4.015625 1.015625q-1.25 1.0 -1.25 2.421875q0 1.234375 0.890625 2.03125q0.875 0.796875 4.5625 1.640625q3.703125 0.828125 5.078125 1.453125q2.0 0.921875 2.953125 2.34375q0.953125 1.40625 0.953125 3.25q0 1.828125 -1.046875 3.453125q-1.046875 1.609375 -3.015625 2.515625q-1.953125 0.890625 -4.40625 0.890625q-3.109375 0 -5.21875 -0.90625q-2.09375 -0.90625 -3.296875 -2.71875q-1.1875 -1.828125 -1.25 -4.125zm28.15625 4.84375l0.40625 2.484375q-1.1875 0.25 -2.125 0.25q-1.53125 0 -2.375 -0.484375q-0.84375 -0.484375 -1.1875 -1.265625q-0.34375 -0.796875 -0.34375 -3.328125l0 -9.546875l-2.0625 0l0 -2.1875l2.0625 0l0 -4.109375l2.796875 -1.6875l0 5.796875l2.828125 0l0 2.1875l-2.828125 0l0 9.703125q0 1.203125 0.140625 1.546875q0.15625 0.34375 0.484375 0.546875q0.34375 0.203125 0.96875 0.203125q0.46875 0 1.234375 -0.109375zm1.703125 -5.78125q0 -4.609375 2.5625 -6.828125q2.140625 -1.84375 5.21875 -1.84375q3.421875 0 5.59375 2.25q2.171875 2.234375 2.171875 6.1875q0 3.203125 -0.96875 5.046875q-0.953125 1.828125 -2.796875 2.84375q-1.828125 1.015625 -4.0 1.015625q-3.484375 0 -5.640625 -2.234375q-2.140625 -2.234375 -2.140625 -6.4375zm2.890625 0q0 3.1875 1.390625 4.78125q1.390625 1.578125 3.5 1.578125q2.09375 0 3.484375 -1.59375q1.390625 -1.59375 1.390625 -4.859375q0 -3.078125 -1.40625 -4.65625q-1.390625 -1.59375 -3.46875 -1.59375q-2.109375 0 -3.5 1.578125q-1.390625 1.578125 -1.390625 4.765625zm15.921875 8.296875l0 -16.59375l2.53125 0l0 2.515625q0.96875 -1.765625 1.78125 -2.328125q0.828125 -0.5625 1.8125 -0.5625q1.421875 0 2.890625 0.90625l-0.96875 2.609375q-1.03125 -0.609375 -2.0625 -0.609375q-0.921875 0 -1.65625 0.5625q-0.734375 0.546875 -1.046875 1.53125q-0.46875 1.5 -0.46875 3.28125l0 8.6875l-2.8125 0zm21.515625 -2.046875q-1.5625 1.328125 -3.015625 1.875q-1.4375 0.546875 -3.09375 0.546875q-2.734375 0 -4.203125 -1.328125q-1.46875 -1.34375 -1.46875 -3.421875q0 -1.21875 0.546875 -2.21875q0.5625 -1.015625 1.453125 -1.625q0.90625 -0.609375 2.03125 -0.921875q0.828125 -0.21875 2.5 -0.421875q3.40625 -0.40625 5.015625 -0.96875q0.015625 -0.578125 0.015625 -0.734375q0 -1.71875 -0.796875 -2.421875q-1.078125 -0.953125 -3.203125 -0.953125q-1.984375 0 -2.9375 0.703125q-0.9375 0.6875 -1.390625 2.453125l-2.75 -0.375q0.375 -1.765625 1.234375 -2.84375q0.859375 -1.09375 2.484375 -1.671875q1.625 -0.59375 3.765625 -0.59375q2.125 0 3.453125 0.5q1.328125 0.5 1.953125 1.265625q0.625 0.75 0.875 1.90625q0.140625 0.71875 0.140625 2.59375l0 3.75q0 3.921875 0.171875 4.96875q0.1875 1.03125 0.71875 1.984375l-2.9375 0q-0.4375 -0.875 -0.5625 -2.046875zm-0.234375 -6.28125q-1.53125 0.625 -4.59375 1.0625q-1.734375 0.25 -2.453125 0.5625q-0.71875 0.3125 -1.109375 0.921875q-0.390625 0.59375 -0.390625 1.328125q0 1.125 0.84375 1.875q0.859375 0.75 2.5 0.75q1.625 0 2.890625 -0.703125q1.265625 -0.71875 1.859375 -1.953125q0.453125 -0.953125 0.453125 -2.8125l0 -1.03125zm6.6875 9.703125l2.734375 0.40625q0.171875 1.265625 0.953125 1.84375q1.046875 0.78125 2.859375 0.78125q1.953125 0 3.015625 -0.78125q1.0625 -0.78125 1.4375 -2.1875q0.21875 -0.859375 0.203125 -3.609375q-1.84375 2.171875 -4.59375 2.171875q-3.421875 0 -5.296875 -2.46875q-1.875 -2.46875 -1.875 -5.921875q0 -2.375 0.859375 -4.375q0.859375 -2.015625 2.484375 -3.109375q1.640625 -1.09375 3.84375 -1.09375q2.9375 0 4.84375 2.375l0 -2.0l2.59375 0l0 14.34375q0 3.875 -0.796875 5.484375q-0.78125 1.625 -2.5 2.5625q-1.703125 0.9375 -4.203125 0.9375q-2.96875 0 -4.796875 -1.34375q-1.828125 -1.328125 -1.765625 -4.015625zm2.328125 -9.96875q0 3.265625 1.296875 4.765625q1.296875 1.5 3.25 1.5q1.9375 0 3.25 -1.484375q1.3125 -1.5 1.3125 -4.6875q0 -3.046875 -1.359375 -4.59375q-1.34375 -1.546875 -3.25 -1.546875q-1.875 0 -3.1875 1.53125q-1.3125 1.515625 -1.3125 4.515625zm27.34375 3.25l2.90625 0.359375q-0.6875 2.546875 -2.546875 3.953125q-1.859375 1.40625 -4.75 1.40625q-3.640625 0 -5.78125 -2.234375q-2.125 -2.25 -2.125 -6.296875q0 -4.1875 2.15625 -6.5q2.15625 -2.3125 5.59375 -2.3125q3.328125 0 5.4375 2.265625q2.109375 2.265625 2.109375 6.375q0 0.25 -0.015625 0.75l-12.375 0q0.15625 2.734375 1.546875 4.1875q1.390625 1.453125 3.46875 1.453125q1.546875 0 2.640625 -0.8125q1.09375 -0.8125 1.734375 -2.59375zm-9.234375 -4.546875l9.265625 0q-0.1875 -2.09375 -1.0625 -3.140625q-1.34375 -1.625 -3.484375 -1.625q-1.9375 0 -3.265625 1.296875q-1.3125 1.296875 -1.453125 3.46875zm13.5625 10.28125l6.640625 -23.6875l2.25 0l-6.625 23.6875l-2.265625 0zm11.453125 -0.390625l0 -22.90625l3.03125 0l0 9.40625l11.90625 0l0 -9.40625l3.03125 0l0 22.90625l-3.03125 0l0 -10.796875l-11.90625 0l0 10.796875l-3.03125 0zm33.53125 0l0 -2.4375q-1.9375 2.8125 -5.265625 2.8125q-1.46875 0 -2.75 -0.5625q-1.265625 -0.5625 -1.890625 -1.40625q-0.609375 -0.859375 -0.859375 -2.09375q-0.171875 -0.828125 -0.171875 -2.625l0 -10.28125l2.8125 0l0 9.203125q0 2.203125 0.171875 2.96875q0.265625 1.109375 1.125 1.75q0.859375 0.625 2.125 0.625q1.265625 0 2.375 -0.640625q1.109375 -0.65625 1.5625 -1.765625q0.46875 -1.125 0.46875 -3.25l0 -8.890625l2.8125 0l0 16.59375l-2.515625 0zm9.515625 0l-2.609375 0l0 -22.90625l2.8125 0l0 8.171875q1.78125 -2.234375 4.546875 -2.234375q1.53125 0 2.890625 0.625q1.375 0.609375 2.25 1.734375q0.890625 1.109375 1.390625 2.6875q0.5 1.578125 0.5 3.375q0 4.265625 -2.109375 6.59375q-2.109375 2.328125 -5.0625 2.328125q-2.9375 0 -4.609375 -2.453125l0 2.078125zm-0.03125 -8.421875q0 2.984375 0.8125 4.3125q1.328125 2.171875 3.59375 2.171875q1.84375 0 3.1875 -1.59375q1.34375 -1.609375 1.34375 -4.78125q0 -3.25 -1.296875 -4.796875q-1.28125 -1.546875 -3.109375 -1.546875q-1.84375 0 -3.1875 1.609375q-1.34375 1.59375 -1.34375 4.625zm28.734375 8.421875l-6.3125 -16.59375l2.96875 0l3.5625 9.9375q0.578125 1.609375 1.0625 3.34375q0.375 -1.3125 1.046875 -3.15625l3.6875 -10.125l2.890625 0l-6.28125 16.59375l-2.625 0zm22.75 -5.34375l2.90625 0.359375q-0.6875 2.546875 -2.546875 3.953125q-1.859375 1.40625 -4.75 1.40625q-3.640625 0 -5.78125 -2.234375q-2.125 -2.25 -2.125 -6.296875q0 -4.1875 2.15625 -6.5q2.15625 -2.3125 5.59375 -2.3125q3.328125 0 5.4375 2.265625q2.109375 2.265625 2.109375 6.375q0 0.25 -0.015625 0.75l-12.375 0q0.15625 2.734375 1.546875 4.1875q1.390625 1.453125 3.46875 1.453125q1.546875 0 2.640625 -0.8125q1.09375 -0.8125 1.734375 -2.59375zm-9.234375 -4.546875l9.265625 0q-0.1875 -2.09375 -1.0625 -3.140625q-1.34375 -1.625 -3.484375 -1.625q-1.9375 0 -3.265625 1.296875q-1.3125 1.296875 -1.453125 3.46875zm15.640625 9.890625l0 -16.59375l2.53125 0l0 2.515625q0.96875 -1.765625 1.78125 -2.328125q0.828125 -0.5625 1.8125 -0.5625q1.421875 0 2.890625 0.90625l-0.96875 2.609375q-1.03125 -0.609375 -2.0625 -0.609375q-0.921875 0 -1.65625 0.5625q-0.734375 0.546875 -1.046875 1.53125q-0.46875 1.5 -0.46875 3.28125l0 8.6875l-2.8125 0zm9.5625 -4.953125l2.78125 -0.4375q0.234375 1.671875 1.296875 2.5625q1.078125 0.890625 3.0 0.890625q1.9375 0 2.875 -0.78125q0.9375 -0.796875 0.9375 -1.859375q0 -0.953125 -0.828125 -1.5q-0.578125 -0.375 -2.875 -0.953125q-3.09375 -0.78125 -4.296875 -1.34375q-1.1875 -0.578125 -1.8125 -1.578125q-0.609375 -1.015625 -0.609375 -2.234375q0 -1.109375 0.5 -2.046875q0.515625 -0.953125 1.390625 -1.578125q0.65625 -0.484375 1.78125 -0.8125q1.140625 -0.34375 2.4375 -0.34375q1.953125 0 3.421875 0.5625q1.484375 0.5625 2.1875 1.53125q0.703125 0.953125 0.96875 2.5625l-2.75 0.375q-0.1875 -1.28125 -1.09375 -2.0q-0.890625 -0.71875 -2.53125 -0.71875q-1.9375 0 -2.765625 0.640625q-0.828125 0.640625 -0.828125 1.5q0 0.546875 0.34375 0.984375q0.34375 0.453125 1.078125 0.75q0.421875 0.15625 2.484375 0.71875q2.984375 0.796875 4.15625 1.3125q1.1875 0.5 1.859375 1.46875q0.671875 0.96875 0.671875 2.40625q0 1.40625 -0.828125 2.65625q-0.8125 1.234375 -2.359375 1.921875q-1.546875 0.671875 -3.5 0.671875q-3.234375 0 -4.9375 -1.34375q-1.6875 -1.34375 -2.15625 -3.984375zm17.140625 -14.71875l0 -3.234375l2.8125 0l0 3.234375l-2.8125 0zm0 19.671875l0 -16.59375l2.8125 0l0 16.59375l-2.8125 0zm6.046875 -8.296875q0 -4.609375 2.5625 -6.828125q2.140625 -1.84375 5.21875 -1.84375q3.421875 0 5.59375 2.25q2.171875 2.234375 2.171875 6.1875q0 3.203125 -0.96875 5.046875q-0.953125 1.828125 -2.796875 2.84375q-1.828125 1.015625 -4.0 1.015625q-3.484375 0 -5.640625 -2.234375q-2.140625 -2.234375 -2.140625 -6.4375zm2.890625 0q0 3.1875 1.390625 4.78125q1.390625 1.578125 3.5 1.578125q2.09375 0 3.484375 -1.59375q1.390625 -1.59375 1.390625 -4.859375q0 -3.078125 -1.40625 -4.65625q-1.390625 -1.59375 -3.46875 -1.59375q-2.109375 0 -3.5 1.578125q-1.390625 1.578125 -1.390625 4.765625zm15.953125 8.296875l0 -16.59375l2.53125 0l0 2.359375q1.828125 -2.734375 5.28125 -2.734375q1.5 0 2.75 0.546875q1.265625 0.53125 1.890625 1.40625q0.625 0.875 0.875 2.078125q0.15625 0.78125 0.15625 2.734375l0 10.203125l-2.8125 0l0 -10.09375q0 -1.71875 -0.328125 -2.5625q-0.328125 -0.859375 -1.171875 -1.359375q-0.828125 -0.515625 -1.953125 -0.515625q-1.796875 0 -3.109375 1.140625q-1.296875 1.140625 -1.296875 4.328125l0 9.0625l-2.8125 0z" fill-rule="nonzero"/><path fill="#cfe2f3" d="m619.48816 332.5013l-46.907715 -39.92914l19.9646 0l0 0c-25.05365 -70.51779 -112.57651 -119.7874 -212.7911 -119.7874l39.92914 0l0 0c100.21457 0 187.73746 49.269608 212.7911 119.7874l19.964539 0z" fill-rule="evenodd"/><path fill="#a5b4c2" d="m399.7185 173.44518l0 0c-113.16971 7.5024567 -199.80511 76.46913 -199.80511 159.05614l-39.92914 0l0 0c0 -44.88263 25.985397 -87.693954 71.59561 -117.95491c45.61023 -30.260956 106.63559 -45.178513 168.13864 -41.101227z" fill-rule="evenodd"/><path fill="#000000" fill-opacity="0.0" d="m399.7185 173.44518l0 0c-113.16971 7.5024567 -199.80511 76.46913 -199.80511 159.05614l-39.92914 0l0 0c0 -88.209 98.394226 -159.71654 219.76968 -159.71654l39.92914 0l0 0c100.21457 0 187.73746 49.269608 212.7911 119.7874l19.964539 0l-32.95056 39.92914l-46.907715 -39.92914l19.9646 0l0 0c-25.05365 -70.51779 -112.57651 -119.7874 -212.7911 -119.7874" fill-rule="evenodd"/><path stroke="#000000" stroke-width="1.0" stroke-linejoin="round" stroke-linecap="butt" d="m399.7185 173.44518l0 0c-113.16971 7.5024567 -199.80511 76.46913 -199.80511 159.05614l-39.92914 0l0 0c0 -88.209 98.394226 -159.71654 219.76968 -159.71654l39.92914 0l0 0c100.21457 0 187.73746 49.269608 212.7911 119.7874l19.964539 0l-32.95056 39.92914l-46.907715 -39.92914l19.9646 0l0 0c-25.05365 -70.51779 -112.57651 -119.7874 -212.7911 -119.7874" fill-rule="evenodd"/><path fill="#cfe2f3" d="m683.3543 523.43304l47.112305 39.92914l-19.9646 0c25.787903 70.51782 115.875854 119.787415 219.02753 119.787415l-39.92914 0l0 0c-103.15167 0 -193.23962 -49.269592 -219.02753 -119.787415l-19.964539 0z" fill-rule="evenodd"/><path fill="#a5b4c2" d="m909.56494 682.52637l0 0c116.73816 -7.3029175 206.2461 -76.34723 206.2461 -159.09332l39.929077 0l0 0c0 44.810425 -26.661255 87.559814 -73.47705 117.815c-46.815796 30.255249 -109.479614 45.233093 -172.69812 41.27832z" fill-rule="evenodd"/><path fill="#000000" fill-opacity="0.0" d="m909.56494 682.52637l0 0c116.73816 -7.3029175 206.2461 -76.34723 206.2461 -159.09332l39.929077 0l0 0c0 88.209045 -101.277954 159.71655 -226.21057 159.71655l-39.92914 0l0 0c-103.15167 0 -193.23962 -49.269592 -219.02753 -119.787415l-19.964539 0l32.74597 -39.92914l47.112305 39.92914l-19.9646 0c25.787903 70.51782 115.875854 119.787415 219.02753 119.787415" fill-rule="evenodd"/><path stroke="#000000" stroke-width="1.0" stroke-linejoin="round" stroke-linecap="butt" d="m909.56494 682.52637l0 0c116.73816 -7.3029175 206.2461 -76.34723 206.2461 -159.09332l39.929077 0l0 0c0 88.209045 -101.277954 159.71655 -226.21057 159.71655l-39.92914 0l0 0c-103.15167 0 -193.23962 -49.269592 -219.02753 -119.787415l-19.964539 0l32.74597 -39.92914l47.112305 39.92914l-19.9646 0c25.787903 70.51782 115.875854 119.787415 219.02753 119.787415" fill-rule="evenodd"/><path fill="#000000" class="text" d="m693.13855 139.93547l3.03125 0.765625q-0.953125 3.734375 -3.4375 5.703125q-2.46875 1.953125 -6.046875 1.953125q-3.703125 0 -6.03125 -1.5q-2.3125 -1.515625 -3.53125 -4.375q-1.203125 -2.859375 -1.203125 -6.140625q0 -3.578125 1.359375 -6.234375q1.375 -2.671875 3.890625 -4.046875q2.53125 -1.390625 5.5625 -1.390625q3.4375 0 5.78125 1.75q2.34375 1.75 3.265625 4.921875l-2.984375 0.703125q-0.796875 -2.5 -2.3125 -3.640625q-1.515625 -1.140625 -3.8125 -1.140625q-2.640625 0 -4.421875 1.265625q-1.765625 1.265625 -2.484375 3.40625q-0.71875 2.125 -0.71875 4.390625q0 2.921875 0.84375 5.109375q0.859375 2.171875 2.65625 3.25q1.796875 1.078125 3.890625 1.078125q2.546875 0 4.3125 -1.46875q1.765625 -1.46875 2.390625 -4.359375zm5.359375 -0.265625q0 -4.609375 2.5625 -6.828125q2.140625 -1.84375 5.21875 -1.84375q3.421875 0 5.59375 2.25q2.171875 2.234375 2.171875 6.1875q0 3.203125 -0.96875 5.046875q-0.953125 1.828125 -2.796875 2.84375q-1.828125 1.015625 -4.0 1.015625q-3.484375 0 -5.640625 -2.234375q-2.140625 -2.234375 -2.140625 -6.4375zm2.890625 0q0 3.1875 1.390625 4.78125q1.390625 1.578125 3.5 1.578125q2.09375 0 3.484375 -1.59375q1.390625 -1.59375 1.390625 -4.859375q0 -3.078125 -1.40625 -4.65625q-1.390625 -1.59375 -3.46875 -1.59375q-2.109375 0 -3.5 1.578125q-1.390625 1.578125 -1.390625 4.765625zm15.953125 8.296875l0 -16.59375l2.53125 0l0 2.359375q1.828125 -2.734375 5.28125 -2.734375q1.5 0 2.75 0.546875q1.265625 0.53125 1.890625 1.40625q0.625 0.875 0.875 2.078125q0.15625 0.78125 0.15625 2.734375l0 10.203125l-2.8125 0l0 -10.09375q0 -1.71875 -0.328125 -2.5625q-0.328125 -0.859375 -1.171875 -1.359375q-0.828125 -0.515625 -1.953125 -0.515625q-1.796875 0 -3.109375 1.140625q-1.296875 1.140625 -1.296875 4.328125l0 9.0625l-2.8125 0zm22.40625 0l-6.3125 -16.59375l2.96875 0l3.5625 9.9375q0.578125 1.609375 1.0625 3.34375q0.375 -1.3125 1.046875 -3.15625l3.6875 -10.125l2.890625 0l-6.28125 16.59375l-2.625 0zm22.75 -5.34375l2.90625 0.359375q-0.6875 2.546875 -2.546875 3.953125q-1.859375 1.40625 -4.75 1.40625q-3.640625 0 -5.78125 -2.234375q-2.125 -2.25 -2.125 -6.296875q0 -4.1875 2.15625 -6.5q2.15625 -2.3125 5.59375 -2.3125q3.328125 0 5.4375 2.265625q2.109375 2.265625 2.109375 6.375q0 0.25 -0.015625 0.75l-12.375 0q0.15625 2.734375 1.546875 4.1875q1.390625 1.453125 3.46875 1.453125q1.546875 0 2.640625 -0.8125q1.09375 -0.8125 1.734375 -2.59375zm-9.234375 -4.546875l9.265625 0q-0.1875 -2.09375 -1.0625 -3.140625q-1.34375 -1.625 -3.484375 -1.625q-1.9375 0 -3.265625 1.296875q-1.3125 1.296875 -1.453125 3.46875zm15.640625 9.890625l0 -16.59375l2.53125 0l0 2.515625q0.96875 -1.765625 1.78125 -2.328125q0.828125 -0.5625 1.8125 -0.5625q1.421875 0 2.890625 0.90625l-0.96875 2.609375q-1.03125 -0.609375 -2.0625 -0.609375q-0.921875 0 -1.65625 0.5625q-0.734375 0.546875 -1.046875 1.53125q-0.46875 1.5 -0.46875 3.28125l0 8.6875l-2.8125 0zm16.828125 -2.515625l0.40625 2.484375q-1.1875 0.25 -2.125 0.25q-1.53125 0 -2.375 -0.484375q-0.84375 -0.484375 -1.1875 -1.265625q-0.34375 -0.796875 -0.34375 -3.328125l0 -9.546875l-2.0625 0l0 -2.1875l2.0625 0l0 -4.109375l2.796875 -1.6875l0 5.796875l2.828125 0l0 2.1875l-2.828125 0l0 9.703125q0 1.203125 0.140625 1.546875q0.15625 0.34375 0.484375 0.546875q0.34375 0.203125 0.96875 0.203125q0.46875 0 1.234375 -0.109375zm3.265625 2.515625l0 -22.90625l15.453125 0l0 2.703125l-12.421875 0l0 7.09375l10.75 0l0 2.703125l-10.75 0l0 10.40625l-3.03125 0zm19.0 0l0 -16.59375l2.53125 0l0 2.515625q0.96875 -1.765625 1.78125 -2.328125q0.828125 -0.5625 1.8125 -0.5625q1.421875 0 2.890625 0.90625l-0.96875 2.609375q-1.03125 -0.609375 -2.0625 -0.609375q-0.921875 0 -1.65625 0.5625q-0.734375 0.546875 -1.046875 1.53125q-0.46875 1.5 -0.46875 3.28125l0 8.6875l-2.8125 0zm9.640625 -8.296875q0 -4.609375 2.5625 -6.828125q2.140625 -1.84375 5.21875 -1.84375q3.421875 0 5.59375 2.25q2.171875 2.234375 2.171875 6.1875q0 3.203125 -0.96875 5.046875q-0.953125 1.828125 -2.796875 2.84375q-1.828125 1.015625 -4.0 1.015625q-3.484375 0 -5.640625 -2.234375q-2.140625 -2.234375 -2.140625 -6.4375zm2.890625 0q0 3.1875 1.390625 4.78125q1.390625 1.578125 3.5 1.578125q2.09375 0 3.484375 -1.59375q1.390625 -1.59375 1.390625 -4.859375q0 -3.078125 -1.40625 -4.65625q-1.390625 -1.59375 -3.46875 -1.59375q-2.109375 0 -3.5 1.578125q-1.390625 1.578125 -1.390625 4.765625zm15.953125 8.296875l0 -16.59375l2.515625 0l0 2.328125q0.78125 -1.21875 2.078125 -1.953125q1.296875 -0.75 2.953125 -0.75q1.84375 0 3.015625 0.765625q1.1875 0.765625 1.671875 2.140625q1.96875 -2.90625 5.125 -2.90625q2.46875 0 3.796875 1.375q1.328125 1.359375 1.328125 4.203125l0 11.390625l-2.796875 0l0 -10.453125q0 -1.6875 -0.28125 -2.421875q-0.265625 -0.75 -0.984375 -1.203125q-0.71875 -0.453125 -1.6875 -0.453125q-1.75 0 -2.90625 1.171875q-1.15625 1.15625 -1.15625 3.71875l0 9.640625l-2.8125 0l0 -10.78125q0 -1.875 -0.6875 -2.8125q-0.6875 -0.9375 -2.25 -0.9375q-1.1875 0 -2.203125 0.625q-1.0 0.625 -1.453125 1.828125q-0.453125 1.203125 -0.453125 3.46875l0 8.609375l-2.8125 0zm32.03125 6.734375q-2.328125 -2.9375 -3.9375 -6.875q-1.609375 -3.9375 -1.609375 -8.15625q0 -3.71875 1.203125 -7.125q1.40625 -3.953125 4.34375 -7.875l2.015625 0q-1.890625 3.25 -2.5 4.640625q-0.953125 2.15625 -1.5 4.5q-0.671875 2.921875 -0.671875 5.875q0 7.515625 4.671875 15.015625l-2.015625 0zm7.125 0l-2.015625 0q4.671875 -7.5 4.671875 -15.015625q0 -2.9375 -0.671875 -5.828125q-0.53125 -2.34375 -1.484375 -4.5q-0.609375 -1.40625 -2.515625 -4.6875l2.015625 0q2.9375 3.921875 4.34375 7.875q1.203125 3.40625 1.203125 7.125q0 4.21875 -1.625 8.15625q-1.609375 3.9375 -3.921875 6.875zm17.703125 -6.734375l0 -16.59375l2.515625 0l0 2.328125q0.78125 -1.21875 2.078125 -1.953125q1.296875 -0.75 2.953125 -0.75q1.84375 0 3.015625 0.765625q1.1875 0.765625 1.671875 2.140625q1.96875 -2.90625 5.125 -2.90625q2.46875 0 3.796875 1.375q1.328125 1.359375 1.328125 4.203125l0 11.390625l-2.796875 0l0 -10.453125q0 -1.6875 -0.28125 -2.421875q-0.265625 -0.75 -0.984375 -1.203125q-0.71875 -0.453125 -1.6875 -0.453125q-1.75 0 -2.90625 1.171875q-1.15625 1.15625 -1.15625 3.71875l0 9.640625l-2.8125 0l0 -10.78125q0 -1.875 -0.6875 -2.8125q-0.6875 -0.9375 -2.25 -0.9375q-1.1875 0 -2.203125 0.625q-1.0 0.625 -1.453125 1.828125q-0.453125 1.203125 -0.453125 3.46875l0 8.609375l-2.8125 0zm38.015625 -5.34375l2.90625 0.359375q-0.6875 2.546875 -2.546875 3.953125q-1.859375 1.40625 -4.75 1.40625q-3.640625 0 -5.78125 -2.234375q-2.125 -2.25 -2.125 -6.296875q0 -4.1875 2.15625 -6.5q2.15625 -2.3125 5.59375 -2.3125q3.328125 0 5.4375 2.265625q2.109375 2.265625 2.109375 6.375q0 0.25 -0.015625 0.75l-12.375 0q0.15625 2.734375 1.546875 4.1875q1.390625 1.453125 3.46875 1.453125q1.546875 0 2.640625 -0.8125q1.09375 -0.8125 1.734375 -2.59375zm-9.234375 -4.546875l9.265625 0q-0.1875 -2.09375 -1.0625 -3.140625q-1.34375 -1.625 -3.484375 -1.625q-1.9375 0 -3.265625 1.296875q-1.3125 1.296875 -1.453125 3.46875zm21.8125 7.375l0.40625 2.484375q-1.1875 0.25 -2.125 0.25q-1.53125 0 -2.375 -0.484375q-0.84375 -0.484375 -1.1875 -1.265625q-0.34375 -0.796875 -0.34375 -3.328125l0 -9.546875l-2.0625 0l0 -2.1875l2.0625 0l0 -4.109375l2.796875 -1.6875l0 5.796875l2.828125 0l0 2.1875l-2.828125 0l0 9.703125q0 1.203125 0.140625 1.546875q0.15625 0.34375 0.484375 0.546875q0.34375 0.203125 0.96875 0.203125q0.46875 0 1.234375 -0.109375zm2.75 2.515625l0 -22.90625l2.8125 0l0 8.21875q1.96875 -2.28125 4.96875 -2.28125q1.84375 0 3.203125 0.734375q1.359375 0.71875 1.9375 2.0q0.59375 1.28125 0.59375 3.71875l0 10.515625l-2.8125 0l0 -10.515625q0 -2.109375 -0.921875 -3.0625q-0.90625 -0.96875 -2.578125 -0.96875q-1.25 0 -2.359375 0.65625q-1.09375 0.640625 -1.5625 1.75q-0.46875 1.109375 -0.46875 3.0625l0 9.078125l-2.8125 0zm16.75 -8.296875q0 -4.609375 2.5625 -6.828125q2.140625 -1.84375 5.21875 -1.84375q3.421875 0 5.59375 2.25q2.171875 2.234375 2.171875 6.1875q0 3.203125 -0.96875 5.046875q-0.953125 1.828125 -2.796875 2.84375q-1.828125 1.015625 -4.0 1.015625q-3.484375 0 -5.640625 -2.234375q-2.140625 -2.234375 -2.140625 -6.4375zm2.890625 0q0 3.1875 1.390625 4.78125q1.390625 1.578125 3.5 1.578125q2.09375 0 3.484375 -1.59375q1.390625 -1.59375 1.390625 -4.859375q0 -3.078125 -1.40625 -4.65625q-1.390625 -1.59375 -3.46875 -1.59375q-2.109375 0 -3.5 1.578125q-1.390625 1.578125 -1.390625 4.765625zm26.71875 8.296875l0 -2.09375q-1.578125 2.46875 -4.640625 2.46875q-1.984375 0 -3.65625 -1.09375q-1.65625 -1.09375 -2.578125 -3.046875q-0.90625 -1.96875 -0.90625 -4.515625q0 -2.484375 0.828125 -4.5q0.828125 -2.03125 2.484375 -3.109375q1.65625 -1.078125 3.703125 -1.078125q1.5 0 2.671875 0.640625q1.171875 0.625 1.90625 1.640625l0 -8.21875l2.796875 0l0 22.90625l-2.609375 0zm-8.890625 -8.28125q0 3.1875 1.34375 4.765625q1.34375 1.578125 3.171875 1.578125q1.84375 0 3.125 -1.5q1.296875 -1.515625 1.296875 -4.609375q0 -3.40625 -1.3125 -5.0q-1.3125 -1.59375 -3.234375 -1.59375q-1.875 0 -3.140625 1.53125q-1.25 1.53125 -1.25 4.828125zm23.765625 -0.015625q0 -4.609375 2.5625 -6.828125q2.140625 -1.84375 5.21875 -1.84375q3.421875 0 5.59375 2.25q2.171875 2.234375 2.171875 6.1875q0 3.203125 -0.96875 5.046875q-0.953125 1.828125 -2.796875 2.84375q-1.828125 1.015625 -4.0 1.015625q-3.484375 0 -5.640625 -2.234375q-2.140625 -2.234375 -2.140625 -6.4375zm2.890625 0q0 3.1875 1.390625 4.78125q1.390625 1.578125 3.5 1.578125q2.09375 0 3.484375 -1.59375q1.390625 -1.59375 1.390625 -4.859375q0 -3.078125 -1.40625 -4.65625q-1.390625 -1.59375 -3.46875 -1.59375q-2.109375 0 -3.5 1.578125q-1.390625 1.578125 -1.390625 4.765625zm15.953125 8.296875l0 -16.59375l2.53125 0l0 2.359375q1.828125 -2.734375 5.28125 -2.734375q1.5 0 2.75 0.546875q1.265625 0.53125 1.890625 1.40625q0.625 0.875 0.875 2.078125q0.15625 0.78125 0.15625 2.734375l0 10.203125l-2.8125 0l0 -10.09375q0 -1.71875 -0.328125 -2.5625q-0.328125 -0.859375 -1.171875 -1.359375q-0.828125 -0.515625 -1.953125 -0.515625q-1.796875 0 -3.109375 1.140625q-1.296875 1.140625 -1.296875 4.328125l0 9.0625l-2.8125 0zm31.296875 0l-6.3125 -16.59375l2.96875 0l3.5625 9.9375q0.578125 1.609375 1.0625 3.34375q0.375 -1.3125 1.046875 -3.15625l3.6875 -10.125l2.890625 0l-6.28125 16.59375l-2.625 0zm10.625 -6.046875l2.8125 -0.375q0.484375 2.390625 1.640625 3.453125q1.171875 1.046875 2.84375 1.046875q1.984375 0 3.34375 -1.375q1.375 -1.375 1.375 -3.40625q0 -1.9375 -1.265625 -3.1875q-1.265625 -1.265625 -3.21875 -1.265625q-0.796875 0 -1.984375 0.3125l0.3125 -2.46875q0.28125 0.03125 0.453125 0.03125q1.796875 0 3.234375 -0.9375q1.4375 -0.9375 1.4375 -2.890625q0 -1.546875 -1.046875 -2.5625q-1.046875 -1.015625 -2.703125 -1.015625q-1.640625 0 -2.734375 1.03125q-1.09375 1.03125 -1.40625 3.09375l-2.8125 -0.5q0.515625 -2.828125 2.34375 -4.375q1.828125 -1.5625 4.546875 -1.5625q1.875 0 3.453125 0.8125q1.578125 0.796875 2.40625 2.1875q0.84375 1.390625 0.84375 2.953125q0 1.484375 -0.796875 2.703125q-0.796875 1.21875 -2.359375 1.9375q2.03125 0.46875 3.15625 1.953125q1.125 1.46875 1.125 3.6875q0 3.0 -2.1875 5.09375q-2.1875 2.078125 -5.53125 2.078125q-3.015625 0 -5.015625 -1.796875q-1.984375 -1.796875 -2.265625 -4.65625z" fill-rule="nonzero"/><path fill="#000000" class="text" d="m734.1666 732.1113l3.03125 0.765625q-0.953125 3.734375 -3.4375 5.703125q-2.46875 1.953125 -6.046875 1.953125q-3.703125 0 -6.03125 -1.5q-2.3125 -1.515625 -3.53125 -4.375q-1.203125 -2.859375 -1.203125 -6.140625q0 -3.578125 1.359375 -6.234375q1.375 -2.671875 3.890625 -4.046875q2.53125 -1.390625 5.5625 -1.390625q3.4375 0 5.78125 1.75q2.34375 1.75 3.265625 4.921875l-2.984375 0.703125q-0.796875 -2.5 -2.3125 -3.640625q-1.515625 -1.140625 -3.8125 -1.140625q-2.640625 0 -4.421875 1.265625q-1.765625 1.265625 -2.484375 3.40625q-0.71875 2.125 -0.71875 4.390625q0 2.921875 0.84375 5.109375q0.859375 2.171875 2.65625 3.25q1.796875 1.078125 3.890625 1.078125q2.546875 0 4.3125 -1.46875q1.765625 -1.46875 2.390625 -4.359375zm5.359375 -0.265625q0 -4.609375 2.5625 -6.828125q2.140625 -1.84375 5.21875 -1.84375q3.421875 0 5.59375 2.25q2.171875 2.234375 2.171875 6.1875q0 3.203125 -0.96875 5.046875q-0.953125 1.828125 -2.796875 2.84375q-1.828125 1.015625 -4.0 1.015625q-3.484375 0 -5.640625 -2.234375q-2.140625 -2.234375 -2.140625 -6.4375zm2.890625 0q0 3.1875 1.390625 4.78125q1.390625 1.578125 3.5 1.578125q2.09375 0 3.484375 -1.59375q1.390625 -1.59375 1.390625 -4.859375q0 -3.078125 -1.40625 -4.65625q-1.390625 -1.59375 -3.46875 -1.59375q-2.109375 0 -3.5 1.578125q-1.390625 1.578125 -1.390625 4.765625zm15.953125 8.296875l0 -16.59375l2.53125 0l0 2.359375q1.828125 -2.734375 5.28125 -2.734375q1.5 0 2.75 0.546875q1.265625 0.53125 1.890625 1.40625q0.625 0.875 0.875 2.078125q0.15625 0.78125 0.15625 2.734375l0 10.203125l-2.8125 0l0 -10.09375q0 -1.71875 -0.328125 -2.5625q-0.328125 -0.859375 -1.171875 -1.359375q-0.828125 -0.515625 -1.953125 -0.515625q-1.796875 0 -3.109375 1.140625q-1.296875 1.140625 -1.296875 4.328125l0 9.0625l-2.8125 0zm22.40625 0l-6.3125 -16.59375l2.96875 0l3.5625 9.9375q0.578125 1.609375 1.0625 3.34375q0.375 -1.3125 1.046875 -3.15625l3.6875 -10.125l2.890625 0l-6.28125 16.59375l-2.625 0zm22.75 -5.34375l2.90625 0.359375q-0.6875 2.546875 -2.546875 3.953125q-1.859375 1.40625 -4.75 1.40625q-3.640625 0 -5.78125 -2.234375q-2.125 -2.25 -2.125 -6.296875q0 -4.1875 2.15625 -6.5q2.15625 -2.3125 5.59375 -2.3125q3.328125 0 5.4375 2.265625q2.109375 2.265625 2.109375 6.375q0 0.25 -0.015625 0.75l-12.375 0q0.15625 2.734375 1.546875 4.1875q1.390625 1.453125 3.46875 1.453125q1.546875 0 2.640625 -0.8125q1.09375 -0.8125 1.734375 -2.59375zm-9.234375 -4.546875l9.265625 0q-0.1875 -2.09375 -1.0625 -3.140625q-1.34375 -1.625 -3.484375 -1.625q-1.9375 0 -3.265625 1.296875q-1.3125 1.296875 -1.453125 3.46875zm15.640625 9.890625l0 -16.59375l2.53125 0l0 2.515625q0.96875 -1.765625 1.78125 -2.328125q0.828125 -0.5625 1.8125 -0.5625q1.421875 0 2.890625 0.90625l-0.96875 2.609375q-1.03125 -0.609375 -2.0625 -0.609375q-0.921875 0 -1.65625 0.5625q-0.734375 0.546875 -1.046875 1.53125q-0.46875 1.5 -0.46875 3.28125l0 8.6875l-2.8125 0zm16.828125 -2.515625l0.40625 2.484375q-1.1875 0.25 -2.125 0.25q-1.53125 0 -2.375 -0.484375q-0.84375 -0.484375 -1.1875 -1.265625q-0.34375 -0.796875 -0.34375 -3.328125l0 -9.546875l-2.0625 0l0 -2.1875l2.0625 0l0 -4.109375l2.796875 -1.6875l0 5.796875l2.828125 0l0 2.1875l-2.828125 0l0 9.703125q0 1.203125 0.140625 1.546875q0.15625 0.34375 0.484375 0.546875q0.34375 0.203125 0.96875 0.203125q0.46875 0 1.234375 -0.109375zm8.9375 2.515625l0 -20.203125l-7.546875 0l0 -2.703125l18.15625 0l0 2.703125l-7.578125 0l0 20.203125l-3.03125 0zm8.765625 -8.296875q0 -4.609375 2.5625 -6.828125q2.140625 -1.84375 5.21875 -1.84375q3.421875 0 5.59375 2.25q2.171875 2.234375 2.171875 6.1875q0 3.203125 -0.96875 5.046875q-0.953125 1.828125 -2.796875 2.84375q-1.828125 1.015625 -4.0 1.015625q-3.484375 0 -5.640625 -2.234375q-2.140625 -2.234375 -2.140625 -6.4375zm2.890625 0q0 3.1875 1.390625 4.78125q1.390625 1.578125 3.5 1.578125q2.09375 0 3.484375 -1.59375q1.390625 -1.59375 1.390625 -4.859375q0 -3.078125 -1.40625 -4.65625q-1.390625 -1.59375 -3.46875 -1.59375q-2.109375 0 -3.5 1.578125q-1.390625 1.578125 -1.390625 4.765625zm21.328125 15.03125q-2.328125 -2.9375 -3.9375 -6.875q-1.609375 -3.9375 -1.609375 -8.15625q0 -3.71875 1.203125 -7.125q1.40625 -3.953125 4.34375 -7.875l2.015625 0q-1.890625 3.25 -2.5 4.640625q-0.953125 2.15625 -1.5 4.5q-0.671875 2.921875 -0.671875 5.875q0 7.515625 4.671875 15.015625l-2.015625 0zm7.125 0l-2.015625 0q4.671875 -7.5 4.671875 -15.015625q0 -2.9375 -0.671875 -5.828125q-0.53125 -2.34375 -1.484375 -4.5q-0.609375 -1.40625 -2.515625 -4.6875l2.015625 0q2.9375 3.921875 4.34375 7.875q1.203125 3.40625 1.203125 7.125q0 4.21875 -1.625 8.15625q-1.609375 3.9375 -3.921875 6.875zm17.703125 -6.734375l0 -16.59375l2.515625 0l0 2.328125q0.78125 -1.21875 2.078125 -1.953125q1.296875 -0.75 2.953125 -0.75q1.84375 0 3.015625 0.765625q1.1875 0.765625 1.671875 2.140625q1.96875 -2.90625 5.125 -2.90625q2.46875 0 3.796875 1.375q1.328125 1.359375 1.328125 4.203125l0 11.390625l-2.796875 0l0 -10.453125q0 -1.6875 -0.28125 -2.421875q-0.265625 -0.75 -0.984375 -1.203125q-0.71875 -0.453125 -1.6875 -0.453125q-1.75 0 -2.90625 1.171875q-1.15625 1.15625 -1.15625 3.71875l0 9.640625l-2.8125 0l0 -10.78125q0 -1.875 -0.6875 -2.8125q-0.6875 -0.9375 -2.25 -0.9375q-1.1875 0 -2.203125 0.625q-1.0 0.625 -1.453125 1.828125q-0.453125 1.203125 -0.453125 3.46875l0 8.609375l-2.8125 0zm38.015625 -5.34375l2.90625 0.359375q-0.6875 2.546875 -2.546875 3.953125q-1.859375 1.40625 -4.75 1.40625q-3.640625 0 -5.78125 -2.234375q-2.125 -2.25 -2.125 -6.296875q0 -4.1875 2.15625 -6.5q2.15625 -2.3125 5.59375 -2.3125q3.328125 0 5.4375 2.265625q2.109375 2.265625 2.109375 6.375q0 0.25 -0.015625 0.75l-12.375 0q0.15625 2.734375 1.546875 4.1875q1.390625 1.453125 3.46875 1.453125q1.546875 0 2.640625 -0.8125q1.09375 -0.8125 1.734375 -2.59375zm-9.234375 -4.546875l9.265625 0q-0.1875 -2.09375 -1.0625 -3.140625q-1.34375 -1.625 -3.484375 -1.625q-1.9375 0 -3.265625 1.296875q-1.3125 1.296875 -1.453125 3.46875zm21.812561 7.375l0.40625 2.484375q-1.1875 0.25 -2.125 0.25q-1.53125 0 -2.375061 -0.484375q-0.84375 -0.484375 -1.1875 -1.265625q-0.34375 -0.796875 -0.34375 -3.328125l0 -9.546875l-2.0625 0l0 -2.1875l2.0625 0l0 -4.109375l2.796936 -1.6875l0 5.796875l2.828125 0l0 2.1875l-2.828125 0l0 9.703125q0 1.203125 0.140625 1.546875q0.15625 0.34375 0.484375 0.546875q0.34375 0.203125 0.96875 0.203125q0.46875 0 1.234375 -0.109375zm2.75 2.515625l0 -22.90625l2.8125 0l0 8.21875q1.96875 -2.28125 4.96875 -2.28125q1.84375 0 3.203125 0.734375q1.359375 0.71875 1.9375 2.0q0.59375 1.28125 0.59375 3.71875l0 10.515625l-2.8125 0l0 -10.515625q0 -2.109375 -0.921875 -3.0625q-0.90625 -0.96875 -2.578125 -0.96875q-1.25 0 -2.359375 0.65625q-1.09375 0.640625 -1.5625 1.75q-0.46875 1.109375 -0.46875 3.0625l0 9.078125l-2.8125 0zm16.75 -8.296875q0 -4.609375 2.5625 -6.828125q2.140625 -1.84375 5.21875 -1.84375q3.421875 0 5.59375 2.25q2.171875 2.234375 2.171875 6.1875q0 3.203125 -0.96875 5.046875q-0.953125 1.828125 -2.796875 2.84375q-1.828125 1.015625 -4.0 1.015625q-3.484375 0 -5.640625 -2.234375q-2.140625 -2.234375 -2.140625 -6.4375zm2.890625 0q0 3.1875 1.390625 4.78125q1.390625 1.578125 3.5 1.578125q2.09375 0 3.484375 -1.59375q1.390625 -1.59375 1.390625 -4.859375q0 -3.078125 -1.40625 -4.65625q-1.390625 -1.59375 -3.46875 -1.59375q-2.109375 0 -3.5 1.578125q-1.390625 1.578125 -1.390625 4.765625zm26.71875 8.296875l0 -2.09375q-1.578125 2.46875 -4.640625 2.46875q-1.984375 0 -3.65625 -1.09375q-1.65625 -1.09375 -2.578125 -3.046875q-0.90625 -1.96875 -0.90625 -4.515625q0 -2.484375 0.828125 -4.5q0.828125 -2.03125 2.484375 -3.109375q1.65625 -1.078125 3.703125 -1.078125q1.5 0 2.671875 0.640625q1.171875 0.625 1.90625 1.640625l0 -8.21875l2.796875 0l0 22.90625l-2.609375 0zm-8.890625 -8.28125q0 3.1875 1.34375 4.765625q1.34375 1.578125 3.171875 1.578125q1.84375 0 3.125 -1.5q1.296875 -1.515625 1.296875 -4.609375q0 -3.40625 -1.3125 -5.0q-1.3125 -1.59375 -3.234375 -1.59375q-1.875 0 -3.140625 1.53125q-1.25 1.53125 -1.25 4.828125zm23.765625 -0.015625q0 -4.609375 2.5625 -6.828125q2.140625 -1.84375 5.21875 -1.84375q3.421875 0 5.59375 2.25q2.171875 2.234375 2.171875 6.1875q0 3.203125 -0.96875 5.046875q-0.953125 1.828125 -2.796875 2.84375q-1.828125 1.015625 -4.0 1.015625q-3.484375 0 -5.640625 -2.234375q-2.140625 -2.234375 -2.140625 -6.4375zm2.890625 0q0 3.1875 1.390625 4.78125q1.390625 1.578125 3.5 1.578125q2.09375 0 3.484375 -1.59375q1.390625 -1.59375 1.390625 -4.859375q0 -3.078125 -1.40625 -4.65625q-1.390625 -1.59375 -3.46875 -1.59375q-2.109375 0 -3.5 1.578125q-1.390625 1.578125 -1.390625 4.765625zm15.953064 8.296875l0 -16.59375l2.53125 0l0 2.359375q1.828125 -2.734375 5.28125 -2.734375q1.5 0 2.75 0.546875q1.265625 0.53125 1.890625 1.40625q0.625 0.875 0.875 2.078125q0.15625 0.78125 0.15625 2.734375l0 10.203125l-2.8125 0l0 -10.09375q0 -1.71875 -0.328125 -2.5625q-0.328125 -0.859375 -1.171875 -1.359375q-0.828125 -0.515625 -1.953125 -0.515625q-1.796875 0 -3.109375 1.140625q-1.296875 1.140625 -1.296875 4.328125l0 9.0625l-2.8125 0zm31.296875 0l-6.3125 -16.59375l2.96875 0l3.5625 9.9375q0.578125 1.609375 1.0625 3.34375q0.375 -1.3125 1.046875 -3.15625l3.6875 -10.125l2.890625 0l-6.28125 16.59375l-2.625 0zm10.625 -6.046875l2.8125 -0.375q0.484375 2.390625 1.640625 3.453125q1.171875 1.046875 2.84375 1.046875q1.984375 0 3.34375 -1.375q1.375 -1.375 1.375 -3.40625q0 -1.9375 -1.265625 -3.1875q-1.265625 -1.265625 -3.21875 -1.265625q-0.796875 0 -1.984375 0.3125l0.3125 -2.46875q0.28125 0.03125 0.453125 0.03125q1.796875 0 3.234375 -0.9375q1.4375 -0.9375 1.4375 -2.890625q0 -1.546875 -1.046875 -2.5625q-1.046875 -1.015625 -2.703125 -1.015625q-1.640625 0 -2.734375 1.03125q-1.09375 1.03125 -1.40625 3.09375l-2.8125 -0.5q0.515625 -2.828125 2.34375 -4.375q1.828125 -1.5625 4.546875 -1.5625q1.875 0 3.453125 0.8125q1.578125 0.796875 2.40625 2.1875q0.84375 1.390625 0.84375 2.953125q0 1.484375 -0.796875 2.703125q-0.796875 1.21875 -2.359375 1.9375q2.03125 0.46875 3.15625 1.953125q1.125 1.46875 1.125 3.6875q0 3.0 -2.1875 5.09375q-2.1875 2.078125 -5.53125 2.078125q-3.015625 0 -5.015625 -1.796875q-1.984375 -1.796875 -2.265625 -4.65625z" fill-rule="nonzero"/><path fill="#cfe2f3" d="m1123.5197 332.4672l-46.907715 -39.92914l19.9646 0l0 0c-25.05371 -70.51779 -112.57648 -119.7874 -212.79108 -119.7874l39.929077 0l0 0c100.2146 0 187.73749 49.269608 212.79108 119.7874l19.9646 0z" fill-rule="evenodd"/><path fill="#a5b4c2" d="m903.75 173.41106l0 0c-113.16968 7.5024567 -199.80511 76.46913 -199.80511 159.05614l-39.92914 0l0 0c0 -44.88263 25.985413 -87.69397 71.59564 -117.95491c45.61023 -30.260956 106.63556 -45.178513 168.13861 -41.101227z" fill-rule="evenodd"/><path fill="#000000" fill-opacity="0.0" d="m903.75 173.41106l0 0c-113.16968 7.5024567 -199.80511 76.46913 -199.80511 159.05614l-39.92914 0l0 0c0 -88.209015 98.394226 -159.71654 219.76971 -159.71654l39.929077 0l0 0c100.2146 0 187.73749 49.269608 212.79108 119.7874l19.9646 0l-32.95056 39.92914l-46.907715 -39.92914l19.9646 0l0 0c-25.05371 -70.51779 -112.57648 -119.7874 -212.79108 -119.7874" fill-rule="evenodd"/><path stroke="#000000" stroke-width="1.0" stroke-linejoin="round" stroke-linecap="butt" d="m903.75 173.41106l0 0c-113.16968 7.5024567 -199.80511 76.46913 -199.80511 159.05614l-39.92914 0l0 0c0 -88.209015 98.394226 -159.71654 219.76971 -159.71654l39.929077 0l0 0c100.2146 0 187.73749 49.269608 212.79108 119.7874l19.9646 0l-32.95056 39.92914l-46.907715 -39.92914l19.9646 0l0 0c-25.05371 -70.51779 -112.57648 -119.7874 -212.79108 -119.7874" fill-rule="evenodd"/><path fill="#cfe2f3" d="m187.46457 523.7139l46.742706 39.92914l-19.964554 0l0 0c24.461197 70.51776 109.91441 119.78735 207.75926 119.78735l-39.92914 0l0 0c-97.84485 0 -183.29805 -49.269592 -207.75926 -119.78735l-19.96457 0z" fill-rule="evenodd"/><path fill="#a5b4c2" d="m402.0374 682.7376l0 0c110.29004 -7.67157 194.60828 -76.57202 194.60828 -159.02368l39.92914 0l0 0c0 44.94403 -25.440186 87.808105 -70.07782 118.07379c-44.637573 30.265686 -104.34097 45.131653 -164.4596 40.94989z" fill-rule="evenodd"/><path fill="#000000" fill-opacity="0.0" d="m402.0374 682.7376l0 0c110.29004 -7.67157 194.60828 -76.57202 194.60828 -159.02368l39.92914 0l0 0c0 88.208984 -96.067566 159.71649 -214.57285 159.71649l-39.92914 0l0 0c-97.84485 0 -183.29805 -49.269592 -207.75926 -119.78735l-19.96457 0l33.115555 -39.92914l46.742706 39.92914l-19.964554 0l0 0c24.461197 70.51776 109.91441 119.78735 207.75926 119.78735" fill-rule="evenodd"/><path stroke="#000000" stroke-width="1.0" stroke-linejoin="round" stroke-linecap="butt" d="m402.0374 682.7376l0 0c110.29004 -7.67157 194.60828 -76.57202 194.60828 -159.02368l39.92914 0l0 0c0 88.208984 -96.067566 159.71649 -214.57285 159.71649l-39.92914 0l0 0c-97.84485 0 -183.29805 -49.269592 -207.75926 -119.78735l-19.96457 0l33.115555 -39.92914l46.742706 39.92914l-19.964554 0l0 0c24.461197 70.51776 109.91441 119.78735 207.75926 119.78735" fill-rule="evenodd"/><path fill="#000000" class="text" d="m193.07555 732.1113l3.03125 0.765625q-0.953125 3.734375 -3.4375 5.703125q-2.46875 1.953125 -6.046875 1.953125q-3.703125 0 -6.03125 -1.5q-2.3125 -1.515625 -3.53125 -4.375q-1.203125 -2.859375 -1.203125 -6.140625q0 -3.578125 1.359375 -6.234375q1.375 -2.671875 3.890625 -4.046875q2.53125 -1.390625 5.5625 -1.390625q3.4375 0 5.78125 1.75q2.34375 1.75 3.265625 4.921875l-2.984375 0.703125q-0.796875 -2.5 -2.3125 -3.640625q-1.515625 -1.140625 -3.8125 -1.140625q-2.640625 0 -4.421875 1.265625q-1.765625 1.265625 -2.484375 3.40625q-0.71875 2.125 -0.71875 4.390625q0 2.921875 0.84375 5.109375q0.859375 2.171875 2.65625 3.25q1.796875 1.078125 3.890625 1.078125q2.546875 0 4.3125 -1.46875q1.765625 -1.46875 2.390625 -4.359375zm5.359375 -0.265625q0 -4.609375 2.5625 -6.828125q2.140625 -1.84375 5.21875 -1.84375q3.421875 0 5.59375 2.25q2.171875 2.234375 2.171875 6.1875q0 3.203125 -0.96875 5.046875q-0.953125 1.828125 -2.796875 2.84375q-1.828125 1.015625 -4.0 1.015625q-3.484375 0 -5.640625 -2.234375q-2.140625 -2.234375 -2.140625 -6.4375zm2.890625 0q0 3.1875 1.390625 4.78125q1.390625 1.578125 3.5 1.578125q2.09375 0 3.484375 -1.59375q1.390625 -1.59375 1.390625 -4.859375q0 -3.078125 -1.40625 -4.65625q-1.390625 -1.59375 -3.46875 -1.59375q-2.109375 0 -3.5 1.578125q-1.390625 1.578125 -1.390625 4.765625zm15.953125 8.296875l0 -16.59375l2.53125 0l0 2.359375q1.828125 -2.734375 5.28125 -2.734375q1.5 0 2.75 0.546875q1.265625 0.53125 1.890625 1.40625q0.625 0.875 0.875 2.078125q0.15625 0.78125 0.15625 2.734375l0 10.203125l-2.8125 0l0 -10.09375q0 -1.71875 -0.328125 -2.5625q-0.328125 -0.859375 -1.171875 -1.359375q-0.828125 -0.515625 -1.953125 -0.515625q-1.796875 0 -3.109375 1.140625q-1.296875 1.140625 -1.296875 4.328125l0 9.0625l-2.8125 0zm22.40625 0l-6.3125 -16.59375l2.96875 0l3.5625 9.9375q0.578125 1.609375 1.0625 3.34375q0.375 -1.3125 1.046875 -3.15625l3.6875 -10.125l2.890625 0l-6.28125 16.59375l-2.625 0zm22.749985 -5.34375l2.90625 0.359375q-0.6875 2.546875 -2.546875 3.953125q-1.859375 1.40625 -4.75 1.40625q-3.6406097 0 -5.7812347 -2.234375q-2.125 -2.25 -2.125 -6.296875q0 -4.1875 2.15625 -6.5q2.15625 -2.3125 5.5937347 -2.3125q3.328125 0 5.4375 2.265625q2.109375 2.265625 2.109375 6.375q0 0.25 -0.015625 0.75l-12.374985 0q0.15625 2.734375 1.546875 4.1875q1.390625 1.453125 3.4687347 1.453125q1.546875 0 2.640625 -0.8125q1.09375 -0.8125 1.734375 -2.59375zm-9.23436 -4.546875l9.26561 0q-0.1875 -2.09375 -1.0625 -3.140625q-1.34375 -1.625 -3.484375 -1.625q-1.9374847 0 -3.2656097 1.296875q-1.3125 1.296875 -1.453125 3.46875zm15.64061 9.890625l0 -16.59375l2.53125 0l0 2.515625q0.96875 -1.765625 1.78125 -2.328125q0.828125 -0.5625 1.8125 -0.5625q1.421875 0 2.890625 0.90625l-0.96875 2.609375q-1.03125 -0.609375 -2.0625 -0.609375q-0.921875 0 -1.65625 0.5625q-0.734375 0.546875 -1.046875 1.53125q-0.46875 1.5 -0.46875 3.28125l0 8.6875l-2.8125 0zm16.828125 -2.515625l0.40625 2.484375q-1.1875 0.25 -2.125 0.25q-1.53125 0 -2.375 -0.484375q-0.84375 -0.484375 -1.1875 -1.265625q-0.34375 -0.796875 -0.34375 -3.328125l0 -9.546875l-2.0625 0l0 -2.1875l2.0625 0l0 -4.109375l2.796875 -1.6875l0 5.796875l2.828125 0l0 2.1875l-2.828125 0l0 9.703125q0 1.203125 0.140625 1.546875q0.15625 0.34375 0.484375 0.546875q0.34375 0.203125 0.96875 0.203125q0.46875 0 1.234375 -0.109375zm3.265625 2.515625l0 -22.90625l15.453125 0l0 2.703125l-12.421875 0l0 7.09375l10.75 0l0 2.703125l-10.75 0l0 10.40625l-3.03125 0zm19.0 0l0 -16.59375l2.53125 0l0 2.515625q0.96875 -1.765625 1.78125 -2.328125q0.828125 -0.5625 1.8125 -0.5625q1.421875 0 2.890625 0.90625l-0.96875 2.609375q-1.03125 -0.609375 -2.0625 -0.609375q-0.921875 0 -1.65625 0.5625q-0.734375 0.546875 -1.046875 1.53125q-0.46875 1.5 -0.46875 3.28125l0 8.6875l-2.8125 0zm9.640625 -8.296875q0 -4.609375 2.5625 -6.828125q2.140625 -1.84375 5.21875 -1.84375q3.421875 0 5.59375 2.25q2.171875 2.234375 2.171875 6.1875q0 3.203125 -0.96875 5.046875q-0.953125 1.828125 -2.796875 2.84375q-1.828125 1.015625 -4.0 1.015625q-3.484375 0 -5.640625 -2.234375q-2.140625 -2.234375 -2.140625 -6.4375zm2.890625 0q0 3.1875 1.390625 4.78125q1.390625 1.578125 3.5 1.578125q2.09375 0 3.484375 -1.59375q1.390625 -1.59375 1.390625 -4.859375q0 -3.078125 -1.40625 -4.65625q-1.390625 -1.59375 -3.46875 -1.59375q-2.109375 0 -3.5 1.578125q-1.390625 1.578125 -1.390625 4.765625zm15.953125 8.296875l0 -16.59375l2.515625 0l0 2.328125q0.78125 -1.21875 2.078125 -1.953125q1.296875 -0.75 2.953125 -0.75q1.84375 0 3.015625 0.765625q1.1875 0.765625 1.671875 2.140625q1.96875 -2.90625 5.125 -2.90625q2.46875 0 3.796875 1.375q1.328125 1.359375 1.328125 4.203125l0 11.390625l-2.796875 0l0 -10.453125q0 -1.6875 -0.28125 -2.421875q-0.265625 -0.75 -0.984375 -1.203125q-0.71875 -0.453125 -1.6875 -0.453125q-1.75 0 -2.90625 1.171875q-1.15625 1.15625 -1.15625 3.71875l0 9.640625l-2.8125 0l0 -10.78125q0 -1.875 -0.6875 -2.8125q-0.6875 -0.9375 -2.25 -0.9375q-1.1875 0 -2.203125 0.625q-1.0 0.625 -1.453125 1.828125q-0.453125 1.203125 -0.453125 3.46875l0 8.609375l-2.8125 0zm32.03125 6.734375q-2.328125 -2.9375 -3.9375 -6.875q-1.609375 -3.9375 -1.609375 -8.15625q0 -3.71875 1.203125 -7.125q1.40625 -3.953125 4.34375 -7.875l2.015625 0q-1.890625 3.25 -2.5 4.640625q-0.953125 2.15625 -1.5 4.5q-0.671875 2.921875 -0.671875 5.875q0 7.515625 4.671875 15.015625l-2.015625 0zm7.125 0l-2.015625 0q4.671875 -7.5 4.671875 -15.015625q0 -2.9375 -0.671875 -5.828125q-0.53125 -2.34375 -1.484375 -4.5q-0.609375 -1.40625 -2.515625 -4.6875l2.015625 0q2.9375 3.921875 4.34375 7.875q1.203125 3.40625 1.203125 7.125q0 4.21875 -1.625 8.15625q-1.609375 3.9375 -3.921875 6.875zm17.703125 -6.734375l0 -16.59375l2.515625 0l0 2.328125q0.78125 -1.21875 2.078125 -1.953125q1.296875 -0.75 2.953125 -0.75q1.84375 0 3.015625 0.765625q1.1875 0.765625 1.671875 2.140625q1.96875 -2.90625 5.125 -2.90625q2.46875 0 3.796875 1.375q1.328125 1.359375 1.328125 4.203125l0 11.390625l-2.796875 0l0 -10.453125q0 -1.6875 -0.28125 -2.421875q-0.265625 -0.75 -0.984375 -1.203125q-0.71875 -0.453125 -1.6875 -0.453125q-1.75 0 -2.90625 1.171875q-1.15625 1.15625 -1.15625 3.71875l0 9.640625l-2.8125 0l0 -10.78125q0 -1.875 -0.6875 -2.8125q-0.6875 -0.9375 -2.25 -0.9375q-1.1875 0 -2.203125 0.625q-1.0 0.625 -1.453125 1.828125q-0.453125 1.203125 -0.453125 3.46875l0 8.609375l-2.8125 0zm38.015656 -5.34375l2.90625 0.359375q-0.6875 2.546875 -2.546875 3.953125q-1.859375 1.40625 -4.75 1.40625q-3.640625 0 -5.78125 -2.234375q-2.1250305 -2.25 -2.1250305 -6.296875q0 -4.1875 2.1562805 -6.5q2.15625 -2.3125 5.59375 -2.3125q3.328125 0 5.4375 2.265625q2.109375 2.265625 2.109375 6.375q0 0.25 -0.015625 0.75l-12.375 0q0.15625 2.734375 1.546875 4.1875q1.390625 1.453125 3.46875 1.453125q1.546875 0 2.640625 -0.8125q1.09375 -0.8125 1.734375 -2.59375zm-9.234375 -4.546875l9.265625 0q-0.1875 -2.09375 -1.0625 -3.140625q-1.34375 -1.625 -3.484375 -1.625q-1.9375 0 -3.265625 1.296875q-1.3125 1.296875 -1.453125 3.46875zm21.8125 7.375l0.40625 2.484375q-1.1875 0.25 -2.125 0.25q-1.53125 0 -2.375 -0.484375q-0.84375 -0.484375 -1.1875 -1.265625q-0.34375 -0.796875 -0.34375 -3.328125l0 -9.546875l-2.0625 0l0 -2.1875l2.0625 0l0 -4.109375l2.796875 -1.6875l0 5.796875l2.828125 0l0 2.1875l-2.828125 0l0 9.703125q0 1.203125 0.140625 1.546875q0.15625 0.34375 0.484375 0.546875q0.34375 0.203125 0.96875 0.203125q0.46875 0 1.234375 -0.109375zm2.75 2.515625l0 -22.90625l2.8125 0l0 8.21875q1.96875 -2.28125 4.96875 -2.28125q1.84375 0 3.203125 0.734375q1.359375 0.71875 1.9375 2.0q0.59375 1.28125 0.59375 3.71875l0 10.515625l-2.8125 0l0 -10.515625q0 -2.109375 -0.921875 -3.0625q-0.90625 -0.96875 -2.578125 -0.96875q-1.25 0 -2.359375 0.65625q-1.09375 0.640625 -1.5625 1.75q-0.46875 1.109375 -0.46875 3.0625l0 9.078125l-2.8125 0zm16.75 -8.296875q0 -4.609375 2.5625 -6.828125q2.140625 -1.84375 5.21875 -1.84375q3.421875 0 5.59375 2.25q2.171875 2.234375 2.171875 6.1875q0 3.203125 -0.96875 5.046875q-0.953125 1.828125 -2.796875 2.84375q-1.828125 1.015625 -4.0 1.015625q-3.484375 0 -5.640625 -2.234375q-2.140625 -2.234375 -2.140625 -6.4375zm2.890625 0q0 3.1875 1.390625 4.78125q1.390625 1.578125 3.5 1.578125q2.09375 0 3.484375 -1.59375q1.390625 -1.59375 1.390625 -4.859375q0 -3.078125 -1.40625 -4.65625q-1.390625 -1.59375 -3.46875 -1.59375q-2.109375 0 -3.5 1.578125q-1.390625 1.578125 -1.390625 4.765625zm26.71875 8.296875l0 -2.09375q-1.578125 2.46875 -4.640625 2.46875q-1.984375 0 -3.65625 -1.09375q-1.65625 -1.09375 -2.578125 -3.046875q-0.90625 -1.96875 -0.90625 -4.515625q0 -2.484375 0.828125 -4.5q0.828125 -2.03125 2.484375 -3.109375q1.65625 -1.078125 3.703125 -1.078125q1.5 0 2.671875 0.640625q1.171875 0.625 1.90625 1.640625l0 -8.21875l2.796875 0l0 22.90625l-2.609375 0zm-8.890625 -8.28125q0 3.1875 1.34375 4.765625q1.34375 1.578125 3.171875 1.578125q1.84375 0 3.125 -1.5q1.296875 -1.515625 1.296875 -4.609375q0 -3.40625 -1.3125 -5.0q-1.3125 -1.59375 -3.234375 -1.59375q-1.875 0 -3.140625 1.53125q-1.25 1.53125 -1.25 4.828125zm23.765625 -0.015625q0 -4.609375 2.5625 -6.828125q2.140625 -1.84375 5.21875 -1.84375q3.421875 0 5.59375 2.25q2.171875 2.234375 2.171875 6.1875q0 3.203125 -0.96875 5.046875q-0.953125 1.828125 -2.796875 2.84375q-1.828125 1.015625 -4.0 1.015625q-3.484375 0 -5.640625 -2.234375q-2.140625 -2.234375 -2.140625 -6.4375zm2.890625 0q0 3.1875 1.390625 4.78125q1.390625 1.578125 3.5 1.578125q2.09375 0 3.484375 -1.59375q1.390625 -1.59375 1.390625 -4.859375q0 -3.078125 -1.40625 -4.65625q-1.390625 -1.59375 -3.46875 -1.59375q-2.109375 0 -3.5 1.578125q-1.390625 1.578125 -1.390625 4.765625zm15.953125 8.296875l0 -16.59375l2.53125 0l0 2.359375q1.828125 -2.734375 5.28125 -2.734375q1.5 0 2.75 0.546875q1.265625 0.53125 1.890625 1.40625q0.625 0.875 0.875 2.078125q0.15625 0.78125 0.15625 2.734375l0 10.203125l-2.8125 0l0 -10.09375q0 -1.71875 -0.328125 -2.5625q-0.328125 -0.859375 -1.171875 -1.359375q-0.828125 -0.515625 -1.953125 -0.515625q-1.796875 0 -3.109375 1.140625q-1.296875 1.140625 -1.296875 4.328125l0 9.0625l-2.8125 0zm31.296875 0l-6.3125 -16.59375l2.96875 0l3.5625 9.9375q0.578125 1.609375 1.0625 3.34375q0.375 -1.3125 1.046875 -3.15625l3.6875 -10.125l2.890625 0l-6.28125 16.59375l-2.625 0zm25.390625 -2.703125l0 2.703125l-15.140625 0q-0.03125 -1.015625 0.328125 -1.953125q0.578125 -1.546875 1.84375 -3.046875q1.28125 -1.5 3.6875 -3.46875q3.734375 -3.0625 5.046875 -4.84375q1.3125 -1.796875 1.3125 -3.390625q0 -1.671875 -1.203125 -2.8125q-1.1875 -1.15625 -3.109375 -1.15625q-2.03125 0 -3.25 1.21875q-1.21875 1.21875 -1.234375 3.375l-2.890625 -0.296875q0.296875 -3.234375 2.234375 -4.921875q1.9375 -1.703125 5.203125 -1.703125q3.296875 0 5.21875 1.828125q1.921875 1.828125 1.921875 4.53125q0 1.375 -0.5625 2.703125q-0.5625 1.328125 -1.875 2.796875q-1.296875 1.46875 -4.328125 4.03125q-2.53125 2.125 -3.25 2.890625q-0.71875 0.75 -1.1875 1.515625l11.234375 0z" fill-rule="nonzero"/><path fill="#000000" class="text" d="m230.13515 138.32655l3.03125 0.765625q-0.953125 3.734375 -3.4375 5.703125q-2.46875 1.953125 -6.046875 1.953125q-3.703125 0 -6.03125 -1.5q-2.3125 -1.515625 -3.53125 -4.375q-1.203125 -2.859375 -1.203125 -6.140625q0 -3.578125 1.359375 -6.234375q1.375 -2.6718826 3.890625 -4.0468826q2.53125 -1.390625 5.5625 -1.390625q3.4375 0 5.78125 1.75q2.34375 1.75 3.265625 4.9218826l-2.984375 0.703125q-0.796875 -2.5000076 -2.3125 -3.6406326q-1.515625 -1.140625 -3.8125 -1.140625q-2.640625 0 -4.421875 1.265625q-1.765625 1.2656326 -2.484375 3.4062576q-0.71875 2.125 -0.71875 4.390625q0 2.921875 0.84375 5.109375q0.859375 2.171875 2.65625 3.25q1.796875 1.078125 3.890625 1.078125q2.546875 0 4.3125 -1.46875q1.765625 -1.46875 2.390625 -4.359375zm5.359375 -0.265625q0 -4.609375 2.5625 -6.828125q2.140625 -1.84375 5.21875 -1.84375q3.421875 0 5.59375 2.25q2.171875 2.234375 2.171875 6.1875q0 3.203125 -0.96875 5.046875q-0.953125 1.828125 -2.796875 2.84375q-1.828125 1.015625 -4.0 1.015625q-3.484375 0 -5.640625 -2.234375q-2.140625 -2.234375 -2.140625 -6.4375zm2.890625 0q0 3.1875 1.390625 4.78125q1.390625 1.578125 3.5 1.578125q2.09375 0 3.484375 -1.59375q1.390625 -1.59375 1.390625 -4.859375q0 -3.078125 -1.40625 -4.65625q-1.390625 -1.59375 -3.46875 -1.59375q-2.109375 0 -3.5 1.578125q-1.390625 1.578125 -1.390625 4.765625zm15.953125 8.296875l0 -16.59375l2.5312653 0l0 2.359375q1.828125 -2.734375 5.28125 -2.734375q1.5 0 2.75 0.546875q1.265625 0.53125 1.890625 1.40625q0.625 0.875 0.875 2.078125q0.15625 0.78125 0.15625 2.734375l0 10.203125l-2.8125 0l0 -10.09375q0 -1.71875 -0.328125 -2.5625q-0.328125 -0.859375 -1.171875 -1.359375q-0.828125 -0.515625 -1.953125 -0.515625q-1.796875 0 -3.109375 1.140625q-1.296875 1.140625 -1.296875 4.328125l0 9.0625l-2.8125153 0zm22.406265 0l-6.3125 -16.59375l2.96875 0l3.5625 9.9375q0.578125 1.609375 1.0625 3.34375q0.375 -1.3125 1.046875 -3.15625l3.6875 -10.125l2.890625 0l-6.28125 16.59375l-2.625 0zm22.75 -5.34375l2.90625 0.359375q-0.6875 2.546875 -2.546875 3.953125q-1.859375 1.40625 -4.75 1.40625q-3.640625 0 -5.78125 -2.234375q-2.125 -2.25 -2.125 -6.296875q0 -4.1875 2.15625 -6.5q2.15625 -2.3125 5.59375 -2.3125q3.328125 0 5.4375 2.265625q2.109375 2.265625 2.109375 6.375q0 0.25 -0.015625 0.75l-12.375 0q0.15625 2.734375 1.546875 4.1875q1.390625 1.453125 3.46875 1.453125q1.546875 0 2.640625 -0.8125q1.09375 -0.8125 1.734375 -2.59375zm-9.234375 -4.546875l9.265625 0q-0.1875 -2.09375 -1.0625 -3.140625q-1.34375 -1.625 -3.484375 -1.625q-1.9375 0 -3.265625 1.296875q-1.3125 1.296875 -1.453125 3.46875zm15.640625 9.890625l0 -16.59375l2.53125 0l0 2.515625q0.96875 -1.765625 1.78125 -2.328125q0.828125 -0.5625 1.8125 -0.5625q1.421875 0 2.890625 0.90625l-0.96875 2.609375q-1.03125 -0.609375 -2.0625 -0.609375q-0.921875 0 -1.65625 0.5625q-0.734375 0.546875 -1.046875 1.53125q-0.46875 1.5 -0.46875 3.28125l0 8.6875l-2.8125 0zm16.828125 -2.515625l0.40625 2.484375q-1.1875 0.25 -2.125 0.25q-1.53125 0 -2.375 -0.484375q-0.84375 -0.484375 -1.1875 -1.265625q-0.34375 -0.796875 -0.34375 -3.328125l0 -9.546875l-2.0625 0l0 -2.1875l2.0625 0l0 -4.1093826l2.796875 -1.6875l0 5.7968826l2.828125 0l0 2.1875l-2.828125 0l0 9.703125q0 1.203125 0.140625 1.546875q0.15625 0.34375 0.484375 0.546875q0.34375 0.203125 0.96875 0.203125q0.46875 0 1.234375 -0.109375zm8.9375 2.515625l0 -20.203133l-7.546875 0l0 -2.703125l18.15625 0l0 2.703125l-7.578125 0l0 20.203133l-3.03125 0zm8.765625 -8.296875q0 -4.609375 2.5625 -6.828125q2.140625 -1.84375 5.21875 -1.84375q3.421875 0 5.59375 2.25q2.171875 2.234375 2.171875 6.1875q0 3.203125 -0.96875 5.046875q-0.953125 1.828125 -2.796875 2.84375q-1.828125 1.015625 -4.0 1.015625q-3.484375 0 -5.640625 -2.234375q-2.140625 -2.234375 -2.140625 -6.4375zm2.890625 0q0 3.1875 1.390625 4.78125q1.390625 1.578125 3.5 1.578125q2.09375 0 3.484375 -1.59375q1.390625 -1.59375 1.390625 -4.859375q0 -3.078125 -1.40625 -4.65625q-1.390625 -1.59375 -3.46875 -1.59375q-2.109375 0 -3.5 1.578125q-1.390625 1.578125 -1.390625 4.765625zm21.328125 15.03125q-2.328125 -2.9375 -3.9375 -6.875q-1.609375 -3.9375 -1.609375 -8.15625q0 -3.71875 1.203125 -7.125q1.40625 -3.9531326 4.34375 -7.8750076l2.015625 0q-1.890625 3.25 -2.5 4.640625q-0.953125 2.1562576 -1.5 4.5000076q-0.671875 2.921875 -0.671875 5.875q0 7.515625 4.671875 15.015625l-2.015625 0zm7.125 0l-2.015625 0q4.671875 -7.5 4.671875 -15.015625q0 -2.9375 -0.671875 -5.828125q-0.53125 -2.34375 -1.484375 -4.5000076q-0.609375 -1.40625 -2.515625 -4.6875l2.015625 0q2.9375 3.921875 4.34375 7.8750076q1.203125 3.40625 1.203125 7.125q0 4.21875 -1.625 8.15625q-1.609375 3.9375 -3.921875 6.875zm17.703125 -6.734375l0 -16.59375l2.515625 0l0 2.328125q0.78125 -1.21875 2.078125 -1.953125q1.296875 -0.75 2.953125 -0.75q1.84375 0 3.015625 0.765625q1.1875 0.765625 1.671875 2.140625q1.96875 -2.90625 5.125 -2.90625q2.46875 0 3.796875 1.375q1.328125 1.359375 1.328125 4.203125l0 11.390625l-2.796875 0l0 -10.453125q0 -1.6875 -0.28125 -2.421875q-0.265625 -0.75 -0.984375 -1.203125q-0.71875 -0.453125 -1.6875 -0.453125q-1.75 0 -2.90625 1.171875q-1.15625 1.15625 -1.15625 3.71875l0 9.640625l-2.8125 0l0 -10.78125q0 -1.875 -0.6875 -2.8125q-0.6875 -0.9375 -2.25 -0.9375q-1.1875 0 -2.203125 0.625q-1.0 0.625 -1.453125 1.828125q-0.453125 1.203125 -0.453125 3.46875l0 8.609375l-2.8125 0zm38.015625 -5.34375l2.90625 0.359375q-0.6875 2.546875 -2.546875 3.953125q-1.859375 1.40625 -4.75 1.40625q-3.640625 0 -5.78125 -2.234375q-2.125 -2.25 -2.125 -6.296875q0 -4.1875 2.15625 -6.5q2.15625 -2.3125 5.59375 -2.3125q3.328125 0 5.4375 2.265625q2.109375 2.265625 2.109375 6.375q0 0.25 -0.015625 0.75l-12.375 0q0.15625 2.734375 1.546875 4.1875q1.390625 1.453125 3.46875 1.453125q1.546875 0 2.640625 -0.8125q1.09375 -0.8125 1.734375 -2.59375zm-9.234375 -4.546875l9.265625 0q-0.1875 -2.09375 -1.0625 -3.140625q-1.34375 -1.625 -3.484375 -1.625q-1.9375 0 -3.265625 1.296875q-1.3125 1.296875 -1.453125 3.46875zm21.8125 7.375l0.40625 2.484375q-1.1875 0.25 -2.125 0.25q-1.53125 0 -2.375 -0.484375q-0.84375 -0.484375 -1.1875 -1.265625q-0.34375 -0.796875 -0.34375 -3.328125l0 -9.546875l-2.0625 0l0 -2.1875l2.0625 0l0 -4.1093826l2.796875 -1.6875l0 5.7968826l2.828125 0l0 2.1875l-2.828125 0l0 9.703125q0 1.203125 0.140625 1.546875q0.15625 0.34375 0.484375 0.546875q0.34375 0.203125 0.96875 0.203125q0.46875 0 1.234375 -0.109375zm2.75 2.515625l0 -22.906258l2.8125 0l0 8.218758q1.96875 -2.28125 4.96875 -2.28125q1.84375 0 3.203125 0.734375q1.359375 0.71875 1.9375 2.0q0.59375 1.28125 0.59375 3.71875l0 10.515625l-2.8125 0l0 -10.515625q0 -2.109375 -0.921875 -3.0625q-0.90625 -0.96875 -2.578125 -0.96875q-1.25 0 -2.359375 0.65625q-1.09375 0.640625 -1.5625 1.75q-0.46875 1.109375 -0.46875 3.0625l0 9.078125l-2.8125 0zm16.75 -8.296875q0 -4.609375 2.5625 -6.828125q2.140625 -1.84375 5.21875 -1.84375q3.421875 0 5.59375 2.25q2.171875 2.234375 2.171875 6.1875q0 3.203125 -0.96875 5.046875q-0.953125 1.828125 -2.796875 2.84375q-1.828125 1.015625 -4.0 1.015625q-3.484375 0 -5.640625 -2.234375q-2.140625 -2.234375 -2.140625 -6.4375zm2.890625 0q0 3.1875 1.390625 4.78125q1.390625 1.578125 3.5 1.578125q2.09375 0 3.484375 -1.59375q1.390625 -1.59375 1.390625 -4.859375q0 -3.078125 -1.40625 -4.65625q-1.390625 -1.59375 -3.46875 -1.59375q-2.109375 0 -3.5 1.578125q-1.390625 1.578125 -1.390625 4.765625zm26.71875 8.296875l0 -2.09375q-1.578125 2.46875 -4.640625 2.46875q-1.984375 0 -3.65625 -1.09375q-1.65625 -1.09375 -2.578125 -3.046875q-0.90625 -1.96875 -0.90625 -4.515625q0 -2.484375 0.828125 -4.5q0.828125 -2.03125 2.484375 -3.109375q1.65625 -1.078125 3.703125 -1.078125q1.5 0 2.671875 0.640625q1.171875 0.625 1.90625 1.640625l0 -8.218758l2.796875 0l0 22.906258l-2.609375 0zm-8.890625 -8.28125q0 3.1875 1.34375 4.765625q1.34375 1.578125 3.171875 1.578125q1.84375 0 3.125 -1.5q1.296875 -1.515625 1.296875 -4.609375q0 -3.40625 -1.3125 -5.0q-1.3125 -1.59375 -3.234375 -1.59375q-1.875 0 -3.140625 1.53125q-1.25 1.53125 -1.25 4.828125zm23.765625 -0.015625q0 -4.609375 2.5625 -6.828125q2.140625 -1.84375 5.21875 -1.84375q3.4219055 0 5.5937805 2.25q2.171875 2.234375 2.171875 6.1875q0 3.203125 -0.96875 5.046875q-0.953125 1.828125 -2.796875 2.84375q-1.828125 1.015625 -4.0000305 1.015625q-3.484375 0 -5.640625 -2.234375q-2.140625 -2.234375 -2.140625 -6.4375zm2.890625 0q0 3.1875 1.390625 4.78125q1.390625 1.578125 3.5 1.578125q2.0937805 0 3.4844055 -1.59375q1.390625 -1.59375 1.390625 -4.859375q0 -3.078125 -1.40625 -4.65625q-1.390625 -1.59375 -3.4687805 -1.59375q-2.109375 0 -3.5 1.578125q-1.390625 1.578125 -1.390625 4.765625zm15.9531555 8.296875l0 -16.59375l2.53125 0l0 2.359375q1.828125 -2.734375 5.28125 -2.734375q1.5 0 2.75 0.546875q1.265625 0.53125 1.890625 1.40625q0.625 0.875 0.875 2.078125q0.15625 0.78125 0.15625 2.734375l0 10.203125l-2.8125 0l0 -10.09375q0 -1.71875 -0.328125 -2.5625q-0.328125 -0.859375 -1.171875 -1.359375q-0.828125 -0.515625 -1.953125 -0.515625q-1.796875 0 -3.109375 1.140625q-1.296875 1.140625 -1.296875 4.328125l0 9.0625l-2.8125 0zm31.296875 0l-6.3125 -16.59375l2.96875 0l3.5625 9.9375q0.578125 1.609375 1.0625 3.34375q0.375 -1.3125 1.046875 -3.15625l3.6875 -10.125l2.890625 0l-6.28125 16.59375l-2.625 0zm25.390625 -2.703125l0 2.703125l-15.140625 0q-0.03125 -1.015625 0.328125 -1.953125q0.578125 -1.546875 1.84375 -3.046875q1.28125 -1.5 3.6875 -3.46875q3.734375 -3.0625 5.046875 -4.84375q1.3125 -1.796875 1.3125 -3.390625q0 -1.6718826 -1.203125 -2.8125076q-1.1875 -1.15625 -3.109375 -1.15625q-2.03125 0 -3.25 1.21875q-1.21875 1.2187576 -1.234375 3.3750076l-2.890625 -0.296875q0.296875 -3.2343826 2.234375 -4.9218826q1.9375 -1.703125 5.203125 -1.703125q3.296875 0 5.21875 1.828125q1.921875 1.828125 1.921875 4.5312576q0 1.375 -0.5625 2.703125q-0.5625 1.328125 -1.875 2.796875q-1.296875 1.46875 -4.328125 4.03125q-2.53125 2.125 -3.25 2.890625q-0.71875 0.75 -1.1875 1.515625l11.234375 0z" fill-rule="nonzero"/></g></svg>
</div>
<p>这样就减少了我们所需定义转换函数的数量，其实就是在模仿 Kubernetes 内部实际的工作方式。</p>
<h2><a class="header" href="#与-webhooks-有什么关系" id="与-webhooks-有什么关系">与 Webhooks 有什么关系？</a></h2>
<p>当 API 客户端（例如 kubectl 或你的控制器）请求特定的版本的资源，Kubernetes API 服务器需要返回该版本的结果。但是，该版本可能不匹配 API 服务器实际存储的版本。</p>
<p>在这种情况下，API 服务器需要知道如何在所需的版本和存储的版本之间进行转换。由于转换不是 CRD 内置的，于是 Kubernetes API 服务器通过调用 Webhook 来执行转换。对于 KubeBuilder ，跟我们上面讨论一样，Webhook 通过控制器运行时来执行 hub-and-spoke 的转换。</p>
<p>现在我们有了向下转换的模型，我们就可以实现转换操作了。</p>
<h1><a class="header" href="#实现转换" id="实现转换">实现转换</a></h1>
<p>采用的转换模型已经就绪，就可以开始实现转换函数了。 我们将这些函数放置在 <code>cronjob_conversion.go</code> 文件中，<code>cronjob_conversion.go</code> 文件和 <code>cronjob_types.go</code> 文件同目录，以避免我们主要的类型文件和额外的方法产生混乱。</p>
<h2><a class="header" href="#hub" id="hub">Hub...</a></h2>
<p>首先，我们需要实现 hub 接口。我们会选择 v1 版本作为 hub 的一个实现：</p>
<div class="literate"><cite class="literate-source"><a href="https://sigs.k8s.io/kubebuilder/docs/book/src/multiversion-tutorial/testdata/project/api/v1/cronjob_conversion.go">project/api/v1/cronjob_conversion.go</a></cite><details class="collapse-code"><summary class="hljs"><pre class="hljs"><span class="hljs-comment">Apache License</span></pre></summary>
<p>Licensed under the Apache License, Version 2.0 (the “License”);
you may not use this file except in compliance with the License.
You may obtain a copy of the License at</p>
<pre><code>http://www.apache.org/licenses/LICENSE-2.0
</code></pre>
<p>Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an “AS IS” BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.</p>
</details>
<pre><code class="language-go">package v1
</code></pre>
<p>实现 hub 方法相当容易 -- 我们只需要添加一个叫做 <code>Hub()</code> 的空方法来作为一个 <a href="https://pkg.go.dev/sigs.k8s.io/controller-runtime/pkg/conversion?tab=doc#Hub">标记</a>。我们也可以将这行代码放到 <code>cronjob_types.go</code> 文件中。</p>
<pre><code class="language-go">// Hub 标记这个类型是一个用来转换的 hub。
func (*CronJob) Hub() {}
</code></pre>
</div>
<h2><a class="header" href="#-然后-spokes" id="-然后-spokes">... 然后 Spokes</a></h2>
<p>然后，我们需要实现我们的 spoke 接口，例如 v2 版本：</p>
<div class="literate"><cite class="literate-source"><a href="https://sigs.k8s.io/kubebuilder/docs/book/src/multiversion-tutorial/testdata/project/api/v2/cronjob_conversion.go">project/api/v2/cronjob_conversion.go</a></cite><details class="collapse-code"><summary class="hljs"><pre class="hljs"><span class="hljs-comment">Apache License</span></pre></summary>
<p>Licensed under the Apache License, Version 2.0 (the “License”);
you may not use this file except in compliance with the License.
You may obtain a copy of the License at</p>
<pre><code>http://www.apache.org/licenses/LICENSE-2.0
</code></pre>
<p>Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an “AS IS” BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.</p>
</details>
<pre><code class="language-go">package v2
</code></pre>
<details class="collapse-code"><summary class="hljs"><pre class="hljs"><span class="hljs-comment">Imports</span></pre></summary>
<p>For imports, we’ll need the controller-runtime
<a href="https://pkg.go.dev/sigs.k8s.io/controller-runtime/pkg/conversion?tab=doc"><code>conversion</code></a>
package, plus the API version for our hub type (v1), and finally some of the
standard packages.</p>
<pre><code class="language-go">import (
	&quot;fmt&quot;
	&quot;strings&quot;

	&quot;sigs.k8s.io/controller-runtime/pkg/conversion&quot;

	&quot;tutorial.kubebuilder.io/project/api/v1&quot;
)
</code></pre>
</details>
<p>我们的 “spoke” 版本需要实现
<a href="https://pkg.go.dev/sigs.k8s.io/controller-runtime/pkg/conversion?tab=doc#Convertible"><code>Convertible</code></a>
接口。顾名思义，它需要实现 <code>ConvertTo</code> 从（其它版本）向 hub 版本转换，<code>ConvertFrom</code> 实现从 hub 版本转换到（其他版本）。</p>
<p>ConvertTo 期望修改其参数以包含转换后的对象。
大部分转换都是直接赋值，除了那些发生变化的 field。</p>
<pre><code class="language-go">// ConvertTo 转换 CronJob 到 Hub 版本 (v1).
func (src *CronJob) ConvertTo(dstRaw conversion.Hub) error {
	dst := dstRaw.(*v1.CronJob)

	sched := src.Spec.Schedule
	scheduleParts := []string{&quot;*&quot;, &quot;*&quot;, &quot;*&quot;, &quot;*&quot;, &quot;*&quot;}
	if sched.Minute != nil {
		scheduleParts[0] = string(*sched.Minute)
	}
	if sched.Hour != nil {
		scheduleParts[1] = string(*sched.Hour)
	}
	if sched.DayOfMonth != nil {
		scheduleParts[2] = string(*sched.DayOfMonth)
	}
	if sched.Month != nil {
		scheduleParts[3] = string(*sched.Month)
	}
	if sched.DayOfWeek != nil {
		scheduleParts[4] = string(*sched.DayOfWeek)
	}
	dst.Spec.Schedule = strings.Join(scheduleParts, &quot; &quot;)
</code></pre>
<details class="collapse-code"><summary class="hljs"><pre class="hljs"><span class="hljs-comment">rote conversion</span></pre></summary>
<p>剩下的转换都相当机械。</p>
<pre><code class="language-go">	// ObjectMeta
	dst.ObjectMeta = src.ObjectMeta

	// Spec
	dst.Spec.StartingDeadlineSeconds = src.Spec.StartingDeadlineSeconds
	dst.Spec.ConcurrencyPolicy = v1.ConcurrencyPolicy(src.Spec.ConcurrencyPolicy)
	dst.Spec.Suspend = src.Spec.Suspend
	dst.Spec.JobTemplate = src.Spec.JobTemplate
	dst.Spec.SuccessfulJobsHistoryLimit = src.Spec.SuccessfulJobsHistoryLimit
	dst.Spec.FailedJobsHistoryLimit = src.Spec.FailedJobsHistoryLimit

	// Status
	dst.Status.Active = src.Status.Active
	dst.Status.LastScheduleTime = src.Status.LastScheduleTime
</code></pre>
</details>
<pre><code class="language-go">	return nil
}
</code></pre>
<p>ConvertFrom 期望修改其接收者以包含转换后的对象。
大部分转换都是直接赋值，除了那些发生变化的 field。</p>
<pre><code class="language-go">// ConvertFrom 从 Hub 版本 (v1) 转换到这个版本。
func (dst *CronJob) ConvertFrom(srcRaw conversion.Hub) error {
	src := srcRaw.(*v1.CronJob)

	schedParts := strings.Split(src.Spec.Schedule, &quot; &quot;)
	if len(schedParts) != 5 {
		return fmt.Errorf(&quot;invalid schedule: not a standard 5-field schedule&quot;)
	}
	partIfNeeded := func(raw string) *CronField {
		if raw == &quot;*&quot; {
			return nil
		}
		part := CronField(raw)
		return &amp;part
	}
	dst.Spec.Schedule.Minute = partIfNeeded(schedParts[0])
	dst.Spec.Schedule.Hour = partIfNeeded(schedParts[1])
	dst.Spec.Schedule.DayOfMonth = partIfNeeded(schedParts[2])
	dst.Spec.Schedule.Month = partIfNeeded(schedParts[3])
	dst.Spec.Schedule.DayOfWeek = partIfNeeded(schedParts[4])
</code></pre>
<details class="collapse-code"><summary class="hljs"><pre class="hljs"><span class="hljs-comment">rote conversion</span></pre></summary>
<p>The rest of the conversion is pretty rote.</p>
<pre><code class="language-go">	// ObjectMeta
	dst.ObjectMeta = src.ObjectMeta

	// Spec
	dst.Spec.StartingDeadlineSeconds = src.Spec.StartingDeadlineSeconds
	dst.Spec.ConcurrencyPolicy = ConcurrencyPolicy(src.Spec.ConcurrencyPolicy)
	dst.Spec.Suspend = src.Spec.Suspend
	dst.Spec.JobTemplate = src.Spec.JobTemplate
	dst.Spec.SuccessfulJobsHistoryLimit = src.Spec.SuccessfulJobsHistoryLimit
	dst.Spec.FailedJobsHistoryLimit = src.Spec.FailedJobsHistoryLimit

	// Status
	dst.Status.Active = src.Status.Active
	dst.Status.LastScheduleTime = src.Status.LastScheduleTime
</code></pre>
</details>
<pre><code class="language-go">	return nil
}
</code></pre>
</div>
<p>现在我们的转换方法已经就绪，我们要做的就是启动我们的 main 方法来运行 webhook。</p>
<h1><a class="header" href="#设置-webhook" id="设置-webhook">设置 webhook</a></h1>
<p>我们的 conversion 已经就位，所以接下来就是告诉 controller-runtime 关于我们的 conversion。</p>
<p>通常，我们通过运行</p>
<pre><code class="language-shell">kubebuilder create webhook --group batch --version v1 --kind CronJob --conversion
</code></pre>
<p>来搭建起 webhook 设置。然而，当我们已经创建好默认和验证过的 webhook 时，我们就已经设置好 webhook。</p>
<h2><a class="header" href="#webhook-设置" id="webhook-设置">Webhook 设置...</a></h2>
<div class="literate"><cite class="literate-source"><a href="https://sigs.k8s.io/kubebuilder/docs/book/src/multiversion-tutorial/testdata/project/api/v1/cronjob_webhook.go">project/api/v1/cronjob_webhook.go</a></cite><details class="collapse-code"><summary class="hljs"><pre class="hljs"><span class="hljs-comment">Apache License</span></pre></summary>
<p>Copyright 2020 The Kubernetes authors.</p>
<p>Licensed under the Apache License, Version 2.0 (the “License”);
you may not use this file except in compliance with the License.
You may obtain a copy of the License at</p>
<pre><code>http://www.apache.org/licenses/LICENSE-2.0
</code></pre>
<p>Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an “AS IS” BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.</p>
</details><details class="collapse-code"><summary class="hljs"><pre class="hljs"><span class="hljs-comment">Go imports</span></pre></summary>
<pre><code class="language-go">package v1

import (
	&quot;github.com/robfig/cron&quot;
	apierrors &quot;k8s.io/apimachinery/pkg/api/errors&quot;
	&quot;k8s.io/apimachinery/pkg/runtime&quot;
	&quot;k8s.io/apimachinery/pkg/runtime/schema&quot;
	validationutils &quot;k8s.io/apimachinery/pkg/util/validation&quot;
	&quot;k8s.io/apimachinery/pkg/util/validation/field&quot;
	ctrl &quot;sigs.k8s.io/controller-runtime&quot;
	logf &quot;sigs.k8s.io/controller-runtime/pkg/log&quot;
	&quot;sigs.k8s.io/controller-runtime/pkg/webhook&quot;
)
</code></pre>
</details>
<pre><code class="language-go">var cronjoblog = logf.Log.WithName(&quot;cronjob-resource&quot;)
</code></pre>
<p>对于 conversion webhook 这项设置达成了两个目标：在我们的类型实现
<a href="https://pkg.go.dev/sigs.k8s.io/controller-runtime/pkg/conversion?tab=doc#Hub">Hub</a> 和
<a href="https://pkg.go.dev/sigs.k8s.io/controller-runtime/pkg/conversion?tab=doc#Convertible">Convertible</a>
接口的同时，一个 conversion webhook 会被成功注册。</p>
<pre><code class="language-go">func (r *CronJob) SetupWebhookWithManager(mgr ctrl.Manager) error {
	return ctrl.NewWebhookManagedBy(mgr).
		For(r).
		Complete()
}
</code></pre>
<details class="collapse-code"><summary class="hljs"><pre class="hljs"><span class="hljs-comment">Existing Defaulting and Validation</span></pre></summary>
<pre><code class="language-go">// +kubebuilder:webhook:path=/mutate-batch-tutorial-kubebuilder-io-v1-cronjob,mutating=true,failurePolicy=fail,groups=batch.tutorial.kubebuilder.io,resources=cronjobs,verbs=create;update,versions=v1,name=mcronjob.kb.io

var _ webhook.Defaulter = &amp;CronJob{}

// Default 实现 webhook.Defaulter 使这类型的 webhook 被成功注册
func (r *CronJob) Default() {
	cronjoblog.Info(&quot;default&quot;, &quot;name&quot;, r.Name)

	if r.Spec.ConcurrencyPolicy == &quot;&quot; {
		r.Spec.ConcurrencyPolicy = AllowConcurrent
	}
	if r.Spec.Suspend == nil {
		r.Spec.Suspend = new(bool)
	}
	if r.Spec.SuccessfulJobsHistoryLimit == nil {
		r.Spec.SuccessfulJobsHistoryLimit = new(int32)
		*r.Spec.SuccessfulJobsHistoryLimit = 3
	}
	if r.Spec.FailedJobsHistoryLimit == nil {
		r.Spec.FailedJobsHistoryLimit = new(int32)
		*r.Spec.FailedJobsHistoryLimit = 1
	}
}

// TODO(user): 修改 verbs 为 &quot;verbs=create;update;delete&quot;，如果你想允许删除验证。
// +kubebuilder:webhook:verbs=create;update,path=/validate-batch-tutorial-kubebuilder-io-v1-cronjob,mutating=false,failurePolicy=fail,groups=batch.tutorial.kubebuilder.io,resources=cronjobs,versions=v1,name=vcronjob.kb.io

var _ webhook.Validator = &amp;CronJob{}

// ValidateCreate 实现 webhook.Validator 使这类型的 webhook 被成功注册
func (r *CronJob) ValidateCreate() error {
	cronjoblog.Info(&quot;validate create&quot;, &quot;name&quot;, r.Name)

	return r.validateCronJob()
}

// ValidateUpdate 实现 webhook.Validator 使这类型的 webhook 被成功注册
func (r *CronJob) ValidateUpdate(old runtime.Object) error {
	cronjoblog.Info(&quot;validate update&quot;, &quot;name&quot;, r.Name)

	return r.validateCronJob()
}

// ValidateDelete 实现 webhook.Validator 使这类型的 webhook 被成功注册
func (r *CronJob) ValidateDelete() error {
	cronjoblog.Info(&quot;validate delete&quot;, &quot;name&quot;, r.Name)

	// TODO(user): 在对象删除之前填入你的验证逻辑
	return nil
}

func (r *CronJob) validateCronJob() error {
	var allErrs field.ErrorList
	if err := r.validateCronJobName(); err != nil {
		allErrs = append(allErrs, err)
	}
	if err := r.validateCronJobSpec(); err != nil {
		allErrs = append(allErrs, err)
	}
	if len(allErrs) == 0 {
		return nil
	}

	return apierrors.NewInvalid(
		schema.GroupKind{Group: &quot;batch.tutorial.kubebuilder.io&quot;, Kind: &quot;CronJob&quot;},
		r.Name, allErrs)
}

func (r *CronJob) validateCronJobSpec() *field.Error {
	// 来自 kubernetes API 的 field 帮助器帮助我们返回友好的
	// 结构化的验证错误。
	return validateScheduleFormat(
		r.Spec.Schedule,
		field.NewPath(&quot;spec&quot;).Child(&quot;schedule&quot;))
}

func validateScheduleFormat(schedule string, fldPath *field.Path) *field.Error {
	if _, err := cron.ParseStandard(schedule); err != nil {
		return field.Invalid(fldPath, schedule, err.Error())
	}
	return nil
}

func (r *CronJob) validateCronJobName() *field.Error {
	if len(r.ObjectMeta.Name) &gt; validationutils.DNS1035LabelMaxLength-11 {
		// 和所有的 Kubernetes 对象一样 job 名称的长度是 63 个字符
		// （它必须适合一个 DNS 子域名）。 当创建一个 job，cronjob 控制器在 
		// cronjob 后附加一个 11 个字符的后缀 (`-$TIMESTAMP`) 。
		// job 名称的长度限制是 63 个字符。因此 cronjob
		// 名称的长度必须 &lt;= 63-11=52。如果这里我们不验证，
		// 那么 job 的创建稍后将会失败。
		return field.Invalid(field.NewPath(&quot;metadata&quot;).Child(&quot;name&quot;), r.Name, &quot;must be no more than 52 characters&quot;)
	}
	return nil
}
</code></pre>
</details></div>
<h2><a class="header" href="#以及-maingo" id="以及-maingo">...以及 <code>main.go</code></a></h2>
<p>同样地，我们的 main 文件也已就绪：</p>
<div class="literate"><cite class="literate-source"><a href="https://sigs.k8s.io/kubebuilder/docs/book/src/multiversion-tutorial/testdata/project/main.go">project/main.go</a></cite><details class="collapse-code"><summary class="hljs"><pre class="hljs"><span class="hljs-comment">Apache License</span></pre></summary>
<p>Copyright 2020 The Kubernetes authors.</p>
<p>Licensed under the Apache License, Version 2.0 (the “License”);
you may not use this file except in compliance with the License.
You may obtain a copy of the License at</p>
<pre><code>http://www.apache.org/licenses/LICENSE-2.0
</code></pre>
<p>Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an “AS IS” BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.</p>
</details><details class="collapse-code"><summary class="hljs"><pre class="hljs"><span class="hljs-comment">Imports</span></pre></summary>
<pre><code class="language-go">package main

import (
	&quot;flag&quot;
	&quot;os&quot;

	kbatchv1 &quot;k8s.io/api/batch/v1&quot;
	&quot;k8s.io/apimachinery/pkg/runtime&quot;
	utilruntime &quot;k8s.io/apimachinery/pkg/util/runtime&quot;
	clientgoscheme &quot;k8s.io/client-go/kubernetes/scheme&quot;
	_ &quot;k8s.io/client-go/plugin/pkg/client/auth/gcp&quot;
	ctrl &quot;sigs.k8s.io/controller-runtime&quot;
	&quot;sigs.k8s.io/controller-runtime/pkg/log/zap&quot;

	batchv1 &quot;tutorial.kubebuilder.io/project/api/v1&quot;
	batchv2 &quot;tutorial.kubebuilder.io/project/api/v2&quot;
	&quot;tutorial.kubebuilder.io/project/controllers&quot;
	// +kubebuilder:scaffold:imports
)
</code></pre>
</details><details class="collapse-code"><summary class="hljs"><pre class="hljs"><span class="hljs-comment">existing setup</span></pre></summary>
<pre><code class="language-go">var (
	scheme   = runtime.NewScheme()
	setupLog = ctrl.Log.WithName(&quot;setup&quot;)
)

func init() {
	utilruntime.Must(clientgoscheme.AddToScheme(scheme))
	_ = kbatchv1.AddToScheme(scheme) // 我们自己添加的
	_ = batchv1.AddToScheme(scheme)
	_ = batchv2.AddToScheme(scheme)
	// +kubebuilder:scaffold:scheme
}
</code></pre>
</details>
<pre><code class="language-go">func main() {
</code></pre>
<details class="collapse-code"><summary class="hljs"><pre class="hljs"><span class="hljs-comment">existing setup</span></pre></summary>
<pre><code class="language-go">	var metricsAddr string
	var enableLeaderElection bool
	flag.StringVar(&amp;metricsAddr, &quot;metrics-addr&quot;, &quot;:8080&quot;, &quot;The address the metric endpoint binds to.&quot;)
	flag.BoolVar(&amp;enableLeaderElection, &quot;enable-leader-election&quot;, false,
		&quot;Enable leader election for controller manager. &quot;+
			&quot;Enabling this will ensure there is only one active controller manager.&quot;)
	flag.Parse()

	ctrl.SetLogger(zap.New(zap.UseDevMode(true)))

	mgr, err := ctrl.NewManager(ctrl.GetConfigOrDie(), ctrl.Options{
		Scheme:             scheme,
		MetricsBindAddress: metricsAddr,
		Port:               9443,
		LeaderElection:     enableLeaderElection,
		LeaderElectionID:   &quot;80807133.tutorial.kubebuilder.io&quot;,
	})
	if err != nil {
		setupLog.Error(err, &quot;unable to start manager&quot;)
		os.Exit(1)
	}

	if err = (&amp;controllers.CronJobReconciler{
		Client: mgr.GetClient(),
		Log:    ctrl.Log.WithName(&quot;controllers&quot;).WithName(&quot;CronJob&quot;),
		Scheme: mgr.GetScheme(),
	}).SetupWithManager(mgr); err != nil {
		setupLog.Error(err, &quot;unable to create controller&quot;, &quot;controller&quot;, &quot;CronJob&quot;)
		os.Exit(1)
	}
</code></pre>
</details>
<p>我们现在调用 SetupWebhookWithManager 来注册我们的 conversion webhook 到管理器，如此。</p>
<pre><code class="language-go">	if err = (&amp;batchv1.CronJob{}).SetupWebhookWithManager(mgr); err != nil {
		setupLog.Error(err, &quot;unable to create webhook&quot;, &quot;webhook&quot;, &quot;CronJob&quot;)
		os.Exit(1)
	}
	if err = (&amp;batchv2.CronJob{}).SetupWebhookWithManager(mgr); err != nil {
		setupLog.Error(err, &quot;unable to create webhook&quot;, &quot;webhook&quot;, &quot;CronJob&quot;)
		os.Exit(1)
	}
	// +kubebuilder:scaffold:builder
</code></pre>
<details class="collapse-code"><summary class="hljs"><pre class="hljs"><span class="hljs-comment">existing setup</span></pre></summary>
<pre><code class="language-go">	setupLog.Info(&quot;starting manager&quot;)
	if err := mgr.Start(ctrl.SetupSignalHandler()); err != nil {
		setupLog.Error(err, &quot;problem running manager&quot;)
		os.Exit(1)
	}
</code></pre>
</details>
<pre><code class="language-go">}
</code></pre>
</div>
<p>所有都已经设置准备好！接下来要做的只有测试我们的 webhook。</p>
<h1><a class="header" href="#部署和测试" id="部署和测试">部署和测试</a></h1>
<p>在测试版本转换之前，我们需要在 CRD 中启用转换：</p>
<p>Kubebuilder 在 <code>config</code> 目录下生成禁用 webhook bits 的 Kubernetes 清单。要启用它们，我们需要：</p>
<ul>
<li>
<p>在 <code>config/crd/kustomization.yaml</code> 文件启用 <code>patches/webhook_in_&lt;kind&gt;.yaml</code> 和
<code>patches/cainjection_in_&lt;kind&gt;.yaml</code>。</p>
</li>
<li>
<p>在 <code>config/default/kustomization.yaml</code> 文件的 <code>bases</code> 部分下启用 <code>../certmanager</code> 和 <code>../webhook</code> 目录。</p>
</li>
<li>
<p>在 <code>config/default/kustomization.yaml</code> 文件的 <code>patches</code> 部分下启用 <code>manager_webhook_patch.yaml</code>。</p>
</li>
<li>
<p>在 <code>config/default/kustomization.yaml</code> 文件的 <code>CERTMANAGER</code> 部分下启用所有变量。</p>
</li>
</ul>
<p>此外，我们需要将 <code>CRD_OPTIONS</code> 变量设置为 <code>&quot;crd&quot;</code>，删除 <code>trivialVersions</code> 选项（这确保我们实际 
<a href="multiversion-tutorial//reference/generating-crd.html#multiple-versions" title="Generating CRDs: Multiple Versions">为每个版本生成验证</a>，而不是告诉 Kubernetes 它们是一样的）：</p>
<pre><code class="language-makefile">CRD_OPTIONS ?= &quot;crd&quot;
</code></pre>
<p>现在，我们已经完成了所有的代码更改和清单，让我们将其部署到集群并对其进行测试。</p>
<p>你需要安装 <a href="multiversion-tutorial/../cronjob-tutorial/cert-manager.html">cert-manager</a>（<code>0.9.0+</code> 版本），
除非你有其他证书管理解决方案。Kubebuilder 团队已在
<a href="https://github.com/jetstack/cert-manager/releases/tag/v0.9.0-alpha.0">0.9.0-alpha.0</a>
版本中测试了本教程中的指令。</p>
<p>一旦所有的证书准备妥当后, 我们就可以运行 <code>make install deploy</code>（和平常一样）将所有的 bits（CRD,
controller-manager deployment）部署到集群上。</p>
<h2><a class="header" href="#测试-1" id="测试-1">测试</a></h2>
<p>一旦启用了转换的所有 bits 都在群集上运行，我们就可以通过请求不同的版本来测试转换。</p>
<p>我们将基于 v1 版本制作 v2 版本（将其放在 <code>config/samples</code> 下）</p>
<pre><code class="language-yaml">apiVersion: batch.tutorial.kubebuilder.io/v2
kind: CronJob
metadata:
  name: cronjob-sample
spec:
  schedule:
    minute: &quot;*/1&quot;
  startingDeadlineSeconds: 60
  concurrencyPolicy: Allow # explicitly specify, but Allow is also default.
  jobTemplate:
    spec:
      template:
        spec:
          containers:
          - name: hello
            image: busybox
            args:
            - /bin/sh
            - -c
            - date; echo Hello from the Kubernetes cluster
          restartPolicy: OnFailure
</code></pre>
<p>然后，我们可以在集群中创建它：</p>
<pre><code class="language-shell">kubectl apply -f config/samples/batch_v2_cronjob.yaml
</code></pre>
<p>如果我们正确地完成了所有操作，那么它应该能够成功地创建，并且我们能够使用 v2 资源来获取它</p>
<pre><code class="language-shell">kubectl get cronjobs.v2.batch.tutorial.kubebuilder.io -o yaml
</code></pre>
<pre><code class="language-yaml">apiVersion: batch.tutorial.kubebuilder.io/v2
kind: CronJob
metadata:
  name: cronjob-sample
spec:
  schedule:
    minute: &quot;*/1&quot;
  startingDeadlineSeconds: 60
  concurrencyPolicy: Allow # explicitly specify, but Allow is also default.
  jobTemplate:
    spec:
      template:
        spec:
          containers:
          - name: hello
            image: busybox
            args:
            - /bin/sh
            - -c
            - date; echo Hello from the Kubernetes cluster
          restartPolicy: OnFailure
</code></pre>
<p>v1 资源</p>
<pre><code class="language-shell">kubectl get cronjobs.v1.batch.tutorial.kubebuilder.io -o yaml
</code></pre>
<pre><code class="language-yaml">apiVersion: batch.tutorial.kubebuilder.io/v1
kind: CronJob
metadata:
  name: cronjob-sample
spec:
  schedule: &quot;*/1 * * * *&quot;
  startingDeadlineSeconds: 60
  concurrencyPolicy: Allow # explicitly specify, but Allow is also default.
  jobTemplate:
    spec:
      template:
        spec:
          containers:
          - name: hello
            image: busybox
            args:
            - /bin/sh
            - -c
            - date; echo Hello from the Kubernetes cluster
          restartPolicy: OnFailure
</code></pre>
<p>两者都应填写，并分别看起来等同于的 v2 和 v1 示例。注意，每个都有不同的 API 版本。</p>
<p>最后，如果稍等片刻，我们应该注意到，即使我们的控制器是根据 v1 API 版本编写的，我们的 CronJob 仍在继续协调。</p>
<aside class="note">
<h1><a class="header" href="#kubectl-和首选版本" id="kubectl-和首选版本">kubectl 和首选版本</a></h1>
<p>当我们从 Go 代码访问 API 类型时，我们会通过使用该版本的 Go 类型（例如 <code>batchv2.CronJob</code>）来请求特定版本。</p>
<p>你可能已经注意到，上面对 kubectl 的调用与我们通常所做的看起来有些不同 —— 即，它指定了一个 
<em>group-version-resource</em> 而不是一个资源。</p>
<p>当我们运行 <code>kubectl get cronjob</code> 时, kubectl 需要弄清楚映射到哪个
group-version-resource。为此，它使用 <em>discovery API</em> 来找出 <code>cronjob</code> 资源的首选版本。对于 CRD，
这或多或少是最新的稳定版本（具体细节请参阅 <a href="https://kubernetes.io/docs/tasks/extend-kubernetes/custom-resources/custom-resource-definition-versioning/#version-priority" title="Versions in CustomResourceDefinitions">CRD 文档</a>)。</p>
<p>随着我们对 CronJob 的更新, 意味着 <code>kubectl get cronjob</code> 将获取 <code>batch/v2</code> group-version。</p>
<p>如果我们想指定一个确切的版本，可以像上面一样使用 <code>kubectl get resource.version.group</code>。</p>
<p><em><strong>你应该始终在脚本中使用完全合格的 group-version-resource 语法</strong></em>。
<code>kubectl get resource</code> 是为人类、有自我意识的机器人和其他能够理解新版本的众生设计的。
<code>kubectl get resource.version.group</code> 用于其他的一切。</p>
</aside>
<h2><a class="header" href="#故障排除" id="故障排除">故障排除</a></h2>
<p><a href="multiversion-tutorial//TODO.html">故障排除的步骤</a></p>
<h1><a class="header" href="#迁移" id="迁移">迁移</a></h1>
<p>Kubebuilder 项目结构之间的迁移通常会涉及到一些手动操作。</p>
<h2><a class="header" href="#这部分将详细说明在-kubebuilder-自动生成的不同版本之间迁移或向更复杂的项目层级结构迁移时所需具备的条件" id="这部分将详细说明在-kubebuilder-自动生成的不同版本之间迁移或向更复杂的项目层级结构迁移时所需具备的条件">这部分将详细说明，在 Kubebuilder 自动生成的不同版本之间迁移或向更复杂的项目层级结构迁移时所需具备的条件。</a></h2>
<ul>
<li></li>
</ul>
<h1><a class="header" href="#kubebuilder-v1-版本-vs-v2-版本" id="kubebuilder-v1-版本-vs-v2-版本">Kubebuilder v1 版本 VS v2 版本</a></h1>
<p>这篇文档涵盖了从 v1 版本迁移到 v2 版本时所有破坏性的变化。</p>
<p>所有细节变化（破坏性的或者其他）可以查询 <a href="https://github.com/kubernetes-sigs/controller-runtime/releases">controller-runtime</a>,
<a href="https://github.com/kubernetes-sigs/controller-tools/releases">controller-tools</a> 和 <a href="https://github.com/kubernetes-sigs/kubebuilder/releases">kubebuilder</a> 发布说明。</p>
<h2><a class="header" href="#常规变化" id="常规变化">常规变化</a></h2>
<p>V2 版本项目中使用 go modules。但是 kubebuilder 会继续支持 <code>dep</code> 直到 go 1.13 正式发布。</p>
<h2><a class="header" href="#controller-runtime" id="controller-runtime">controller-runtime</a></h2>
<ul>
<li>
<p><code>Client.List</code> 现在使用 functional options (<code>List(ctx, list, ...option)</code>) 代替 <code>List(ctx, ListOptions, list)</code>。</p>
</li>
<li>
<p><code>Client</code> 接口加入了 <code>Client.DeleteAllOf</code>。</p>
</li>
<li>
<p>默认开启 Metrics。</p>
</li>
<li>
<p><code>pkg/runtime</code>下的一些包已经被移除，它们旧的位置已被弃用。并将会在 controller-runtime v1.0.0 版本之前删除。更多信息请看 <a href="https://pkg.go.dev/sigs.k8s.io/controller-runtime/pkg/runtime?tab=doc">godocs</a>。</p>
</li>
</ul>
<h2><a class="header" href="#webhook-related" id="webhook-related">Webhook-related</a></h2>
<ul>
<li>
<p>webhooks 的自动证书生成已经被移除，并且它将不再自动注册。使用 controller-tools 去生成 webhook 配置。如果你需要生成证书，我们推荐使用 <a href="https://github.com/jetstack/cert-manager">cert-manager</a>。Kubebuilder v2 版本将会自动生成证书管理器配置供你使用 -- 更多细节请看 <a href="migration//cronjob-tutorial/webhook-implementation.html">Webhook 教程</a>。</p>
</li>
<li>
<p><code>builder</code> 包现在为 controllers 和 webhooks 提供了独立的生成器，这便于选择哪个去运行。</p>
</li>
</ul>
<h2><a class="header" href="#controller-tools" id="controller-tools">controller-tools</a></h2>
<p>在 v2 版本中已经重写了生成器框架。在许多情况下，它仍然像以前一样工作，但是要注意有一些破坏性的变化。更多细节请看 <a href="migration//reference/markers.html">marker 文档</a>。</p>
<h2><a class="header" href="#kubebuilder" id="kubebuilder">Kubebuilder</a></h2>
<ul>
<li>
<p>Kubebuilder v2 版本引入了简化的项目布局。你可以在 <a href="https://github.com/kubernetes-sigs/kubebuilder/blob/master/designs/simplified-scaffolding.md">这里</a> 找到相关设计文档。</p>
</li>
<li>
<p>在 v1 版本中，manager 作为一个 <code>StatefulSet</code> 部署，而在 v2 版本中是作为一个 <code>Deployment</code> 部署。</p>
</li>
<li>
<p><code>kubebuilder create webhook</code> 命令被用来自动生成 mutating/validating/conversion webhooks. 它代替了 <code>kubebuilder alpha webhook</code> 命令。</p>
</li>
<li>
<p>v2 版本使用 <code>distroless/static</code> 代替 Ubuntu 作为基础镜像。这减少了镜像大小和受攻击面。</p>
</li>
<li>
<p>v2 版本要求 kustomize v3.1.0+。</p>
</li>
</ul>
<h1><a class="header" href="#从-v1-版本迁移到-v2-版本" id="从-v1-版本迁移到-v2-版本">从 v1 版本迁移到 v2 版本</a></h1>
<p>在继续后续操作之前要确保你了解<a href="migration/./v1vsv2.html">Kubebuilder v1 版本和 v2 版本之间的不同</a>。</p>
<p>请确保你根据<a href="migration//quick-start.html#installation">安装指导</a>安装了迁移所需的组件。</p>
<p>迁移 v1 项目的推荐方法是创建一个新的 v2 项目，然后将 API 和 reconciliation 代码拷贝过来。
这种转换就像一个原生的 v2 项目。然后，在某些情况下，是可以进行就地升级的（比如，复用 v1 项目
的层级结构，升级 controller-runtime 和 controller-tools）。</p>
<p>让我们来看一个[v1 项目例子][v1-project]并且将其迁移至 Kubebuilder v2。最后，我们会有一些
东西看起来像<a href="https://github.com/kubernetes-sigs/kubebuilder/tree/master/docs/book/src/cronjob-tutorial/testdata/project">v2 项目例子</a>。</p>
<h2><a class="header" href="#准备" id="准备">准备</a></h2>
<p>我们将需要明确 group，vresion，kind 和 domain 都是什么。</p>
<p>让我们看看我们目前的 v1 项目的结构:</p>
<pre><code>pkg/
├── apis
│   ├── addtoscheme_batch_v1.go
│   ├── apis.go
│   └── batch
│       ├── group.go
│       └── v1
│           ├── cronjob_types.go
│           ├── cronjob_types_test.go
│           ├── doc.go
│           ├── register.go
│           ├── v1_suite_test.go
│           └── zz_generated.deepcopy.go
├── controller
└── webhook
</code></pre>
<p>我们所有的 API 信息都存放在 <code>pkg/apis/batch</code> 目录下，因此我们可以在那儿查找以
获取我们需要知道的东西。</p>
<p>在 <code>cronjob_types.go</code> 中，我们可以找到</p>
<pre><code class="language-go">type CronJob struct {...}
</code></pre>
<p>在 <code>register.go</code> 中，我们可以找到</p>
<pre><code class="language-go">SchemeGroupVersion = schema.GroupVersion{Group: &quot;batch.tutorial.kubebuilder.io&quot;, Version: &quot;v1&quot;}
</code></pre>
<p>把这些集合起来，我们能够得到 kind 是 <code>CronJob</code>，group-version 是 <code>batch.tutorial.kubebuilder.io/v1</code>。</p>
<h2><a class="header" href="#初始化一个-v2-项目" id="初始化一个-v2-项目">初始化一个 v2 项目</a></h2>
<p>现在，我们需要初始化一个 v2 项目。然而，在此之前，如果在 <code>gopath</code> 中我们没有找到 go 模块，
那么我们需要初始化一个新的 go 模块。</p>
<pre><code class="language-bash">go mod init tutorial.kubebuilder.io/project
</code></pre>
<p>接下来，我们可以用 kubebuilder 来完成项目的初始化：</p>
<pre><code class="language-bash">kubebuilder init --domain tutorial.kubebuilder.io
</code></pre>
<h2><a class="header" href="#迁移-apis-和-controllers" id="迁移-apis-和-controllers">迁移 APIs 和 Controllers</a></h2>
<p>接下来，我们将重新生成 API 类型和 controllers。因为两者我们都需要，当向我们询问
我们想要生成哪些部分时，我们需要输入 yes 来同时生成 API 和 controller。</p>
<pre><code class="language-bash">kubebuilder create api --group batch --version v1 --kind CronJob
</code></pre>
<p>如果你在使用多 group，迁移的时候就需要一些手动工作了。更多详细信息可以
查看<a href="migration//migration/multi-group.html">这个</a>。</p>
<h3><a class="header" href="#迁移-apis" id="迁移-apis">迁移 APIs</a></h3>
<p>现在，让我们把 API 的定义部分从 <code>pkg/apis/batch/v1/cronjob_types.go</code> 拷贝
至 <code>api/v1/cronjob_types.go</code>。我们仅仅需要拷贝 <code>Spec</code> 和 <code>Status</code> 字段的实现部分。</p>
<p>我们可以用 <code>+kubebuilder:object:root=true</code> 来替代 <code>+k8s:deepcopy-gen:interfaces=...</code> 标记
（这个在<a href="migration//reference/markers/object.html">Kubebuilder 中废弃了</a>）。</p>
<p>我们不再需要以下的标记了（他们不再被使用，是 KubeBuilder 一些老版本的遗留产物）。 </p>
<pre><code class="language-go">// +genclient
// +k8s:openapi-gen=true
</code></pre>
<p>我们的 API 类型看起来应该像下面这样:</p>
<pre><code class="language-go">// +kubebuilder:object:root=true
// +kubebuilder:subresource:status
// CronJob is the Schema for the cronjobs API
type CronJob struct {...}

// +kubebuilder:object:root=true

// CronJobList contains a list of CronJob
type CronJobList struct {...}
</code></pre>
<h3><a class="header" href="#迁移-controllers" id="迁移-controllers">迁移 Controllers</a></h3>
<p>现在，让我们将 controller reconciler 的代码从 <code>pkg/controller/cronjob/cronjob_controller.go</code>
迁移至 <code>controllers/cronjob_controller.go</code>。</p>
<p>我们需要拷贝</p>
<ul>
<li><code>ReconcileCronJob</code> 结构体中的字段到 <code>CronJobReconciler</code>。</li>
<li><code>Reconcile</code> 函数的内容。</li>
<li><a href="migration//reference/markers/rbac.html">rbac 相关标记</a>到一个新文件。</li>
<li><code>func add(mgr manager.Manager, r reconcile.Reconciler) error</code> 下的代码
到 <code>func SetupWithManager</code>。</li>
</ul>
<h2><a class="header" href="#迁移-webhooks" id="迁移-webhooks">迁移 Webhooks</a></h2>
<p>如果你还没有webhook，你可以跳过此章节。</p>
<h3><a class="header" href="#core-类型和外部-crds-的-webhooks" id="core-类型和外部-crds-的-webhooks">Core 类型和外部 CRDs 的 Webhooks</a></h3>
<p>如果你在使用 Kubernetes core 类型（比如 Pods），或者不属于你的一个外部 CRD 的 webhooks，
你可以参考<a href="https://sigs.k8s.io/controller-runtime/examples/builtins">内置类型的 controller-runtime 例子</a>，然后做一些类似的事情。
Kubebuilder 不会为这种情形生成太多，但是你可以用 controller-runtime 中的一些库。</p>
<h3><a class="header" href="#为我们的-crds-自动生成-webhooks" id="为我们的-crds-自动生成-webhooks">为我们的 CRDs 自动生成 Webhooks</a></h3>
<p>现在让我们为我们的 CRD (CronJob) 自动生成 webhooks。我们需要运行以下命令并指定 <code>--defaulting</code>
和 <code>--programmatic-validation</code> 参数（因为我们的测试项目使用 defaulting 和 validating webhooks）：</p>
<pre><code class="language-bash">kubebuilder create webhook --group batch --version v1 --kind CronJob --defaulting --programmatic-validation
</code></pre>
<p>取决于有多少 CRDs 需要 webhooks，我们或许需要为不同的 Group-Version-Kinds 多次执行上述的命令。</p>
<p>现在，我们需要为每一个 webhook 来拷贝逻辑。对于 validating webhooks，我们需要将
<code>pkg/default_server/cronjob/validating/cronjob_create_handler.go</code> 文件中 <code>func validatingCronJobFn</code>
内容拷贝至 <code>api/v1/cronjob_webhook.go</code> 文件中的 <code>func ValidateCreate</code>，对于 <code>update</code> 来说也是一样的。</p>
<p>类似的，我们将 <code>func mutatingCronJobFn</code> 拷贝至 <code>func Default</code>。</p>
<h3><a class="header" href="#webhook-标记" id="webhook-标记">Webhook 标记</a></h3>
<p>当自动生成 webhooks 时，Kubebuilder v2 添加了以下标记：</p>
<pre><code>// 这些是 v2 标记

// 这些是关于 mutating webhook 的
// +kubebuilder:webhook:path=/mutate-batch-tutorial-kubebuilder-io-v1-cronjob,mutating=true,failurePolicy=fail,groups=batch.tutorial.kubebuilder.io,resources=cronjobs,verbs=create;update,versions=v1,name=mcronjob.kb.io

...

// 这些是关于 validating webhook 的
// +kubebuilder:webhook:path=/validate-batch-tutorial-kubebuilder-io-v1-cronjob,mutating=false,failurePolicy=fail,groups=batch.tutorial.kubebuilder.io,resources=cronjobs,verbs=create;update,versions=v1,name=vcronjob.kb.io
</code></pre>
<p>默认的 verbs 是 <code>verbs=create;update</code>。我们需要确保 <code>verbs</code> 和我们所需要的是一致的。
比如，如果我们仅仅想验证 creation，那么我们就需要将 verbs 改成 <code>verbs=create</code>。</p>
<p>我们也需要确保 <code>failure-policy</code> 是不变的。</p>
<p>如下所示的标记将不再被使用（因为他们和自部署证书配置有关，这些在 v2 被移除了）：</p>
<pre><code class="language-go">// v1 markers
// +kubebuilder:webhook:port=9876,cert-dir=/tmp/cert
// +kubebuilder:webhook:service=test-system:webhook-service,selector=app:webhook-server
// +kubebuilder:webhook:secret=test-system:webhook-server-secret
// +kubebuilder:webhook:mutating-webhook-config-name=test-mutating-webhook-cfg
// +kubebuilder:webhook:validating-webhook-config-name=test-validating-webhook-cfg
</code></pre>
<p>在 v1 中，一个单个的 webhook 标记可能会被拆分成多个段落。但是在 v2 中，每一个
webhook 必须由一个单个的标记来表示。</p>
<h2><a class="header" href="#其他" id="其他">其他</a></h2>
<p>v1 中如果对 <code>main.go</code> 有任何手动更新，我们需要将修改同步至新的 <code>main.go</code> 中。我们还
需要确保所有需要的 schemes 已经被注册了。</p>
<p>如果在 <code>config</code> 目录下有一些额外的清单被添加进来，同样需要做同步。</p>
<p>如果需要的话在 Makefile 中修改镜像名字。</p>
<h2><a class="header" href="#验证" id="验证">验证</a></h2>
<p>最后，我们可以运行 <code>make</code> 和 <code>make docker-build</code> 来确保一些都运行正常。</p>
<h1><a class="header" href="#single-group-to-multi-group" id="single-group-to-multi-group">Single Group to Multi-Group</a></h1>
<aside class="note warning">
<h1><a class="header" href="#note" id="note">Note</a></h1>
<p>KubeBuilder 在早期的 v2 版本（v2.0.0）中不支持 Multi-group 代码生成功能。</p>
<p>想要更新项目结构支持 Multi-Group，请运行命令 <code>kubebuilder edit --multigroup = true</code>。 
更新到 Multi-group 结构后，将在新结构中生成新的 Kind，但是需要一些其他手动操作才能将旧的 API 组移至新结构中。</p>
</aside>
<p>尽管默认情况下 KubeBuilder v2 不会在同一存储库中搭建与多个 API 组兼容的项目结构，但可以修改默认项目结构以支持它。</p>
<p>让我们迁移下<a href="migration//cronjob-tutorial/cronjob-tutorial.html" title="Tutorial: Building CronJob">CronJob 示例</a>。</p>
<p>通常，我们使用 API 组的前缀作为目录名称。 查看 <code>api/v1/groupversion_info.go</code>，我们可以看到：</p>
<pre><code class="language-go">// +groupName=batch.tutorial.kubebuilder.io
package v1
</code></pre>
<p>为了让 api 结构更清晰，我们将 <code>api</code> 重命名为 <code>apis</code>，并将现有的 API 移动到新的子目录 batch 中：</p>
<pre><code class="language-bash">mkdir apis/batch
mv api/* apis/batch
# 确保所有文件都成功移动后，删除旧目录 `api`
rm -rf api/ 
</code></pre>
<p>将 API 移至新目录后，控制器也需要做相同的处理：</p>
<pre><code class="language-bash">mkdir controllers/batch
mv controllers/* controllers/batch/
</code></pre>
<p>接下来，我们将需要更新所有对旧软件包名称的引用。
对于 CronJob，我们需要更新 <code>main.go</code> 和 <code>controllers/batch/cronjob_controller.go</code>。</p>
<p>如果你已经在项目中添加了其他文件，那么也需要更新这些文件中的引用。</p>
<p>最后，我们将运行在项目中启用 Multi-group 模式的命令：</p>
<pre><code>kubebuilder edit --multigroup=true
</code></pre>
<p>执行 <code>kubebuilder edit --multigroup=true</code> 命令后，KubeBuilder 将会在 <code>PROJECT</code> 中新增一行，标记该项目是一个 Multi-group 项目:</p>
<pre><code class="language-yaml">version: &quot;2&quot;
domain: tutorial.kubebuilder.io
repo: tutorial.kubebuilder.io/project
multigroup: true
</code></pre>
<p>请注意，<code>multigroup: true</code> 表示这是一个 Multi-group 项目。</p>
<p>通过上述操作将项目标记为 Multi-group 项目后，原本已经实现的 API 仍旧保持原来的目录结构。该命令并不会自动帮你做调整。
请注意，在 <code>Multi-group</code> 项目中，Kind API 的文件被生成在 <code>apis/&lt;group&gt;/&lt;version&gt;</code>，而不是在 <code>api/&lt;version&gt;</code>。
另外，请注意控制器将在 <code>controllers/&lt;group&gt;</code> 目录下创建，而不是在 <code>controllers</code>。 
这就是为什么我们在前面的步骤中使用脚本移动之前生成的 API。
请记住，之后要更新引用。</p>
<p><a href="migration//cronjob-tutorial/cronjob-tutorial.html" title="Tutorial: Building CronJob">CronJob教程</a>更详细地解释了每个更改（在 KubeBuilder 为 Single-group 项目生成这些更改的上下文中）。</p>
<h1><a class="header" href="#参考" id="参考">参考</a></h1>
<ul>
<li>
<p><a href="reference/generating-crd.html">生成 CRDs</a></p>
</li>
<li>
<p><a href="reference/using-finalizers.html">使用 Finalizers</a>
Finalizers 是一种在资源被从 Kubernetes 集群删除之前，对资源执行的任何与资源相关的自定义逻辑的机制。</p>
</li>
<li>
<p><a href="reference/kind.html">Kind 集群</a></p>
</li>
<li>
<p><a href="reference/webhook-overview.html">什么是 webhook?</a>
Webhooks 是一种 HTTP 回调，在 k8s 中有三种 webhooks：1）准入 webhook
2）CRD 转换 webhook 3）授权 webhook</p>
<ul>
<li><a href="reference/admission-webhook.html">准入 webhook</a>
准入 webhooks 是对 mutating 和 validating 资源在准入 API server 之前的 HTTP 回调。</li>
</ul>
</li>
<li>
<p><a href="reference/markers.html">Config/Code 生成标记</a></p>
<ul>
<li><a href="reference/markers/crd.html">CRD 生成</a></li>
<li><a href="reference/markers/crd-validation.html">CRD 验证</a></li>
<li><a href="reference/markers/webhook.html">Webhook</a></li>
<li><a href="reference/markers/object.html">Object/DeepCopy</a></li>
<li><a href="reference/markers/rbac.html">RBAC</a></li>
</ul>
</li>
<li>
<p><a href="reference/controller-gen.html">controller-gen 命令行</a></p>
</li>
<li>
<p><a href="reference/completion.html">补全</a></p>
</li>
<li>
<p><a href="reference/artifacts.html">制品</a></p>
</li>
<li>
<p><a href="reference/writing-tests.html">编写 controller 测试</a></p>
</li>
<li>
<p><a href="reference/metrics.html">指标</a></p>
</li>
</ul>
<h1><a class="header" href="#生成-crd" id="生成-crd">生成 CRD</a></h1>
<p>KubeBuilder 使用一个叫做 <a href="https://sigs.k8s.io/controller-tools" title="Controller Tools"><code>controller-gen</code></a> 的工具来生成工具代码和 Kubernetes 的 YAML 对象，比如 CustomResourceDefinitions。</p>
<p>为了实现这种方式，它使用一种特殊的 “标记注释”（以 <code>// +</code> 开头）来表示这里要插入字段，类型和包相关的信息。如果是 CRD，那么这些信息通常是从以 <code>_types.go</code> 结尾的文件中产生的。更多关于标记的信息，可以看<a href="reference/./markers.html" title="Markers for Config/Code Generation">标记相关文档</a>。</p>
<p>KubeBuilder 提供了提供了一个 <code>make</code> 的命令来运行 controller-gen 并生成 CRD：<code>make manifests</code>。</p>
<p>当运行 <code>make manifests</code> 的时候，在 <code>config/crd/bases</code> 目录下可以看到生成的 CRD。<code>make manifests</code> 可以生成许多其它的文件 -- 更多详情请查看<a href="reference/./markers.html" title="Markers for Config/Code Generation">标记相关文档</a>。</p>
<h2><a class="header" href="#验证-1" id="验证-1">验证</a></h2>
<p>CRD 支持使用 <a href="https://github.com/OAI/OpenAPI-Specification/blob/master/versions/3.0.0.md#schemaObject" title="OpenAPI v3">OpenAPI v3 schema</a> 在 <code>validation</code> 段中进行<a href="https://kubernetes.io/docs/tasks/access-kubernetes-api/custom-resources/custom-resource-definitions/#validation" title="Custom Resource Definitions: Validation">声明式验证</a>。</p>
<p>通常，<a href="reference/./markers/crd-validation.html">验证标记</a>可能会关联到字段或者类型。如果你定义了复杂的验证，或者如果你需要重复使用验证，亦或者你需要验证切片元素，那么通常你最好定义一个新的类型来描述你的验证。</p>
<p>例如：</p>
<pre><code class="language-go">type ToySpec struct {
	// +kubebuilder:validation:MaxLength=15
	// +kubebuilder:validation:MinLength=1
	Name string `json:&quot;name,omitempty&quot;`

	// +kubebuilder:validation:MaxItems=500
	// +kubebuilder:validation:MinItems=1
	// +kubebuilder:validation:UniqueItems=true
	Knights []string `json:&quot;knights,omitempty&quot;`

	Alias   Alias   `json:&quot;alias,omitempty&quot;`
	Rank    Rank    `json:&quot;rank&quot;`
}

// +kubebuilder:validation:Enum=Lion;Wolf;Dragon
type Alias string

// +kubebuilder:validation:Minimum=1
// +kubebuilder:validation:Maximum=3
// +kubebuilder:validation:ExclusiveMaximum=false
type Rank int32

</code></pre>
<h2><a class="header" href="#打印其它信息列" id="打印其它信息列">打印其它信息列</a></h2>
<p>从 Kubernetes 1.11 开始，<code>kubectl get</code> 可以询问 Kubernetes 服务要展示哪些列。对于 CRD 来说，可以用 <code>kubectl get</code> 来提供展示有用的特定类型的信息，类似于为内置类型提供的信息。</p>
<p>你 CRD 的 [additionalPrinterColumns 字段][kube-additional-printer-columns] 控制了要展示的信息，它是通过在给 CRD 的 Go 类型上标注 <a href="reference/./markers/crd.html" title="CRD Generation"><code>+kubebuilder:printcolumn</code></a> 标签来控制要展示的信息。</p>
<p>比如下面的验证例子，我们添加字段来显示 knights，rank 和 alias 字段的信息</p>
<pre><code class="language-go">// +kubebuilder:printcolumn:name=&quot;Alias&quot;,type=string,JSONPath=`.spec.alias`
// +kubebuilder:printcolumn:name=&quot;Rank&quot;,type=integer,JSONPath=`.spec.rank`
// +kubebuilder:printcolumn:name=&quot;Bravely Run Away&quot;,type=boolean,JSONPath=`.spec.knights[?(@ == &quot;Sir Robin&quot;)]`,description=&quot;when danger rears its ugly head, he bravely turned his tail and fled&quot;,priority=10
// +kubebuilder:printcolumn:name=&quot;Age&quot;,type=&quot;date&quot;,JSONPath=&quot;.metadata.creationTimestamp&quot;
type Toy struct {
	metav1.TypeMeta   `json:&quot;,inline&quot;`
	metav1.ObjectMeta `json:&quot;metadata,omitempty&quot;`

	Spec   ToySpec   `json:&quot;spec,omitempty&quot;`
	Status ToyStatus `json:&quot;status,omitempty&quot;`
}

</code></pre>
<h2><a class="header" href="#子资源" id="子资源">子资源</a></h2>
<p>在 Kubernetes 1.13 中 CRD 可以选择实现 <code>/status</code> 和 <code>/scale</code> 这类<a href="https://kubernetes.io/docs/tasks/access-kubernetes-api/custom-resources/custom-resource-definitions/#status-subresource" title="Custom Resource Definitions: Status Subresource">子资源</a>。</p>
<p>通常推荐你在所有资源上实现 <code>/status</code> 子资源的时候，要有一个状态字段。</p>
<p>两个子资源都有对应的[标签][crd markers]。</p>
<h3><a class="header" href="#状态" id="状态">状态</a></h3>
<p>通过 <code>+kubebuilder:subresource:status</code> 设置子资源的状态。当时启用状态时，更新主资源不会修改它的状态。类似的，更新子资源状态也只是修改了状态字段。</p>
<p>例如：</p>
<pre><code class="language-go">// +kubebuilder:subresource:status
type Toy struct {
	metav1.TypeMeta   `json:&quot;,inline&quot;`
	metav1.ObjectMeta `json:&quot;metadata,omitempty&quot;`

	Spec   ToySpec   `json:&quot;spec,omitempty&quot;`
	Status ToyStatus `json:&quot;status,omitempty&quot;`
}
</code></pre>
<h3><a class="header" href="#扩缩容" id="扩缩容">扩缩容</a></h3>
<p>子资源的伸缩可以通过 <code>+kubebuilder:subresource:scale</code> 来启用。启用后，用户可以使用 <code>kubectl scale</code> 来对你的资源进行扩容或者缩容。如果 <code>selectorpath</code> 参数被指定为字符串形式的标签选择器，HorizontalPodAutoscaler 将可以自动扩容你的资源。</p>
<p>例如：</p>
<pre><code class="language-go">type CustomSetSpec struct {
	Replicas *int32 `json:&quot;replicas&quot;`
}

type CustomSetStatus struct {
	Replicas int32 `json:&quot;replicas&quot;`
    Selector string `json:&quot;selector&quot;` // this must be the string form of the selector
}


// +kubebuilder:subresource:status
// +kubebuilder:subresource:scale:specpath=.spec.replicas,statuspath=.status.replicas,selectorpath=.status.selector
type CustomSet struct {
	metav1.TypeMeta   `json:&quot;,inline&quot;`
	metav1.ObjectMeta `json:&quot;metadata,omitempty&quot;`

	Spec   ToySpec   `json:&quot;spec,omitempty&quot;`
	Status ToyStatus `json:&quot;status,omitempty&quot;`
}
</code></pre>
<h2><a class="header" href="#多版本" id="多版本">多版本</a></h2>
<p>Kubernetes 1.13，你可以在你的 CRD 的同一个 Kind 中定义多个版本，并且使用一个 webhook 对它们进行互转。</p>
<p>更多这部分相关的信息，请看<a href="reference//multiversion-tutorial/tutorial.html">多版本教程</a>。</p>
<p>默认情况下，KubeBuilder 会禁止为你的 CRD 的不同版本产生不同的验证，这都是为了兼容老版本的 Kubernetes。</p>
<p>如果需要，你要通过修改 makefile 中的命令：把 <code>CRD_OPTIONS ?= &quot;crd:trivialVersions=true</code> 修改为 <code>CRD_OPTIONS ?= crd</code>。</p>
<p>这样，你就可以使用  <code>+kubebuilder:storageversion</code> <a href="reference/./markers/crd.html" title="CRD Generation">标签</a> 来告知 <a href="reference//cronjob-tutorial/gvks.html" title="Group-Version-Kind">GVK</a> 这个字段应该被 API 服务来存储数据。</p>
<h2><a class="header" href="#写在最后" id="写在最后">写在最后</a></h2>
<p>KubeBuilder 会制定规则来运行 <code>controller-gen</code>。如果 <code>controller-gen</code> 不在 <code>go get</code> 用来下载 Go 模块的路径下的时候，这些规则会自动的安装 <code>controller-gen</code>。</p>
<p>如果你想知道它到底做了什么，你也可以直接运行 <code>controller-gen</code>。</p>
<p>每一个 <code>controller-gen</code> “生成器” 都由 <code>controller-gen</code> 的一个参数选项控制，和标签的语法一样。比如，要生成带有 “trivial versions” 的 CRD（无版本转换的 webhook），我们可以执行 <code>controller-gen crd:trivialVersions=true paths=./api/...</code>。</p>
<p><code>controller-gen</code> 也支持不同的输出“规则”，以此来控制如何及输出到哪里。注意 <code>manifests</code> 生成规则（是只生成 CRD 的简短写法）：</p>
<pre><code class="language-makefile"># 生成 CRD 清单
manifests: controller-gen
	$(CONTROLLER_GEN) crd:trivialVersions=true paths=&quot;./...&quot; output:crd:artifacts:config=config/crd/bases
</code></pre>
<p>它使用了 <code>output:crd:artifacts</code>  输出规则来表示 CRD 关联的配置（非代码）应该在 <code>config/crd/bases</code> 目录下，而不是在 <code>config/crd</code> 下。</p>
<p>运行如下命令可以看到 <code>controller-gen</code> 的所有支持参数：</p>
<pre><code class="language-shell">$ controller-gen -h
</code></pre>
<p>或者，可以执行以下命令，获取更多详细信息:</p>
<pre><code class="language-shell">$ controller-gen -hhh
</code></pre>
<h1><a class="header" href="#使用-finalizers" id="使用-finalizers">使用 Finalizers</a></h1>
<p><code>Finalizers</code> 允许控制器实现异步预删除挂钩。假设你为 API 类型的每个对象创建了一个外部资源（例如存储桶），并且想要从 Kubernetes 中删除对象同时删除关联的外部资源，则可以使用 finalizers 来实现。</p>
<p>您可以在<a href="https://kubernetes.io/docs/tasks/extend-kubernetes/custom-resources/custom-resource-definitions/#finalizers">Kubernetes参考文档中</a>阅读有关 finalizers 的更多信息。以下部分演示了如何在控制器的 <code>Reconcile</code> 方法中注册和触发预删除挂钩。</p>
<p>要注意的关键点是 finalizers 使对象上的“删除”成为设置删除时间戳的“更新”。对象上存在删除时间戳记表明该对象正在被删除。否则，在没有 finalizers 的情况下，删除将显示为协调，缓存中缺少该对象。</p>
<p>注意：</p>
<ul>
<li>如果未删除对象并且未注册 finalizers ，则添加 finalizers 并在 Kubernetes 中更新对象。</li>
<li>如果要删除对象，但 finalizers 列表中仍存在 finalizers ，请执行预删除逻辑并移除 finalizers 并更新对象。</li>
<li>确保预删除逻辑是幂等的。</li>
</ul>
<div class="literate"><cite class="literate-source"><a href="https://sigs.k8s.io/kubebuilder/docs/book/src/cronjob-tutorial/testdata/finalizer_example.go">../../cronjob-tutorial/testdata/finalizer_example.go</a></cite><details class="collapse-code"><summary class="hljs"><pre class="hljs"><span class="hljs-comment">Apache License</span></pre></summary>
<p>Licensed under the Apache License, Version 2.0 (the “License”);
you may not use this file except in compliance with the License.
You may obtain a copy of the License at</p>
<pre><code>http://www.apache.org/licenses/LICENSE-2.0
</code></pre>
<p>Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an “AS IS” BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.</p>
</details><details class="collapse-code"><summary class="hljs"><pre class="hljs"><span class="hljs-comment">Imports</span></pre></summary>
<p>First, we start out with some standard imports.
As before, we need the core controller-runtime library, as well as
the client package, and the package for our API types.</p>
<pre><code class="language-go">package controllers

import (
	&quot;context&quot;

	&quot;github.com/go-logr/logr&quot;
	ctrl &quot;sigs.k8s.io/controller-runtime&quot;
	&quot;sigs.k8s.io/controller-runtime/pkg/client&quot;

	batchv1 &quot;tutorial.kubebuilder.io/project/api/v1&quot;
)
</code></pre>
</details>
<p>The code snippet below shows skeleton code for implementing a finalizer.</p>
<pre><code class="language-go">func (r *CronJobReconciler) Reconcile(req ctrl.Request) (ctrl.Result, error) {
	ctx := context.Background()
	log := r.Log.WithValues(&quot;cronjob&quot;, req.NamespacedName)

	var cronJob *batchv1.CronJob
	if err := r.Get(ctx, req.NamespacedName, cronJob); err != nil {
		log.Error(err, &quot;unable to fetch CronJob&quot;)
		// 在我们删除一个不存在的对象的时，我们会遇到not-found errors这样的报错
	        // 我们将暂时忽略，因为不能通过重新加入队列的方式来修复这些错误
	        //（我们需要等待新的通知），而且我们可以根据删除的请求来获取它们
		return ctrl.Result{}, client.IgnoreNotFound(err)
	}

	// 自定义 finalizer 的名字
	myFinalizerName := &quot;storage.finalizers.tutorial.kubebuilder.io&quot;

	// 检查 DeletionTimestamp 以确定对象是否在删除中
	if cronJob.ObjectMeta.DeletionTimestamp.IsZero() {
		// 如果当前对象没有 finalizer， 说明其没有处于正被删除的状态。
		// 接着让我们添加 finalizer 并更新对象，相当于注册我们的 finalizer。
		if !containsString(cronJob.ObjectMeta.Finalizers, myFinalizerName) {
			cronJob.ObjectMeta.Finalizers = append(cronJob.ObjectMeta.Finalizers, myFinalizerName)
			if err := r.Update(context.Background(), cronJob); err != nil {
				return ctrl.Result{}, err
			}
		}
	} else {
		// 这个对象将要被删除
		if containsString(cronJob.ObjectMeta.Finalizers, myFinalizerName) {
			// 我们的 finalizer 就在这, 接下来就是处理外部依赖
			if err := r.deleteExternalResources(cronJob); err != nil {
				// 如果无法在此处删除外部依赖项，则返回错误
				// 以便可以重试
				return ctrl.Result{}, err
			}
			// 从列表中删除我们的 finalizer 并进行更新。
			cronJob.ObjectMeta.Finalizers = removeString(cronJob.ObjectMeta.Finalizers, myFinalizerName)
			if err := r.Update(context.Background(), cronJob); err != nil {
				return ctrl.Result{}, err
			}
		}

		// 当它们被删除的时候停止 reconciliation
		return ctrl.Result{}, nil
	}

	// Your reconcile logic

	return ctrl.Result{}, nil
}

func (r *Reconciler) deleteExternalResources(cronJob *batch.CronJob) error {

	// 删除与 cronJob 相关的任何外部资源
	// 确保删除是幂等性操作且可以安全调用同一对象多次。
}

// 辅助函数用于检查并从字符串切片中删除字符串。
func containsString(slice []string, s string) bool {
	for _, item := range slice {
		if item == s {
			return true
		}
	}
	return false
}

func removeString(slice []string, s string) (result []string) {
	for _, item := range slice {
		if item == s {
			continue
		}
		result = append(result, item)
	}
	return
}
</code></pre>
</div>
<h1><a class="header" href="#kind-集群" id="kind-集群">Kind 集群</a></h1>
<p>这篇文章只涉及到使用一个 kind 集群的基础。你可以在 <a href="https://kind.sigs.k8s.io/">kind 文档</a> 中找到更详细的介绍。</p>
<h2><a class="header" href="#安装-1" id="安装-1">安装</a></h2>
<p>你可以按照<a href="https://kind.sigs.k8s.io/#installation-and-usage">这个文档</a>来安装 <code>kind</code>。</p>
<h2><a class="header" href="#创建一个集群" id="创建一个集群">创建一个集群</a></h2>
<p>你可以简单的通过下面的命令来创建一个 <code>kind</code> 集群。</p>
<pre><code class="language-bash">kind create cluster
</code></pre>
<p>要定制你的集群，你可以提供额外的配置。比如，下面的例子是一个 <code>kind</code> 配置的例子。</p>
<pre><code class="language-yaml">{{#include ../cronjob-tutorial/testdata/project/hack/kind-config.yaml}}
</code></pre>
<p>使用上面的配置来运行下面的命令会创建一个 k8s v1.17.2 的集群，包含了 1 个 master 节点和 3 个 worker 节点。</p>
<pre><code class="language-bash">kind create cluster --config hack/kind-config.yaml --image=kindest/node:v1.17.2
</code></pre>
<p>你可以使用 <code>--image</code> 标记来指定你想创建集群的版本，比如：<code>--image=kindest/node:v1.17.2</code>，能支持的版本在<a href="https://hub.docker.com/r/kindest/node/tags">这里</a>。</p>
<h2><a class="header" href="#加载-docker-镜像到集群" id="加载-docker-镜像到集群">加载 Docker 镜像到集群</a></h2>
<p>当使用一个本地 kind 集群进行开发时，加载 docker 镜像到集群中是一个非常有用的功能。可以让你避免使用容器仓库。</p>
<ul>
<li><a href="https://kind.sigs.k8s.io/docs/user/quick-start/#loading-an-image-into-your-cluster">加载一个本地镜像到一个 kind 集群</a>。</li>
</ul>
<pre><code class="language-bash">kind load docker-image your-image-name:your-tag
</code></pre>
<h2><a class="header" href="#删除一个集群" id="删除一个集群">删除一个集群</a></h2>
<ul>
<li>删除一个 kind 集群</li>
</ul>
<pre><code class="language-bash">kind delete cluster
</code></pre>
<h1><a class="header" href="#webhook" id="webhook">Webhook</a></h1>
<p>Webhooks 是一种以阻塞方式发送的信息请求。实现 webhooks 的 web 应用程序将在特定事件发生时向其他应用程序发送 HTTP 请求。</p>
<p>在 kubernetes 中，有下面三种 webhook：<a href="https://kubernetes.io/docs/reference/access-authn-authz/extensible-admission-controllers/#admission-webhooks">admission webhook</a>，
<a href="https://kubernetes.io/docs/reference/access-authn-authz/webhook/">authorization webhook</a> 和 <a href="https://kubernetes.io/docs/tasks/extend-kubernetes/custom-resources/custom-resource-definition-versioning/#webhook-conversion">CRD conversion webhook</a>。</p>
<p>在 <a href="https://pkg.go.dev/sigs.k8s.io/controller-runtime/pkg/webhook?tab=doc">controller-runtime</a> 库中，我们支持 admission webhooks 和 CRD conversion webhooks。</p>
<p>Kubernetes 在 1.9 版本中（该特性进入 beta 版时）支持这些动态 admission webhooks。</p>
<p>Kubernetes 在 1.15 版本（该特性进入 beta 版时）支持 conversion webhook。</p>
<h1><a class="header" href="#准入-webhooks" id="准入-webhooks">准入 Webhooks</a></h1>
<p>准入 webhook 是 HTTP 的回调，它可以接受准入请求，处理它们并且返回准入响应。</p>
<p>Kubernetes 提供了下面几种类型的准入 webhook：</p>
<ul>
<li>
<p><strong>变更准入 Webhook</strong>
这种类型的 webhook 会在对象创建或是更新且没有存储前改变操作对象，然后才存储。它可以用于资源请求中的默认字段，比如在 Deployment 中没有被用户制定的字段。它可以用于注入 sidecar 容器。</p>
</li>
<li>
<p><strong>验证准入 Webhook</strong>
这种类型的 webhook 会在对象创建或是更新且没有存储前验证操作对象，然后才存储。它可以有比纯基于 schema 验证更加复杂的验证。比如：交叉字段验证和 pod 镜像白名单。</p>
</li>
</ul>
<p>默认情况下 apiserver 自己没有对 webhook 进行认证。然而，如果你想认证客户端，你可以配置 apiserver 使用基本授权，持有 token，或者证书对 webhook 进行认证。
详细的步骤可以查看<a href="https://kubernetes.io/docs/reference/access-authn-authz/extensible-admission-controllers/#authenticate-apiservers">这里</a>。</p>
<h1><a class="header" href="#核心类型的准入-webhook" id="核心类型的准入-webhook">核心类型的准入 Webhook</a></h1>
<p>为 CRD 构建准入 webhook 非常容易，这在 CronJob 教程中已经介绍过了。由于 kubebuilder 不支持核心类型的 webhook 自动生成，您必须使用 controller-runtime 的库来处理它。这里可以参考 controller-runtime 的一个 <a href="https://github.com/kubernetes-sigs/controller-runtime/tree/master/examples/builtins">示例</a>。</p>
<p>建议使用 kubebuilder 初始化一个项目，然后按照下面的步骤为核心类型添加准入 webhook。</p>
<h2><a class="header" href="#实现处理程序" id="实现处理程序">实现处理程序</a></h2>
<p>你需要用自己的处理程序去实现 <a href="https://pkg.go.dev/sigs.k8s.io/controller-runtime/pkg/webhook/admission?tab=doc#Handler">admission.Handler</a> 接口。</p>
<pre><code class="language-go">type podAnnotator struct {
	Client  client.Client
	decoder *admission.Decoder
}

func (a *podAnnotator) Handle(ctx context.Context, req admission.Request) admission.Response {
	pod := &amp;corev1.Pod{}
	err := a.decoder.Decode(req, pod)
	if err != nil {
		return admission.Errored(http.StatusBadRequest, err)
	}

	//在 pod 中修改字段

	marshaledPod, err := json.Marshal(pod)
	if err != nil {
		return admission.Errored(http.StatusInternalServerError, err)
	}
	return admission.PatchResponseFromRaw(req.Object.Raw, marshaledPod)
}
</code></pre>
<p>如果需要客户端，只需在结构构建时传入客户端。</p>
<p>如果你为你的处理程序添加了 <code>InjectDecoder</code> 方法，将会注入一个解码器。</p>
<pre><code class="language-go">func (a *podAnnotator) InjectDecoder(d *admission.Decoder) error {
	a.decoder = d
	return nil
}
</code></pre>
<p><strong>注意</strong>: 为了使得 controller-gen 能够为你生成 webhook 配置，你需要添加一些标记。例如，
<code>// +kubebuilder:webhook:path=/mutate-v1-pod,mutating=true,failurePolicy=fail,groups=&quot;&quot;,resources=pods,verbs=create;update,versions=v1,name=mpod.kb.io</code></p>
<h2><a class="header" href="#更新-maingo" id="更新-maingo">更新 main.go</a></h2>
<p>现在你需要在 webhook 服务端中注册你的处理程序。</p>
<pre><code class="language-go">mgr.GetWebhookServer().Register(&quot;/mutate-v1-pod&quot;, &amp;webhook.Admission{Handler: &amp;podAnnotator{Client: mgr.GetClient()}})
</code></pre>
<p>您需要确保这里的路径与标记中的路径相匹配。</p>
<h2><a class="header" href="#部署" id="部署">部署</a></h2>
<p>部署它就像为 CRD 部署 webhook 服务端一样。你需要</p>
<ol>
<li>提供服务证书</li>
<li>部署服务端</li>
</ol>
<p>你可以参考 <a href="reference//cronjob-tutorial/running.html">教程</a>。</p>
<h1><a class="header" href="#configcode-生成标记" id="configcode-生成标记">Config/Code 生成标记</a></h1>
<p>Kubebuilder 利用一个叫做<a href="reference//reference/controller-gen.html">controller-gen</a>的工具来生成公共的代码和 Kubernetes YAML 文件。
这些代码和配置的生成是由 Go 代码中特殊存在的“标记注释”来控制的。</p>
<p>标记都是以加号开头的单行注释，后面跟着一个标记名称，而跟随的关于标记的特定配置则是可选的。</p>
<pre><code class="language-go">// +kubebuilder:validation:Optional
// +kubebuilder:validation:MaxItems=2
// +kubebuilder:printcolumn:JSONPath=&quot;.status.replicas&quot;,name=Replicas,type=string
</code></pre>
<p>关于不同类型的代码和 YAML 生成可以查看每一小节来获取详细信息。</p>
<h2><a class="header" href="#在-kubebuilder-中生成代码--制品" id="在-kubebuilder-中生成代码--制品">在 KubeBuilder 中生成代码 &amp; 制品</a></h2>
<p>Kubebuilder 项目有两个 <code>make</code> 命令用到了 controller-gen：</p>
<ul>
<li>
<p><code>make manifests</code> 用来生成 Kubernetes 对象的 YAML 文件，像<a href="reference/./markers/crd.html">CustomResourceDefinitions</a>，<a href="reference/./markers/webhook.html">WebhookConfigurations</a> 和 <a href="reference/./markers/rbac.html">RBAC
roles</a>。</p>
</li>
<li>
<p><code>make generate</code> 用来生成代码，像<a href="reference/./markers/object.html">runtime.Object/DeepCopy
implementations</a>。</p>
</li>
</ul>
<p>查看[生成 CRDs]来获取综合描述。</p>
<h2><a class="header" href="#标记语法" id="标记语法">标记语法</a></h2>
<p>准确的语法在<a href="https://pkg.go.dev/sigs.k8s.io/controller-tools/pkg/markers?tab=doc">godocs for
controller-tools</a>有描述。</p>
<p>通常，标记可以是：</p>
<ul>
<li>
<p><strong>Empty</strong> (<code>+kubebuilder:validation:Optional</code>)：空标记像命令行中的布尔标记位-- 仅仅是指定他们来开启某些行为。</p>
</li>
<li>
<p><strong>Anonymous</strong> (<code>+kubebuilder:validation:MaxItems=2</code>)：匿名标记使用单个值作为参数。</p>
</li>
<li>
<p><strong>Multi-option</strong>
(<code>+kubebuilder:printcolumn:JSONPath=&quot;.status.replicas&quot;,name=Replicas,type=string</code>)：多选项标记使用一个或多个命名参数。第一个参数与名称之间用冒号隔开，而后面的参数使用逗号隔开。参数的顺序没有关系。有些参数是可选的。</p>
</li>
</ul>
<p>Marker arguments may be strings, ints, bools, slices, or maps thereof.
Strings, ints, and bools follow their Go syntax:</p>
<p>标记的参数可以是字符，整数，布尔，切片，或者 map 类型。
字符，整数，和布尔都应该符合 Go 语法：</p>
<pre><code class="language-go">// +kubebuilder:validation:ExclusiveMaximum=false
// +kubebuilder:validation:Format=&quot;date-time&quot;
// +kubebuilder:validation:Maximum=42
</code></pre>
<p>为了方便，在简单的例子中字符的引号可以被忽略，尽管这种做法在任何时候都是不被鼓励使用的，即便是单个字符：</p>
<pre><code class="language-go">// +kubebuilder:validation:Type=string
</code></pre>
<p>切片可以用大括号和逗号分隔来指定。</p>
<pre><code class="language-go">// +kubebuilder:webhooks:Enum={&quot;crackers, Gromit, we forgot the crackers!&quot;,&quot;not even wensleydale?&quot;}
</code></pre>
<p>或者，在简单的例子中，用分号来隔开。</p>
<pre><code class="language-go">// +kubebuilder:validation:Enum=Wallace;Gromit;Chicken
</code></pre>
<p>Maps 是用字符类型的键和任意类型的值（有效地<code>map[string]interface{}</code>）来指定的。一个 map 是由大括号（<code>{}</code>）包围起来的，每一个键和每一个值是用冒号（<code>:</code>）隔开的，每一个键值对是由逗号隔开的。</p>
<pre><code class="language-go">// +kubebuilder:validation:Default={magic: {numero: 42, stringified: forty-two}}
</code></pre>
<h1><a class="header" href="#crd-生成" id="crd-生成">CRD 生成</a></h1>
<p>这些标记描述了如何从一系列 Go 类型和包中构建出一个 CRD。而<a href="reference/markers/./crd-validation.html">验证标记</a>则描述了实际验证模式的生成。</p>
<p>从 <a href="reference/markers//reference/generating-crd.html">生成 CRDs</a> 查看示例。</p>
<div><input checked type="checkbox" class="markers-summarize" id="markers-summarize-CRD"></input><label class="markers-summarize" for="markers-summarize-CRD">Show Detailed Argument Help</label><dl class="markers"><div class="marker anonymous" data-target="package"><dt class="literal name">groupName</dt><dd class="args"><dl class="args summary"><dt class="argument literal"></dt><dd class="argument type"><span class="optional">string</span></dd></dl></dd><dd class="description"><details ><summary class="no-details">specifies the API group name for this package.</summary></details><dl class="args"><dt class="argument literal"></dt><dd class="argument type"><span class="optional">string</span></dd><dd class="description"></dd></dl></dd></div><div class="marker" data-target="type"><dt class="literal name">kubebuilder:printcolumn</dt><dd class="args"><dl class="args summary"><dt class="argument literal">JSONPath</dt><dd class="argument type"><span class="optional">string</span></dd><dt class="literal optional argument">description</dt><dd class="argument type optional"><span class="optional">string</span></dd><dt class="argument literal optional">format</dt><dd class="argument type optional"><span class="optional">string</span></dd><dt class="argument literal">name</dt><dd class="argument type"><span class="optional">string</span></dd><dt class="literal optional argument">priority</dt><dd class="argument type optional"><span class="optional">int</span></dd><dt class="argument literal">type</dt><dd class="argument type"><span class="optional">string</span></dd></dl></dd><dd class="description"><details ><summary class="no-details">adds a column to &#34;kubectl get&#34; output for this CRD.</summary></details><dl class="args"><dt class="argument literal">JSONPath</dt><dd class="argument type"><span class="optional">string</span></dd><dd class="description"><details ><summary class="no-details">specifies the jsonpath expression used to extract the value of the column.</summary></details></dd><dt class="argument literal optional">description</dt><dd class="optional argument type"><span class="optional">string</span></dd><dd class="description"><details ><summary class="no-details">specifies the help/description for this column.</summary></details></dd><dt class="argument literal optional">format</dt><dd class="argument type optional"><span class="optional">string</span></dd><dd class="description"><details ><summary class="">specifies the format of the column. </summary>
<p>It may be any OpenAPI data format corresponding to the type, listed at https://github.com/OAI/OpenAPI-Specification/blob/master/versions/2.0.md#data-types.</p>
</details></dd><dt class="argument literal">name</dt><dd class="argument type"><span class="optional">string</span></dd><dd class="description"><details ><summary class="no-details">specifies the name of the column.</summary></details></dd><dt class="argument literal optional">priority</dt><dd class="argument type optional"><span class="optional">int</span></dd><dd class="description"><details ><summary class="">indicates how important it is that this column be displayed. </summary>
<p>Lower priority (<em>higher</em> numbered) columns will be hidden if the terminal width is too small.</p>
</details></dd><dt class="argument literal">type</dt><dd class="argument type"><span class="optional">string</span></dd><dd class="description"><details ><summary class="">indicates the type of the column. </summary>
<p>It may be any OpenAPI data type listed at https://github.com/OAI/OpenAPI-Specification/blob/master/versions/2.0.md#data-types.</p>
</details></dd></dl></dd></div><div class="marker" data-target="type"><dt class="literal name">kubebuilder:resource</dt><dd class="args"><dl class="args summary"><dt class="argument literal optional">categories</dt><dd class="optional argument type"><span class="slice optional"><span class="optional">string</span></span></dd><dt class="literal optional argument">path</dt><dd class="argument type optional"><span class="optional">string</span></dd><dt class="argument literal optional">scope</dt><dd class="argument type optional"><span class="optional">string</span></dd><dt class="argument literal optional">shortName</dt><dd class="argument type optional"><span class="slice optional"><span class="optional">string</span></span></dd><dt class="literal optional argument">singular</dt><dd class="optional argument type"><span class="optional">string</span></dd></dl></dd><dd class="description"><details ><summary class="no-details">configures naming and scope for a CRD.</summary></details><dl class="args"><dt class="argument literal optional">categories</dt><dd class="optional argument type"><span class="slice optional"><span class="optional">string</span></span></dd><dd class="description"><details ><summary class="">specifies which group aliases this resource is part of. </summary>
<p>Group aliases are used to work with groups of resources at once. The most common one is “all“ which covers about a third of the base resources in Kubernetes, and is generally used for “user-facing“ resources.</p>
</details></dd><dt class="optional argument literal">path</dt><dd class="argument type optional"><span class="optional">string</span></dd><dd class="description"><details ><summary class="">specifies the plural &#34;resource&#34; for this CRD. </summary>
<p>It generally corresponds to a plural, lower-cased version of the Kind. See https://book.kubebuilder.io/cronjob-tutorial/gvks.html.</p>
</details></dd><dt class="argument literal optional">scope</dt><dd class="argument type optional"><span class="optional">string</span></dd><dd class="description"><details ><summary class="">overrides the scope of the CRD (Cluster vs Namespaced). </summary>
<p>Scope defaults to “Namespaced“.  Cluster-scoped (“Cluster“) resources don‘t exist in namespaces.</p>
</details></dd><dt class="literal optional argument">shortName</dt><dd class="optional argument type"><span class="slice optional"><span class="optional">string</span></span></dd><dd class="description"><details ><summary class="">specifies aliases for this CRD. </summary>
<p>Short names are often used when people have work with your resource over and over again.  For instance, “rs“ for “replicaset“ or “crd“ for customresourcedefinition.</p>
</details></dd><dt class="argument literal optional">singular</dt><dd class="argument type optional"><span class="optional">string</span></dd><dd class="description"><details ><summary class="">overrides the singular form of your resource. </summary>
<p>The singular form is otherwise defaulted off the plural (path).</p>
</details></dd></dl></dd></div><div class="marker" data-target="package"><dt class="literal name">kubebuilder:skip</dt><dd class="args"><dl class="args summary"></dl></dd><dd class="description"><details ><summary class="no-details">don&#39;t consider this package as an API version.</summary></details><dl class="args"></dl></dd></div><div class="marker" data-target="type"><dt class="literal name">kubebuilder:skipversion</dt><dd class="args"><dl class="args summary"></dl></dd><dd class="description"><details ><summary class="">removes the particular version of the CRD from the CRDs spec. </summary>
<p>This is useful if you need to skip generating and listing version entries for ‘internal‘ resource versions, which typically exist if using the Kubernetes upstream conversion-gen tool.</p>
</details><dl class="args"></dl></dd></div><div class="marker" data-target="type"><dt class="literal name">kubebuilder:storageversion</dt><dd class="args"><dl class="args summary"></dl></dd><dd class="description"><details ><summary class="">marks this version as the &#34;storage version&#34; for the CRD for conversion. </summary>
<p>When conversion is enabled for a CRD (i.e. it‘s not a trivial-versions/single-version CRD), one version is set as the “storage version“ to be stored in etcd.  Attempting to store any other version will result in conversion to the storage version via a conversion webhook.</p>
</details><dl class="args"></dl></dd></div><div class="marker" data-target="type"><dt class="literal name">kubebuilder:subresource:scale</dt><dd class="args"><dl class="args summary"><dt class="argument literal optional">selectorpath</dt><dd class="argument type optional"><span class="optional">string</span></dd><dt class="argument literal">specpath</dt><dd class="argument type"><span class="optional">string</span></dd><dt class="argument literal">statuspath</dt><dd class="argument type"><span class="optional">string</span></dd></dl></dd><dd class="description"><details ><summary class="no-details">enables the &#34;/scale&#34; subresource on a CRD.</summary></details><dl class="args"><dt class="optional argument literal">selectorpath</dt><dd class="type optional argument"><span class="optional">string</span></dd><dd class="description"><details ><summary class="">specifies the jsonpath to the pod label selector field for the scale&#39;s status. </summary>
<p>The selector field must be the <em>string</em> form (serialized form) of a selector. Setting a pod label selector is necessary for your type to work with the HorizontalPodAutoscaler.</p>
</details></dd><dt class="argument literal">specpath</dt><dd class="type argument"><span class="optional">string</span></dd><dd class="description"><details ><summary class="no-details">specifies the jsonpath to the replicas field for the scale&#39;s spec.</summary></details></dd><dt class="literal argument">statuspath</dt><dd class="argument type"><span class="optional">string</span></dd><dd class="description"><details ><summary class="no-details">specifies the jsonpath to the replicas field for the scale&#39;s status.</summary></details></dd></dl></dd></div><div class="marker" data-target="type"><dt class="literal name">kubebuilder:subresource:status</dt><dd class="args"><dl class="args summary"></dl></dd><dd class="description"><details ><summary class="no-details">enables the &#34;/status&#34; subresource on a CRD.</summary></details><dl class="args"></dl></dd></div><div class="marker" data-target="type"><dt class="literal name">kubebuilder:unservedversion</dt><dd class="args"><dl class="args summary"></dl></dd><dd class="description"><details ><summary class="">does not serve this version. </summary>
<p>This is useful if you need to drop support for a version in favor of a newer version.</p>
</details><dl class="args"></dl></dd></div><div class="marker anonymous" data-target="package"><dt class="literal name">versionName</dt><dd class="args"><dl class="args summary"><dt class="argument literal"></dt><dd class="argument type"><span class="optional">string</span></dd></dl></dd><dd class="description"><details ><summary class="no-details">overrides the API group version for this package (defaults to the package name).</summary></details><dl class="args"><dt class="argument literal"></dt><dd class="argument type"><span class="optional">string</span></dd><dd class="description"></dd></dl></dd></div></dl></div>
<h1><a class="header" href="#crd-validation" id="crd-validation">CRD Validation</a></h1>
<p>These markers modify how the CRD validation schema is produced for the
types and fields they modify.  Each corresponds roughly to an OpenAPI/JSON
schema option.
这些标记修改了如何为其修改的类型和字段生成 CRD 验证框架。每个标记大致对应一个 OpenAPI/JSON 模式选项。</p>
<p>有关示例，请参见<a href="reference/markers//reference/generating-crd.html">生成 CRDs</a>。</p>
<div><input checked type="checkbox" class="markers-summarize" id="markers-summarize-CRD-validation"></input><label class="markers-summarize" for="markers-summarize-CRD-validation">Show Detailed Argument Help</label><dl class="markers"><div class="marker anonymous" data-target="field"><dt class="literal name">kubebuilder:default</dt><dd class="args"><dl class="args summary"><dt class="argument literal"></dt><dd class="argument type"><span class="optional">any</span></dd></dl></dd><dd class="description"><details ><summary class="">sets the default value for this field. </summary>
<p>A default value will be accepted as any value valid for the field. Formatting for common types include: boolean: <code>true</code>, string: <code>Cluster</code>, numerical: <code>1.24</code>, array: <code>{1,2}</code>, object: <code>{policy: &amp;#34;delete&amp;#34;}</code>). Defaults should be defined in pruned form, and only best-effort validation will be performed. Full validation of a default requires submission of the containing CRD to an apiserver.</p>
</details><dl class="args"><dt class="argument literal"></dt><dd class="argument type"><span class="optional">any</span></dd><dd class="description"></dd></dl></dd></div><div class="marker" data-target="field"><dt class="literal name">kubebuilder:validation:EmbeddedResource</dt><dd class="args"><dl class="args summary"></dl></dd><dd class="description"><details ><summary class="">EmbeddedResource marks a fields as an embedded resource with apiVersion, kind and metadata fields. </summary>
<p>An embedded resource is a value that has apiVersion, kind and metadata fields. They are validated implicitly according to the semantics of the currently running apiserver. It is not necessary to add any additional schema for these field, yet it is possible. This can be combined with PreserveUnknownFields.</p>
</details><dl class="args"></dl></dd></div><div class="anonymous marker" data-target="type"><dt class="literal name">kubebuilder:validation:Enum</dt><dd class="args"><dl class="args summary"><dt class="argument literal"></dt><dd class="argument type"><span class="slice"><span class="optional">any</span></span></dd></dl></dd><dd class="description"><details ><summary class="no-details">specifies that this (scalar) field is restricted to the *exact* values specified here.</summary></details><dl class="args"><dt class="argument literal"></dt><dd class="argument type"><span class="slice"><span class="optional">any</span></span></dd><dd class="description"></dd></dl></dd></div><div class="marker anonymous" data-target="field"><dt class="literal name">kubebuilder:validation:Enum</dt><dd class="args"><dl class="args summary"><dt class="argument literal"></dt><dd class="argument type"><span class="slice"><span class="optional">any</span></span></dd></dl></dd><dd class="description"><details ><summary class="no-details">specifies that this (scalar) field is restricted to the *exact* values specified here.</summary></details><dl class="args"><dt class="argument literal"></dt><dd class="argument type"><span class="slice"><span class="optional">any</span></span></dd><dd class="description"></dd></dl></dd></div><div class="marker anonymous" data-target="type"><dt class="literal name">kubebuilder:validation:ExclusiveMaximum</dt><dd class="args"><dl class="args summary"><dt class="argument literal"></dt><dd class="argument type"><span class="optional">bool</span></dd></dl></dd><dd class="description"><details ><summary class="no-details">indicates that the maximum is &#34;up to&#34; but not including that value.</summary></details><dl class="args"><dt class="argument literal"></dt><dd class="argument type"><span class="optional">bool</span></dd><dd class="description"></dd></dl></dd></div><div class="anonymous marker" data-target="field"><dt class="literal name">kubebuilder:validation:ExclusiveMaximum</dt><dd class="args"><dl class="args summary"><dt class="argument literal"></dt><dd class="argument type"><span class="optional">bool</span></dd></dl></dd><dd class="description"><details ><summary class="no-details">indicates that the maximum is &#34;up to&#34; but not including that value.</summary></details><dl class="args"><dt class="argument literal"></dt><dd class="type argument"><span class="optional">bool</span></dd><dd class="description"></dd></dl></dd></div><div class="anonymous marker" data-target="type"><dt class="literal name">kubebuilder:validation:ExclusiveMinimum</dt><dd class="args"><dl class="args summary"><dt class="argument literal"></dt><dd class="argument type"><span class="optional">bool</span></dd></dl></dd><dd class="description"><details ><summary class="no-details">indicates that the minimum is &#34;up to&#34; but not including that value.</summary></details><dl class="args"><dt class="argument literal"></dt><dd class="argument type"><span class="optional">bool</span></dd><dd class="description"></dd></dl></dd></div><div class="anonymous marker" data-target="field"><dt class="literal name">kubebuilder:validation:ExclusiveMinimum</dt><dd class="args"><dl class="args summary"><dt class="argument literal"></dt><dd class="argument type"><span class="optional">bool</span></dd></dl></dd><dd class="description"><details ><summary class="no-details">indicates that the minimum is &#34;up to&#34; but not including that value.</summary></details><dl class="args"><dt class="argument literal"></dt><dd class="type argument"><span class="optional">bool</span></dd><dd class="description"></dd></dl></dd></div><div class="marker anonymous" data-target="field"><dt class="literal name">kubebuilder:validation:Format</dt><dd class="args"><dl class="args summary"><dt class="argument literal"></dt><dd class="argument type"><span class="optional">string</span></dd></dl></dd><dd class="description"><details ><summary class="">specifies additional &#34;complex&#34; formatting for this field. </summary>
<p>For example, a date-time field would be marked as “type: string“ and “format: date-time“.</p>
</details><dl class="args"><dt class="argument literal"></dt><dd class="argument type"><span class="optional">string</span></dd><dd class="description"></dd></dl></dd></div><div class="anonymous marker" data-target="type"><dt class="literal name">kubebuilder:validation:Format</dt><dd class="args"><dl class="args summary"><dt class="argument literal"></dt><dd class="argument type"><span class="optional">string</span></dd></dl></dd><dd class="description"><details ><summary class="">specifies additional &#34;complex&#34; formatting for this field. </summary>
<p>For example, a date-time field would be marked as “type: string“ and “format: date-time“.</p>
</details><dl class="args"><dt class="argument literal"></dt><dd class="argument type"><span class="optional">string</span></dd><dd class="description"></dd></dl></dd></div><div class="anonymous marker" data-target="field"><dt class="literal name">kubebuilder:validation:MaxItems</dt><dd class="args"><dl class="args summary"><dt class="argument literal"></dt><dd class="argument type"><span class="optional">int</span></dd></dl></dd><dd class="description"><details ><summary class="no-details">specifies the maximum length for this list.</summary></details><dl class="args"><dt class="argument literal"></dt><dd class="argument type"><span class="optional">int</span></dd><dd class="description"></dd></dl></dd></div><div class="marker anonymous" data-target="type"><dt class="literal name">kubebuilder:validation:MaxItems</dt><dd class="args"><dl class="args summary"><dt class="literal argument"></dt><dd class="argument type"><span class="optional">int</span></dd></dl></dd><dd class="description"><details ><summary class="no-details">specifies the maximum length for this list.</summary></details><dl class="args"><dt class="argument literal"></dt><dd class="argument type"><span class="optional">int</span></dd><dd class="description"></dd></dl></dd></div><div class="marker anonymous" data-target="type"><dt class="literal name">kubebuilder:validation:MaxLength</dt><dd class="args"><dl class="args summary"><dt class="argument literal"></dt><dd class="argument type"><span class="optional">int</span></dd></dl></dd><dd class="description"><details ><summary class="no-details">specifies the maximum length for this string.</summary></details><dl class="args"><dt class="argument literal"></dt><dd class="argument type"><span class="optional">int</span></dd><dd class="description"></dd></dl></dd></div><div class="marker anonymous" data-target="field"><dt class="literal name">kubebuilder:validation:MaxLength</dt><dd class="args"><dl class="args summary"><dt class="argument literal"></dt><dd class="argument type"><span class="optional">int</span></dd></dl></dd><dd class="description"><details ><summary class="no-details">specifies the maximum length for this string.</summary></details><dl class="args"><dt class="argument literal"></dt><dd class="argument type"><span class="optional">int</span></dd><dd class="description"></dd></dl></dd></div><div class="marker anonymous" data-target="type"><dt class="literal name">kubebuilder:validation:Maximum</dt><dd class="args"><dl class="args summary"><dt class="argument literal"></dt><dd class="argument type"><span class="optional">int</span></dd></dl></dd><dd class="description"><details ><summary class="no-details">specifies the maximum numeric value that this field can have.</summary></details><dl class="args"><dt class="argument literal"></dt><dd class="argument type"><span class="optional">int</span></dd><dd class="description"></dd></dl></dd></div><div class="marker anonymous" data-target="field"><dt class="literal name">kubebuilder:validation:Maximum</dt><dd class="args"><dl class="args summary"><dt class="argument literal"></dt><dd class="argument type"><span class="optional">int</span></dd></dl></dd><dd class="description"><details ><summary class="no-details">specifies the maximum numeric value that this field can have.</summary></details><dl class="args"><dt class="argument literal"></dt><dd class="argument type"><span class="optional">int</span></dd><dd class="description"></dd></dl></dd></div><div class="marker anonymous" data-target="type"><dt class="literal name">kubebuilder:validation:MinItems</dt><dd class="args"><dl class="args summary"><dt class="argument literal"></dt><dd class="argument type"><span class="optional">int</span></dd></dl></dd><dd class="description"><details ><summary class="no-details">specifies the minimun length for this list.</summary></details><dl class="args"><dt class="argument literal"></dt><dd class="type argument"><span class="optional">int</span></dd><dd class="description"></dd></dl></dd></div><div class="marker anonymous" data-target="field"><dt class="literal name">kubebuilder:validation:MinItems</dt><dd class="args"><dl class="args summary"><dt class="argument literal"></dt><dd class="argument type"><span class="optional">int</span></dd></dl></dd><dd class="description"><details ><summary class="no-details">specifies the minimun length for this list.</summary></details><dl class="args"><dt class="argument literal"></dt><dd class="argument type"><span class="optional">int</span></dd><dd class="description"></dd></dl></dd></div><div class="marker anonymous" data-target="type"><dt class="literal name">kubebuilder:validation:MinLength</dt><dd class="args"><dl class="args summary"><dt class="argument literal"></dt><dd class="argument type"><span class="optional">int</span></dd></dl></dd><dd class="description"><details ><summary class="no-details">specifies the minimum length for this string.</summary></details><dl class="args"><dt class="argument literal"></dt><dd class="argument type"><span class="optional">int</span></dd><dd class="description"></dd></dl></dd></div><div class="marker anonymous" data-target="field"><dt class="literal name">kubebuilder:validation:MinLength</dt><dd class="args"><dl class="args summary"><dt class="argument literal"></dt><dd class="argument type"><span class="optional">int</span></dd></dl></dd><dd class="description"><details ><summary class="no-details">specifies the minimum length for this string.</summary></details><dl class="args"><dt class="argument literal"></dt><dd class="argument type"><span class="optional">int</span></dd><dd class="description"></dd></dl></dd></div><div class="anonymous marker" data-target="field"><dt class="literal name">kubebuilder:validation:Minimum</dt><dd class="args"><dl class="args summary"><dt class="argument literal"></dt><dd class="argument type"><span class="optional">int</span></dd></dl></dd><dd class="description"><details ><summary class="no-details">specifies the minimum numeric value that this field can have.</summary></details><dl class="args"><dt class="argument literal"></dt><dd class="argument type"><span class="optional">int</span></dd><dd class="description"></dd></dl></dd></div><div class="marker anonymous" data-target="type"><dt class="literal name">kubebuilder:validation:Minimum</dt><dd class="args"><dl class="args summary"><dt class="argument literal"></dt><dd class="argument type"><span class="optional">int</span></dd></dl></dd><dd class="description"><details ><summary class="no-details">specifies the minimum numeric value that this field can have.</summary></details><dl class="args"><dt class="argument literal"></dt><dd class="type argument"><span class="optional">int</span></dd><dd class="description"></dd></dl></dd></div><div class="marker anonymous" data-target="field"><dt class="literal name">kubebuilder:validation:MultipleOf</dt><dd class="args"><dl class="args summary"><dt class="argument literal"></dt><dd class="argument type"><span class="optional">int</span></dd></dl></dd><dd class="description"><details ><summary class="no-details">specifies that this field must have a numeric value that&#39;s a multiple of this one.</summary></details><dl class="args"><dt class="argument literal"></dt><dd class="type argument"><span class="optional">int</span></dd><dd class="description"></dd></dl></dd></div><div class="marker anonymous" data-target="type"><dt class="literal name">kubebuilder:validation:MultipleOf</dt><dd class="args"><dl class="args summary"><dt class="argument literal"></dt><dd class="argument type"><span class="optional">int</span></dd></dl></dd><dd class="description"><details ><summary class="no-details">specifies that this field must have a numeric value that&#39;s a multiple of this one.</summary></details><dl class="args"><dt class="argument literal"></dt><dd class="argument type"><span class="optional">int</span></dd><dd class="description"></dd></dl></dd></div><div class="marker" data-target="package"><dt class="literal name">kubebuilder:validation:Optional</dt><dd class="args"><dl class="args summary"></dl></dd><dd class="description"><details ><summary class="no-details">specifies that all fields in this package are optional by default.</summary></details><dl class="args"></dl></dd></div><div class="marker" data-target="field"><dt class="literal name">kubebuilder:validation:Optional</dt><dd class="args"><dl class="args summary"></dl></dd><dd class="description"><details ><summary class="no-details">specifies that this field is optional, if fields are required by default.</summary></details><dl class="args"></dl></dd></div><div class="marker anonymous" data-target="field"><dt class="literal name">kubebuilder:validation:Pattern</dt><dd class="args"><dl class="args summary"><dt class="argument literal"></dt><dd class="argument type"><span class="optional">string</span></dd></dl></dd><dd class="description"><details ><summary class="no-details">specifies that this string must match the given regular expression.</summary></details><dl class="args"><dt class="literal argument"></dt><dd class="argument type"><span class="optional">string</span></dd><dd class="description"></dd></dl></dd></div><div class="marker anonymous" data-target="type"><dt class="literal name">kubebuilder:validation:Pattern</dt><dd class="args"><dl class="args summary"><dt class="argument literal"></dt><dd class="argument type"><span class="optional">string</span></dd></dl></dd><dd class="description"><details ><summary class="no-details">specifies that this string must match the given regular expression.</summary></details><dl class="args"><dt class="argument literal"></dt><dd class="argument type"><span class="optional">string</span></dd><dd class="description"></dd></dl></dd></div><div class="marker" data-target="field"><dt class="literal name">kubebuilder:validation:Required</dt><dd class="args"><dl class="args summary"></dl></dd><dd class="description"><details ><summary class="no-details">specifies that this field is required, if fields are optional by default.</summary></details><dl class="args"></dl></dd></div><div class="marker" data-target="package"><dt class="literal name">kubebuilder:validation:Required</dt><dd class="args"><dl class="args summary"></dl></dd><dd class="description"><details ><summary class="no-details">specifies that all fields in this package are required by default.</summary></details><dl class="args"></dl></dd></div><div class="marker anonymous" data-target="field"><dt class="literal name">kubebuilder:validation:Type</dt><dd class="args"><dl class="args summary"><dt class="argument literal"></dt><dd class="argument type"><span class="optional">string</span></dd></dl></dd><dd class="description"><details ><summary class="">overrides the type for this field (which defaults to the equivalent of the Go type). </summary>
<p>This generally must be paired with custom serialization.  For example, the metav1.Time field would be marked as “type: string“ and “format: date-time“.</p>
</details><dl class="args"><dt class="argument literal"></dt><dd class="type argument"><span class="optional">string</span></dd><dd class="description"></dd></dl></dd></div><div class="anonymous marker" data-target="type"><dt class="literal name">kubebuilder:validation:Type</dt><dd class="args"><dl class="args summary"><dt class="argument literal"></dt><dd class="argument type"><span class="optional">string</span></dd></dl></dd><dd class="description"><details ><summary class="">overrides the type for this field (which defaults to the equivalent of the Go type). </summary>
<p>This generally must be paired with custom serialization.  For example, the metav1.Time field would be marked as “type: string“ and “format: date-time“.</p>
</details><dl class="args"><dt class="literal argument"></dt><dd class="argument type"><span class="optional">string</span></dd><dd class="description"></dd></dl></dd></div><div class="marker anonymous" data-target="type"><dt class="literal name">kubebuilder:validation:UniqueItems</dt><dd class="args"><dl class="args summary"><dt class="argument literal"></dt><dd class="argument type"><span class="optional">bool</span></dd></dl></dd><dd class="description"><details ><summary class="no-details">specifies that all items in this list must be unique.</summary></details><dl class="args"><dt class="argument literal"></dt><dd class="argument type"><span class="optional">bool</span></dd><dd class="description"></dd></dl></dd></div><div class="marker anonymous" data-target="field"><dt class="literal name">kubebuilder:validation:UniqueItems</dt><dd class="args"><dl class="args summary"><dt class="argument literal"></dt><dd class="argument type"><span class="optional">bool</span></dd></dl></dd><dd class="description"><details ><summary class="no-details">specifies that all items in this list must be unique.</summary></details><dl class="args"><dt class="argument literal"></dt><dd class="argument type"><span class="optional">bool</span></dd><dd class="description"></dd></dl></dd></div><div class="marker" data-target="type"><dt class="literal name">kubebuilder:validation:XEmbeddedResource</dt><dd class="args"><dl class="args summary"></dl></dd><dd class="description"><details ><summary class="">EmbeddedResource marks a fields as an embedded resource with apiVersion, kind and metadata fields. </summary>
<p>An embedded resource is a value that has apiVersion, kind and metadata fields. They are validated implicitly according to the semantics of the currently running apiserver. It is not necessary to add any additional schema for these field, yet it is possible. This can be combined with PreserveUnknownFields.</p>
</details><dl class="args"></dl></dd></div><div class="marker" data-target="field"><dt class="literal name">kubebuilder:validation:XEmbeddedResource</dt><dd class="args"><dl class="args summary"></dl></dd><dd class="description"><details ><summary class="">EmbeddedResource marks a fields as an embedded resource with apiVersion, kind and metadata fields. </summary>
<p>An embedded resource is a value that has apiVersion, kind and metadata fields. They are validated implicitly according to the semantics of the currently running apiserver. It is not necessary to add any additional schema for these field, yet it is possible. This can be combined with PreserveUnknownFields.</p>
</details><dl class="args"></dl></dd></div><div class="marker" data-target="field"><dt class="literal name">nullable</dt><dd class="args"><dl class="args summary"></dl></dd><dd class="description"><details ><summary class="">marks this field as allowing the &#34;null&#34; value. </summary>
<p>This is often not necessary, but may be helpful with custom serialization.</p>
</details><dl class="args"></dl></dd></div><div class="marker" data-target="field"><dt class="literal name">optional</dt><dd class="args"><dl class="args summary"></dl></dd><dd class="description"><details ><summary class="no-details">specifies that this field is optional, if fields are required by default.</summary></details><dl class="args"></dl></dd></div></dl></div>
<h1><a class="header" href="#crd-处理" id="crd-处理">CRD 处理</a></h1>
<p>当你有自定义资源请求时,这些标记有助于 Kubernetes API 服务器控制处理 API。</p>
<p>作为例子可查看章节<a href="reference/markers//reference/generating-crd.html">生成 CRDs</a>.</p>
<div><input checked type="checkbox" class="markers-summarize" id="markers-summarize-CRD-processing"></input><label class="markers-summarize" for="markers-summarize-CRD-processing">Show Detailed Argument Help</label><dl class="markers"><div class="marker" data-target="field"><dt class="literal name">kubebuilder:pruning:PreserveUnknownFields</dt><dd class="args"><dl class="args summary"></dl></dd><dd class="description"><details ><summary class="">PreserveUnknownFields stops the apiserver from pruning fields which are not specified. </summary>
<p>By default the apiserver drops unknown fields from the request payload during the decoding step. This marker stops the API server from doing so. It affects fields recursively, but switches back to normal pruning behaviour if nested  properties or additionalProperties are specified in the schema. This can either be true or undefined. False is forbidden.</p>
</details><dl class="args"></dl></dd></div><div class="marker" data-target="type"><dt class="literal name">kubebuilder:validation:XPreserveUnknownFields</dt><dd class="args"><dl class="args summary"></dl></dd><dd class="description"><details ><summary class="">PreserveUnknownFields stops the apiserver from pruning fields which are not specified. </summary>
<p>By default the apiserver drops unknown fields from the request payload during the decoding step. This marker stops the API server from doing so. It affects fields recursively, but switches back to normal pruning behaviour if nested  properties or additionalProperties are specified in the schema. This can either be true or undefined. False is forbidden.</p>
</details><dl class="args"></dl></dd></div><div class="marker" data-target="field"><dt class="literal name">kubebuilder:validation:XPreserveUnknownFields</dt><dd class="args"><dl class="args summary"></dl></dd><dd class="description"><details ><summary class="">PreserveUnknownFields stops the apiserver from pruning fields which are not specified. </summary>
<p>By default the apiserver drops unknown fields from the request payload during the decoding step. This marker stops the API server from doing so. It affects fields recursively, but switches back to normal pruning behaviour if nested  properties or additionalProperties are specified in the schema. This can either be true or undefined. False is forbidden.</p>
</details><dl class="args"></dl></dd></div><div class="marker anonymous" data-target="field"><dt class="literal name">listMapKey</dt><dd class="args"><dl class="args summary"><dt class="argument literal"></dt><dd class="argument type"><span class="optional">string</span></dd></dl></dd><dd class="description"><details ><summary class="">specifies the keys to map listTypes. </summary>
<p>It indicates the index of a map list. They can be repeated if multiple keys must be used. It can only be used when ListType is set to map, and the keys should be scalar types.</p>
</details><dl class="args"><dt class="argument literal"></dt><dd class="argument type"><span class="optional">string</span></dd><dd class="description"></dd></dl></dd></div><div class="marker anonymous" data-target="field"><dt class="literal name">listType</dt><dd class="args"><dl class="args summary"><dt class="argument literal"></dt><dd class="argument type"><span class="optional">string</span></dd></dl></dd><dd class="description"><details ><summary class="">specifies the type of data-structure that the list represents (map, set, atomic). </summary>
<p>Possible data-structure types of a list are: </p>
<ul>
<li>“map“: it needs to have a key field, which will be used to build an   associative list. A typical example is a the pod container list,   which is indexed by the container name. </li>
<li>“set“: Fields need to be “scalar“, and there can be only one   occurrence of each. </li>
<li>“atomic“: All the fields in the list are treated as a single value,   are typically manipulated together by the same actor.</li>
</ul>
</details><dl class="args"><dt class="argument literal"></dt><dd class="argument type"><span class="optional">string</span></dd><dd class="description"></dd></dl></dd></div><div class="marker anonymous" data-target="field"><dt class="literal name">mapType</dt><dd class="args"><dl class="args summary"><dt class="literal argument"></dt><dd class="type argument"><span class="optional">string</span></dd></dl></dd><dd class="description"><details ><summary class="">specifies the level of atomicity of the map; i.e. whether each item in the map is independent of the others, or all fields are treated as a single unit. </summary>
<p>Possible values: </p>
<ul>
<li>“granular“: items in the map are independent of each other,   and can be manipulated by different actors.   This is the default behavior. </li>
<li>“atomic“: all fields are treated as one unit.   Any changes have to replace the entire map.</li>
</ul>
</details><dl class="args"><dt class="argument literal"></dt><dd class="argument type"><span class="optional">string</span></dd><dd class="description"></dd></dl></dd></div><div class="marker anonymous" data-target="field"><dt class="literal name">structType</dt><dd class="args"><dl class="args summary"><dt class="argument literal"></dt><dd class="argument type"><span class="optional">string</span></dd></dl></dd><dd class="description"><details ><summary class="">specifies the level of atomicity of the struct; i.e. whether each field in the struct is independent of the others, or all fields are treated as a single unit. </summary>
<p>Possible values: </p>
<ul>
<li>“granular“: fields in the struct are independent of each other,   and can be manipulated by different actors.   This is the default behavior. </li>
<li>“atomic“: all fields are treated as one unit.   Any changes have to replace the entire struct.</li>
</ul>
</details><dl class="args"><dt class="argument literal"></dt><dd class="argument type"><span class="optional">string</span></dd><dd class="description"></dd></dl></dd></div></dl></div>
<h1><a class="header" href="#webhook-1" id="webhook-1">Webhook</a></h1>
<p>这些标记描述了<a href="reference/markers/../webhook-overview.html">webhook配置</a>如何生成。
使用这些使你的 webhook 描述与实现它们的代码保持一致。</p>
<div><input checked type="checkbox" class="markers-summarize" id="markers-summarize-Webhook"></input><label class="markers-summarize" for="markers-summarize-Webhook">Show Detailed Argument Help</label><dl class="markers"><div class="marker" data-target="package"><dt class="literal name">kubebuilder:webhook</dt><dd class="args"><dl class="args summary"><dt class="argument literal">failurePolicy</dt><dd class="argument type"><span class="optional">string</span></dd><dt class="argument literal">groups</dt><dd class="argument type"><span class="slice"><span class="optional">string</span></span></dd><dt class="argument literal optional">matchPolicy</dt><dd class="argument type optional"><span class="optional">string</span></dd><dt class="argument literal">mutating</dt><dd class="argument type"><span class="optional">bool</span></dd><dt class="literal argument">name</dt><dd class="argument type"><span class="optional">string</span></dd><dt class="argument literal">path</dt><dd class="argument type"><span class="optional">string</span></dd><dt class="argument literal">resources</dt><dd class="argument type"><span class="slice"><span class="optional">string</span></span></dd><dt class="optional argument literal">sideEffects</dt><dd class="argument type optional"><span class="optional">string</span></dd><dt class="argument literal">verbs</dt><dd class="argument type"><span class="slice"><span class="optional">string</span></span></dd><dt class="argument literal">versions</dt><dd class="argument type"><span class="slice"><span class="optional">string</span></span></dd></dl></dd><dd class="description"><details ><summary class="">specifies how a webhook should be served. </summary>
<p>It specifies only the details that are intrinsic to the application serving it (e.g. the resources it can handle, or the path it serves on).</p>
</details><dl class="args"><dt class="argument literal">failurePolicy</dt><dd class="argument type"><span class="optional">string</span></dd><dd class="description"><details ><summary class="">specifies what should happen if the API server cannot reach the webhook. </summary>
<p>It may be either “ignore“ (to skip the webhook and continue on) or “fail“ (to reject the object in question).</p>
</details></dd><dt class="literal argument">groups</dt><dd class="type argument"><span class="slice"><span class="optional">string</span></span></dd><dd class="description"><details ><summary class="no-details">specifies the API groups that this webhook receives requests for.</summary></details></dd><dt class="argument literal optional">matchPolicy</dt><dd class="argument type optional"><span class="optional">string</span></dd><dd class="description"><details ><summary class="no-details">defines how the &#34;rules&#34; list is used to match incoming requests. Allowed values are &#34;Exact&#34; (match only if it exactly matches the specified rule) or &#34;Equivalent&#34; (match a request if it modifies a resource listed in rules, even via another API group or version).</summary></details></dd><dt class="argument literal">mutating</dt><dd class="type argument"><span class="optional">bool</span></dd><dd class="description"><details ><summary class="">marks this as a mutating webhook (it&#39;s validating only if false) </summary>
<p>Mutating webhooks are allowed to change the object in their response, and are called <em>before</em> all validating webhooks.  Mutating webhooks may choose to reject an object, similarly to a validating webhook.</p>
</details></dd><dt class="argument literal">name</dt><dd class="argument type"><span class="optional">string</span></dd><dd class="description"><details ><summary class="no-details">indicates the name of this webhook configuration. Should be a domain with at least three segments separated by dots</summary></details></dd><dt class="argument literal">path</dt><dd class="type argument"><span class="optional">string</span></dd><dd class="description"><details ><summary class="no-details">specifies that path that the API server should connect to this webhook on. Must be prefixed with a &#39;/validate-&#39; or &#39;/mutate-&#39; depending on the type, and followed by $GROUP-$VERSION-$KIND where all values are lower-cased and the periods in the group are substituted for hyphens. For example, a validating webhook path for type batch.tutorial.kubebuilder.io/v1,Kind=CronJob would be /validate-batch-tutorial-kubebuilder-io-v1-cronjob</summary></details></dd><dt class="argument literal">resources</dt><dd class="argument type"><span class="slice"><span class="optional">string</span></span></dd><dd class="description"><details ><summary class="no-details">specifies the API resources that this webhook receives requests for.</summary></details></dd><dt class="argument literal optional">sideEffects</dt><dd class="argument type optional"><span class="optional">string</span></dd><dd class="description"><details ><summary class="no-details">specify whether calling the webhook will have side effects. This has an impact on dry runs and `kubectl diff`: if the sideEffect is &#34;Unknown&#34; (the default) or &#34;Some&#34;, then the API server will not call the webhook on a dry-run request and fails instead. If the value is &#34;None&#34;, then the webhook has no side effects and the API server will call it on dry-run. If the value is &#34;NoneOnDryRun&#34;, then the webhook is responsible for inspecting the &#34;dryRun&#34; property of the AdmissionReview sent in the request, and avoiding side effects if that value is &#34;true.&#34;</summary></details></dd><dt class="argument literal">verbs</dt><dd class="argument type"><span class="slice"><span class="optional">string</span></span></dd><dd class="description"><details ><summary class="">specifies the Kubernetes API verbs that this webhook receives requests for. </summary>
<p>Only modification-like verbs may be specified. May be “create“, “update“, “delete“, “connect“, or “*“ (for all).</p>
</details></dd><dt class="argument literal">versions</dt><dd class="argument type"><span class="slice"><span class="optional">string</span></span></dd><dd class="description"><details ><summary class="no-details">specifies the API versions that this webhook receives requests for.</summary></details></dd></dl></dd></div></dl></div>
<h1><a class="header" href="#objectdeepcopy" id="objectdeepcopy">Object/DeepCopy</a></h1>
<p>这些标记控制何时生成 <code>DeepCopy</code> 和 <code>runtime.Object</code> 实现方法。</p>
<div><input checked type="checkbox" class="markers-summarize" id="markers-summarize-object"></input><label class="markers-summarize" for="markers-summarize-object">Show Detailed Argument Help</label><dl class="markers"><div class="anonymous marker deprecated" data-target="package" data-deprecated="kubebuilder:object:generate"><dt class="literal name">k8s:deepcopy-gen</dt><dd class="args"><dl class="args summary"><dt class="argument literal"></dt><dd class="argument type"><span class="optional">raw</span></dd></dl></dd><dd class="description"><details ><summary class="no-details">enables or disables object interface &amp; deepcopy implementation generation for this package</summary></details><dl class="args"><dt class="argument literal"></dt><dd class="argument type"><span class="optional">raw</span></dd><dd class="description"></dd></dl></dd></div><div class="marker deprecated anonymous" data-target="type" data-deprecated="kubebuilder:object:generate"><dt class="literal name">k8s:deepcopy-gen</dt><dd class="args"><dl class="args summary"><dt class="argument literal"></dt><dd class="argument type"><span class="optional">raw</span></dd></dl></dd><dd class="description"><details ><summary class="no-details">overrides enabling or disabling deepcopy generation for this type</summary></details><dl class="args"><dt class="argument literal"></dt><dd class="argument type"><span class="optional">raw</span></dd><dd class="description"></dd></dl></dd></div><div class="marker deprecated anonymous" data-target="type" data-deprecated="kubebuilder:object:root"><dt class="literal name">k8s:deepcopy-gen:interfaces</dt><dd class="args"><dl class="args summary"><dt class="argument literal"></dt><dd class="argument type"><span class="optional">string</span></dd></dl></dd><dd class="description"><details ><summary class="no-details">enables object interface implementation generation for this type</summary></details><dl class="args"><dt class="argument literal"></dt><dd class="argument type"><span class="optional">string</span></dd><dd class="description"></dd></dl></dd></div><div class="marker anonymous" data-target="package"><dt class="literal name">kubebuilder:object:generate</dt><dd class="args"><dl class="args summary"><dt class="literal argument"></dt><dd class="argument type"><span class="optional">bool</span></dd></dl></dd><dd class="description"><details ><summary class="no-details">enables or disables object interface &amp; deepcopy implementation generation for this package</summary></details><dl class="args"><dt class="argument literal"></dt><dd class="type argument"><span class="optional">bool</span></dd><dd class="description"></dd></dl></dd></div><div class="marker anonymous" data-target="type"><dt class="literal name">kubebuilder:object:generate</dt><dd class="args"><dl class="args summary"><dt class="argument literal"></dt><dd class="argument type"><span class="optional">bool</span></dd></dl></dd><dd class="description"><details ><summary class="no-details">overrides enabling or disabling deepcopy generation for this type</summary></details><dl class="args"><dt class="argument literal"></dt><dd class="argument type"><span class="optional">bool</span></dd><dd class="description"></dd></dl></dd></div><div class="marker anonymous" data-target="type"><dt class="literal name">kubebuilder:object:root</dt><dd class="args"><dl class="args summary"><dt class="argument literal"></dt><dd class="argument type"><span class="optional">bool</span></dd></dl></dd><dd class="description"><details ><summary class="no-details">enables object interface implementation generation for this type</summary></details><dl class="args"><dt class="argument literal"></dt><dd class="type argument"><span class="optional">bool</span></dd><dd class="description"></dd></dl></dd></div></dl></div>
<h1><a class="header" href="#rbac" id="rbac">RBAC</a></h1>
<p>这些标签会导致生成一个 <a href="https://kubernetes.io/docs/reference/access-authn-authz/rbac/#role-and-clusterrole">RBAC 的 ClusterRole</a>。这可以让您描述控制器所需要的权限，以及使用这些权限的代码。</p>
<div><input checked type="checkbox" class="markers-summarize" id="markers-summarize-RBAC"></input><label class="markers-summarize" for="markers-summarize-RBAC">Show Detailed Argument Help</label><dl class="markers"><div class="marker" data-target="package"><dt class="literal name">kubebuilder:rbac</dt><dd class="args"><dl class="args summary"><dt class="literal optional argument">groups</dt><dd class="type optional argument"><span class="slice optional"><span class="optional">string</span></span></dd><dt class="argument literal optional">namespace</dt><dd class="argument type optional"><span class="optional">string</span></dd><dt class="argument literal optional">resourceNames</dt><dd class="argument type optional"><span class="slice optional"><span class="optional">string</span></span></dd><dt class="argument literal optional">resources</dt><dd class="argument type optional"><span class="slice optional"><span class="optional">string</span></span></dd><dt class="argument literal optional">urls</dt><dd class="argument type optional"><span class="slice optional"><span class="optional">string</span></span></dd><dt class="literal argument">verbs</dt><dd class="type argument"><span class="slice"><span class="optional">string</span></span></dd></dl></dd><dd class="description"><details ><summary class="no-details">specifies an RBAC rule to all access to some resources or non-resource URLs.</summary></details><dl class="args"><dt class="optional argument literal">groups</dt><dd class="argument type optional"><span class="slice optional"><span class="optional">string</span></span></dd><dd class="description"><details ><summary class="no-details">specifies the API groups that this rule encompasses.</summary></details></dd><dt class="argument literal optional">namespace</dt><dd class="argument type optional"><span class="optional">string</span></dd><dd class="description"><details ><summary class="no-details">specifies the scope of the Rule. If not set, the Rule belongs to the generated ClusterRole. If set, the Rule belongs to a Role, whose namespace is specified by this field.</summary></details></dd><dt class="argument literal optional">resourceNames</dt><dd class="argument type optional"><span class="slice optional"><span class="optional">string</span></span></dd><dd class="description"><details ><summary class="">specifies the names of the API resources that this rule encompasses. </summary>
<p>Create requests cannot be restricted by resourcename, as the object‘s name is not known at authorization time.</p>
</details></dd><dt class="literal optional argument">resources</dt><dd class="optional argument type"><span class="slice optional"><span class="optional">string</span></span></dd><dd class="description"><details ><summary class="no-details">specifies the API resources that this rule encompasses.</summary></details></dd><dt class="argument literal optional">urls</dt><dd class="argument type optional"><span class="slice optional"><span class="optional">string</span></span></dd><dd class="description"><details ><summary class="no-details">URL specifies the non-resource URLs that this rule encompasses.</summary></details></dd><dt class="argument literal">verbs</dt><dd class="argument type"><span class="slice"><span class="optional">string</span></span></dd><dd class="description"><details ><summary class="no-details">specifies the (lowercase) kubernetes API verbs that this rule encompasses.</summary></details></dd></dl></dd></div></dl></div>
<h1><a class="header" href="#controller-gen-cli" id="controller-gen-cli">controller-gen CLI</a></h1>
<p>KubeBuilder 使用了一个称为 <a href="https://sigs.k8s.io/controller-tools/cmd/controller-gen">controller-gen</a>
用于生成通用代码和 Kubernetes YAML。 代码和配置的生成规则是被 Go 代码中的一些特殊<a href="reference//reference/markers.html">标记注释</a>控制的。</p>
<p>controller-gen 由不同的“generators”(指定生成什么)和“输出规则”(指定如何以及在何处输出结果)。</p>
<p>两者都是通过指定的命令行参数配置的，更详细的说明见 <a href="reference//reference/markers.html">标记格式化</a>。</p>
<p>例如，</p>
<pre><code class="language-shell">controller-gen paths=./... crd:trivialVersions=true rbac:roleName=controller-perms output:crd:artifacts:config=config/crd/bases
</code></pre>
<p>生成的 CRD 和 RBAC YAML 文件默认存储在<code>config/crd/bases</code>目录。 
RBAC 规则默认输出到(<code>config/rbac</code>)。 主要考虑到当前目录结构中的每个包的关系。
(按照 go <code>...</code> 的通配符规则)。</p>
<h2><a class="header" href="#生成器" id="生成器">生成器</a></h2>
<p>每个不同的生成器都是通过 CLI 选项配置的。controller-gen 一次运行也可以指定多个生成器。</p>
<div><input checked type="checkbox" class="markers-summarize" id="markers-summarize-CLI:-generators"></input><label class="markers-summarize" for="markers-summarize-CLI:-generators">Show Detailed Argument Help</label><dl class="markers"><div class="marker" data-target="package"><dt class="literal name">webhook</dt><dd class="args"><dl class="args summary"></dl></dd><dd class="description"><details ><summary class="no-details">generates (partial) {Mutating,Validating}WebhookConfiguration objects.</summary></details><dl class="args"></dl></dd></div><div class="marker" data-target="package"><dt class="literal name">schemapatch</dt><dd class="args"><dl class="args summary"><dt class="argument literal">manifests</dt><dd class="argument type"><span class="optional">string</span></dd><dt class="literal optional argument">maxDescLen</dt><dd class="argument type optional"><span class="optional">int</span></dd></dl></dd><dd class="description"><details ><summary class="">patches existing CRDs with new schemata. </summary>
<p>For legacy (v1beta1) single-version CRDs, it will simply replace the global schema. 
For legacy (v1beta1) multi-version CRDs, and any v1 CRDs, it will replace schemata of existing versions and <em>clear the schema</em> from any versions not specified in the Go code.  It will <em>not</em> add new versions, or remove old ones. 
For legacy multi-version CRDs with identical schemata, it will take care of lifting the per-version schema up to the global schema. 
It will generate output for each “CRD Version“ (API version of the CRD type itself) , e.g. apiextensions/v1beta1 and apiextensions/v1) available.</p>
</details><dl class="args"><dt class="argument literal">manifests</dt><dd class="type argument"><span class="optional">string</span></dd><dd class="description"><details ><summary class="no-details">contains the CustomResourceDefinition YAML files.</summary></details></dd><dt class="argument literal optional">maxDescLen</dt><dd class="argument type optional"><span class="optional">int</span></dd><dd class="description"><details ><summary class="">specifies the maximum description length for fields in CRD&#39;s OpenAPI schema. </summary>
<p>0 indicates drop the description for all fields completely. n indicates limit the description to at most n characters and truncate the description to closest sentence boundary if it exceeds n characters.</p>
</details></dd></dl></dd></div><div class="marker" data-target="package"><dt class="literal name">rbac</dt><dd class="args"><dl class="args summary"><dt class="argument literal">roleName</dt><dd class="argument type"><span class="optional">string</span></dd></dl></dd><dd class="description"><details ><summary class="no-details">generates ClusterRole objects.</summary></details><dl class="args"><dt class="argument literal">roleName</dt><dd class="argument type"><span class="optional">string</span></dd><dd class="description"><details ><summary class="no-details">sets the name of the generated ClusterRole.</summary></details></dd></dl></dd></div><div class="marker" data-target="package"><dt class="literal name">object</dt><dd class="args"><dl class="args summary"><dt class="argument literal optional">headerFile</dt><dd class="argument type optional"><span class="optional">string</span></dd><dt class="argument literal optional">year</dt><dd class="argument type optional"><span class="optional">string</span></dd></dl></dd><dd class="description"><details ><summary class="no-details">generates code containing DeepCopy, DeepCopyInto, and DeepCopyObject method implementations.</summary></details><dl class="args"><dt class="literal optional argument">headerFile</dt><dd class="argument type optional"><span class="optional">string</span></dd><dd class="description"><details ><summary class="no-details">specifies the header text (e.g. license) to prepend to generated files.</summary></details></dd><dt class="argument literal optional">year</dt><dd class="type optional argument"><span class="optional">string</span></dd><dd class="description"><details ><summary class="no-details">specifies the year to substitute for &#34; YEAR&#34; in the header file.</summary></details></dd></dl></dd></div><div class="marker" data-target="package"><dt class="literal name">crd</dt><dd class="args"><dl class="args summary"><dt class="argument literal optional">crdVersions</dt><dd class="argument type optional"><span class="slice optional"><span class="optional">string</span></span></dd><dt class="argument literal optional">maxDescLen</dt><dd class="argument type optional"><span class="optional">int</span></dd><dt class="argument literal optional">preserveUnknownFields</dt><dd class="argument type optional"><span class="optional">bool</span></dd><dt class="argument literal optional">trivialVersions</dt><dd class="argument type optional"><span class="optional">bool</span></dd></dl></dd><dd class="description"><details ><summary class="no-details">generates CustomResourceDefinition objects.</summary></details><dl class="args"><dt class="argument literal optional">crdVersions</dt><dd class="argument type optional"><span class="slice optional"><span class="optional">string</span></span></dd><dd class="description"><details ><summary class="">specifies the target API versions of the CRD type itself to generate.  Defaults to v1beta1. </summary>
<p>The first version listed will be assumed to be the “default“ version and will not get a version suffix in the output filename. 
You‘ll need to use “v1“ to get support for features like defaulting, along with an API server that supports it (Kubernetes 1.16+).</p>
</details></dd><dt class="literal optional argument">maxDescLen</dt><dd class="argument type optional"><span class="optional">int</span></dd><dd class="description"><details ><summary class="">specifies the maximum description length for fields in CRD&#39;s OpenAPI schema. </summary>
<p>0 indicates drop the description for all fields completely. n indicates limit the description to at most n characters and truncate the description to closest sentence boundary if it exceeds n characters.</p>
</details></dd><dt class="argument literal optional">preserveUnknownFields</dt><dd class="argument type optional"><span class="optional">bool</span></dd><dd class="description"><details ><summary class="">indicates whether or not we should turn off pruning. </summary>
<p>Left unspecified, it‘ll default to true when only a v1beta1 CRD is generated (to preserve compatibility with older versions of this tool), or false otherwise. 
It‘s required to be false for v1 CRDs.</p>
</details></dd><dt class="argument literal optional">trivialVersions</dt><dd class="argument type optional"><span class="optional">bool</span></dd><dd class="description"><details ><summary class="">indicates that we should produce a single-version CRD. </summary>
<p>Single “trivial-version“ CRDs are compatible with older (pre 1.13) Kubernetes API servers.  The storage version‘s schema will be used as the CRD‘s schema. 
Only works with the v1beta1 CRD version.</p>
</details></dd></dl></dd></div></dl></div>
<h2><a class="header" href="#输出规则" id="输出规则">输出规则</a></h2>
<p>输出规则配置给定生成器如何输出其结果。 默认是一个全局 fallback 输出规则(指定为 <code>output:&lt;rule&gt;</code>)，
另外还有 per-generator 的规则(指定为<code>output:&lt;generator&gt;:&lt;rule&gt;</code>)，会覆盖掉 fallback 规则。</p>
<aside class="note">
<h1><a class="header" href="#默认规则" id="默认规则">默认规则</a></h1>
<p>如果没有手动指定 fallback 规则，默认的 per-generator 将被使用，生成的 YAML 将放到
<code>config/&lt;generator&gt;</code>相应目录，代码所在的位置不变。</p>
<p>对于每个生成器来说，默认的规则等价于<code>output:&lt;generator&gt;:artifacts:config=config/&lt;generator&gt;</code>。</p>
<p>指定 fallback 规则后，将使用该规则代替默认规则。</p>
<p>例如，如果你指定<code>crd rbac:roleName=controller-permsoutput:crd:stdout</code>，你将在标准输出中获得 CRD，在<code>config/rbac</code>目录得到 rbac 规则。 
如果你要添加全局规则，例如<code>crdrbac:roleName=controller-perms output:crd:stdout output:none</code>，CRD 会被重定向到终端输出，其他被重定向到 /dev/null，因为我们已经明确指定了 fallback 。</p>
</aside>
<p>为简便起见，每个生成器的输出规则(<code>output:&lt;generator&gt;:&lt;rule&gt;</code>)默认省略。 相当于这里列出的全局备用选项。</p>
<div><input checked type="checkbox" class="markers-summarize" id="markers-summarize-CLI:-output-rules-(optionally-as-output:<generator>:...)"></input><label class="markers-summarize" for="markers-summarize-CLI:-output-rules-(optionally-as-output:<generator>:...)">Show Detailed Argument Help</label><dl class="markers"><div class="marker" data-target="package"><dt class="literal name">output:artifacts</dt><dd class="args"><dl class="args summary"><dt class="argument literal optional">code</dt><dd class="argument type optional"><span class="optional">string</span></dd><dt class="argument literal">config</dt><dd class="argument type"><span class="optional">string</span></dd></dl></dd><dd class="description"><details ><summary class="">outputs artifacts to different locations, depending on whether they&#39;re package-associated or not. </summary>
<p>Non-package associated artifacts are output to the Config directory, while package-associated ones are output to their package‘s source files‘ directory, unless an alternate path is specified in Code.</p>
</details><dl class="args"><dt class="argument literal optional">code</dt><dd class="argument type optional"><span class="optional">string</span></dd><dd class="description"><details ><summary class="no-details">overrides the directory in which to write new code (defaults to where the existing code lives).</summary></details></dd><dt class="literal argument">config</dt><dd class="argument type"><span class="optional">string</span></dd><dd class="description"><details ><summary class="no-details">points to the directory to which to write configuration.</summary></details></dd></dl></dd></div><div class="marker anonymous" data-target="package"><dt class="literal name">output:dir</dt><dd class="args"><dl class="args summary"><dt class="literal argument"></dt><dd class="argument type"><span class="optional">string</span></dd></dl></dd><dd class="description"><details ><summary class="no-details">outputs each artifact to the given directory, regardless of if it&#39;s package-associated or not.</summary></details><dl class="args"><dt class="argument literal"></dt><dd class="argument type"><span class="optional">string</span></dd><dd class="description"></dd></dl></dd></div><div class="marker" data-target="package"><dt class="literal name">output:none</dt><dd class="args"><dl class="args summary"></dl></dd><dd class="description"><details ><summary class="no-details">skips outputting anything.</summary></details><dl class="args"></dl></dd></div><div class="marker" data-target="package"><dt class="literal name">output:stdout</dt><dd class="args"><dl class="args summary"></dl></dd><dd class="description"><details ><summary class="">outputs everything to standard-out, with no separation. </summary>
<p>Generally useful for single-artifact outputs.</p>
</details><dl class="args"></dl></dd></div></dl></div>
<h2><a class="header" href="#其他选项" id="其他选项">其他选项</a></h2>
<div><input checked type="checkbox" class="markers-summarize" id="markers-summarize-CLI:-generic"></input><label class="markers-summarize" for="markers-summarize-CLI:-generic">Show Detailed Argument Help</label><dl class="markers"><div class="marker anonymous" data-target="package"><dt class="literal name">paths</dt><dd class="args"><dl class="args summary"><dt class="literal argument"></dt><dd class="argument type"><span class="slice"><span class="optional">string</span></span></dd></dl></dd><dd class="description"><details ><summary class="no-details">represents paths and go-style path patterns to use as package roots.</summary></details><dl class="args"><dt class="argument literal"></dt><dd class="argument type"><span class="slice"><span class="optional">string</span></span></dd><dd class="description"></dd></dl></dd></div></dl></div>
<h1><a class="header" href="#开启-shell-自动补全" id="开启-shell-自动补全">开启 shell 自动补全</a></h1>
<p>Kubebuilder 的 Bash 补全脚本可以通过命令 <code>kubebuilder completion bash</code> 来自动生成，Kubebuilder 的 Zsh 补全脚本可以通过命令 <code>kubebuilder completion zsh</code> 来自动生成。需要注意的是在你的 shell 环境中用 source 运行一下补全脚本就会开启 Kubebuilder 自动补全。</p>
<aside class="note">
<h1><a class="header" href="#bash-前提条件" id="bash-前提条件">Bash 前提条件</a></h1>
<p>Bash 脚本补全依赖于<a href="https://github.com/scop/bash-completion">bash-completion</a>，这也就意味着你不得不首先安装此软件（如果你已经安装了 bash 补全，你可以进行测试）。此外，确保你的 Bash 版本是 4.1+。</p>
</aside>
<ul>
<li>
<p>一旦安装完成，要在 <code>/etc/shells</code> 中添加路径 <code>/usr/local/bin/bash</code>。</p>
<p><code>echo “/usr/local/bin/bash” &gt; /etc/shells</code></p>
</li>
<li>
<p>确保使用当前用户安装的 shell。</p>
<p><code>chsh -s /usr/local/bin/bash</code></p>
</li>
<li>
<p>在 /.bash_profile 或 ~/.bashrc 中添加以下内容：</p>
</li>
</ul>
<pre><code># kubebuilder autocompletion
if [ -f /usr/local/share/bash-completion/bash_completion ]; then
. /usr/local/share/bash-completion/bash_completion
fi
. &lt;(kubebuilder completion)
</code></pre>
<ul>
<li>重启终端以便让修改生效。</li>
</ul>
<aside class="note">
<h1><a class="header" href="#zsh" id="zsh">Zsh</a></h1>
`zsh` 补全可以参考上述流程。
</aside>
<h1><a class="header" href="#制品" id="制品">制品</a></h1>
<p>除了主要的二进制版本外 Kubebuilder 还发布测试二进制文件和容器镜像。</p>
<h2><a class="header" href="#测试二进制文件" id="测试二进制文件">测试二进制文件</a></h2>
<p>你可以在 <code>https://go.kubebuilder.io/test-tools</code> 中找到所有的测试二进制文件。
你可以在 <code>https://go.kubebuilder.io/test-tools/${version}/${os}/${arch}</code> 找到单独的二进制文件。</p>
<h2><a class="header" href="#容器镜像" id="容器镜像">容器镜像</a></h2>
<p>你可以在 <code>https://go.kubebuilder.io/images/${os}</code> 或者 <code>gcr.io/kubebuilder/thirdparty-${os}</code> 中找到与你系统相对应的所有容器镜像。
你可以在 <code>https://go.kubebuilder.io/images/${os}/${version}</code> 或者 <code>gcr.io/kubebuilder/thirdparty-${os}:${version}</code> 中找到单独的容器镜像。</p>
<h2><a class="header" href="#在集成测试中使用-envtest" id="在集成测试中使用-envtest">在集成测试中使用 envtest</a></h2>
<p><a href="http://sigs.k8s.io/controller-runtime"><code>controller-runtime</code></a> 提供 <code>envtest</code> (<a href="https://pkg.go.dev/sigs.k8s.io/controller-runtime/pkg/envtest?tab=doc">godoc</a>)，这个包可以帮助你为你在 etcd 和 Kubernetes API server 中设置并启动的 controllers 实例来写集成测试，不需要 kubelet，controller-manager 或者其他组件。</p>
<p>可以根据以下通用流程在集成测试中使用 <code>envtest</code>：</p>
<pre><code class="language-go">import sigs.k8s.io/controller-runtime/pkg/envtest

//指定 testEnv 配置
testEnv = &amp;envtest.Environment{
	CRDDirectoryPaths: []string{filepath.Join(&quot;..&quot;, &quot;config&quot;, &quot;crd&quot;, &quot;bases&quot;)},
}

//启动 testEnv
cfg, err = testEnv.Start()

//编写测试逻辑

//停止 testEnv
err = testEnv.Stop()
</code></pre>
<p><code>kubebuilder</code> 为你提供了 testEnv 的设置和清除模版，在生成的 <code>/controllers</code> 目录下的 ginkgo 测试套件中。</p>
<p>测试运行中的 Logs 以 <code>test-env</code> 为前缀。</p>
<h3><a class="header" href="#配置你的测试控制面" id="配置你的测试控制面">配置你的测试控制面</a></h3>
<p>你可以在你的集成测试中使用环境变量和/或者标记位来指定 <code>api-server</code> 和 <code>etcd</code> 设置。</p>
<h4><a class="header" href="#环境变量" id="环境变量">环境变量</a></h4>
<table><thead><tr><th>变量名称</th><th align="left">类型</th><th align="left">使用时机</th></tr></thead><tbody>
<tr><td><code>USE_EXISTING_CLUSTER</code></td><td align="left">boolean</td><td align="left">可以指向一个已存在 cluster 的控制面，而不用设置一个本地的控制面。</td></tr>
<tr><td><code>KUBEBUILDER_ASSETS</code></td><td align="left">目录路径</td><td align="left">将集成测试指向一个包含所有二进制文件（api-server，etcd 和 kubectl）的目录。</td></tr>
<tr><td><code>TEST_ASSET_KUBE_APISERVER</code>, <code>TEST_ASSET_ETCD</code>, <code>TEST_ASSET_KUBECTL</code></td><td align="left">分别代表 api-server，etcd，和 kubectl 二进制文件的路径</td><td align="left">和 <code>KUBEBUILDER_ASSETS</code> 相似，但是更细一点。指示集成测试使用非默认的二进制文件。这些环境变量也可以被用来确保特定的测试是在期望版本的二进制文件下运行的。</td></tr>
<tr><td><code>KUBEBUILDER_CONTROLPLANE_START_TIMEOUT</code> 和 <code>KUBEBUILDER_CONTROLPLANE_STOP_TIMEOUT</code></td><td align="left"><a href="https://golang.org/pkg/time/#ParseDuration"><code>time.ParseDuration</code></a> 支持的持续时间的格式</td><td align="left">指定不同于测试控制面（分别）启动和停止的超时时间；任何超出设置的测试都会运行失败。</td></tr>
<tr><td><code>KUBEBUILDER_ATTACH_CONTROL_PLANE_OUTPUT</code></td><td align="left">boolean</td><td align="left">设置为 <code>true</code> 可以将控制面的标准输出和标准错误贴合到 os.Stdout 和 os.Stderr 上。这种做法在调试测试失败时是非常有用的，因为输出包含控制面的输出。</td></tr>
</tbody></table>
<h4><a class="header" href="#标记位" id="标记位">标记位</a></h4>
<p>下面是一个在你的集成测试中通过修改标记位来启动 API server 的例子，和 <code>envtest.DefaultKubeAPIServerFlags</code> 中的默认值相对比：</p>
<pre><code class="language-go">var _ = BeforeSuite(func(done Done) {
	Expect(os.Setenv(&quot;TEST_ASSET_KUBE_APISERVER&quot;, &quot;../testbin/bin/kube-apiserver&quot;)).To(Succeed())
	Expect(os.Setenv(&quot;TEST_ASSET_ETCD&quot;, &quot;../testbin/bin/etcd&quot;)).To(Succeed())
	Expect(os.Setenv(&quot;TEST_ASSET_KUBECTL&quot;, &quot;../testbin/bin/kubectl&quot;)).To(Succeed())

	logf.SetLogger(zap.New(zap.WriteTo(GinkgoWriter), zap.UseDevMode(true)))
	testenv = &amp;envtest.Environment{}

	_, err := testenv.Start()
	Expect(err).NotTo(HaveOccurred())

	close(done)
}, 60)

var _ = AfterSuite(func() {
	Expect(testenv.Stop()).To(Succeed())

	Expect(os.Unsetenv(&quot;TEST_ASSET_KUBE_APISERVER&quot;)).To(Succeed())
	Expect(os.Unsetenv(&quot;TEST_ASSET_ETCD&quot;)).To(Succeed())
	Expect(os.Unsetenv(&quot;TEST_ASSET_KUBECTL&quot;)).To(Succeed())

})
</code></pre>
<pre><code class="language-go">customApiServerFlags := []string{
	&quot;--secure-port=6884&quot;,
	&quot;--admission-control=MutatingAdmissionWebhook&quot;,
}

apiServerFlags := append([]string(nil), envtest.DefaultKubeAPIServerFlags...)
apiServerFlags = append(apiServerFlags, customApiServerFlags...)

testEnv = &amp;envtest.Environment{
	CRDDirectoryPaths: []string{filepath.Join(&quot;..&quot;, &quot;config&quot;, &quot;crd&quot;, &quot;bases&quot;)},
	KubeAPIServerFlags: apiServerFlags,
}
</code></pre>
<h3><a class="header" href="#测试注意事项" id="测试注意事项">测试注意事项</a></h3>
<p>除非你在使用一个已存在的 cluster，否则需要记住在测试内容中没有内置的 controllers 在运行。在某些方面，测试控制面会表现的和“真实” clusters 有点不一样，这可能会对你如何写测试有些影响。一个很常见的例子就是垃圾回收；因为没有 controllers 来监控内置的资源，对象是不会被删除的，即使设置了 <code>OwnerReference</code>。 </p>
<p>为了测试删除生命周期是否工作正常，要测试所有权而不是仅仅判断是否存在。比如：</p>
<pre><code class="language-go">expectedOwnerReference := v1.OwnerReference{
	Kind:       &quot;MyCoolCustomResource&quot;,
	APIVersion: &quot;my.api.example.com/v1beta1&quot;,
	UID:        &quot;d9607e19-f88f-11e6-a518-42010a800195&quot;,
	Name:       &quot;userSpecifiedResourceName&quot;,
}
Expect(deployment.ObjectMeta.OwnerReferences).To(ContainElement(expectedOwnerReference))
</code></pre>
<h1><a class="header" href="#指标" id="指标">指标</a></h1>
<p>默认情况下，controller-runtime 会构建一个全局 prometheus 注册，并且会为每个控制器发布一系列性能指标。</p>
<h2><a class="header" href="#指标保护" id="指标保护">指标保护</a></h2>
<p>如果使用了 kubebuilder <a href="https://github.com/brancz/kube-rbac-proxy">kube-auth-proxy</a> 默认会保护这些指标。Kubebuilder v2.2.0+ 会创建一个集群角色，它在 <code>config/rbac/auth_proxy_client_clusterrole.yaml</code> 文件中配置。</p>
<p>你需要给你所有的 Prometheus 服务授权，以便它可以拿到这些被保护的指标。为实现授权，你可以创建一个 <code>clusterRoleBinding</code> 把 <code>clusterRole</code> 绑定到一个你的 Prometheus 服务使用的账户上。</p>
<p>可以运行下面的 kubectl 命令来创建它。如果你使用 kubebuilder，在<code>config/default/kustomization.yaml</code> 文件中 <code>namePrefix</code> 字段是 <code>&lt;project-prefix&gt;</code>。</p>
<pre><code class="language-bash">kubectl create clusterrolebinding metrics --clusterrole=&lt;project-prefix&gt;-metrics-reader --serviceaccount=&lt;namespace&gt;:&lt;service-account-name&gt;
</code></pre>
<h2><a class="header" href="#给-prometheus-导出指标" id="给-prometheus-导出指标">给 Prometheus 导出指标</a></h2>
<p>按照下面的步骤来用 Prometheus Operator 导出指标：</p>
<ol>
<li>安装 Prometheus 和 Prometheus Operator。如果没有自己的监控系统，在生产环境上我们推荐使用 <a href="https://github.com/coreos/kube-prometheus#installing">kube-prometheus</a>。如果你只是做实验，那么可以只安装 Prometheus 和 Prometheus Operator。</li>
<li>在 <code>config/default/kustomization.yaml</code> 配置文件中取消 <code>- ../prometheus</code> 这一行的注释。它会创建可以导出指标的 <code>ServiceMonitor</code> 资源。</li>
</ol>
<pre><code class="language-yaml"># [PROMETHEUS] 用于启用 prometheus 监控, 取消所有带 'PROMETHEUS' 部分的注释。
- ../prometheus
</code></pre>
<p>注意，当你在集群中安装你的项目时，它会创建一个 <code>ServiceMonitor</code> 来导出指标。为了检查 ServiceMonitor，可以运行 <code>kubectl get ServiceMonitor -n &lt;project&gt;-system</code>。看下面的例子：</p>
<pre><code>$ kubectl get ServiceMonitor -n monitor-system
NAME                                         AGE
monitor-controller-manager-metrics-monitor   2m8s
</code></pre>
<p>同样，要注意默认情况下是通过 <code>8443</code> 端口导出指标的。这种情况下，你可以在自己的 dashboard 中检查 Prometheus metrics。要检查这些指标，在项目运行的 <code>{namespace=&quot;&lt;project&gt;-system&quot;}</code> 命名空间下搜索导出的指标。看下面的例子：</p>
<img width="1680" alt="Screenshot 2019-10-02 at 13 07 13" src="https://user-images.githubusercontent.com/7708031/66042888-a497da80-e515-11e9-9d77-d8a9fc1159a5.png">
<h2><a class="header" href="#发布额外的指标" id="发布额外的指标">发布额外的指标：</a></h2>
<p>如果你想从你的控制器发布额外的指标，可以通过在 <code>conoller-runtime/pkg/metrics</code> 中使用全局注册的方式来轻松做到。</p>
<p>实现发布额外指标的一种方式是把收集器声明为全局变量，并且使用 <code>init()</code> 来注册。</p>
<p>例如：</p>
<pre><code class="language-go">import (
    &quot;github.com/prometheus/client_golang/prometheus&quot;
    &quot;sigs.k8s.io/controller-runtime/pkg/metrics&quot;
)

var (
    goobers = prometheus.NewCounter(
        prometheus.CounterOpts{
            Name: &quot;goobers_total&quot;,
            Help: &quot;Number of goobers proccessed&quot;,
        },
    )
    gooberFailures = prometheus.NewCounter(
        prometheus.CounterOpts{
            Name: &quot;goober_failures_total&quot;,
            Help: &quot;Number of failed goobers&quot;,
        },
    )
)

func init() {
    // Register custom metrics with the global prometheus registry
    metrics.Registry.MustRegister(goobers, gooberFailures)
}
</code></pre>
<p>然后就可以从你的接收循环部分中记录这些指标到收集器中了，并且这些指标就可以被 prometheus 或者其它开放指标系统来抓取了。</p>
<h1><a class="header" href="#将要做的事" id="将要做的事">将要做的事</a></h1>
<p>如果你正在看这页，很大程度是因为在这本书中还有东西没有完成。前往<a href="https://github.com/kubernetes-sigs/kubebuilder/issues?q=is%3Aopen+is%3Aissue+label%3Akind%2Fdocumentation">查看是否有人能发现这个</a>或者<a href="https://github.com/kubernetes-sigs/kubebuilder/issues/new?assignees=&amp;labels=kind%2Fdocumentation">向 maintainers 报告 bug</a>。</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        

                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                

                
            </nav>

        </div>

        

        
        <!-- Google Analytics Tag -->
        <script type="text/javascript">
            var localAddrs = ["localhost", "127.0.0.1", ""];
            // make sure we don't activate google analytics if the developer is
            // inspecting the book locally...
            if (localAddrs.indexOf(document.location.hostname) === -1) {
                (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
                })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
                ga('create', 'UA-119864590-1', 'auto');
                ga('send', 'pageview');
            }
        </script>
        

        
        
        

        

        
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        
        
        <script type="text/javascript">
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>
        
        

    </body>
</html>